<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>35 Diagrams and charts | The Epidemiologist R Handbook</title>

    <meta name="author" content="the handbook team" />
  
  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script>
  <script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script>
    <script src="libs/header-attrs-2.8/header-attrs.js"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
    <script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
    <script src="libs/bs3compat-0.2.5.1/tabs.js"></script>
    <script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script>
    <link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet" />
    <script src="libs/bs4_book-1.0.0/bs4_book.js"></script>
    <script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script>

  <!-- CSS -->
    <link rel="stylesheet" href="style_bs4.css" />
    
</head>

<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book">
    <a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">The Epidemiologist R Handbook</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
      </form>

      <nav aria-label="Table of contents">
        <h2>Table of contents</h2>
        <div id="book-toc"></div>

        <div class="book-extra">
          <p><a id="book-repo" href="#">View book source <i class="fab fa-github"></i></a></li></p>
        </div>
      </nav>
    </div>
  </header>

  <main class="col-sm-12 col-md-9 col-lg-7" id="content">
<div id="diagrams-and-charts" class="section level1" number="35">
<h1><span class="header-section-number">35</span> Diagrams and charts</h1>
<p>This page covers code to produce:</p>
<ul>
<li>Flow diagrams using <strong>DiagrammeR</strong> and the DOT language<br />
</li>
<li>Alluvial/Sankey diagrams<br />
</li>
<li>Event timelines</li>
</ul>
<!-- * DAGs (Directed Acyclic Graphs)   -->
<!-- * GANTT charts   -->
<!-- ======================================================= -->
<div id="preparation-28" class="section level2" number="35.1">
<h2><span class="header-section-number">35.1</span> Preparation</h2>
<div id="load-packages-24" class="section level3 unnumbered">
<h3>Load packages</h3>
<p>This code chunk shows the loading of packages required for the analyses. In this handbook we emphasize <code>p_load()</code> from <strong>pacman</strong>, which installs the package if necessary <em>and</em> loads it for use. You can also load installed packages with <code>library()</code> from <strong>base</strong> R. See the page on <a href="r-basics.html#r-basics">R basics</a> for more information on R packages.</p>
</div>
<div id="import-data-21" class="section level3 unnumbered">
<h3>Import data</h3>
<p>Most of the content in this page does not require a dataset. However, in the Sankey diagram section, we will use the case linelist from a simulated Ebola epidemic. If you want to follow along for this part, <a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds' class='download-button'>click to download the “clean” linelist</a> (as .rds file). Import data with the <code>import()</code> function from the <strong>rio</strong> package (it handles many file types like .xlsx, .csv, .rds - see the <a href="import-and-export.html#import-and-export">Import and export</a> page for details).</p>
<p>The first 50 rows of the linelist are displayed below.</p>
<!-- ======================================================= -->
</div>
</div>
<div id="flow-diagrams" class="section level2" number="35.2">
<h2><span class="header-section-number">35.2</span> Flow diagrams</h2>
<p>One can use the R package <strong>DiagrammeR</strong> to create charts/flow charts. They can be static, or they can adjust somewhat dynamically based on changes in a dataset.</p>
<p><strong>Tools</strong></p>
<p>The function <code>grViz()</code> is used to create a “Graphviz” diagram. This function accepts a <em>character string input containing instructions</em> for making the diagram. Within that string, the instructions are written in a different language, called <a href="https://graphviz.org/doc/info/lang.html">DOT</a> - it is quite easy to learn the basics.</p>
<p><strong>Basic structure</strong></p>
<ol style="list-style-type: decimal">
<li>Open the instructions <code>grViz("</code><br />
</li>
<li>Specify directionality and name of the graph, and open brackets, e.g. <code>digraph my_flow_chart {</code></li>
<li>Graph statement (layout, rank direction)<br />
</li>
<li>Nodes statements (create nodes)</li>
<li>Edges statements (gives links between nodes)<br />
</li>
<li>Close the instructions <code>}")</code></li>
</ol>
<div id="simple-examples" class="section level3 unnumbered">
<h3>Simple examples</h3>
<p>Below are two simple examples</p>
<p>A very minimal example:</p>
<p>An example with perhaps a bit more applied public health context:</p>
</div>
<div id="syntax" class="section level3 unnumbered">
<h3>Syntax</h3>
<p><strong>Basic syntax</strong></p>
<p>Node names, or edge statements, can be separated with spaces, semicolons, or newlines.</p>
<p><strong>Rank direction</strong></p>
<p>A plot can be re-oriented to move left-to-right by adjusting the <code>rankdir</code> argument within the graph statement. The default is TB (top-to-bottom), but it can be LR (left-to-right), RL, or BT.</p>
<p><strong>Node names</strong></p>
<p>Node names can be single words, as in the simple example above. To use multi-word names or special characters (e.g. parentheses, dashes), put the node name within single quotes (’ ’). It may be easier to have a short node name, and assign a <em>label</em>, as shown below within brackets [ ]. If you want to have a newline within the node’s name, you must do it via a label - use <code>\n</code> in the node label within single quotes, as shown below.</p>
<p><strong>Subgroups</strong><br />
Within edge statements, subgroups can be created on either side of the edge with curly brackets ({ }). The edge then applies to all nodes in the bracket - it is a shorthand.</p>
<p><strong>Layouts</strong></p>
<ul>
<li>dot (set <code>rankdir</code> to either TB, LR, RL, BT, )</li>
<li>neato<br />
</li>
<li>twopi<br />
</li>
<li>circo</li>
</ul>
<p><strong>Nodes - editable attributes</strong></p>
<ul>
<li><code>label</code> (text, in single quotes if multi-word)<br />
</li>
<li><code>fillcolor</code> (many possible colors)<br />
</li>
<li><code>fontcolor</code><br />
</li>
<li><code>alpha</code> (transparency 0-1)<br />
</li>
<li><code>shape</code> (ellipse, oval, diamond, egg, plaintext, point, square, triangle)<br />
</li>
<li><code>style</code><br />
</li>
<li><code>sides</code><br />
</li>
<li><code>peripheries</code><br />
</li>
<li><code>fixedsize</code> (h x w)<br />
</li>
<li><code>height</code><br />
</li>
<li><code>width</code><br />
</li>
<li><code>distortion</code><br />
</li>
<li><code>penwidth</code> (width of shape border)<br />
</li>
<li><code>x</code> (displacement left/right)<br />
</li>
<li><code>y</code> (displacement up/down)<br />
</li>
<li><code>fontname</code><br />
</li>
<li><code>fontsize</code><br />
</li>
<li><code>icon</code></li>
</ul>
<p><strong>Edges - editable attributes</strong></p>
<ul>
<li><code>arrowsize</code><br />
</li>
<li><code>arrowhead</code> (normal, box, crow, curve, diamond, dot, inv, none, tee, vee)<br />
</li>
<li><code>arrowtail</code><br />
</li>
<li><code>dir</code> (direction, )<br />
</li>
<li><code>style</code> (dashed, …)<br />
</li>
<li><code>color</code><br />
</li>
<li><code>alpha</code><br />
</li>
<li><code>headport</code> (text in front of arrowhead)<br />
</li>
<li><code>tailport</code> (text in behind arrowtail)<br />
</li>
<li><code>fontname</code><br />
</li>
<li><code>fontsize</code><br />
</li>
<li><code>fontcolor</code><br />
</li>
<li><code>penwidth</code> (width of arrow)<br />
</li>
<li><code>minlen</code> (minimum length)</li>
</ul>
<p><strong>Color names</strong>: hexadecimal values or ‘X11’ color names, see <a href="http://rich-iannone.github.io/DiagrammeR/graphviz_and_mermaid.html">here for X11 details</a></p>
</div>
<div id="complex-examples" class="section level3 unnumbered">
<h3>Complex examples</h3>
<p>The example below expands on the surveillance_diagram, adding complex node names, grouped edges, colors and styling</p>
<pre><code>DiagrammeR::grViz(&quot;               # All instructions are within a large character string
digraph surveillance_diagram {    # &#39;digraph&#39; means &#39;directional graph&#39;, then the graph name 
  
  # graph statement
  #################
  graph [layout = dot,
         rankdir = TB,            # layout top-to-bottom
         fontsize = 10]
  

  # nodes (circles)
  #################
  node [shape = circle,           # shape = circle
       fixedsize = true
       width = 1.3]                      
  
  Primary   [label = &#39;Primary\nFacility&#39;] 
  Secondary [label = &#39;Secondary\nFacility&#39;] 
  Tertiary  [label = &#39;Tertiary\nFacility&#39;] 
  SC        [label = &#39;Surveillance\nCoordination&#39;,
             fontcolor = darkgreen] 
  
  # edges
  #######
  Primary   -&gt; Secondary [label = &#39; case transfer&#39;,
                          fontcolor = red,
                          color = red]
  Secondary -&gt; Tertiary [label = &#39; case transfer&#39;,
                          fontcolor = red,
                          color = red]
  
  # grouped edge
  {Primary Secondary Tertiary} -&gt; SC [label = &#39;case reporting&#39;,
                                      fontcolor = darkgreen,
                                      color = darkgreen,
                                      style = dashed]
}
&quot;)</code></pre>
<p><strong>Sub-graph clusters</strong></p>
<p>To group nodes into boxed clusters, put them within the same named subgraph (<code>subgraph name {}</code>). To have each subgraph identified within a bounding box, begin the name of the subgraph with “cluster”, as shown with the 4 boxes below.</p>
<pre><code>DiagrammeR::grViz(&quot;             # All instructions are within a large character string
digraph surveillance_diagram {  # &#39;digraph&#39; means &#39;directional graph&#39;, then the graph name 
  
  # graph statement
  #################
  graph [layout = dot,
         rankdir = TB,            
         overlap = true,
         fontsize = 10]
  

  # nodes (circles)
  #################
  node [shape = circle,                  # shape = circle
       fixedsize = true
       width = 1.3]                      # width of circles
  
  subgraph cluster_passive {
    Primary   [label = &#39;Primary\nFacility&#39;] 
    Secondary [label = &#39;Secondary\nFacility&#39;] 
    Tertiary  [label = &#39;Tertiary\nFacility&#39;] 
    SC        [label = &#39;Surveillance\nCoordination&#39;,
               fontcolor = darkgreen] 
  }
  
  # nodes (boxes)
  ###############
  node [shape = box,                     # node shape
        fontname = Helvetica]            # text font in node
  
  subgraph cluster_active {
    Active [label = &#39;Active\nSurveillance&#39;] 
    HCF_active [label = &#39;HCF\nActive Search&#39;]
  }
  
  subgraph cluster_EBD {
    EBS [label = &#39;Event-Based\nSurveillance (EBS)&#39;] 
    &#39;Social Media&#39;
    Radio
  }
  
  subgraph cluster_CBS {
    CBS [label = &#39;Community-Based\nSurveillance (CBS)&#39;]
    RECOs
  }

  
  # edges
  #######
  {Primary Secondary Tertiary} -&gt; SC [label = &#39;case reporting&#39;]

  Primary   -&gt; Secondary [label = &#39;case transfer&#39;,
                          fontcolor = red]
  Secondary -&gt; Tertiary [label = &#39;case transfer&#39;,
                          fontcolor = red]
  
  HCF_active -&gt; Active
  
  {&#39;Social Media&#39; Radio} -&gt; EBS
  
  RECOs -&gt; CBS
}
&quot;)
</code></pre>
<p><strong>Node shapes</strong></p>
<p>The example below, borrowed from <a href="http://rich-iannone.github.io/DiagrammeR/">this tutorial</a>, shows applied node shapes and a shorthand for serial edge connections</p>
</div>
<div id="outputs" class="section level3 unnumbered">
<h3>Outputs</h3>
<p>How to handle and save outputs</p>
<ul>
<li>Outputs will appear in RStudio’s Viewer pane, by default in the lower-right alongside Files, Plots, Packages, and Help.<br />
</li>
<li>To export you can “Save as image” or “Copy to clipboard” from the Viewer. The graphic will adjust to the specified size.</li>
</ul>
</div>
<div id="parameterized-figures" class="section level3 unnumbered">
<h3>Parameterized figures</h3>
<p>Here is a quote from this tutorial: <a href="https://mikeyharper.uk/flowcharts-in-r-using-diagrammer/" class="uri">https://mikeyharper.uk/flowcharts-in-r-using-diagrammer/</a></p>
<p>“Parameterized figures: A great benefit of designing figures within R is that we are able to connect the figures directly with our analysis by reading R values directly into our flowcharts. For example, suppose you have created a filtering process which removes values after each stage of a process, you can have a figure show the number of values left in the dataset after each stage of your process. To do this we, you can use the @<span class="citation">@X</span> symbol directly within the figure, then refer to this in the footer of the plot using [X]:, where X is the a unique numeric index.”</p>
<p>We encourage you to review this tutorial if parameterization is something you are interested in.</p>
<!-- And below is some example code from this tutorial. -->
<!-- ```{r, eval=F} -->
<!-- # Define some sample data -->
<!-- data <- list(a=1000, b=800, c=600, d=400) -->
<!-- DiagrammeR::grViz(" -->
<!-- digraph graph2 { -->
<!-- graph [layout = dot] -->
<!-- # node definitions with substituted label text -->
<!-- node [shape = rectangle, width = 4, fillcolor = Biege] -->
<!-- a [label = '@@1'] -->
<!-- b [label = '@@2'] -->
<!-- c [label = '@@3'] -->
<!-- d [label = '@@4'] -->
<!-- a -> b -> c -> d -->
<!-- } -->
<!-- [1]:  paste0('Raw Data (n = ', data$a, ')') -->
<!-- [2]: paste0('Remove Errors (n = ', data$b, ')') -->
<!-- [3]: paste0('Identify Potential Customers (n = ', data$c, ')') -->
<!-- [4]: paste0('Select Top Priorities (n = ', data$d, ')') -->
<!-- ") -->
<!-- ``` -->
<!-- ### CONSORT diagram  {.unnumbered} -->
<!-- THIS SECTION IS UNDER CONSTRUCTION   -->
<!-- https://scriptsandstatistics.wordpress.com/2017/12/22/how-to-draw-a-consort-flow-diagram-using-r-and-graphviz/ -->
<!-- Note above is out of date via DiagrammeR -->
<!-- ======================================================= -->
</div>
</div>
<div id="alluvialsankey-diagrams" class="section level2" number="35.3">
<h2><span class="header-section-number">35.3</span> Alluvial/Sankey Diagrams</h2>
<div id="load-packages-25" class="section level3 unnumbered">
<h3>Load packages</h3>
<p>This code chunk shows the loading of packages required for the analyses. In this handbook we emphasize <code>p_load()</code> from <strong>pacman</strong>, which installs the package if necessary <em>and</em> loads it for use. You can also load installed packages with <code>library()</code> from <strong>base</strong> R. See the page on <a href="r-basics.html#r-basics">R basics</a> for more information on R packages.</p>
<p>We load the <strong>networkD3</strong> package to produce the diagram, and also <strong>tidyverse</strong> for the data preparation steps.</p>
</div>
<div id="plotting-from-dataset" class="section level3 unnumbered">
<h3>Plotting from dataset</h3>
<p>Plotting the connections in a dataset. Below we demonstrate using this package on the case <code>linelist</code>. Here is an <a href="https://www.r-graph-gallery.com/321-introduction-to-interactive-sankey-diagram-2.html">online tutorial</a>.</p>
<p>We begin by getting the case counts for each unique age category and hospital combination. We’ve removed values with missing age category for clarity. We also re-label the <code>hospital</code> and <code>age_cat</code> columns as <code>source</code> and <code>target</code> respectively. These will be the two sides of the alluvial diagram.</p>
<p>The dataset now look like this:</p>
<p>Now we create a data frame of all the diagram nodes, under the column <code>name</code>. This consists of all the values for <code>hospital</code> and <code>age_cat</code>. Note that we ensure they are all class Character before combining them. and adjust the ID columns to be numbers instead of labels:</p>
<p>The we edit the <code>links</code> data frame, which we created above with <code>count()</code>. We add two numeric columns <code>IDsource</code> and <code>IDtarget</code> which will actually reflect/create the links between the nodes. These columns will hold the rownumbers (position) of the source and target nodes. 1 is subtracted so that these position numbers begin at 0 (not 1).</p>
<p>The links dataset now looks like this:</p>
<p>Now plot the Sankey diagram with <code>sankeyNetwork()</code>. You can read more about each argument by running <code>?sankeyNetwork</code> in the console. Note that unless you set <code>iterations = 0</code> the order of your nodes may not be as expected.</p>
<p>Here is an example where the patient Outcome is included as well. Note in the data preparation step we have to calculate the counts of cases between age and hospital, and separately between hospital and outcome - and then bind all these counts together with <code>bind_rows()</code>.</p>
<p><a href="https://www.displayr.com/sankey-diagrams-r/" class="uri">https://www.displayr.com/sankey-diagrams-r/</a></p>
<!-- ======================================================= -->
</div>
</div>
<div id="event-timelines" class="section level2" number="35.4">
<h2><span class="header-section-number">35.4</span> Event timelines</h2>
<p>To make a timeline showing specific events, you can use the <code>vistime</code> package.</p>
<p>See this <a href="https://cran.r-project.org/web/packages/vistime/vignettes/vistime-vignette.html#ex.-2-project-planning">vignette</a></p>
<p>Here is the events dataset we begin with:</p>
<!-- ======================================================= -->
</div>
<div id="dags" class="section level2" number="35.5">
<h2><span class="header-section-number">35.5</span> DAGs</h2>
<p>You can build a DAG manually using the <strong>DiagammeR</strong> package and DOT language as described above.</p>
<p>Alternatively, there are packages like <strong>ggdag</strong> and <strong>daggity</strong></p>
<p><a href="https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html">Introduction to DAGs ggdag vignette</a></p>
<p><a href="https://www.r-bloggers.com/2019/08/causal-inference-with-dags-in-r/#:~:text=In%20a%20DAG%20all%20the,for%20drawing%20and%20analyzing%20DAGs.">Causal inference with dags in R</a></p>
<!-- ======================================================= -->
</div>
<div id="resources-28" class="section level2" number="35.6">
<h2><span class="header-section-number">35.6</span> Resources</h2>
<p>Much of the above regarding the DOT language is adapted from the tutorial <a href="https://mikeyharper.uk/flowcharts-in-r-using-diagrammer/">at this site</a></p>
<p>Another more in-depth <a href="http://rich-iannone.github.io/DiagrammeR/">tutorial on DiagammeR</a></p>
<p>This page on <a href="https://www.displayr.com/sankey-diagrams-r/">Sankey diagrams</a></p>

</div>
</div>
  </main>

  <div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page">
      <h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          <li><a id="book-source" href="#">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="#">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
      </div>
    </nav>
  </div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5">
  <div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>The Epidemiologist R Handbook</strong>" was written by the handbook team. It was last built on 2021-05-30.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
