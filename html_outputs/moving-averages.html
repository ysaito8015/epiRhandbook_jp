<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>22 Moving averages | The Epidemiologist R Handbook</title>

    <meta name="author" content="the handbook team" />
  
  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script>
  <script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script>
    <script src="libs/header-attrs-2.8/header-attrs.js"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
    <script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
    <script src="libs/bs3compat-0.2.5.1/tabs.js"></script>
    <script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script>
    <link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet" />
    <script src="libs/bs4_book-1.0.0/bs4_book.js"></script>
    <script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script>

  <!-- CSS -->
    <link rel="stylesheet" href="style_bs4.css" />
    
</head>

<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book">
    <a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">The Epidemiologist R Handbook</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
      </form>

      <nav aria-label="Table of contents">
        <h2>Table of contents</h2>
        <div id="book-toc"></div>

        <div class="book-extra">
          <p><a id="book-repo" href="#">View book source <i class="fab fa-github"></i></a></li></p>
        </div>
      </nav>
    </div>
  </header>

  <main class="col-sm-12 col-md-9 col-lg-7" id="content">
<div id="moving-averages" class="section level1" number="22">
<h1><span class="header-section-number">22</span> Moving averages</h1>
<p>This page will cover two methods to calculate and visualize moving averages:</p>
<ol style="list-style-type: decimal">
<li>Calculate with the <strong>slider</strong> package<br />
</li>
<li>Calculate <em>within</em> a <code>ggplot()</code> command with the <strong>tidyquant</strong> package</li>
</ol>
<!-- ======================================================= -->
<div id="preparation-13" class="section level2" number="22.1">
<h2><span class="header-section-number">22.1</span> Preparation</h2>
<div id="load-packages-15" class="section level3 unnumbered">
<h3>Load packages</h3>
<p>This code chunk shows the loading of packages required for the analyses. In this handbook we emphasize <code>p_load()</code> from <strong>pacman</strong>, which installs the package if necessary <em>and</em> loads it for use. You can also load installed packages with <code>library()</code> from <strong>base</strong> R. See the page on <a href="r-basics.html#r-basics">R basics</a> for more information on R packages.</p>
</div>
<div id="import-data-14" class="section level3 unnumbered">
<h3>Import data</h3>
<p>We import the dataset of cases from a simulated Ebola epidemic. If you want to follow along, <a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds' class='download-button'>click to download the “clean” linelist</a> (as .rds file). Import data with the <code>import()</code> function from the <strong>rio</strong> package (it handles many file types like .xlsx, .csv, .rds - see the <a href="import-and-export.html#import-and-export">Import and export</a> page for details).</p>
<p>The first 50 rows of the linelist are displayed below.</p>
<!-- ======================================================= -->
</div>
</div>
<div id="calculate-with-slider" class="section level2" number="22.2">
<h2><span class="header-section-number">22.2</span> Calculate with <strong>slider</strong></h2>
<p><strong>Use this approach to calculate a moving average in a data frame prior to plotting.</strong></p>
<p>The <strong>slider</strong> package provides several “sliding window” functions to compute rolling averages, cumulative sums, rolling regressions, etc. It treats a data frame as a vector of rows, allowing iteration row-wise over a data frame.</p>
<p>Here are some of the common functions:</p>
<ul>
<li><code>slide_dbl()</code> - iterates through a <em>numeric</em> (hence "_dbl") column performing an operation using a sliding window
<ul>
<li><code>slide_sum()</code> - rolling sum shortcut function for <code>slide_dbl()</code><br />
</li>
<li><code>slide_mean()</code> - rolling average shortcut function for <code>slide_dbl()</code></li>
</ul></li>
<li><code>slide_index_dbl()</code> - applies the rolling window on a numeric column using a separate column to <em>index</em> the window progression (useful if rolling by date with some dates absent)
<ul>
<li><code>slide_index_sum()</code> - rolling sum shortcut function with indexing<br />
</li>
<li><code>slide_index_mean()</code> - rolling mean shortcut function with indexing</li>
</ul></li>
</ul>
<p>The <strong>slider</strong> package has many other functions that are covered in the Resources section of this page. We briefly touch upon the most common.</p>
<p><strong>Core arguments</strong></p>
<ul>
<li><code>.x</code>, the first argument by default, is the vector to iterate over and to apply the function to<br />
</li>
<li><code>.i =</code> for the “index” versions of the <strong>slider</strong> functions - provide a column to “index” the roll on (see section <a href="moving-averages.html#roll_index">below</a>)<br />
</li>
<li><code>.f =</code>, the second argument by default, either:
<ul>
<li>A function, written without parentheses, like <code>mean</code>, or<br />
</li>
<li>A formula, which will be converted into a function. For example <code>~ .x - mean(.x)</code> will return the result of the current value minus the mean of the window’s value</li>
</ul></li>
<li>For more details see this <a href="https://davisvaughan.github.io/slider/reference/slide.html">reference material</a></li>
</ul>
<p><strong>Window size</strong></p>
<p>Specify the size of the window by using either <code>.before</code>, <code>.after</code>, or both arguments:</p>
<ul>
<li><code>.before =</code> - Provide an integer<br />
</li>
<li><code>.after =</code> - Provide an integer<br />
</li>
<li><code>.complete =</code> - Set this to <code>TRUE</code> if you only want calculation performed on complete windows</li>
</ul>
<p>For example, to achieve a 7-day window including the current value and the six previous, use <code>.before = 6</code>. To achieve a “centered” window provide the same number to both <code>.before =</code> and <code>.after =</code>.</p>
<p>By default, <code>.complete =</code> will be FALSE so if the full window of rows does not exist, the functions will use available rows to perform the calculation. Setting to TRUE restricts so calculations are only performed on complete windows.</p>
<p><strong>Expanding window</strong></p>
<p>To achieve <em>cumulative</em> operations, set the <code>.before =</code> argument to <code>Inf</code>. This will conduct the operation on the current value and all coming before.</p>
<div id="roll_index" class="section level3 unnumbered">
<h3>Rolling by date</h3>
<p>The most likely use-case of a rolling calculation in applied epidemiology is to examine a metric <em>over time</em>. For example, a rolling measurement of case incidence, based on daily case counts.</p>
<p>If you have clean time series data with values for every date, you may be OK to use <code>slide_dbl()</code>, as demonstrated here in the <a href="time-series-and-outbreak-detection.html#timeseries_moving">Time series and outbreak detection</a> page.</p>
<p>However, in many applied epidemiology circumstances you may have dates absent from your data, where there are no events recorded. In these cases, it is best to use the “index” versions of the <strong>slider</strong> functions.</p>
</div>
<div id="indexed-data" class="section level3 unnumbered">
<h3>Indexed data</h3>
<p>Below, we show an example using <code>slide_index_dbl()</code> on the case linelist. Let us say that our objective is to calculate a rolling 7-day incidence - the sum of cases using a rolling 7-day window. If you are looking for an example of rolling average, see the section below on <a href="moving-averages.html#roll_slider_group">grouped rolling</a>.</p>
<p>To begin, the dataset <code>daily_counts</code> is created to reflect the daily case counts from the <code>linelist</code>, as calculated with <code>count()</code> from <strong>dplyr</strong>.</p>
<p>Here is the <code>daily_counts</code> data frame - there are <code>nrow(daily_counts)</code> rows, each day is represented by one row, but especially early in the epidemic <em>some days are not present (there were no cases admitted on those days)</em>.</p>
<p>It is crucial to recognize that a standard rolling function (like <code>slide_dbl()</code> would use a window of 7 <em>rows</em>, not 7 <em>days</em>. So, if there are any absent dates, some windows will actually extend more than 7 calendar days!</p>
<p>A “smart” rolling window can be achieved with <code>slide_index_dbl()</code>. The “index” means that the function uses a <em>separate column</em> as an “index” for the rolling window. The window is not simply based on the rows of the data frame.</p>
<p>If the index column is a date, you have the added ability to specify the window extent to <code>.before =</code> and/or <code>.after =</code> in units of <strong>lubridate</strong> <code>days()</code> or <code>months()</code>. If you do these things, the function will include absent days in the windows as if they were there (as <code>NA</code> values).</p>
<p>Let’s show a comparison. Below, we calculate rolling 7-day case incidence with regular and indexed windows.</p>
<p>Observe how in the regular column for the first 7 rows the count steadily increases <em>despite the rows not being within 7 days of each other</em>! The adjacent “indexed” column accounts for these absent calendar days, so its 7-day sums are much lower, at least in this period of the epidemic when the cases a farther between.</p>
<p>Now you can plot these data using <code>ggplot()</code>:</p>
<!-- ### Rolling by month {.unnumbered}   -->
<!-- If you want to calculate statistics by month (e.g. sum, mean, max) you can do this with **dplyr** as described in the [Grouping data] page. Simply create a "month" column, group the data, and run your calculations with `summarise()`.   -->
<!-- If however, you want to calculate rolling statistics over several months (e.g a 2-month rolling window), you can use the `slide_period()` function from **slider**.   -->
<!-- ```{r} -->
<!-- monthly_mean = function(data){ -->
<!--   summarise(data, mean = mean(new_cases, na.rm=T)) -->
<!-- } -->
<!-- linelist %>%  -->
<!--   count(date_hospitalisation, name = "new_cases") %>%  -->
<!--   mutate( -->
<!--     slide_period_dfr( -->
<!--       new_cases,  -->
<!--       .i = date_hospitalisation, -->
<!--       .period = "month", -->
<!--       .f = monthly_mean))  #~mean(.x, na.rm=T))) -->
<!--       #values_col = new_cases, -->
<!--       #index_col = date_hospitalisation -->
<!--     )) -->
<!-- ``` -->
</div>
<div id="roll_slider_group" class="section level3 unnumbered">
<h3>Rolling by group</h3>
<p>If you group your data prior to using a <strong>slider</strong> function, the sliding windows will be applied by group. Be careful to arrange your rows in the desired order <em>by group</em>.</p>
<p>Each time a new group begins, the sliding window will re-start. Therefore, one nuance to be aware of is that if your data are grouped <em>and</em> you have set <code>.complete = TRUE</code>, you will have empty values at each transition between groups. As the function moved downward through the rows, every transition in the grouping column will re-start the accrual of the minimum window size to allow a calculation.</p>
<p>See handbook page on <a href="grouping-data.html#grouping-data">Grouping data</a> for details on grouping data.</p>
<p>Below, we count linelist cases by date <em>and</em> by hospital. Then we arrange the rows in ascending order, first ordering by hospital and then within that by date. Next we set <code>group_by()</code>. Then we can create our new rolling average.</p>
<p>Here is the new dataset:</p>
<p>We can now plot the moving averages, displaying the data by group by specifying <code>~ hospital</code> to <code>facet_wrap()</code> in <code>ggplot()</code>. For fun, we plot two geometries - a <code>geom_col()</code> showing the daily case counts and a <code>geom_line()</code> showing the 7-day moving average.</p>
<p><span style="color: red;"><strong><em>DANGER:</em></strong> If you get an error saying <em>“slide() was deprecated in tsibble 0.9.0 and is now defunct. Please use slider::slide() instead.”</em>, it means that the <code>slide()</code> function from the <strong>tsibble</strong> package is masking the <code>slide()</code> function from <strong>slider</strong> package. Fix this by specifying the package in the command, such as <code>slider::slide_dbl()</code>.</span></p>
<!-- You can group the data prior to using a **slider** function. For example, if you want to calculate the same 7-day rolling sum as above, but by hospital. above rolling mean delay from symptom onset to hospital admission (column `days_onset_hosp`).   -->
<!-- You can group the data by the month of symptom onset using **lubridate**'s `floor_date()` as described in the [Grouping data] page. Then, use `slide_index_dbl()` as before but set your window extent using `months()` (also from **lubridate**).  -->
<!-- f you want a rolling average by *months*, you can use **lubridate** to group the data by month, and then apply `slide_index_dbl()` as below shown for a three-month rolling average:   -->
<!-- ```{r} -->
<!-- months_delay <- linelist %>% -->
<!--   arrange(date_onset) %>%    # drop rows missing date of onset -->
<!--   group_by(hospital) %>%  -->
<!--   #group_by(month_onset = floor_date(date_onset, "month")) %>% # create and group by month of onset  -->
<!--   mutate( -->
<!--     delay_7d = slide_index_dbl( -->
<!--       days_onset_hosp,                  # calculate avg based on value in new_cases column -->
<!--       .i = date_onset,                 # index column is date_onset, so non-present dates are included in 7day window  -->
<!--       .f = ~mean(.x, na.rm = TRUE),     # function is mean() with missing values removed -->
<!--       .before = days(7)), -->
<!--     delay_month = slide_index_dbl( -->
<!--       days_onset_hosp,                  # calculate avg based on value in new_cases column -->
<!--       .i = date_onset,                 # index column is date_onset, so non-present dates are included in 7day window  -->
<!--       .f = ~mean(.x, na.rm = TRUE),     # function is mean() with missing values removed -->
<!--       .before = months(1)))               # window is the month and the prior month -->
<!-- # window is the month and the prior month -->
<!-- ``` -->
<!-- ```{r} -->
<!-- ggplot(data = months_delay, mapping = aes(x = month_onset))+ -->
<!--   geom_line(mapping = aes(y = )) -->
<!-- ``` -->
<!-- ======================================================= -->
</div>
</div>
<div id="calculate-with-tidyquant-within-ggplot" class="section level2" number="22.3">
<h2><span class="header-section-number">22.3</span> Calculate with <strong>tidyquant</strong> within <code>ggplot()</code></h2>
<p>The package <strong>tidyquant</strong> offers another approach to calculating moving averages - this time from <em>within</em> a <code>ggplot()</code> command itself.</p>
<p>Below the <code>linelist</code> data are counted by date of onset, and this is plotted as a faded line (<code>alpha</code> &lt; 1). Overlaid on top is a line created with <code>geom_ma()</code> from the package <strong>tidyquant</strong>, with a set window of 7 days (<code>n = 7</code>) with specified color and thickness.</p>
<p>By default <code>geom_ma()</code> uses a simple moving average (<code>ma_fun = "SMA"</code>), but other types can be specified, such as:</p>
<ul>
<li>“EMA” - exponential moving average (more weight to recent observations)<br />
</li>
<li>“WMA” - weighted moving average (<code>wts</code> are used to weight observations in the moving average)<br />
</li>
<li>Others can be found in the function documentation</li>
</ul>
<p>See this <a href="https://cran.r-project.org/web/packages/tidyquant/vignettes/TQ04-charting-with-tidyquant.html">vignette</a> for more details on the options available within <strong>tidyquant</strong>.</p>
<!-- ## Rolling regression  -->
<!-- ```{r} -->
<!-- a <- linelist %>% -->
<!--   separate(time_admission, into = c("hour", "minute"), sep = ":") %>%  -->
<!--   count(days_onset_hosp, hour) %>%  -->
<!--   mutate(reg_admit_hour = slide(., ~lm(days_onset_hosp ~ hour), .before = 3, .complete = T)) %>%  -->
<!--   mutate(coeff = reg_admit_hour[[1]]) -->
<!-- ggplot()+ -->
<!--   geom_point(aes(x = hour, y = days_onset_hosp)) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- linelist %>%  -->
<!--   mutate( -->
<!--   ) -->
<!-- ``` -->
<!-- ======================================================= -->
</div>
<div id="resources-15" class="section level2" number="22.4">
<h2><span class="header-section-number">22.4</span> Resources</h2>
<p>See the helpful online <a href="https://cran.r-project.org/web/packages/slider/vignettes/slider.html">vignette for the <strong>slider</strong> package</a></p>
<p>The <strong>slider</strong> <a href="https://github.com/DavisVaughan/slider">github page</a></p>
<p>A <strong>slider</strong> <a href="https://davisvaughan.github.io/slider/articles/slider.html">vignette</a></p>
<p><a href="https://cran.r-project.org/web/packages/tidyquant/vignettes/TQ04-charting-with-tidyquant.html">tidyquant vignette</a></p>
<p>If your use case requires that you “skip over” weekends and even holidays, you might like <strong>almanac</strong> package.</p>

</div>
</div>
  </main>

  <div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page">
      <h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          <li><a id="book-source" href="#">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="#">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
      </div>
    </nav>
  </div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5">
  <div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>The Epidemiologist R Handbook</strong>" was written by the handbook team. It was last built on 2021-05-30.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
