---
output: html_document
editor_options: 
  chunk_output_type: console
---
# ルーチンで作成するレポートを整理する {  }  { #reportfactory }

このページは、**reportfactory** パッケージについて解説いたします。このパッケージは *R Markdown でレポートを作成する場合に補助的に利用する*ものとなります。

日次、週次などで、日常的にレポートを作成するような場合、パッケージを利用することで複数の R Markdown ファイルの出力と結果の整理を簡単にします。手短にまとめると、パッケージは 自動的に日付と時間が記録された出力用フォルダを作成したうえで、「手軽に」バージョン管理を行うことができる、R Markdown レポートを実行するための「工場」を用意してくれます。

**reportfactory**は RECON （ R Epidemics Consortium ） が開発したパッケージの一つです。RECON のウェブサイトと Github は ここ（[ウェブサイト](https://www.repidemicsconsortium.org/)）とここ（[Github](https://github.com/reconverse)）にあります。  


## 準備

### パッケージの読み込み {.unnumbered}  

RStudio の中で、Github から最新版の**reportfactory**パッケージをインストールしましょう。

You can do this via the **pacman** package with `p_load_current_gh()` which will force intall of the latest version from Github. 
インストールは、**pacman** パッケージの `p_load_curreng_gh()` を利用することで行えます。この関数を利用すると Github からパッケージの最新バージョンを強制的にインストールしてくれます。 関数に、"reconverse/reportfactory" という文字を引数として与えましょう。 reconverse は Github 上の organization を表し、 reportfactory が repository を表します。 別のインストール方法としては、 **remotes**  パッケージの `install_github()` を利用することも可能です。

```{r, eval=FALSE}
# Github からパッケージの最新版をインストールして読み込む
pacman::p_load_current_gh("reconverse/reportfactory")
#remotes::install_github("reconverse/reportfactory") # 別の方法はこちら
```

## 新しい「工場」

To create a new factory, run the function `new_factory()`. This will create a new self-contained R project folder. By default:  
`new_factory()`を実行して、新しい工場を作りましょう。実行すると、必要なものが含まれた新しい R プロジェクトフォルダが作成されます。初期設定では次のような動作となります：

* 現在のワーキングディレクトリに工場が追加されます
* 新しい「工場 R プロジェクト」は "new_factory.Rproj"となります
* RStudio のセッションは、この「工場 R プロジェクト」に「移動」します。


```{r, eval=F}
# This will create the factory in the working directory
# これを実行すると現在のワーキングディレクトリに新しい「工場」が作成されます
new_factory()
```

Looking inside the factory, you can see that sub-folders and some files were created automatically.  
新しい「工場」の中には、自動的にサブフォルダやファイルが作成されているはずです。

```{r, warning=F, message=F, echo=F}
# nn:このチャンクは画像表示用。
# 新しく作成された「工場」の初期ファイルやサブフォルダの画像。
knitr::include_graphics(here::here("images", "factory_new2.png"))
```

* *report_sources* フォルダは、レポートを生成する R Markdown スクリプトを保存する場所です。
* *outputs* フォルダは、生成されたレポートが保存される場所です。（例：HTML、Word、PDF などのファイル）
* The *scripts* folder can be used to store other R scripts (e.g. that are sourced by your Rmd scripts)
* *scripts* フォルダは、他の R スクリプトを保存する場所として利用できます。（例：Rmd ファイルから呼び出されるスクリプトなど）  
* *data* フォルダは、データを保存する場所として利用できます。（サブフォルダとして "raw" と "clean" フォルダが含まれています）
* A *.here* file, so you can use the **here** package to call files in sub-folders by their relation to this root folder (see [R projects] page for details)  
* *.here* ファイル：**here**パッケージを使用して、サブフォルダー内のファイルを、このルートフォルダーからの相対的なパスで呼び出すことができます（詳細は[R projects]ページを参照してください）。
* *gitignore* ファイル：「工場 R プロジェクト」をGithub レポジトリと関連付けた場合に備えて作成されています。（詳細は、[Version control and collaboration with Github] べージを参照してください）。
* *README* ファイル（空）：Githubレポジトリを利用した場合に備えて作成されています。

<span style="color: orange;">**_注意:_** ".here" ファイルなどのいくつかのファイルは存在していたとしても、コンピューターの設定によっては見えない場合があります。</span>  

Of the default settings, below are several that you might want to adjust within the `new_factory()` command:  
初期設定のうち、`new_factory()`関数の実行の際に動作を調整したいと思う可能性があるものをいくつか紹介します。

* `factory = ` - 新しく生成される「工場」のフォルダ名を変更できます (初期設定は "new_factory" です)
* `path = ` - 新しい「工場」フォルダが作成されるパスを指定できます（初期設定は現在の作業ディレクトリ）
* `report_sources = ` R Markdown スクリプトを保存するサブフォルダの名前を指定できます（初期設定は "report_sources"）
* `outputs = ` 生成されたレポートが保存されるフォルダの名前を指定できます（初期設定は "outputs"）

設定可能な全ての引数のリストは `?new_factory` でヘルプファイルを参照してください。 

新しいファクトリーを作成すると、R のセッションは新しく作成された R プロジェクトに移されるので、再度 **reportfactory** パッケージを読み込む必要があります。  

```{r, eval=FALSE}
pacman::p_load(reportfactory)
```
 
これで準備が整いました。`factory_overview()`コマンドを実行すると、「工場の構造」（すべてのフォルダとファイル）を見ることができます。  

```{r, eval=F}
factory_overview()            # コンソールに「工場の構造」を表示する
```

次の図のように、「工場」に含まれるフォルダとファイルが R コンソールに表示されます。"data" フォルダの中に "raw" と "clean" サブフォルダと例示のための CSV データが含まれていることに注意してください。また、 "example_report.Rmd" ファイルが同じように "report_sources" フォルダに含まれています。

```{r, warning=F, message=F, echo=F}
# nn:画像の表示用。 factory_overview()の実行結果が表示されている。
knitr::include_graphics(here::here("images", "factory_overview.png"))
```

## レポートの作成

「工場 R プロジェクト」の中で、普段行うように R Markdown ファイルを作成して、"report_sources" フォルダに保存してみましょう。 R Markdown ファイルの作成方法は、[R Markdown][Reports with R Markdown]のページを参照してください。例示することを目的に、ここでは次のように「工場」を変更しています。

* A new R markdown script entitled "daily_sitrep.Rmd", saved within the "report_sources" folder  
* Data for the report ("linelist_cleaned.rds"), saved to the "clean" sub-folder within the "data" folder  

We can see using `factory_overview()` our R Markdown in the "report_sources" folder and the data file in the "clean" data folder (highlighted):

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_overview2.png"))
```

Below is a screenshot of the beginning of the R Markdown "daily_sitrep.Rmd". You can see that the output format is set to be HTML, via the YAML header `output: html_document`. 

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_new_rmd.png"))
```

In this simple script, there are commands to:  

* Load necessary packages  
* Import the linelist data using a filepath from the **here** package (read more in the page on [Import and export])  

```{r, eval=F}
linelist <- import(here("data", "clean", "linelist_cleaned.rds"))
```

* Print a summary table of cases, and export it with `export()` as a .csv file  
* Print an epicurve, and export it with `ggsave()` as a .png file  


You can review just the list of R Markdown reports in the "report_sources" folder with this command:  

```{r, eval=F}
list_reports()
```



## Compile  

In a report factory, to "compile" a R Markdown report means that the .Rmd script will be run and the output will be produced (as specified in the script YAML e.g. as HTML, Word, PDF, etc).  

*The factory will automatically create a date- and time-stamped folder for the outputs in the "outputs" folder.*  

The report itself and any exported files produced by the script (e.g. csv, png, xlsx) will be saved into this folder. In addition, the Rmd script itself will be saved in this folder, so you have a record of that version of the script.  

This contrasts with the normal behavior of a "knitted" R Markdown, which saves outputs to the location of the Rmd script. This default behavior can result in crowded, messy folders. The factory aims to improve organization when one needs to run reports frequently.  

### Compile by name {.unnumbered}  

You can compile a specific report by running `compile_reports()` and providing the Rmd script name (without .Rmd extension) to `reports = `. For simplicity, you can skip the `reports = ` and just write the R Markdown name in quotes, as below.  

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_compile1.png"))
```


This command would compile only the "daily_sitrep.Rmd" report, saving the HTML report, and the .csv table and .png epicurve exports into a date- and time-stamped sub-folder specific to the report, within the "outputs" folder.  

Note that if you choose to provide the .Rmd extension, you must correctly type the extension as it is saved in the file name (.rmd vs. .Rmd).  

Also note that when you compile, you may see several files temporarily appear in the "report_sources" folder - but they will soon disappear as they are transferred to the correct "outputs" folder. 

### Compile by number {.unnumbered}

You can also specify the Rmd script to compile by providing a number or vector of numbers to `reports = `. The numbers must align with the order the reports appear when you run `list_reports()`.  

```{r, eval=F}
# Compile the second and fourth Rmds in the "report_sources" folder
compile_reports(reports = c(2, 4))
```



### Compile all {.unnumbered}

You can compile *all* the R Markdown reports in the "report_sources" folder by setting the `reports = ` argument to TRUE.  

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_compile_all.png"))
```


### Compile from sub-folder {.unnumbered}  

You can add sub-folders to the "report_sources" folder. To run an R Markdown report from a subfolder, simply provide the name of the folder to `subfolder = `. Below is an example of code to compile a Rmd report that lives in a sub_folder of "report_sources".  

```{r, eval=F}
compile_reports(
     reports = "summary_for_partners.Rmd",
     subfolder = "for_partners")
```

You can compile all Rmd reports within a subfolder by providing the subfolder name to `reports = `, with a slash on the end, as below.  

```{r, eval=F}
compile_reports(reports = "for_partners/")
```


### Parameterization {.unnumbered}

As noted in the page on [Reports with R Markdown], you can run reports with specified parameters. You can pass these parameters as a list to `compile_reports()` via the `params = ` argument. For example, in this fictional report there are three parameters provided to the R Markdown reports.  

```{r, eval=F}
compile_reports(
  reports = "daily_sitrep.Rmd",
  params = list(most_recent_data = TRUE,
                region = "NORTHERN",
                rates_denominator = 10000),
  subfolder = "regional"
)
```


### Using a "run-file" {.unnumbered}  

If you have multiple reports to run, consider creating a R script that contains all the `compile_reports()` commands. A user can simply run all the commands in this R script and all the reports will compile. You can save this "run-file" to the "scripts" folder.  



## Outputs  

After we have compiled the reports a few times, the "outputs" folder might look like this (highlights added for clarity):  


```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_overview_all.png"))
```


* Within "outputs", sub-folders have been created for each Rmd report  
* Within those, further sub-folders have been created for each unique compiling  
  * These are date- and time-stamped ("2021-04-23_T11-07-36" means 23rd April 2021 at 11:07:36)  
  * You can edit the date/time-stamp format. See `?compile_reports`
* Within each date/time compiled folder, the report output is stored (e.g. HTML, PDF, Word) along with the Rmd script (version control!) and any other exported files (e.g. table.csv, epidemic_curve.png)  

Here is a view inside one of the date/time-stamped folders, for the "daily_sitrep" report. The file path is highlighted in yellow for emphasis.  

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_compile_folder.png"))
```


Finally, below is a screenshot of the HTML report output.  


```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_html.png"))
```

You can use `list_outputs()` to review a list of the outputs.  




## Miscellaneous  

### Knit {.unnumbered} 

You can still "knit" one of your R Markdown reports by pressing the "Knit" button, if you want. If you do this, as by default, the outputs will appear in the folder where the Rmd is saved - the "report_sources" folder. In prior versions of **reportfactory**, having any non-Rmd files in "report_sources" would prevent compiling, but this is no longer the case. You can run `compile_reports()` and no error will occur.  

### Scripts {.unnumbered}  

We encourage you to utilize the "scripts" folder to store "runfiles" or .R scripts that are sourced by your .Rmd scripts. See the page on [R Markdown][Reports with R Markdown] for tips on how to structure your code across several files.  


### Extras {.unnumbered} 

* With **reportfactory**, you can use the function `list_deps()` to list all packages required across all the reports in the entire factory.  

* There is an accompanying package in development called **rfextras** that offers more helper functions to assist you in building reports, such as:  
  * `load_scripts()` - sources/loads all .R scripts in a given folder (the "scripts" folder by default)  
  * `find_latest()` - finds the latest version of a file (e.g. the latest dataset)




<!-- ======================================================= -->
## Resources {  }

See the **reportfactory** package's [Github page](https://github.com/reconverse/reportfactory)

See the **rfextras** package's [Github page](https://github.com/reconhub/rfextras)  

