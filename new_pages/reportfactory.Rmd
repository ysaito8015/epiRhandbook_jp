# ルーチンで作成するレポートの整理 { #reportfactory }

このページは、**reportfactory** パッケージについて解説いたします。このパッケージは <u>R Markdown でレポートを作成する場合に補助的に利用する</u>ものとなります。

日次、週次などで、日常的にレポートを作成するような場合、パッケージを利用することで複数の R Markdown ファイルの出力と結果の整理を簡単にします。手短にまとめると、パッケージは 自動的に日付と時間が記録された出力用フォルダを作成したうえで、「手軽に」バージョン管理を行うことができる、R Markdown レポートを実行するためのファクトリーを用意してくれます。

**reportfactory**は RECON （ R Epidemics Consortium ） が開発したパッケージの一つです。RECON のウェブサイトと Github は ここ（[ウェブサイト](https://www.repidemicsconsortium.org/)）とここ（[Github](https://github.com/reconverse)）にあります。  


## 準備

### パッケージの読み込み {.unnumbered}  

RStudio の中で、Github から最新版の**reportfactory**パッケージをインストールしましょう。

インストールは、**pacman** パッケージの `p_load_curreng_gh()` を利用することで行えます。この関数を利用すると Github からパッケージの最新バージョンを強制的にインストールしてくれます。 関数に、"reconverse/reportfactory" という文字を引数として与えましょう。 reconverse は Github 上の organization を表し、 reportfactory が repository を表します。 別のインストール方法としては、 **remotes**  パッケージの `install_github()` を利用することも可能です。

```{r, eval=FALSE}
# Github からパッケージの最新版をインストールして読み込む
pacman::p_load_current_gh("reconverse/reportfactory")
#remotes::install_github("reconverse/reportfactory") # 別の方法はこちら
```

## 新しいファクトリー

`new_factory()`を実行して、新しいファクトリーを作りましょう。実行すると、必要なものが含まれた新しい R プロジェクトフォルダが作成されます。初期設定では次のような動作となります：

* 現在のワーキングディレクトリに                                                                                  が追加されます
* 新しい「ファクトリー R プロジェクト」は "new_factory.Rproj"となります
* RStudio のセッションは、この「ファクトリー R プロジェクト」に「移動」します。


```{r, eval=F}
# これを実行すると現在のワーキングディレクトリに新しいファクトリーが作成されます
new_factory()
```

新しいファクトリーの中には、自動的にサブフォルダやファイルが作成されているはずです。

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_new2.png"))
```

* <u>report_sources</u> フォルダは、レポートを生成する R Markdown スクリプトを保存する場所です。
* <u>outputs</u> フォルダは、生成されたレポートが保存される場所です。（例：HTML、Word、PDF などのファイル）
* <u>scripts</u> フォルダは、他の R スクリプトを保存する場所として利用できます。（例：Rmd ファイルから呼び出されるスクリプトなど）  
* <u>data</u> フォルダは、データを保存する場所として利用できます。（サブフォルダとして "raw" と "clean" フォルダが含まれています）
* <u>.here</u> ファイル：**here**パッケージを使用して、サブフォルダー内のファイルを、このルートフォルダーからの相対的なパスで呼び出すことができます（詳細は[R projects]ページを参照してください）。
* <u>gitignore</u> ファイル：ファクトリー R プロジェクトをGithub レポジトリと関連付けた場合に備えて作成されています。（詳細は、[Version control and collaboration with Github] べージを参照してください）。
* <u>README</u> ファイル（空）：Githubレポジトリを利用した場合に備えて作成されています。

<span style="color: orange;">**_注意:_** ".here" ファイルなどのいくつかのファイルは存在していたとしても、コンピューターの設定によっては見えない場合があります。</span>  

初期設定のうち、`new_factory()`関数の実行の際に動作を調整したいと思う可能性があるものをいくつか紹介します。

* `factory = ` - 新しく生成されるファクトリーのフォルダ名を変更できます (初期設定は "new_factory" です)
* `path = ` - 新しいファクトリーフォルダが作成されるパスを指定できます（初期設定は現在の作業ディレクトリ）
* `report_sources = ` R Markdown スクリプトを保存するサブフォルダの名前を指定できます（初期設定は "report_sources"）
* `outputs = ` 生成されたレポートが保存されるフォルダの名前を指定できます（初期設定は "outputs"）

設定可能な全ての引数のリストは `?new_factory` でヘルプファイルを参照してください。 

新しいファクトリーを作成すると、R のセッションは新しく作成された R プロジェクトに移されるので、再度 **reportfactory** パッケージを読み込む必要があります。  

```{r, eval=FALSE}
pacman::p_load(reportfactory)
```
 
これで準備が整いました。`factory_overview()`コマンドを実行すると、ファクトリーの構造（すべてのフォルダとファイル）を見ることができます。  

```{r, eval=F}
factory_overview()            # コンソールにファクトリーの構造を表示する
```

次の図のように、ファクトリーに含まれるフォルダとファイルが R コンソールに表示されます。"data" フォルダの中に "raw" と "clean" サブフォルダと例示のための CSV データが含まれていることに注意してください。また、 "example_report.Rmd" ファイルが同じように "report_sources" フォルダに含まれています。

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_overview.png"))
```

## レポートの作成

ファクトリー R プロジェクトの中で、普段行うように R Markdown ファイルを作成して、"report_sources" フォルダに保存してみましょう。 R Markdown ファイルの作成方法は、[R Markdown][Reports with R Markdown]のページを参照してください。例示することを目的に、ここでは次のようにファクトリーを変更しています。

* "daily_sitrep.Rmd" というタイトル[^sitrep]の新しいR Markdown スクリプトを "report_sources" フォルダ内に保存してあります。
* レポート用のデータ（"linelist_cleaned.rds"）は、"data" フォルダ内の "clean" サブフォルダに保存してあります。

[^sitrep]: 翻訳者注：ここで、sitrepとは、状況報告などの意味を表す英単語。"situation report"の略。

`factory_overview()`を使うと、R Markdown スクリプトが "report_sources" フォルダに、レポート用のデータファイルが "clean" サブフォルダに格納されているのがわかります（次の画像でのハイライト部分）。

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_overview2.png"))
```

次の画像は、R Markdown ファイル、"daily_sitrep.Rmd" の冒頭部分のスクリーンショットです。YAMLヘッダの `output: html_document` から、出力形式がHTMLに設定されていることが確認できます。

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_new_rmd.png"))
```
 
この単純なスクリプトの中には次のようなコマンドが記述されています：

* 必要なパッケージを読み込むためのコード
* **here** パッケージによるファイルパスを使用して、 "linelinst_cleaned.rds" データをインポートするためのコード（詳しくは[Import and export]のページを参照）

```{r, eval=F}
linelist <- import(here("data", "clean", "linelist_cleaned.rds"))
```

* 事例の要約表を表示し、`export()` で表を .csv ファイルとしてエクスポートするためのコード
* エピカーブを印刷し、`ggsave()`で.pngファイルとしてエクスポートするためのコード

次のコマンドで「report_sources」フォルダ内の R Markdown レポートのリストを確認することができます：

```{r, eval=F}
list_reports()
```

## コンパイル 

レポートファクトリーでは、R Markdown レポートを「コンパイル」するとは、 .Rmd スクリプトが実行され、出力結果が作成されるという意味となります。（出力結果は、YAML に記載されている通りとなり、例として HTML、Word、PDF などのファイル形式となります）

*ファクトリーでは、自動的に "outputs" フォルダ内に、日付とタイムスタンプ付きの出力用フォルダが作成されます。

レポート本体と、スクリプトからエクスポートされたファイル（ csv、png、xlsx など）は、このフォルダに保存されます。さらに、Rmd スクリプトそのものもこのフォルダに保存されます。そのため、スクリプトのバージョンの記録をとることが可能です。

これは、R Markdown の通常の Knit して作成される出力結果とは対照的です。Knit した場合は Rmd スクリプトの場所に出力が保存されます。この動作は結果的に、フォルダが乱雑で汚い状態になる可能性があります。ファクトリーは、頻繁にレポートを出力する必要がある場合の整理整頓が目的です。  

### 名前でのコンパイル {.unnumbered}   

特定のレポートをコンパイルするには、`compile_reports()`を実行し、`reports = `に Rmd スクリプト名（.Rmd 拡張子は含めない）を指定します。 簡単にするには、以下のように`reports = `を省略して、R Markdown の名前をクオート（`"`や`'`）で囲んで書くこともできます。 

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_compile1.png"))
```

このコマンドは、"daily_sitrep.Rmd" レポートのみをコンパイルします。HTMLレポート、.csvの表、.png の epicurve 画像の出力結果を、"outputs" フォルダ内のレポート専用のサブフォルダに、日付とタイムスタンプ付きで保存します。  

なお、.Rmd の拡張子を付けた場合は、ファイルの拡張子を正確に入力する必要があります（ .rmd と .Rmd ）。  

さらに、コンパイル時に "report_sources" フォルダにいくつかのファイルが一時的に表示されることがありますが、これらは正しい "outputs" フォルダに転送されるため、すぐに消えるということに注意してください。

### 数字でのコンパイル {.unnumbered} 

`reports = ` に数字または数字ベクトルを指定することで、コンパイルする Rmd スクリプトを指定することができます。これらの数字は `list_reports()` を実行した際に表示されるレポートの順番と一致している必要があります。  

```{r, eval=F}
# "report_sources" フォルダ内の二番目と四番目の Rmd ファイルをコンパイルする
compile_reports(reports = c(2, 4))
```

### すべてをコンパイルする {.unnumbered}

"report_sources" フォルダ内の R Markdown レポート<u>すべて</u>をコンパイルするには、`reports = ` 引数をTRUEに設定します。

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_compile_all.png"))
```

### サブフォルダからコンパイルする {.unnumbered}

"report_sources" フォルダにサブフォルダを追加することができます。サブフォルダから R Markdown レポートを実行するには、`subfolder = `にフォルダの名前を指定するだけです。下記は "report_sources "のサブフォルダに存在するRmdレポートをコンパイルするコードの例です。  

```{r, eval=F}
compile_reports(
     reports = "summary_for_partners.Rmd",
     subfolder = "for_partners")
```

以下のようにサブフォルダ名を `reports = ` に指定し、最後にスラッシュ（ / ）を付けることで、サブフォルダ内の全ての Rmd レポートをコンパイルすることができます。  

```{r, eval=F}
compile_reports(reports = "for_partners/")
```

### パラメター化 {.unnumbered}

[Reports with R Markdown] のページで述べたように、パラメータを指定してレポートを作成することができます。 これらのパラメータは、引数 `params = ` にリストを与えることで `compile_reports()` に渡すことができます。 例えば、この架空のレポートでは、R Markdown レポートに3つのパラメータが用意されています。  

```{r, eval=F}
compile_reports(
  reports = "daily_sitrep.Rmd",
  params = list(most_recent_data = TRUE,
                region = "NORTHERN",
                rates_denominator = 10000),
  subfolder = "regional"
)
```


### "run-file" を利用する {.unnumbered}

作成するレポートが複数ある場合は、すべてのレポートに対する`compile_reports()`コマンドを含んだ R スクリプトを作成することを検討してください。ユーザーは、この R スクリプト内のすべてのコマンドを実行するだけで、すべてのレポートがコンパイルされます。この "run-file" を "scripts" フォルダに保存することができます。 

## 出力結果

何度かレポートをコンパイルした後、"outputs" フォルダは次のようになります（わかりやすくするためにハイライトを追加しています）：

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_overview_all.png"))
```

* "outputs" フォルダの中には、それぞれの Rmd レポート用のサブフォルダーが作成されています。 
* そのサブフォルダの中には、コンパイルされる度にサブフォルダが作られています。 
  * これらのフォルダには、日付と時間が記録されています ("2021-04-23_T11-07-36" は 2021 年 4 月 23 日 11 時 7 分 36 秒を表します)  
  * 日付と時間のフォーマットを編集することが可能です。詳しくは `?compile_reports` を確認してください。
* 各日時をコンパイルしたフォルダ内には、レポートの出力結果（ HTML 、PDF、Word など）と Rmd スクリプト（バージョン管理されています！）、その他のエクスポートされたファイル（ table.csv、epidemic_curve.png など）が格納されます。  
 
次の画像は、 "daily_sitrep" レポートの日付と時刻のタイムスタンプが付いたフォルダの中身です。ファイルパスは強調のために、黄色で表示されています。

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_compile_folder.png"))
```

最後に、次のスクリーンショットが、HTML で出力されたレポートです。

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_html.png"))
```

出力の一覧を確認するには、`list_outputs()`を使用してください。

## その他

### Knit {.unnumbered} 

必要であれば、"Knit" ボタンを押して、R Markdown レポートの1つを "Knit"することもできます。 "knit" した場合、デフォルトでは Rmd が保存されている、 "report_sources" フォルダに出力が表示されます。 以前のバージョンの **reportfactory** では、"report_sources" に Rmd 以外のファイルがあるとコンパイルができませんでしたが、現在はそのようなことはありません。 `compile_reports()`を実行してもエラーにはなりません。  

### スクリプト {.unnumbered}  

"scripts" フォルダには "runfiles" や .Rmd スクリプトのソースとなる .R スクリプトを格納することをお勧めします。複数のファイルにまたがるコードをどのように構成するかのヒントは、[R Markdown][Reports with R Markdown]のページをご覧ください。  

### エキストラ {.unnumbered} 

* **reportfactory** では、関数 `list_deps()` を使用して、ファクトリー全体のレポートに必要なすべてのパッケージをリストアップすることができます。  

* **rfextras** というパッケージが開発されており、次のような、レポート作成を支援するヘルパー関数が提供されています：
  * `load_scripts()` - 指定されたフォルダにある全ての .R スクリプトを実行/読み込みます（デフォルトではscriptsフォルダ）
  * `find_latest()` - ファイルの最新版を探す（例：最新のデータセットなど）

<!-- ======================================================= -->
## Resources {  }

**reportfactory** パッケージの [Githubページ](https://github.com/reconverse/reportfactory)

**rfextras**パッケージの [Github page](https://github.com/reconhub/rfextras)  

