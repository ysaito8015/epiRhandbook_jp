# Factors {}

<!-- ======================================================= -->
## Overview
 
Under construction - TBD  


In R, a column can be of class *factor*. In this case, the values are stored as *ordered integer levels*, with assigned display *labels*.  

In a column of class *factor*:  

* the possible values are limited - values not already defined as levels are rejected  
* values are ordered, which impacts how they display in tables and plots  

Most of this page will use functions from the package **forcats** (a short name for "For categorical variables"). 


Factors are particularly useful in statistical modeling, which allows integer values such as 1/0 to be evaluated categorically and not continuously.  




<!-- ======================================================= -->
## Preparation  

**Load packages**  

```{r}
pacman::p_load(forcats, tidyverse)
```





<!-- ======================================================= -->
## Defining levels  

Let's begin by creating a categorical column in the dataframe `linelist` - whether a patient was admitted in the morning, afternoon, evening, or night:  

```{r}
linelist <- linelist %>% 
  mutate(hour = hour(strptime(time_admission, format = "%H:%M"))) %>% 
  mutate(time_period = case_when(
    hour > 06 & hour < 12 ~ "Morning",
    hour >= 12 & hour < 17 ~ "Afternoon",
    hour >= 17 & hour < 21 ~ "Evening",
    hour >=21 | hour <= 6 ~ "Night"))
```

This is a categorical column, **not** classified as a factor. If we make a frequency table, we see that the values appear in alphabetical order 

```{r}
table(linelist$time_period, useNA = "always")
```

Likewise, if we make a bar plot the values also appear in alphabetical order:  

```{r}
ggplot(data = linelist, aes(x = time_period))+
  geom_bar()+
  coord_flip()  # flip axes for easier reading
```


To initially convert a column to class *factor*, use the **base** R function `factor()`. Below the dataframe `linelist` is modified such that the column `time_period` is converted to a factor.    

```{r}
linelist <- linelist %>%
  mutate(time_period = factor(time_period))
```

Unless specified, the levels will be in alphabetic (or numeric) order. See how the levels of `time_period` are ordered using the **base** R function `levels()`:  

```{r}
levels(linelist$time_period)
```

There are several ways to adjust the order of the levels:  

* Use `fct_relevel()` to manually define the order  
* Use `fct_infreq()` to reorder by frequency (highest to lowest)  
* Use `fct_inorder()` to reorder by order of appearance in the data  
* Use `fct_reorder()` to reorder by another column (e.g. order time_period levels by their row's median delay to admission)  
* Use `fct_rev()` to reverse the existing order  
* Use `fct_reorder2()` to reorder by the final values when plotted with two other columns  

Below are some examples:  


**`fct_infreq()`**  

To order by frequency that the value appears in the data, use `fct_infreq()`. Missing values (`NA`) will automatically be included at the top.  
You can reverse this by wrapping with `fct_rev()` like `fct_rev(fct_infreq(time_period))`.

```{r}
ggplot(data = linelist, aes(x = fct_infreq(time_period)))+
  geom_bar()+
  coord_flip()  # flip axes for easier reading
```




If we were to plot a bargraph of the number of patients per hospital, it might look like this:  

```{r}
ggplot(data = linelist, aes(x = hospital))+
  geom_bar()+
  coord_flip()
```

We likely want to provide some sensical ordering to these bars - perhaps order them from largest to smallest but with "Missing" at the bottom. We can do this with `fct_reorder()` like this:  

```{r}
ggplot(data = linelist, aes(x = age_cat))+
  geom_bar()+
  coord_flip()
```

 



```{r}
linelist %>% 
  group_by(hospital) %>% 
  summarize(median = median(days_onset_hosp, na.rm=T))

```


### Epiweeks {-}  

Epiweeks produced by **aweek** will appear as an ordered factor 

```{r}
a <- linelist %>% 
  mutate(epiweek = aweek::date2week(date_onset, ))


a <- linelist %>% 
  mutate(epiweek = factor(lubridate::isoweek(date_onset)))

levels(a$epiweek)
```

<!-- ======================================================= -->
## Resources {} 

R for Data Science page on [factors](https://r4ds.had.co.nz/factors.html).  
