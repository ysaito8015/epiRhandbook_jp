# 複数回答データの分析 {#combination-analysis}

```{r echo=F, out.width= "75%", warning=F, message=F}
pacman::p_load(tidyverse,
               UpSetR,
               ggupset)

# 症状に関する無作為の変数を追加する（症状あり"yes"または症状なし"no"） 
linelist_sym <- linelist %>% 
  mutate(fever  = sample(c("yes", "no"), nrow(linelist), replace = T, prob = c(0.80, 0.20)),
         chills = sample(c("yes", "no"), nrow(linelist), replace = T, prob = c(0.20, 0.80)),
         cough  = sample(c("yes", "no"), nrow(linelist), replace = T, prob = c(0.9, 0.15)),
         aches  = sample(c("yes", "no"), nrow(linelist), replace = T, prob = c(0.10, 0.90)),
         vomit = sample(c("yes", "no"), nrow(linelist), replace = T))

linelist_sym_2 <- linelist_sym %>% 
  
  # 症状あり"yes"または症状なし"no"を、症状名に変換する
  mutate(fever = case_when(fever == "yes" ~ 1,          # "yes"の場合は、"fever"に置き換える
                           TRUE           ~ 0),   # "yes"以外の値の場合は、NAに置き換える
         
         chills = case_when(chills == "yes" ~ 1,
                           TRUE           ~ 0),
         
         cough = case_when(cough == "yes" ~ 1,
                           TRUE           ~ 0),
         
         aches = case_when(aches == "yes" ~ 1,
                           TRUE           ~ 0),
         
         vomit = case_when(vomit == "yes" ~ 1,
                           TRUE           ~ 0))

# プロットを作成する
UpSetR::upset(
  select(linelist_sym_2, fever, chills, cough, aches, vomit),
  sets = c("fever", "chills", "cough", "aches", "vomit"),
  order.by = "freq",
  sets.bar.color = c("blue", "red", "yellow", "darkgreen", "orange"), # 色の追加
  empty.intersections = "on",
  # nsets = 3,
  number.angles = 0,
  point.size = 3.5,
  line.size = 2, 
  mainbar.y.label = "Symptoms Combinations",
  sets.x.label = "Patients with Symptom")

```

この章では、異なる値や回答の**組み合わせ**の頻度分析をプロットする方法を説明します。上のプロットでは、複数の症状が発現した感染者の頻度分析をプロットしています。

このような頻度分析は、

-   複数回答データの分析（**Multiple response analysis**）
-   セット分析（**Sets analysis**）
-   組み合わせ分析（**Combinations analysis**）

上のプロットの例では、5つの症状が示されており、それぞれの縦棒の下には、反映されている症状の組み合わせを示す線と点があります。左側の横棒は、各症状の頻度を示しています。

まず初めに **ggupset** パッケージを使用した方法を説明し、次に **UpSetR** パッケージを使用した方法を紹介します。

<!-- ======================================================= -->

## データ準備

### パッケージを読む込む {.unnumbered}

下に記載されたコードは、分析に必要なパッケージを読み込むためのコードです。このハンドブックでは、必要なパッケージを読み込むために、**pacman** パッケージの `p_load()` 関数を使用しています。`p_load()` 関数は、パッケージがインストールされているかチェックし、インストールされている場合はパッケージを読み込み、インストールされていない場合はインストール後にパッケージを読み込みます。既にインストールされているパッケージは、**base R** の `library()` 関数を使用しても読み込むことができます。R のパッケージの詳細については、 [R の基礎] (\#basics) のページをご覧ください。

```{r, warning=F, message=F}
pacman::p_load(
  tidyverse,     # データ管理と可視化
  UpSetR,        # 複数回答データ分析用のパッケージ
  ggupset)       # 複数回答データ分析用のパッケージ
```

<!-- ======================================================= -->

### データをインポートする {.unnumbered}

この章では、エボラ出血熱のエピデミックのラインリストをサンプルとして使用します。このデータは既に前処理されており、 <a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds' class='download-button'>こちらをクリックするとダウンロードできます</a> （.rds 形式）です。 **rio** パッケージの `import()` 関数を使用し、データセットをインポートします。（import() 関数は、.xlsx、 .csv、 .rdsなど様々なファイル形式に対応しています。詳細は、[インポートとエクスポート] (\#importing) の章をご覧ください。）

```{r, echo=F}
# ラインリストをインポートする
linelist_sym <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))
```

```{r, eval=F}
# ラインリストをインポートする 
linelist_sym <- import("linelist_cleaned.rds")
```

このラインリストには、報告された 5 つの症状について、症状あり（yes）か症状なし（no）を示す変数が含まれています。 **ggupset** パッケージを使ってプロットを作成するために、変数の前処理が必要です。まず、データを確認しましょう（症状の変数を確認するには、以下の表を右にスクロールしてください）。

```{r, message=FALSE, echo=F}
# ラインリストを表として表示する
DT::datatable(head(linelist_sym, 50), rownames = FALSE, filter="top", options = list(pageLength = 5, scrollX=T), class = 'white-space: nowrap' )
```

<!-- ======================================================= -->

### Re-format values {.unnumbered}

To align with the format expected by **ggupset** we convert the "yes" and "no" the the actual symptom name, using `case_when()` from **dplyr**. If "no", we set the value as blank, so the values are eiter `NA` or the symptom.

```{r, warning=F, message=F}
# create column with the symptoms named, separated by semicolons
linelist_sym_1 <- linelist_sym %>% 
  
  # 症状あり"yes"または症状なし"no"を、症状名に変換する
  mutate(
    fever = case_when(
      fever == "yes" ~ "fever",          # "yes"の場合は、"fever"に置き換える
      TRUE           ~ NA_character_),   # "yes"以外の値の場合は、NAに置き換える
         
    chills = case_when(
       chills == "yes" ~ "chills",
       TRUE           ~ NA_character_),
    
    cough = case_when(
      cough == "yes" ~ "cough",
      TRUE           ~ NA_character_),
         
    aches = case_when(
      aches == "yes" ~ "aches",
      TRUE           ~ NA_character_),
         
    vomit = case_when(
      vomit == "yes" ~ "vomit",
      TRUE           ~ NA_character_)
    )
```

Now we make two final columns:

1.  Concatenating (gluing together) all the symptoms of the patient (a character column)\
2.  Convert the above column to class *list*, so it can be accepted by **ggupset** to make the plot

See the page on [Characters and strings] to learn more about the `unite()` function from **stringr**

```{r, warning=F, message=F}
linelist_sym_1 <- linelist_sym_1 %>% 
  unite(col = "all_symptoms",
        c(fever, chills, cough, aches, vomit), 
        sep = "; ",
        remove = TRUE,
        na.rm = TRUE) %>% 
  mutate(
    # make a copy of all_symptoms column, but of class "list" (which is required to use ggupset() in next step)
    all_symptoms_list = as.list(strsplit(all_symptoms, "; "))
    )
```

View the new data. Note the two columns towards the right end - the pasted combined values, and the list

```{r, echo=F, , warning=F, message=F}
DT::datatable(head(linelist_sym_1,50), rownames = FALSE, options = list(pageLength = 5, scrollX=T), class = 'white-space: nowrap')
```

<!-- ======================================================= -->

## **ggupset**

Load the package

```{r}
pacman::p_load(ggupset)
```

Create the plot. We begin with a `ggplot()` and `geom_bar()`, but then we add the special function `scale_x_upset()` from the **ggupset**.

```{r, warning=F, message=F}
ggplot(
  data = linelist_sym_1,
  mapping = aes(x = all_symptoms_list)) +
geom_bar() +
scale_x_upset(
  reverse = FALSE,
  n_intersections = 10,
  sets = c("fever", "chills", "cough", "aches", "vomit"))+
labs(
  title = "Signs & symptoms",
  subtitle = "10 most frequent combinations of signs and symptoms",
  caption = "Caption here.",
  x = "Symptom combination",
  y = "Frequency in dataset")

```

More information on **ggupset** can be found [online](https://rdrr.io/cran/ggupset/man/scale_x_upset.html) or offline in the package documentation in your RStudio Help tab `?ggupset`.

<!-- ======================================================= -->

## `UpSetR`

The **UpSetR** package allows more customization of the plot, but it can be more difficult to execute:

**Load package**

```{r}
pacman::p_load(UpSetR)
```

**Data cleaning**

We must convert the `linelist` symptoms values to 1 / 0.

```{r}
# Make using upSetR

linelist_sym_2 <- linelist_sym %>% 
  
  # convert the "yes" and "no" values into the symptom name itself
  mutate(
    fever = case_when(
      fever == "yes" ~ 1,    # if old value is "yes", new value is 1
      TRUE           ~ 0),   # if old value is anything other than "yes", the new value is 0
         
    chills = case_when(
      chills == "yes" ~ 1,
      TRUE           ~ 0),
         
    cough = case_when(
      cough == "yes" ~ 1,
      TRUE           ~ 0),
         
    aches = case_when(
      aches == "yes" ~ 1,
      TRUE           ~ 0),
         
    vomit = case_when(
      vomit == "yes" ~ 1,
      TRUE           ~ 0)
    )
```

Now make the plot using the custom function `upset()` - using only the symptoms columns. You must designate which "sets" to compare (the names of the symptom columns). Alternatively, use `nsets =` and `order.by = "freq"` to only show the top X combinations.

```{r, warning=F, message=F}

# Make the plot
UpSetR::upset(
  select(linelist_sym_2, fever, chills, cough, aches, vomit),
  sets = c("fever", "chills", "cough", "aches", "vomit"),
  order.by = "freq",
  sets.bar.color = c("blue", "red", "yellow", "darkgreen", "orange"), # optional colors
  empty.intersections = "on",
  # nsets = 3,
  number.angles = 0,
  point.size = 3.5,
  line.size = 2, 
  mainbar.y.label = "Symptoms Combinations",
  sets.x.label = "Patients with Symptom")

```

<!-- ======================================================= -->

## 参考文献

[The github page on UpSetR](https://github.com/hms-dbmi/UpSetR)

[A Shiny App version - you can upload your own data](https://gehlenborglab.shinyapps.io/upsetr/)

[\*documentation - difficult to interpret](https://cran.r-project.org/web/packages/UpSetR/UpSetR.pdf)
