# ネットワークドライブで R を使用する場合 {#network-drives}

<!-- ======================================================= -->

## はじめに

ネットワークドライブや会社の共有ドライブで R を使用する場合、様々な問題が発生することがあります。この章では、よくあるエラーについて説明し、筆者の経験から得たアプローチ並びに対処法を提案します。R Markdown に関するヒントも紹介します。

**R をネットワークドライブで使用する場合の原則**

1)  お使いのコンピュータの管理者権限が必要です。RStudio を管理者として実行するように設定してください。\
2)  パッケージはできるだけ文字のあるドライブ（C: ドライブなど）のライブラリに保存してください。パスが 「\\」 で始まるライブラリは、できるだけ使用しないでください。\
3)  **rmarkdown** [パッケージは、「\\」で始まるライブラリに保存しないでください。]{.ul}「\\」で始まるライブラリに保存した場合、TinyTex や Pandoc に接続できなくなります。

## 管理者として RStudio を使用する

RStudio のアイコンを右クリックし、RStudio を開くと、「管理者として実行」のオプションが表示されます。お使いのコンピュータによっては、表示されない場合があります。その場合は、プロパティ（Properties）を開いてください。プロパティを開くと、「互換性（Compatibility）」オプションのあるウィンドウが表示されるので、「管理者として実行（Run as Administrator）」のチェックボックスにチェックを入れてください。

## 便利なコマンド

ネットワークドライブ上で R を使用している際に直面した問題のトラブルシューティングに役立つコマンドをいくつか以下に示します。

まず、R にインストール済みのパッケージが保存されている場所（ライブラリ）を知りたい場合は、以下のコードを実行するとライブラリのパスを確認できます。R がパッケージのインストール・読み込み・検索に使用している順序で、パスが表示されます。他のデフォルトライブラリを使用したい場合は、パスの順序を変更することができます（2 つ下のコードを参照ください）。

```{r, eval=F}
# ライブラリの場所を表示する
.libPaths()                   # ライブラリパスを表示
                              # 注意: 表時れたパスにはすべてのパッケージが含まれて
                              # いるが、C: 等いくつかのドライブに保存された
                              # パッケージを表示するためには、管理者として 
                              # RStudioを実行する必要がある場合もある
                              # （install packages library 
                                   # のドロップダウンには表示されない）
```

R がパッケージを検索する際に、「\\」で始まるライブラリや「D:」等の文字で始まる場所に保存されたライブラリを先に拾っている場合など、R が使用するライブラリの順番を入れ替えたい場合は、以下のコードで `.libPaths()` の順序を変更することができます。

```{r, eval=F}
# ライブラリの順序を変更する
# 順序を変更することで、R がパッケージを検索する際の優先順位度が変更される
# 例えば、C:ドライブのライブラリを先に表示したい場合
myPaths <- .libPaths() # パッケージライブラリのパスをオブジェクトにアサインする
myPaths <- c(myPaths[2], myPaths[1]) # パスの順序を変更する
.libPaths(myPaths) # 変更した順序のパスを再度アサインする
```

R MarkdownがPandocに接続する際にエラーが発生した場合は、以下のコードを使用して Pandoc が RStudio のどこにインストールされているかを確認できます。

```{r, eval=F}
# Pandocを探す
Sys.getenv("RSTUDIO_PANDOC")  # Pandoc がどこにインストールされているか確認する
```

どのライブラリからパッケージを読み込みしているかを知りたい場合は、以下のコードを実行してください。

```{r, eval=F}
# パッケージを探す
# ライブラリの場所が表示される（複数のライブラリに保存されている場合は、最初のライブラリが表示される）
find.package("rmarkdown", lib.loc = NULL, quiet = FALSE, verbose = getOption("verbose")) 
```

<!-- ======================================================= -->

## よくあるエラー

**"Failed to compile...tex in rmarkdown"**

-   TinyTex がインストールされているか確認してください。インストールされていない場合は、C: ドライブに TinyTex をインストールしてください。TinyTex のインストール方法については、[R の基礎] (\#basics) の章をご覧ください。

```{r, eval=F}
# tinytex がインストールされているか確認し、C:ドライブにインストールする
tinytex::install_tinytex()
tinytex:::is_tinytex() # should return TRUE (note three colons)
```

**Internet routines cannot be loaded**

For example, `Error in tools::startDynamicHelp() : internet routines cannot be loaded`

-   Try selecting 32-bit version from RStudio via Tools/Global Options.

    -   note: if 32-bit version does not appear in menu, make sure you are not using RStudio v1.2.\

-   Alternatively, try uninstalling R and re-installing with different bit version (32 instead of 64)

**C: library does not appear as an option when I try to install packages manually**

-   Run RStudio as an administrator, then this option will appear.\
-   To set-up RStudio to always run as administrator (advantageous when using an Rproject where you don't click RStudio icon to open)... right-click the Rstudio icon

The image below shows how you can manually select the library to install a package to. This window appears when you open the Packages RStudio pane and click "Install".

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "network_install.png"))
```

**Pandoc 1 error**

If you are getting "pandoc error 1" when knitting R Markdowns scripts on network drives:

-   Of multiple library locations, have the one with a lettered drive listed first (see codes above)\
-   The above solution worked when knitting on local drive but while on a networked internet connection\
-   See more tips here: <https://ciser.cornell.edu/rmarkdown-knit-to-html-word-pdf/>

**Pandoc Error 83**

The error will look something like this: `can't find file...rmarkdown...lua...`. This means that it was unable to find this file.

See <https://stackoverflow.com/questions/58830927/rmarkdown-unable-to-locate-lua-filter-when-knitting-to-word>

Possibilities:

1)  Rmarkdown package is not installed\
2)  Rmarkdown package is not findable\
3)  An admin rights issue.

It is possible that R is not able to find the **rmarkdown** package file, so check which library the **rmarkdown** package lives (see code above). If the package is installed to a library that in inaccessible (e.g. starts with "\\") consider manually moving it to C: or other named drive library. Be aware that the **rmarkdown** package has to be able to connect to TinyTex installation, so can not live in a library on a network drive.

**Pandoc Error 61**

For example: `Error: pandoc document conversion failed with error 61` or `Could not fetch...`

-   Try running RStudio as administrator (right click icon, select run as admin, see above instructions)\
-   Also see if the specific package that was unable to be reached can be moved to C: library.

**LaTex error (see below)**

An error like: `! Package pdftex.def Error: File 'cict_qm2_2020-06-29_files/figure-latex/unnamed-chunk-5-1.png' not found: using draft setting.` or `Error: LaTeX failed to compile file_name.tex.`

-   See <https://yihui.org/tinytex/r/#debugging> for debugging tips.\
-   See file_name.log for more info.

**Pandoc Error 127**

This could be a RAM (space) issue. Re-start your R session and try again.

**Mapping network drives**

Mapping a network drive can be risky. Consult with your IT department before attempting this.

A tip borrowed from this [forum discussion](https://stackoverflow.com/questions/48161177/r-markdown-openbinaryfile-does-not-exist-no-such-file-or-directory/55616529?noredirect=1#comment97966859_55616529):

How does one open a file "through a mapped network drive"?

-   First, you'll need to know the network location you're trying to access.\
-   Next, in the Windows file manager, you will need to right click on "This PC" on the right hand pane, and select "Map a network drive".\
-   Go through the dialogue to define the network location from earlier as a lettered drive.\
-   Now you have two ways to get to the file you're opening. Using the drive-letter path should work.

**Error in install.packages()**

If you get an error that includes mention of a "lock" directory, for example: `Error in install.packages : ERROR: failed to lock directory...`

Look in your package library and you will see a folder whose name begins with "00LOCK". Try the following tips:

-   Manually delete the "00LOCK" folder directory from your package library. Try installing the package again.\
-   You can also try the command `pacman::p_unlock()` (you can also put this command in the Rprofile so it runs every time project opens.). Then try installing the package again. It may take several tries.\
-   Try running RStudio in Administrator mode, and try installing the packages one-by-one.\
-   If all else fails, install the package to another library or folder (e.g. Temp) and then manually copy the package's folder over to the desired library.
