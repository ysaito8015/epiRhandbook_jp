<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>10 Missing data | R Handbook for Epidemiologists</title>
<meta name="author" content="the handbook team">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.6/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.15/datatables.js"></script><link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.9.3/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-1.57.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-1.57.1/plotly-latest.min.js"></script><link href="libs/vis-4.20.1/vis.css" rel="stylesheet">
<script src="libs/vis-4.20.1/vis.min.js"></script><script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-1.57.1/plotly-basic-1.57.1.min.js"></script><script src="libs/plotly-cartesian-1.57.1/plotly-cartesian-1.57.1.min.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R Handbook for Epidemiologists</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Welcome</a></li>
<li class="book-part">About this book</li>
<li><a class="" href="style-and-editorial-notes.html"><span class="header-section-number">2</span> Style and editorial notes</a></li>
<li><a class="" href="datasets-used.html"><span class="header-section-number">3</span> Datasets used</a></li>
<li class="book-part">Basics</li>
<li><a class="" href="r-basics.html"><span class="header-section-number">4</span> R Basics</a></li>
<li><a class="" href="importing-data.html"><span class="header-section-number">5</span> Importing data</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R projects</a></li>
<li><a class="" href="suggested-packages.html"><span class="header-section-number">7</span> Suggested packages</a></li>
<li class="book-part">Data Management</li>
<li><a class="" href="cleaning-data.html"><span class="header-section-number">8</span> Cleaning data</a></li>
<li><a class="" href="working-with-dates.html"><span class="header-section-number">9</span> Working with Dates</a></li>
<li><a class="active" href="missing-data.html"><span class="header-section-number">10</span> Missing data</a></li>
<li><a class="" href="groupingaggregating-data.html"><span class="header-section-number">11</span> Grouping/aggregating data</a></li>
<li><a class="" href="joining-matching-datasets.html"><span class="header-section-number">12</span> Joining &amp; matching datasets</a></li>
<li><a class="" href="charactersstrings.html"><span class="header-section-number">13</span> Characters/strings</a></li>
<li><a class="" href="de-duplication.html"><span class="header-section-number">14</span> De-duplication</a></li>
<li><a class="" href="ifelse-for-loops.html"><span class="header-section-number">15</span> if/else &amp; ‘for’ loops</a></li>
<li><a class="" href="iteration.html"><span class="header-section-number">16</span> Iteration</a></li>
<li class="book-part">Analysis</li>
<li><a class="" href="descriptive-analysis.html"><span class="header-section-number">17</span> Descriptive analysis</a></li>
<li><a class="" href="simple-statistical-tests.html"><span class="header-section-number">18</span> Simple statistical tests</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">19</span> Standardization</a></li>
<li><a class="" href="moving-averages.html"><span class="header-section-number">20</span> Moving averages</a></li>
<li><a class="" href="outbreak-detection.html"><span class="header-section-number">21</span> Outbreak detection</a></li>
<li><a class="" href="time-series-analysis.html"><span class="header-section-number">22</span> Time series analysis</a></li>
<li><a class="" href="epidemicmodels.html"><span class="header-section-number">23</span> Epidemic modeling</a></li>
<li><a class="" href="modeling.html"><span class="header-section-number">24</span> Modeling</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">25</span> Survey analysis</a></li>
<li><a class="" href="survival-analysis-1.html"><span class="header-section-number">26</span> Survival analysis</a></li>
<li><a class="" href="gis-basics.html"><span class="header-section-number">27</span> GIS basics</a></li>
<li class="book-part">Data Vizualization</li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">28</span> ggplot tips</a></li>
<li><a class="" href="epidemic-curves.html"><span class="header-section-number">29</span> Epidemic curves</a></li>
<li><a class="" href="plotting-continuous-data.html"><span class="header-section-number">30</span> Plotting continuous data</a></li>
<li><a class="" href="plotting-discrete-variables.html"><span class="header-section-number">31</span> Plotting discrete variables</a></li>
<li><a class="" href="tables.html"><span class="header-section-number">32</span> Tables</a></li>
<li><a class="" href="age-pyramids.html"><span class="header-section-number">33</span> Age pyramids</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">34</span> Diagrams</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">35</span> Combination analysis</a></li>
<li><a class="" href="heatmaps-density-plots.html"><span class="header-section-number">36</span> Heatmaps &amp; density plots</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">37</span> Transmission Chains</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">38</span> Phylogenetic trees</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">39</span> Interactive plots</a></li>
<li class="book-part">Advanced</li>
<li><a class="" href="errors-warnings-1.html"><span class="header-section-number">40</span> Errors &amp; Warnings</a></li>
<li><a class="" href="advanced-rstudio.html"><span class="header-section-number">41</span> Advanced RStudio</a></li>
<li><a class="" href="relational-databases.html"><span class="header-section-number">42</span> Relational databases</a></li>
<li><a class="" href="routine-reports.html"><span class="header-section-number">43</span> Routine reports</a></li>
<li><a class="" href="r-markdown.html"><span class="header-section-number">44</span> R Markdown</a></li>
<li><a class="" href="shiny-basics.html"><span class="header-section-number">45</span> Shiny basics</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Collaboration</a></li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">47</span> Writing functions</a></li>
<li><a class="" href="r-on-network-drives.html"><span class="header-section-number">48</span> R on network drives</a></li>
<li><a class="" href="directory-interactions.html"><span class="header-section-number">49</span> Directory interactions</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="missing-data" class="section level1 tabset tabset-fade" number="10">
<h1>
<span class="header-section-number">10</span> Missing data<a class="anchor" aria-label="anchor" href="#missing-data"><i class="fas fa-link"></i></a>
</h1>
<div class="inline-figure"><img src="images/missingness.png" width="50%"></div>
<!-- ======================================================= -->
<div id="overview-4" class="section level2 tabset tabset-fade" number="10.1">
<h2>
<span class="header-section-number">10.1</span> Overview<a class="anchor" aria-label="anchor" href="#overview-4"><i class="fas fa-link"></i></a>
</h2>
<p>This page will cover:</p>
<ol style="list-style-type: decimal">
<li>Useful functions for assessing missingness<br>
</li>
<li>Assess missingness in a dataframe<br>
</li>
<li>Filter out rows with missingness<br>
</li>
<li>Plotting missingness over time<br>
</li>
<li>Handling how <code>NA</code> is displayed in plots<br>
</li>
<li>Imputation</li>
</ol>
<!-- ======================================================= -->
</div>
<div id="preparation-1" class="section level2 tabset tabset-fade" number="10.2">
<h2>
<span class="header-section-number">10.2</span> Preparation<a class="anchor" aria-label="anchor" href="#preparation-1"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Load packages</strong></p>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span>
  <span class="va">tidyverse</span>,
  <span class="va">rio</span>
<span class="op">)</span></code></pre></div>
<p><strong>Load data</strong></p>
<div class="sourceCode" id="cb279"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"linelist_cleaned.rds"</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="useful-functions" class="section level2 tabset tabset-fade" number="10.3">
<h2>
<span class="header-section-number">10.3</span> Useful functions<a class="anchor" aria-label="anchor" href="#useful-functions"><i class="fas fa-link"></i></a>
</h2>
<p>The following are useful functions when assessing or handling missing values:</p>
<p><strong><code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code> and <code>!is.na()</code></strong></p>
<p>To identify missing values use <code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code> or its opposite (with <code><a href="https://rdrr.io/r/base/Logic.html">!</a></code> in front). Both are from <strong>base</strong> R.<br>
These return a logical vector (<code>TRUE</code> or <code>FALSE</code>). Remember that you can <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> the resulting vector to count the number <code>TRUE</code>, e.g. <code><a href="https://rdrr.io/r/base/sum.html">sum(is.na(linelist$date_outcome))</a></code>.</p>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">56</span>, <span class="cn">NA</span>, <span class="fl">5</span>, <span class="cn">NA</span>, <span class="fl">22</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">my_vector</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE</code></pre>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">my_vector</span><span class="op">)</span></code></pre></div>
<pre><code>## [1]  TRUE  TRUE  TRUE FALSE  TRUE FALSE  TRUE</code></pre>
<p><strong><code><a href="https://rdrr.io/r/stats/na.fail.html">na.omit()</a></code></strong></p>
<p>This function, if applied to a dataframe, will remove rows with <em>any</em> missing values. It is also from <strong>base</strong> R.<br>
If applied to a vector, it will remove <code>NA</code> values from the vector it is applied to. For example:</p>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="va">my_vector</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 88</code></pre>
<p><strong><code>na.rm = TRUE</code></strong></p>
<p>Often a mathematical function will by default <em>include</em> <code>NA</code> in calculations, which results in the function returning <code>NA</code> (this is designed intentionally, to make you aware that you have missing data).<br>
You can usually avoid this by removing missing values from the calculation, by including the argument <code>na.rm = TRUE</code> (na.rm stands for “remove <code>NA</code>”).</p>
<div class="sourceCode" id="cb286"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">my_vector</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] NA</code></pre>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">my_vector</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 17.6</code></pre>
<!-- ======================================================= -->
</div>
<div id="assess-missingness-in-a-dataframe" class="section level2 tabset tabset-fade" number="10.4">
<h2>
<span class="header-section-number">10.4</span> Assess missingness in a dataframe<a class="anchor" aria-label="anchor" href="#assess-missingness-in-a-dataframe"><i class="fas fa-link"></i></a>
</h2>
<p>You can use the package <strong>naniar</strong> to assess and visualize missingness.</p>
<div class="sourceCode" id="cb290"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">naniar</span><span class="op">)</span></code></pre></div>
<div id="statistics" class="section level3" number="10.4.1">
<h3>
<span class="header-section-number">10.4.1</span> Statistics<a class="anchor" aria-label="anchor" href="#statistics"><i class="fas fa-link"></i></a>
</h3>
<p>Some basic missingness functions from <strong>naniar</strong> include:</p>
<p>The percent of all values that are missing</p>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pct_miss</span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span>  <span class="co"># also see n_miss() for counts</span></code></pre></div>
<pre><code>## [1] 6.854978</code></pre>
<p>These two functions return the percent of rows with any missing values, or that are entirely complete, respectively. Note that "" or " " will register as non-missing.</p>
<div class="sourceCode" id="cb293"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pct_miss_case</span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span>   <span class="co"># also see n_complete() for counts</span></code></pre></div>
<pre><code>## [1] 68.29682</code></pre>
<div class="sourceCode" id="cb295"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pct_complete_case</span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span> <span class="co"># see n_complete</span></code></pre></div>
<pre><code>## [1] 31.70318</code></pre>
</div>
<div id="visualizing-missingness" class="section level3" number="10.4.2">
<h3>
<span class="header-section-number">10.4.2</span> Visualizing missingness<a class="anchor" aria-label="anchor" href="#visualizing-missingness"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>gg_miss_var()</code> function will tell you the number missing in each column. You can add a bare column name to the argument <code>facet =</code> if desired to see the plot by groups. By default, counts are shown instead of percents (<code>show_pct = FALSE</code>). You can also add labs as a normal ggplot with <code>+labs()</code>.</p>
<div class="sourceCode" id="cb297"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">gg_miss_var</span><span class="op">(</span><span class="va">linelist</span>, show_pct <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-173-1.png" width="672"></div>
<p>You can use <code>vis_miss()</code> to visualize the dataframe as a heatmap, showing whether each value is missing or not:</p>
<div class="sourceCode" id="cb298"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">vis_miss</span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-174-1.png" width="672"></div>
</div>
<div id="explore-and-visualize-missingness-relationships" class="section level3" number="10.4.3">
<h3>
<span class="header-section-number">10.4.3</span> Explore and visualize missingness relationships<a class="anchor" aria-label="anchor" href="#explore-and-visualize-missingness-relationships"><i class="fas fa-link"></i></a>
</h3>
<p>How do you visualize something that is not there??? By default, ggplot removes points with missing values from plots.</p>
<p><strong>naniar</strong> offers a solution via <code>geom_miss_point()</code>. When creating a scatterplot of two columns, records with one of the values missing and the other present are shown by setting the missing values to 10% lower than the lowest value in the column, and coloring them distinctly.<br>
In the scatterplot below, the red dots are records where the X column is present but the value for the Y column is missing.</p>
<div class="sourceCode" id="cb299"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>
  <span class="va">linelist</span>, 
  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">generation</span>,             
      y <span class="op">=</span> <span class="va">days_onset_hosp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>     <span class="co"># column to show missingness</span>
  <span class="fu">geom_miss_point</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-175-1.png" width="672"></div>
<p>To assess missingness in the dataframe by another column, consider <code>gg_miss_fct()</code>, which returns a heatmap of percent missingness in the dataframe by a factor/categorical (or date) column:</p>
<div class="sourceCode" id="cb300"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">gg_miss_fct</span><span class="op">(</span><span class="va">linelist</span>, <span class="va">age_cat5</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-176-1.png" width="672"></div>
<p>This function can also be used on date column to neat effect:</p>
<div class="sourceCode" id="cb301"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">gg_miss_fct</span><span class="op">(</span><span class="va">linelist</span>, <span class="va">date_onset</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 28 rows containing missing values (geom_tile).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-177-1.png" width="672"></div>
<p><strong>“Shadow” columns</strong></p>
<p>Another way to visualize missingness in one column by values in a second column is using the “shadow” that <strong>naniar</strong> can create. Essentially, <code>bind_shadow()</code> creates a binary <code>NA</code>/not <code>NA</code> column for every column, and adds all these columns to the dataset (doubling the number of columns). See below:</p>
<div class="sourceCode" id="cb303"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">shadowed_linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">bind_shadow</span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">shadowed_linelist</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "case_id"                 "generation"              "date_infection"          "date_onset"             
##  [5] "date_hospitalisation"    "date_outcome"            "outcome"                 "gender"                 
##  [9] "age"                     "age_unit"                "age_years"               "age_cat"                
## [13] "age_cat5"                "hospital"                "lon"                     "lat"                    
## [17] "infector"                "source"                  "wt_kg"                   "ht_cm"                  
## [21] "ct_blood"                "fever"                   "chills"                  "cough"                  
## [25] "aches"                   "vomit"                   "temp"                    "time_admission"         
## [29] "days_onset_hosp"         "case_id_NA"              "generation_NA"           "date_infection_NA"      
## [33] "date_onset_NA"           "date_hospitalisation_NA" "date_outcome_NA"         "outcome_NA"             
## [37] "gender_NA"               "age_NA"                  "age_unit_NA"             "age_years_NA"           
## [41] "age_cat_NA"              "age_cat5_NA"             "hospital_NA"             "lon_NA"                 
## [45] "lat_NA"                  "infector_NA"             "source_NA"               "wt_kg_NA"               
## [49] "ht_cm_NA"                "ct_blood_NA"             "fever_NA"                "chills_NA"              
## [53] "cough_NA"                "aches_NA"                "vomit_NA"                "temp_NA"                
## [57] "time_admission_NA"       "days_onset_hosp_NA"</code></pre>
<p>These “shadow” columns can be used to plot the density of proportion of values that are missing by another column X. For example, the plot below shows the proportion of records missing <code>days_onset_hosp</code> (number of days from symptom onset to hospitalisation), by that record’s value in <code>date_hospitalisation</code>. Essentially, you are plot the density of the x-axis column, but stratify the results (<code>color =</code>) by a shadow column of interest. This analysis works best if the x-axis is numeric or date column.</p>
<div class="sourceCode" id="cb305"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>
  <span class="va">shadowed_linelist</span>,                   <span class="co"># dataframe with shadow columns</span>
  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_hospitalisation</span>,        <span class="co"># numeric or date column</span>
      colour <span class="op">=</span> <span class="va">days_onset_hosp_NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># shadown column of interest</span>
  <span class="fu">geom_density</span><span class="op">(</span><span class="op">)</span>                       <span class="co"># plots the density curves</span></code></pre></div>
<pre><code>## Warning: Removed 1 rows containing non-finite values (stat_density).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-179-1.png" width="672"></div>
<p>You can also use these “shadow” columns to stratify a statistical summary, as shown below:</p>
<div class="sourceCode" id="cb307"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span>
  <span class="fu">bind_shadow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>                <span class="co"># create the shows cols</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date_outcome_NA</span><span class="op">)</span> <span class="op">%&gt;%</span>    <span class="co"># shadow col for stratifying</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_at</a></span><span class="op">(</span>.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"days_onset_hosp"</span><span class="op">)</span>,     <span class="co"># variable of interest for calculations</span>
               .funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="st">"sd"</span>, <span class="st">"var"</span>, <span class="st">"min"</span>, <span class="st">"max"</span><span class="op">)</span>,  <span class="co"># stats to calculate</span>
               na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>       <span class="co"># other arguments for the stat calculations</span></code></pre></div>
<pre><code>## # A tibble: 2 x 6
##   date_outcome_NA  mean    sd   var   min   max
## * &lt;fct&gt;           &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 !NA              2.07  2.31  5.34     0    22
## 2 NA               1.99  2.04  4.17     0    14</code></pre>
<p>An alternative way to plot the proportion of values in one column, including missingness, is given below. It does not involve <strong>naniar</strong>. This example shows percent of weekly observations that are missing in a column):</p>
<ol style="list-style-type: decimal">
<li>Aggregate the data into a useful time unit (days, weeks, etc.), summarizing the proportion of observations with <code>NA</code> (and any other values of interest)<br>
</li>
<li>Plot the proportion missing as a line using <code>ggplot()</code>
</li>
</ol>
<p>Below, we take the linelist, add a new column for week, group the data by week, and then calculate the percent of that week’s records where the value is missing. (note: if you want % of 7 days the calculation would be slightly different).</p>
<div class="sourceCode" id="cb309"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">outcome_missing</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>week <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">date_onset</span>, <span class="st">"week"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>   <span class="co"># create new week column</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span> <span class="op">%&gt;%</span>                                             <span class="co"># group the rows by week</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>                                                     <span class="co"># summarize each week</span>
    n_obs <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,                                                     <span class="co"># number of records</span>
    
    outcome_missing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op">|</span> <span class="va">outcome</span> <span class="op">==</span> <span class="st">""</span><span class="op">)</span>,       <span class="co"># number of records missing the value</span>
    outcome_p_miss  <span class="op">=</span> <span class="va">outcome_missing</span> <span class="op">/</span> <span class="va">n_obs</span>,                   <span class="co"># proportion of records missing the value</span>
  
    outcome_dead    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">==</span> <span class="st">"Death"</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,          <span class="co"># number of records as dead</span>
    outcome_p_dead  <span class="op">=</span> <span class="va">outcome_dead</span> <span class="op">/</span> <span class="va">n_obs</span><span class="op">)</span> <span class="op">%&gt;%</span>                  <span class="co"># proportion of records as dead</span>
  
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">week</span>, names_to <span class="op">=</span> <span class="st">"statistic"</span><span class="op">)</span> <span class="op">%&gt;%</span>         <span class="co"># pivot all columns except week, to long format for ggplot</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">statistic</span>, <span class="st">"_p_"</span><span class="op">)</span><span class="op">)</span>                  <span class="co"># keep only the proportion values</span></code></pre></div>
<p>Then we plot the proportion missing as a line, by week</p>
<div class="sourceCode" id="cb310"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">outcome_missing</span><span class="op">)</span><span class="op">+</span>
    <span class="fu">geom_line</span><span class="op">(</span>
      <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">statistic</span>, color <span class="op">=</span> <span class="va">statistic</span><span class="op">)</span>,
      size <span class="op">=</span> <span class="fl">2</span>,
      stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span><span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Weekly outcomes"</span>,
         x <span class="op">=</span> <span class="st">"Week"</span>,
         y <span class="op">=</span> <span class="st">"Proportion of weekly records"</span><span class="op">)</span> <span class="op">+</span> 
     <span class="fu">scale_color_discrete</span><span class="op">(</span>
       name <span class="op">=</span> <span class="st">""</span>,
       labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Died"</span>, <span class="st">"Missing outcome"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
    <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>
    legend.position <span class="op">=</span> <span class="st">"bottom"</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 2 row(s) containing missing values (geom_path).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-182-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="filter-out-rows-with-missing-values" class="section level2 tabset tabset-fade" number="10.5">
<h2>
<span class="header-section-number">10.5</span> Filter out rows with missing values<a class="anchor" aria-label="anchor" href="#filter-out-rows-with-missing-values"><i class="fas fa-link"></i></a>
</h2>
<p>To quickly remove rows with missing values, use the <strong>dplyr</strong> function <code><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na()</a></code>.</p>
<p>The original <code>linelist</code> has <code><a href="https://rdrr.io/r/base/nrow.html">nrow(linelist)</a></code> rows. The adjusted number of rows is shown below:</p>
<div class="sourceCode" id="cb312"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>     <span class="co"># remove rows with ANY missing values</span>
  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Additionally you can specify columns to evaluate for missingness:</p>
<div class="sourceCode" id="cb313"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># remove rows missing date_onset </span>
  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 5641</code></pre>
<p>Multiple columns can be specified one after the other, or using this standard syntax:</p>
<div class="sourceCode" id="cb315"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># remove rows missing values in any "date" column </span>
  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 3055</code></pre>
<!-- ======================================================= -->
</div>
<div id="handling-na-in-ggplot" class="section level2 tabset tabset-fade" number="10.6">
<h2>
<span class="header-section-number">10.6</span> Handling <code>NA</code> in <code>ggplot()</code><a class="anchor" aria-label="anchor" href="#handling-na-in-ggplot"><i class="fas fa-link"></i></a>
</h2>
<p>It is often wise to report the number of values excluded from a plot in a caption. Below is an example:</p>
<p>In <code>ggplot()</code>, you can add <code>labs()</code> and within it a <code>caption =</code>. In the caption, you can use <code>str_glue()</code> from <strong>stringr</strong> package to paste values together into a sentence dynamically so they will adjust to the data. An example is below:</p>
<ul>
<li>Note the use of <code>\n</code> for a new line.<br>
</li>
<li>Note that if multiple column would contribute to values not being plotted (e.g. age or sex if those are reflected in the plot), then you must filter on those columns as well to correctly calculate the number not shown.</li>
</ul>
<div class="sourceCode" id="cb317"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">labs</span><span class="op">(</span>
  title <span class="op">=</span> <span class="st">"Weekly case incidence, by gender"</span>,
  y <span class="op">=</span> <span class="st">"Weekly case incidence"</span>,
  x <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,
  caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; {nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown."</span><span class="op">)</span><span class="op">)</span>  </code></pre></div>
<p>Sometimes, it can be easier to save the value as an object in commands before the <code>ggplot()</code> command, and simply reference the named value within the <code>str_glue()</code>.</p>
<!-- ======================================================= -->
</div>
<div id="imputation" class="section level2 tabset tabset-fade" number="10.7">
<h2>
<span class="header-section-number">10.7</span> Imputation<a class="anchor" aria-label="anchor" href="#imputation"><i class="fas fa-link"></i></a>
</h2>
<p>Under construction - TBD - TODO</p>
<!-- ======================================================= -->
</div>
<div id="resources-1" class="section level2 tabset tabset-fade" number="10.8">
<h2>
<span class="header-section-number">10.8</span> Resources<a class="anchor" aria-label="anchor" href="#resources-1"><i class="fas fa-link"></i></a>
</h2>
<p>Vignette on the <a href="https://cran.r-project.org/web/packages/naniar/vignettes/getting-started-w-naniar.html">naniar package</a></p>
<p>Gallery of <a href="https://cran.r-project.org/web/packages/naniar/vignettes/naniar-visualisation.html">missing value visualizations</a></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="working-with-dates.html"><span class="header-section-number">9</span> Working with Dates</a></div>
<div class="next"><a href="groupingaggregating-data.html"><span class="header-section-number">11</span> Grouping/aggregating data</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#missing-data"><span class="header-section-number">10</span> Missing data</a></li>
<li><a class="nav-link" href="#overview-4"><span class="header-section-number">10.1</span> Overview</a></li>
<li><a class="nav-link" href="#preparation-1"><span class="header-section-number">10.2</span> Preparation</a></li>
<li><a class="nav-link" href="#useful-functions"><span class="header-section-number">10.3</span> Useful functions</a></li>
<li>
<a class="nav-link" href="#assess-missingness-in-a-dataframe"><span class="header-section-number">10.4</span> Assess missingness in a dataframe</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#statistics"><span class="header-section-number">10.4.1</span> Statistics</a></li>
<li><a class="nav-link" href="#visualizing-missingness"><span class="header-section-number">10.4.2</span> Visualizing missingness</a></li>
<li><a class="nav-link" href="#explore-and-visualize-missingness-relationships"><span class="header-section-number">10.4.3</span> Explore and visualize missingness relationships</a></li>
</ul>
</li>
<li><a class="nav-link" href="#filter-out-rows-with-missing-values"><span class="header-section-number">10.5</span> Filter out rows with missing values</a></li>
<li><a class="nav-link" href="#handling-na-in-ggplot"><span class="header-section-number">10.6</span> Handling NA in ggplot()</a></li>
<li><a class="nav-link" href="#imputation"><span class="header-section-number">10.7</span> Imputation</a></li>
<li><a class="nav-link" href="#resources-1"><span class="header-section-number">10.8</span> Resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R Handbook for Epidemiologists</strong>" was written by the handbook team. It was last built on 2021-02-03.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
