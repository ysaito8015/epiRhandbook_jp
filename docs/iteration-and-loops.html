<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>16 Iteration and loops | The Epidemiologist R Handbook</title>
<meta name="author" content="the handbook team">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.6/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.15/datatables.js"></script><link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet">
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script><link href="libs/tabwid-1.0.0/tabwid.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.9.3/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-1.57.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-1.57.1/plotly-latest.min.js"></script><link href="libs/vis-4.20.1/vis.css" rel="stylesheet">
<script src="libs/vis-4.20.1/vis.min.js"></script><script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-1.57.1/plotly-basic-1.57.1.min.js"></script><script src="libs/plotly-cartesian-1.57.1/plotly-cartesian-1.57.1.min.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">The Epidemiologist R Handbook</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">The Epidemiologist R Handbook</a></li>
<li class="book-part">About this book</li>
<li><a class="" href="style-and-editorial-notes.html"><span class="header-section-number">1</span> Style and editorial notes</a></li>
<li><a class="" href="datasets-used.html"><span class="header-section-number">2</span> Datasets used</a></li>
<li class="book-part">Basics</li>
<li><a class="" href="r-basics.html"><span class="header-section-number">3</span> R Basics</a></li>
<li><a class="" href="transition-to-r.html"><span class="header-section-number">4</span> Transition to R</a></li>
<li><a class="" href="import-and-export.html"><span class="header-section-number">5</span> Import and export</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R projects</a></li>
<li><a class="" href="suggested-packages.html"><span class="header-section-number">7</span> Suggested packages</a></li>
<li class="book-part">Data Management</li>
<li><a class="" href="cleaning-data.html"><span class="header-section-number">8</span> Cleaning data</a></li>
<li><a class="" href="working-with-dates.html"><span class="header-section-number">9</span> Working with dates</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">10</span> Factors</a></li>
<li><a class="" href="pivoting-data.html"><span class="header-section-number">11</span> Pivoting data</a></li>
<li><a class="" href="grouping-data.html"><span class="header-section-number">12</span> Grouping data</a></li>
<li><a class="" href="joining-data.html"><span class="header-section-number">13</span> Joining data</a></li>
<li><a class="" href="characters-and-strings.html"><span class="header-section-number">14</span> Characters and strings</a></li>
<li><a class="" href="de-duplication.html"><span class="header-section-number">15</span> De-duplication</a></li>
<li><a class="active" href="iteration-and-loops.html"><span class="header-section-number">16</span> Iteration and loops</a></li>
<li class="book-part">Analysis</li>
<li><a class="" href="missing-data.html"><span class="header-section-number">17</span> Missing data</a></li>
<li><a class="" href="descriptive-analysis.html"><span class="header-section-number">18</span> Descriptive analysis</a></li>
<li><a class="" href="univariate-and-multivariate-regression.html"><span class="header-section-number">19</span> Univariate and multivariate regression</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">20</span> Standardization</a></li>
<li><a class="" href="moving-averages.html"><span class="header-section-number">21</span> Moving averages</a></li>
<li><a class="" href="time-series-and-outbreak-detection.html"><span class="header-section-number">22</span> Time series and outbreak detection</a></li>
<li><a class="" href="epidemic-modeling.html"><span class="header-section-number">23</span> Epidemic modeling</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">24</span> Survey analysis</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">25</span> Survival analysis</a></li>
<li><a class="" href="gis-basics.html"><span class="header-section-number">26</span> GIS basics</a></li>
<li class="book-part">Data Vizualization</li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">27</span> ggplot tips</a></li>
<li><a class="" href="epidemic-curves.html"><span class="header-section-number">28</span> Epidemic curves</a></li>
<li><a class="" href="plot-continuous-data.html"><span class="header-section-number">29</span> Plot continuous data</a></li>
<li><a class="" href="plot-categorical-data.html"><span class="header-section-number">30</span> Plot categorical data</a></li>
<li><a class="" href="tables-1.html"><span class="header-section-number">31</span> Tables</a></li>
<li><a class="" href="age-pyramids-and-likert-scales.html"><span class="header-section-number">32</span> Age pyramids and Likert-scales</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">33</span> Diagrams</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">34</span> Combination analysis</a></li>
<li><a class="" href="heatmaps.html"><span class="header-section-number">35</span> Heatmaps</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">36</span> Transmission chains</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">37</span> Phylogenetic trees</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">38</span> Interactive plots</a></li>
<li class="book-part">Advanced</li>
<li><a class="" href="directory-interactions.html"><span class="header-section-number">39</span> Directory interactions</a></li>
<li><a class="" href="r-markdown-1.html"><span class="header-section-number">40</span> R Markdown</a></li>
<li><a class="" href="routine-reports.html"><span class="header-section-number">41</span> Routine reports</a></li>
<li><a class="" href="errors-warnings-1.html"><span class="header-section-number">42</span> Errors &amp; warnings</a></li>
<li><a class="" href="advanced-rstudio.html"><span class="header-section-number">43</span> Advanced RStudio</a></li>
<li><a class="" href="relational-databases.html"><span class="header-section-number">44</span> Relational databases</a></li>
<li><a class="" href="shiny-and-dashboards.html"><span class="header-section-number">45</span> Shiny and dashboards</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Collaboration</a></li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">47</span> Writing functions</a></li>
<li><a class="" href="r-on-network-drives.html"><span class="header-section-number">48</span> R on network drives</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="iteration-and-loops" class="section level1" number="16">
<h1>
<span class="header-section-number">16</span> Iteration and loops<a class="anchor" aria-label="anchor" href="#iteration-and-loops"><i class="fas fa-link"></i></a>
</h1>
<p>This page will introduce two approaches to iterative operations - using <em>for loops</em> and using the package <strong>purrr</strong>. Iterative operations help you perform repetitive tasks, reduce the chances of error, reduce code length, and maximize efficiency.</p>
<ol style="list-style-type: decimal">
<li>
<em>for loops</em> are a common tool in programming languages, but less so in R because it relies more on functions (still worth understanding though!)<br>
</li>
<li>
<strong>purrr</strong> operations can replace most <em>for loops</em> with more clear code</li>
</ol>
<!-- ======================================================= --><div id="preparation-5" class="section level2" number="16.1">
<h2>
<span class="header-section-number">16.1</span> Preparation<a class="anchor" aria-label="anchor" href="#preparation-5"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Load packages</strong></p>
<div class="sourceCode" id="cb655"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span>
     <span class="va">rio</span>,
     <span class="va">here</span>, 
     <span class="va">purrr</span>,
     <span class="va">tidyverse</span>
<span class="op">)</span></code></pre></div>
<p><strong>Load data</strong></p>
<div class="sourceCode" id="cb656"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"linelist_cleaned.xlsx"</span><span class="op">)</span></code></pre></div>
<p>The first 50 rows are displayed:</p>
<div id="htmlwidget-488825c6a34db4dfa64d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-488825c6a34db4dfa64d">{"x":{"filter":"none","data":[["a3c8b8","d8a13d","5fe599","8689b7","11f8ea","893f25","be99c8","d0523a","ce9c02","275cc7","07e3e8","8a4580","2b8773","057e7a","be502d","4cff96","bab455","a6c614","c15f36","2eaa9a","2ebf95","c36eb4","02d8fd","af9f9a","88eff2","f50e8a","bc648d","567136","b799eb","67184b","170473","42e1a9","64c8ef","8ebf6e","e56412","0b46a0","188619","62a2ef","da8ecb","148f18","a9feb3","92ab68","58b968","f81362","6670a5","92ddf7","386dfb","3ad520","ae50c8","2ed605"],[4,4,4,4,2,3,3,7,5,5,4,4,5,7,5,6,5,5,5,5,6,8,9,6,5,10,9,6,5,6,7,12,6,7,9,9,7,9,5,6,6,8,10,8,9,9,9,7,9,9],["2014-05-07","2014-05-06","2014-05-08",null,null,"2014-05-18","2014-05-03","2014-05-20","2014-05-27","2014-05-24","2014-05-22",null,"2014-05-31","2014-06-04","2014-06-09","2014-06-05",null,"2014-06-05",null,"2014-06-07",null,"2014-06-15","2014-06-14",null,null,null,null,null,"2014-06-27",null,"2014-07-05",null,null,"2014-07-02","2014-07-12","2014-07-12","2014-07-05","2014-07-02","2014-06-20",null,"2014-06-29",null,"2014-07-18",null,"2014-07-18","2014-07-19","2014-07-19","2014-07-12","2014-07-20","2014-07-27"],["2014-05-08","2014-05-08","2014-05-13","2014-05-13","2014-05-16","2014-05-21","2014-05-22","2014-05-24","2014-05-27","2014-05-27","2014-05-27","2014-06-02","2014-06-06","2014-06-14","2014-06-15","2014-06-15","2014-06-15","2014-06-16","2014-06-17","2014-06-17","2014-06-19","2014-06-20","2014-06-20","2014-06-20","2014-06-20","2014-06-22","2014-06-30","2014-07-02","2014-07-03","2014-07-04","2014-07-09","2014-07-12","2014-07-14","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-19","2014-07-19","2014-07-20","2014-07-20","2014-07-20","2014-07-23","2014-07-23","2014-07-24","2014-07-25","2014-07-28"],["2014-05-10","2014-05-10","2014-05-15","2014-05-14","2014-05-18","2014-05-22","2014-05-23","2014-05-26","2014-05-29","2014-05-28","2014-05-29","2014-06-02","2014-06-07","2014-06-15","2014-06-16","2014-06-16","2014-06-16","2014-06-18","2014-06-19","2014-06-17","2014-06-21","2014-06-21","2014-06-20","2014-06-20","2014-06-21","2014-06-23","2014-07-02","2014-07-03","2014-07-05","2014-07-06","2014-07-10","2014-07-14","2014-07-15","2014-07-14","2014-07-17","2014-07-16","2014-07-19","2014-07-19","2014-07-20","2014-07-20","2014-07-21","2014-07-20","2014-07-21","2014-07-21","2014-07-22","2014-07-25","2014-07-23","2014-07-24","2014-07-27","2014-07-30"],["2014-05-14",null,null,"2014-05-18","2014-05-30","2014-05-29","2014-05-24","2014-06-05","2014-06-17","2014-06-07","2014-06-01",null,"2014-06-16",null,"2014-06-19","2014-06-25","2014-06-18","2014-06-26","2014-06-28",null,"2014-06-23","2014-06-24","2014-07-01","2014-07-13","2014-06-24","2014-07-01","2014-07-14","2014-07-07","2014-07-12","2014-07-09","2014-08-09","2014-07-20","2014-07-25","2014-07-27","2014-07-19","2014-08-11","2014-07-24","2014-07-23","2014-08-01","2014-07-23","2014-08-03","2014-08-05","2014-07-28","2014-08-07","2014-08-01",null,null,null,"2014-08-08","2014-08-09"],["Recover",null,null,"Recover","Recover","Recover","Recover",null,"Death","Death","Recover","Death",null,"Recover","Death",null,"Death","Recover","Recover","Recover","Death","Death","Death",null,"Death",null,"Recover",null,"Recover","Death","Recover","Death","Recover","Recover","Death","Recover","Death","Death",null,"Death","Death",null,null,"Death","Death","Recover","Recover",null,"Death",null],["m","f","m","f","m","m","f","f","m","f","f","m","f","f","m","m","f","f","f","f","m","m","m","f","f","f","m","m","m","m","f","f","m","f","f","f","m","f","m","f","f","f","m","m","f","m","f","f","f","f"],[1,4,21,2,27,25,18,2,20,4,22,7,7,18,33,34,12,31,0,3,3,51,51,9,15,8,35,37,34,15,35,9,30,9,23,13,25,14,39,1,14,12,14,28,13,6,42,10,6,10],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[1,4,21,2,27,25,18,2,20,4,22,7,7,18,33,34,12,31,0,3,3,51,51,9,15,8,35,37,34,15,35,9,30,9,23,13,25,14,39,1,14,12,14,28,13,6,42,10,6,10],["0-4","0-4","20-29","0-4","20-29","20-29","15-19","0-4","20-29","0-4","20-29","5-9","5-9","15-19","30-49","30-49","10-14","30-49","0-4","0-4","0-4","50-69","50-69","5-9","15-19","5-9","30-49","30-49","30-49","15-19","30-49","5-9","30-49","5-9","20-29","10-14","20-29","10-14","30-49","0-4","10-14","10-14","10-14","20-29","10-14","5-9","30-49","10-14","5-9","10-14"],["0-4","0-4","20-24","0-4","25-29","25-29","15-19","0-4","20-24","0-4","20-24","5-9","5-9","15-19","30-34","30-34","10-14","30-34","0-4","0-4","0-4","50-54","50-54","5-9","15-19","5-9","35-39","35-39","30-34","15-19","35-39","5-9","30-34","5-9","20-24","10-14","25-29","10-14","35-39","0-4","10-14","10-14","10-14","25-29","10-14","5-9","40-44","10-14","5-9","10-14"],["Port Hospital","St. Mark's Maternity Hospital (SMMH)","Other","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Missing","Port Hospital","Central Hospital","Missing","Military Hospital","Missing","Missing","Military Hospital","Port Hospital","Port Hospital","Other","Missing","Missing","Port Hospital","Port Hospital","Port Hospital","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Port Hospital","Port Hospital","Missing","Other","Military Hospital","Military Hospital","Central Hospital","Military Hospital","Central Hospital","Missing","Military Hospital","Central Hospital","Missing","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Other","Military Hospital","Missing","Military Hospital","Missing","Port Hospital","Military Hospital"],[-13.2231931914572,-13.2354719577436,-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2228638912441,-13.222625321098,-13.2565628977111,-13.2243703238737,-13.2369393782451,-13.2331547837254,-13.2222002700958,-13.2149474159902,-13.2180326141688,-13.2535215623253,-13.217651519706,-13.2372027220014,-13.2190654487695,-13.2189533374241,-13.209391925612,-13.2265780018024,-13.2619688324425,-13.2124311244169,-13.2371313571269,-13.2195578885261,-13.2336087079551,-13.2130045468176,-13.2160657166043,-13.2162953240809,-13.2355883289789,-13.247814368147,-13.2142410663192,-13.2614705796373,-13.2630592726116,-13.2343341712241,-13.2087039682346,-13.2581175859281,-13.2379376608352,-13.218781651651,-13.2483677722899,-13.2155668757305,-13.2333516655879,-13.238964614443,-13.2163318124535,-13.2217866965605,-13.2221173306518,-13.2510797882678,-13.262635786914,-13.2472895700622,-13.2597714344876],[8.47325128269697,8.4627682729487,8.46897295100924,8.45171855856465,8.46481700596819,8.46082377490923,8.46183062600728,8.48379248016347,8.47024789713924,8.46916113869591,8.46272931462646,8.46388925014565,8.45192988292173,8.47155535608018,8.45884880725177,8.46236804334872,8.46956119136946,8.47737640975659,8.45136291368722,8.47570184950483,8.48676680560442,8.48475855218221,8.45344099552146,8.48777544809491,8.46210832824745,8.47804840685363,8.47135450705077,8.48802917129884,8.46395131808455,8.4728562695215,8.47038713612408,8.4641347894342,8.45750552360835,8.47493999153642,8.47832062438022,8.4763997148275,8.45535258467199,8.4697737543226,8.48438437371817,8.48466158574339,8.4627846208641,8.46517148129756,8.48776686246878,8.4630635336683,8.4623972994508,8.46420961833913,8.47178418137766,8.4632880274758,8.48450777619227,8.45925216791802],["2ae019","20b688","f547d6",null,null,"11f8ea","aec8ec","4b38b7","53da57","e02f66","893f25",null,"5387a2","cbbe78","a2086d","ba7326",null,"3ff1bc",null,"9f6884",null,"057e7a","e61cb9",null,null,null,null,null,"ea3740",null,"71577a",null,null,"567136","894024","894024","71577a","b0c500","eb2277",null,"af1c1f",null,"62a2ef",null,"67be4e","d15be5","f36522","312ecf","26c588","e26da6"],["other","other","other",null,null,"other","other","other","other","other","other",null,"other","funeral","other","other",null,"funeral",null,"other",null,"other","other",null,null,null,null,null,"other",null,"other",null,null,"other","funeral","funeral","other","other","funeral",null,"other",null,"other",null,"other","other","other","other","other","other"],[18,35,78,18,68,66,57,25,64,41,72,45,29,53,71,77,52,71,0,35,45,82,92,34,40,42,67,75,66,52,84,39,66,52,55,60,67,59,75,28,61,55,77,68,51,44,88,46,33,53],[50,74,148,61,198,161,116,48,156,75,144,109,99,140,157,146,118,162,22,62,58,195,257,114,144,96,206,172,176,125,229,88,177,88,150,151,169,136,186,24,124,147,163,167,152,89,188,112,72,139],[22,21,22,23,21,21,22,20,22,23,22,20,22,22,21,22,22,23,23,21,23,20,22,22,22,22,22,22,22,22,23,23,23,22,23,23,20,22,21,22,23,23,23,20,21,21,22,21,22,23],[null,"no","no",null,null,"no",null,"no","no","no","no","no","no","no",null,null,null,"no","no",null,"no","no","no","no","no",null,"no",null,null,"no",null,null,"no",null,"no","no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no"],[null,"no","yes",null,null,"no",null,"yes","no","no","no","no","yes","yes",null,null,null,"no","no",null,"no","no","no","no","no",null,"no",null,null,"no",null,null,"yes",null,"no","no","no","yes","no","no","no","yes","yes","yes","no","no",null,"no","no","yes"],[null,"yes","yes",null,null,"yes",null,"no","yes","yes","yes","no","yes","yes",null,null,null,"yes","yes",null,"yes","no","yes","yes","yes",null,"yes",null,null,"yes",null,null,"yes",null,"no","yes","yes","yes","yes","no","yes","yes","no","yes","yes","yes",null,"yes","yes","yes"],[null,"no","yes",null,null,"no",null,"no","no","no","no","no","no","no",null,null,null,"no","no",null,"no","no","no","no","no",null,"no",null,null,"no",null,null,"no",null,"no","no","no","no","no","no","no","no","yes","no","no","yes",null,"no","no","no"],[null,"yes","yes",null,null,"yes",null,"yes","yes","no","yes","no","yes","yes",null,null,null,"no","yes",null,"no","yes","yes","no","yes",null,"yes",null,null,"yes",null,null,"no",null,"yes","yes","no","no","no","no","yes","yes","no","yes","no","no",null,"no","yes","no"],[37.3,37.4,37,36,36.7,37.3,36.8,37,36.4,37.2,37.3,36.9,37,36.9,37.3,37.1,36.7,36.6,37.7,37.6,36.8,36.9,36.6,37.7,37,36.4,36.4,37.4,36.3,37,37.5,37.8,36.8,37.5,37.4,36.5,37.2,36.6,37.3,36.3,37.2,36.9,36.4,36.4,36.2,37,37.2,37.3,36.4,37.5],["20:35","14:16","09:17","11:32","18:52","16:51",null,"14:29","11:57","09:21","13:08","23:20","17:29",null,"18:39",null,"14:16",null,"08:00","11:43","11:10","15:10","11:53","19:11",null,"14:26","04:17","17:32",null,null,"12:28",null,"10:12","10:39","16:46","19:50","16:06","13:52","11:28","07:40","12:60","15:24","06:27","06:17","09:36","14:01","17:06","12:57","13:07",null],[72,63.9152666179693,35.6099342585829,48.3740929857565,17.3451688603204,25.4619806334632,42.3602853745541,108.506944444444,26.2984878369494,72.8888888888889,34.7222222222222,37.8755996969952,29.5888174676053,27.0408163265306,28.8044139721693,36.1231000187652,37.3455903476013,27.0538027739674,0,91.05098855359,133.769322235434,21.5647600262985,13.9290526730155,26.1618959679902,19.2901234567901,45.5729166666667,15.7884814779904,25.3515413737155,21.3068181818182,33.28,16.018001182281,50.3615702479339,21.0667432730058,67.1487603305785,24.4444444444444,26.3146353230121,23.458562375267,31.8987889273356,21.6788067984738,486.111111111111,39.6722164412071,25.4523578138738,28.9811434378411,24.3823729785937,22.0740997229917,55.5485418507764,24.8981439565414,36.6709183673469,63.6574074074074,27.431292376171],[2,2,2,1,2,1,1,2,2,1,2,0,1,1,1,1,1,2,2,0,2,1,0,0,1,1,2,1,2,2,1,2,1,0,2,0,2,2,2,1,2,1,1,1,2,2,0,0,2,2]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><!-- ======================================================= -->
</div>
<div id="for-loops" class="section level2" number="16.2">
<h2>
<span class="header-section-number">16.2</span> <em>for loops</em><a class="anchor" aria-label="anchor" href="#for-loops"><i class="fas fa-link"></i></a>
</h2>
<p>As an epidemiologist, it is a common need to repeat analyses on sub-groups (e.g. jurisdictions or sub-populations). Iterating with a <em>for loop</em> is one method to automate this process.</p>
<p>A <em>for loop</em> has three core parts:</p>
<ol style="list-style-type: decimal">
<li>The <strong>container</strong> for the results (optional)<br>
</li>
<li>The <strong>sequence</strong> of items to iterate through<br>
</li>
<li>The <strong>operations</strong> to conduct per item in the sequence</li>
</ol>
<p>The basic syntax is: <code>for (item in sequence) {do operations using item}</code>. Note the parentheses and the curly brackets. The results could be printed to console, or stored in a container R object.</p>
<div id="container" class="section level3 unnumbered">
<h3>Container<a class="anchor" aria-label="anchor" href="#container"><i class="fas fa-link"></i></a>
</h3>
<p>Sometimes the results of your <em>for loop</em> will be printed to the console or Plots pane. Other times, you will want to store the outputs in a container for later use. Such a container could be a vector, a data frame, or even a list.</p>
<p>It is most efficient to create the container for the results <em>before</em> even beginning the <em>for loop</em>. In practice, this means creating an empty vector, data frame, or list. These can be created with the functions <code><a href="https://rdrr.io/r/base/vector.html">vector()</a></code> for vectors or lists, or with <code><a href="https://rdrr.io/r/base/matrix.html">matrix()</a></code> and <code><a href="https://rdrr.io/r/base/data.frame.html">data.frame()</a></code> for a data frame.</p>
<p><strong>Empty vector</strong><br>
Say you want to store the median delay-to-admission for each hospital in a new vector. Use <code><a href="https://rdrr.io/r/base/vector.html">vector()</a></code> and specify the class as either “double” (to hold numbers), “character”, or “logical”. In this case we would use “double” and set the length to be the number of expected outputs (length of the <em>sequence</em>, or in this case the number of unique hospitals in the data set).</p>
<div class="sourceCode" id="cb657"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">delays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"double"</span>,
                 length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># this is the number of unique hospitals in the dataset</span></code></pre></div>
<p><strong>Empty data frame</strong></p>
<p>You can make an empty data frame by specifying the number of rows and columns like this:</p>
<div class="sourceCode" id="cb658"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">delays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><strong>Empty list</strong></p>
<p>Say you want to store some plots created by a <em>for loop</em> in a list. You actually initialize the container using the same <code><a href="https://rdrr.io/r/base/vector.html">vector()</a></code> command as above, but with <code>mode = "list"</code>. Specify the length however you wish.</p>
<div class="sourceCode" id="cb659"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></code></pre></div>
</div>
<div id="sequence" class="section level3 unnumbered">
<h3>Sequence<a class="anchor" aria-label="anchor" href="#sequence"><i class="fas fa-link"></i></a>
</h3>
<p>This is the “for” part of a <em>for loop</em> - the operations will run for each item in the sequence. The sequence can be a series of character values (e.g. of jurisdictions, diseases, etc), or R object names (e.g. column names or list element names), or the sequence can be a series of consecutive numbers (e.g. 1,2,3,4,5). Each approach has their own utilities, described below.</p>
<p><strong>Sequence of character values</strong></p>
<p>In this case, the loop is applied for each value in a character vector.</p>
<div class="sourceCode" id="cb660"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make vector of the hospital names</span>
<span class="va">hospital_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span>
<span class="va">hospital_names</span> <span class="co"># print</span></code></pre></div>
<pre><code>## [1] "Port Hospital"                        "St. Mark's Maternity Hospital (SMMH)" "Other"                               
## [4] "Missing"                              "Military Hospital"                    "Central Hospital"</code></pre>
<p>The value of the “item”, whose value changes each iteration of the loop, proceeds through each value in the character vector. In this example, the term <code>hosp</code> represents a value from the vector <code>hospital_names</code>. For the first iteration of the loop the value would be “Port Hospital”. TFor the second loop it would be “St. Mark’s Maternity Hospital (SMMH)”. And so on…</p>
<div class="sourceCode" id="cb662"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 'for loop'</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">hosp</span> <span class="kw">in</span> <span class="va">hospital_names</span><span class="op">)</span><span class="op">{</span>       <span class="co"># sequence</span>
  
  <span class="co"># OPERATIONS HERE</span>
  
<span class="op">}</span></code></pre></div>
<p><strong>Sequence of names</strong></p>
<p>This is a variation on the character sequence above, in which the names of an existing R object are extracted and become the character vector. For example, the column names of a data frame. This is useful because you know the names are exact matches to the column names and thus can be used to <em>index</em> the R object within the <em>for loop</em>.</p>
<p>Below, the sequence is the <code><a href="https://rdrr.io/r/base/names.html">names()</a></code> (column names) of <code>linelist</code>. Inside the <em>for loop</em>, the column names are used to <em>index</em> (subset) <code>linelist</code> one-at-a-time. In this example, we demonstrate an <em>if</em> conditional statement as part of the operations code within the <em>for loop</em>. <strong>If</strong> the column of interest is class Numeric, then the mean of the column is printed to the console. If the column is not class Numeric then another statement is printed to the console.</p>
<p><em>A note on indexing with column names</em> - whenever referencing the column itself (e.g. within <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code>) <em>do not just write “col”! <code>col</code> is just the character column name! To refer to the entire column you use the column name as an </em>index* on <code>linelist</code> via <code>linelist[[col]]</code>.</p>
<div class="sourceCode" id="cb663"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span><span class="op">)</span><span class="op">{</span> 
  
  <span class="co"># if column is class Numeric, print the mean value</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>     <span class="co"># don't forget to index with [[col]]</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>        
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Column not numeric"</span><span class="op">)</span>            <span class="co"># if column is not numeric, print this</span>
  <span class="op">}</span>
  
<span class="op">}</span></code></pre></div>
<pre><code>## [1] "Column not numeric"
## [1] 16.56165081521739
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] 16.20082744354422
## [1] "Column not numeric"
## [1] 16.14425673734414
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] -13.23380634001095
## [1] 8.469637508784336
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] 53.14758831521739
## [1] 124.7961956521739
## [1] 21.19412364130435
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] "Column not numeric"
## [1] 38.54143924908743
## [1] "Column not numeric"
## [1] 48.11272478311054
## [1] 2.011888586956522</code></pre>
<p><strong>Sequence of numbers</strong></p>
<p>Use this approach if you plan to do more complicated operations or to store the results of the <em>for loop</em>. In this approach, the sequence is a series of consecutive numbers. Thus, the value of the “item” is not a character value (e.g. “Central Hospital” or “date_onset”) but is a number. This is useful for looping through data frames, as you can use the numeric item inside the <em>for loop</em> to index the dataframe by <em>row number</em>.</p>
<p>For example, let’s say that you want to loop over every row in your data frame and extract certain information. Your “items” would be numeric row numbers. The process could be explained as “for every item in a sequence of numbers from 1 to the total number of rows in my data frame, do X”. The first iteration of the loop, <code>i</code> would be 1. For the second iteration, <code>i</code> would be 2, etc.</p>
<p>Whew, that was a mouthful of words! Here is what it looks like in code: <code>for (i in seq_len(nrow(linelist)) {}</code> where <code>i</code> represents the item and <code><a href="https://rdrr.io/r/base/seq.html">seq_len()</a></code> produces a sequence of consecutive numbers from 1 to the number of rows in <code>linelist</code>. If using this approach on a named vector (not a data frame), use <code><a href="https://rdrr.io/r/base/seq.html">seq_along()</a></code>, like <code>for (i in seq_along(hospital_names) {}</code>.</p>
<div class="sourceCode" id="cb665"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb665-1"><a href="iteration-and-loops.html#cb665-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(linelist)) {  <span class="co"># use on a data frame</span></span>
<span id="cb665-2"><a href="iteration-and-loops.html#cb665-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># OPERATIONS HERE</span></span>
<span id="cb665-3"><a href="iteration-and-loops.html#cb665-3" aria-hidden="true" tabindex="-1"></a>}  </span></code></pre></div>
<p>The below code actually returns numbers, which become the value of <code>i</code> in their respective loop.</p>
<div class="sourceCode" id="cb666"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">hospital_names</span><span class="op">)</span>  <span class="co"># use on a named vector</span></code></pre></div>
<pre><code>## [1] 1 2 3 4 5 6</code></pre>
</div>
<div id="operations" class="section level3 unnumbered">
<h3>Operations<a class="anchor" aria-label="anchor" href="#operations"><i class="fas fa-link"></i></a>
</h3>
<p>This is code within the <em>for loop</em>. You want this to run for each item in the <em>sequence</em>. Therefore, be careful that every part of your code that changes by the item is correctly coded such that it changes! Remember to use <code>[[ ]]</code> for indexing. For example,</p>
<p>Below, we use <code><a href="https://rdrr.io/r/base/seq.html">seq_len()</a></code> on the linelist. The gender and age of each row is pasted together and stored the container character vector <code>cases_demographics</code>.</p>
<div class="sourceCode" id="cb668"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create container to store results - a character vector</span>
<span class="va">cases_demographics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"character"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span><span class="op">)</span>

<span class="co"># the for loop</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  
  <span class="co"># OPERATIONS</span>
  <span class="co"># extract values from linelist for i using indexing</span>
  <span class="va">row_gender</span>  <span class="op">&lt;-</span> <span class="va">linelist</span><span class="op">$</span><span class="va">gender</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>
  <span class="va">row_age</span>     <span class="op">&lt;-</span> <span class="va">linelist</span><span class="op">$</span><span class="va">age_years</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>    <span class="co"># don't forget to index!</span>
  
  <span class="co"># store the gender-age in container at indexed location</span>
  <span class="va">cases_demographics</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">str_c</span><span class="op">(</span><span class="va">row_gender</span>, <span class="va">row_age</span>, sep <span class="op">=</span> <span class="st">", "</span><span class="op">)</span> 

<span class="op">}</span>  <span class="co"># end for loop</span>

<span class="co"># display first 10 rows of container</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cases_demographics</span>, <span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "m, 1"  "f, 4"  "m, 21" "f, 2"  "m, 27" "m, 25" "f, 18" "f, 2"  "m, 20" "f, 4"</code></pre>
</div>
<div id="printing" class="section level3 unnumbered">
<h3>Printing<a class="anchor" aria-label="anchor" href="#printing"><i class="fas fa-link"></i></a>
</h3>
<p>Note that to print from within a <em>for loop</em> you will likely need to explicitly wrap with the function <code><a href="https://rdrr.io/r/base/print.html">print()</a></code>.</p>
<p>In this example below, the sequence is an explicit character vector, which is used to subset the linelist by hospital.The results are not stored in a container, but rather print to console with the <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> function.</p>
<div class="sourceCode" id="cb670"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span> <span class="op">(</span><span class="va">hosp</span> <span class="kw">in</span> <span class="va">hospital_names</span><span class="op">)</span><span class="op">{</span> 
  <span class="va">hospital_cases</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">hosp</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">hospital_cases</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<pre><code>## [1] 1762
## [1] 422
## [1] 885
## [1] 1469
## [1] 896
## [1] 454</code></pre>
</div>
<div id="testing-your-for-loop" class="section level3 unnumbered">
<h3>Testing your for loop<a class="anchor" aria-label="anchor" href="#testing-your-for-loop"><i class="fas fa-link"></i></a>
</h3>
<p>To test your loop, you can make a temporarily assignment of the item, such as <code>i &lt;- 10</code> or <code>hosp &lt;- "Central Hospital"</code> and run your operations code to see if the expected results are produced.</p>
</div>
<div id="looping-plots" class="section level3 unnumbered">
<h3>Looping plots<a class="anchor" aria-label="anchor" href="#looping-plots"><i class="fas fa-link"></i></a>
</h3>
<p>To put all three components together (container, sequence, and operations) let’s try to plot an epicurve for each hospital (see page on <a href="epidemic-curves.html#epidemic-curves">Epidemic curves</a>.</p>
<p>Of course, we can make an epicurve of all the cases using the <strong>incidence2</strong> package as below:</p>
<div class="sourceCode" id="cb672"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create 'incidence' object</span>
<span class="va">outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/incidence2/man/incidence.html">incidence</a></span><span class="op">(</span>   
     x <span class="op">=</span> <span class="va">linelist</span>,                   <span class="co"># dataframe - complete linelist</span>
     date_index <span class="op">=</span> <span class="va">date_onset</span>,        <span class="co"># date column</span>
     interval <span class="op">=</span> <span class="st">"week"</span>,              <span class="co"># aggregate counts weekly</span>
     groups <span class="op">=</span> <span class="va">gender</span>,                <span class="co"># group values by gender</span>
     na_as_group <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>             <span class="co"># missing gender is own group</span>

<span class="co"># plot epi curve</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">outbreak</span>,                       <span class="co"># name of incidence object</span>
     fill <span class="op">=</span> <span class="st">"gender"</span>,                <span class="co"># color bars by gender</span>
     color <span class="op">=</span> <span class="st">"black"</span>,                <span class="co"># outline color of bars</span>
     title <span class="op">=</span> <span class="st">"Outbreak of ALL cases"</span> <span class="co"># title</span>
     <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-483-1.png" width="672"></div>
<p>To produce a separate plot for each hospital’s cases, we can put this epicurve code within a <em>for loop</em>.</p>
<p>First, we save a named vector of the unique hospital names, <code>hospital_names</code>. The <em>for loop</em> will run once for each of these names (<code>for (hosp in hospital_names)</code>). Each iteration of the <em>for loop</em>, the current hospital name from the vector will be represented as “hosp” for use within the loop.</p>
<p>Within the loop, you can write R code as normal, but use the item (<code>hosp</code> in this case) knowing that its value will be changing. Within this loop:</p>
<ul>
<li>A <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> is applied to <code>linelist</code>, such that column <code>hospital</code> must equal the current value of <code>hosp</code><br>
</li>
<li>The incidence object is created on the filtered linelist<br>
</li>
<li>The plot for the current hospital is created, with an auto-adjusting title<br>
</li>
<li>The plot for the current hospital is temporarily saved and then printed<br>
</li>
<li>The loop then moves onward to repeat with the next hospital in <code>hospital_names</code>
</li>
</ul>
<div class="sourceCode" id="cb673"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make vector of the hospital names</span>
<span class="va">hospital_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span>

<span class="co"># for each name ("hosp") in hospital_names, create and print the epi curve</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">hosp</span> <span class="kw">in</span> <span class="va">hospital_names</span><span class="op">)</span> <span class="op">{</span>
     
     <span class="co"># create incidence object specific to the current hospital</span>
     <span class="va">outbreak_hosp</span> <span class="op">&lt;-</span> <span class="fu">incidence2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/incidence2/man/incidence.html">incidence</a></span><span class="op">(</span>
                    x <span class="op">=</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">hosp</span><span class="op">)</span>,   <span class="co"># linelist is filtered to the current hospital</span>
                    date_index <span class="op">=</span> <span class="va">date_onset</span>,
                    interval <span class="op">=</span> <span class="st">"week"</span>, 
                    groups <span class="op">=</span> <span class="va">gender</span>,
                    na_as_group <span class="op">=</span> <span class="cn">TRUE</span>
     <span class="op">)</span>
     
     <span class="co"># Create and save the plot. Title automatically adjusts to the current hospital</span>
     <span class="va">plot_hosp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">outbreak_hosp</span>,
                       fill <span class="op">=</span> <span class="st">"gender"</span>,
                       color <span class="op">=</span> <span class="st">"black"</span>,
                       title <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"Epidemic of cases admitted to {hosp}"</span><span class="op">)</span>
                       <span class="op">)</span>
     
     <span class="co"># print the plot for the current hospital</span>
     <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">plot_hosp</span><span class="op">)</span>

<span class="op">}</span> <span class="co"># end the for loop when it has been run for every hospital in hospital_names </span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-484-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-484-2.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-484-3.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-484-4.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-484-5.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-484-6.png" width="50%"></p>
</div>
<div id="tracking-progress-of-a-loop" class="section level3 unnumbered">
<h3>Tracking progress of a loop<a class="anchor" aria-label="anchor" href="#tracking-progress-of-a-loop"><i class="fas fa-link"></i></a>
</h3>
<p>A loop with many iterations can run for many minutes or even hours. Thus, it can be helpful to print the progress to the R console. This code can be placed <em>within</em> the loop to print every 100th number.</p>
<div class="sourceCode" id="cb674"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb674-1"><a href="iteration-and-loops.html#cb674-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loop with code to print progress every 100 iterations</span></span>
<span id="cb674-2"><a href="iteration-and-loops.html#cb674-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (row <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(linelist)){</span>
<span id="cb674-3"><a href="iteration-and-loops.html#cb674-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb674-4"><a href="iteration-and-loops.html#cb674-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print progress</span></span>
<span id="cb674-5"><a href="iteration-and-loops.html#cb674-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(row <span class="sc">%%</span> <span class="dv">100</span><span class="sc">==</span><span class="dv">0</span>){    <span class="co"># The %% operator is the remainder</span></span>
<span id="cb674-6"><a href="iteration-and-loops.html#cb674-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(row)</span>
<span id="cb674-7"><a href="iteration-and-loops.html#cb674-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb674-8"><a href="iteration-and-loops.html#cb674-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<!-- ======================================================= -->
</div>
</div>
<div id="purrr" class="section level2" number="16.3">
<h2>
<span class="header-section-number">16.3</span> <strong>purrr</strong><a class="anchor" aria-label="anchor" href="#purrr"><i class="fas fa-link"></i></a>
</h2>
<p>One approach to iterative operations is the <strong>purrr</strong> package. If you are using a <em>for loop</em>, you can probably do it with <strong>purrr</strong>! For example, applying a model to different datasets, producing plots or maps for various jurisdictions, or iterating data management tasks (across columns or subsets).</p>
<p>In this section we will explain the basic syntax and a few key functions, and demonstrate the use by making plots and by performing data operations such as importing/exporting multiple Excel sheets and CSV files.</p>
<p>See the Resource section for more extensive trainings. Also, here is the <strong>purrr</strong> online <a href="https://raw.githubusercontent.com/rstudio/cheatsheets/master/pngs/thumbnails/purrr-cheatsheet-thumbs.png">cheatsheet</a>.</p>
<div id="load-packages-3" class="section level3 unnumbered">
<h3>Load packages<a class="anchor" aria-label="anchor" href="#load-packages-3"><i class="fas fa-link"></i></a>
</h3>
<p><strong>purrr</strong> is part of the <strong>tidyverse</strong>, so there is no need to install/load a separate package.</p>
<div class="sourceCode" id="cb675"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span>
  <span class="va">rio</span>,            <span class="co"># import/export</span>
  <span class="va">here</span>,           <span class="co"># relative filepaths</span>
  <span class="va">tidyverse</span>,      <span class="co"># data mgmt and viz</span>
  <span class="va">writexl</span>,        <span class="co"># write Excel file with multiple sheets</span>
  <span class="va">readxl</span>          <span class="co"># import Excel with multiple sheets</span>
  <span class="op">)</span></code></pre></div>
<p>One core <strong>purrr</strong> function is <code>map()</code>, which “maps” (applies) a function to each input element. There are several variations on <code>map()</code> for specific use cases, as detailed below.</p>
<p>The key arguments are:</p>
<ul>
<li>
<code>.x =</code> this is the input - e.g. a vector, data frame, or list upon which the <code>.f</code> function will be iteratively applied<br>
</li>
<li>
<code>.f =</code> this is the function to apply to each element of the <code>.x</code> input</li>
</ul>
<p>The basic form is <code>map(.x, ~.f)</code>, which in a pipe chain can also look like:</p>
<div class="sourceCode" id="cb676"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu">map</span><span class="op">(</span><span class="op">~</span><span class="va">.f</span><span class="op">)</span></code></pre></div>
<p>You may encounter the syntax <code>.x</code> (or simply <code>.</code>) <em>within</em> the <code>.f</code> function as a placeholder for the <code>.x</code> input of that iteration.</p>
</div>
<div id="mapping-a-function-across-columns" class="section level3 unnumbered">
<h3>Mapping a function across columns<a class="anchor" aria-label="anchor" href="#mapping-a-function-across-columns"><i class="fas fa-link"></i></a>
</h3>
<p>Below, we <code>map()</code> the function <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> across numeric columns, comparing values by gender. Recall from the page on <a href="time-series-and-outbreak-detection.html#descriptive-analysis-2">Descriptive analysis</a> that <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> can take inputs in a formula format, such as NUMERIC_COLUMN ~ BINARY COLUMN. In this example, we do the following:</p>
<ul>
<li>The numeric columns of interest are selected from <code>linelist</code> - these are the <code>.x</code> inputs<br>
</li>
<li>The function <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> is supplied as the <code>.f</code> function mapped to each numeric column (note tilde <code><a href="https://rdrr.io/r/base/tilde.html">~</a></code> in front)<br>
</li>
<li>Within the parentheses of <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code>:
<ul>
<li>the <code>.</code> represents the current column being mapped<br>
</li>
<li>the second <code><a href="https://rdrr.io/r/base/tilde.html">~</a></code> is part of the t-test equation<br>
</li>
<li>the <code>linelist$gender</code> is the binary column for t-test comparison, not is a separate column not included in <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> so that it is not included on the left side of the t.test equation.</li>
</ul>
</li>
</ul>
<p>The result is a list of t-test results - one element for each numeric column. <strong>Only the first one of six is shown for demonstration purposes.</strong></p>
<div class="sourceCode" id="cb677"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Results are saved as a list</span>
<span class="va">t.test_results</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">wt_kg</span>, <span class="va">ht_cm</span>, <span class="va">ct_blood</span>, <span class="va">temp</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># keep only the numeric columns to map across</span>
  <span class="fu">map</span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">~</span> <span class="va">linelist</span><span class="op">$</span><span class="va">gender</span><span class="op">)</span><span class="op">)</span>              <span class="co"># t.test function, with equation NUMERIC ~ CATEGORICAL</span>

<span class="va">t.test_results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># show first result </span></code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  .x by linelist$gender
## t = -22.813808812458, df = 4803.371114955, p-value &lt; 0.00000000000000022204460493
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -8.032928518914238 -6.761591694025840
## sample estimates:
##   mean in group f   mean in group m 
## 12.49840142095915 19.89566152742919</code></pre>
<p>If you wanted the p-values only, you can modify the <code>.f</code> function by appending <code>$p.value</code> to the <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> output. This way, the value that <code>map()</code> returns to it’s output list is only the p-value and not the entire t.test output.</p>
<div class="sourceCode" id="cb679"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">wt_kg</span>, <span class="va">ht_cm</span>, <span class="va">ct_blood</span>, <span class="va">temp</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">map</span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">linelist</span><span class="op">$</span><span class="va">gender</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span><span class="op">)</span></code></pre></div>
<pre><code>## $age
## [1] 0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001821713221074871
## 
## $wt_kg
## [1] 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005768922697194617
## 
## $ht_cm
## [1] 0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006116975742624153
## 
## $ct_blood
## [1] 0.7107848639794567
## 
## $temp
## [1] 0.5572371740897707</code></pre>
<p>Note:<br>
Remember that if you want to apply a function to only certain columns in a data frame, you can also use <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code>, as explained in the <a href="grouping-data.html#grouping-data">Grouping data</a> page. Below is an example of applying <code><a href="https://rdrr.io/r/base/character.html">as.character()</a></code> to only the “age” columns. Note the placement of the parentheses and commas.</p>
<div class="sourceCode" id="cb681"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># convert columns with column name containing "age" to class Character</span>
<span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"age"</span><span class="op">)</span>, <span class="va">as.character</span><span class="op">)</span><span class="op">)</span>  </code></pre></div>
</div>
<div id="custom-functions" class="section level3 unnumbered">
<h3>Custom functions<a class="anchor" aria-label="anchor" href="#custom-functions"><i class="fas fa-link"></i></a>
</h3>
<p>You will often want to create your own function to provide to <code>map()</code>. In fact, we already did this! While <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> was an existing function, when we used it in <code>map()</code> the second time we modified it by adding <code>$p.value</code> to the end, which in effect changed the function provided to <code>map()</code>.</p>
<p>One example of making a purely custom plotting function to provide to <code>map()</code> is shown below.</p>
<p>Let’s say we want to create simple epicurves for each hospital. To do this using <strong>purrr</strong>, our <code>.f</code> function can be <code>ggplot()</code> and extensions with <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> as usual. As the output of <code>map()</code> is always a list, the plots are stored in a list. They can be extracted and plotted with the <code>ggarrange()</code> function from the <strong>ggpubr</strong> package (<a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html">documentation</a>.</p>
<div class="sourceCode" id="cb682"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load package for plotting elements from list</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">ggpubr</span><span class="op">)</span>

<span class="co"># map across the vector of 6 hospital "names" (created earlier)</span>
<span class="co"># use the ggplot function specified</span>
<span class="co"># output is a list with 6 ggplots</span>

<span class="va">my_plots</span> <span class="op">&lt;-</span> <span class="fu">map</span><span class="op">(</span>
  .x <span class="op">=</span> <span class="va">hospital_names</span>,
  .f <span class="op">=</span> <span class="op">~</span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
                <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
                <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="va">.x</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># print the ggplots (they are stored in a list)</span>
<span class="fu">ggarrange</span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">my_plots</span>, ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-491-1.png" width="672"></div>
<p>If this code style looks too messy, you can achieve the same result by saving your specific <code>ggplot()</code> command as a custom user-defined function, for example we can name it <code>make_epicurve())</code>. This function is then used within the <code>map()</code>. <code>.x</code> will be iteratively replaced by the hospital name, and used as <code>hosp_name</code> in the <code>make_epicurve()</code> function. See the page on <a href="writing-functions.html#writing-functions">Writing functions</a>.</p>
<div class="sourceCode" id="cb683"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">make_epicurve</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">hosp_name</span><span class="op">)</span><span class="op">{</span>
  
  <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">hosp_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="va">hosp_name</span><span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb684"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># mapping</span>
<span class="va">my_plots</span> <span class="op">&lt;-</span> <span class="fu">map</span><span class="op">(</span><span class="va">hospital_names</span>, <span class="op">~</span><span class="fu">make_epicurve</span><span class="op">(</span>hosp_name <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span>

<span class="co"># print the ggplots (they are stored in a list)</span>
<span class="fu">ggarrange</span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">my_plots</span>, ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
</div>
<div id="split-and-combine-datasets" class="section level3 unnumbered">
<h3>Split and combine datasets<a class="anchor" aria-label="anchor" href="#split-and-combine-datasets"><i class="fas fa-link"></i></a>
</h3>
<div id="split-dataset-and-export-csv-files" class="section level4 unnumbered">
<h4>Split dataset and export CSV files<a class="anchor" aria-label="anchor" href="#split-dataset-and-export-csv-files"><i class="fas fa-link"></i></a>
</h4>
<p>Here is a more complex <strong>purrr</strong> <code>map()</code> example. Let’s say that we want to create a separate linelist for each hospital and export each as a separate CSV file. This is a task that would be arduous if done copy-paste by hand in Excel, and involve a lot of code if each <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> and <code>export()</code> was a distinct command (imagine if we wanted to make a linelist for each hospital-gender!).</p>
<p>Below, we do the following steps:</p>
<p>Use <code><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split()</a></code> (from <strong>dplyr</strong>) to split the <code>linelist</code> by hospital of admission - the output is a list with one “element” per hospital subset (in this case, each element is a dataframe)</p>
<div class="sourceCode" id="cb685"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist_split</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span></code></pre></div>
<p>You can <code><a href="https://rdrr.io/r/utils/View.html">View(linelsit_split)</a></code> and see that this list contains 6 dataframe each representing the cases from one hospital.</p>
<div class="inline-figure"><img src="images/purrr_linelist_split.png" width="574" style="display: block; margin: auto;"></div>
<p>However, note that the dataframes in the list do not have names! This is standard behavior of <code>map()</code>, but we want each to have a name, and to use that name when saving the CSV file. So, we use <code><a href="https://dplyr.tidyverse.org/reference/pull.html">pull()</a></code> (from <strong>purrr</strong>) to extract the ’hospital<code>column from each data frame in the list. Then, to be safe, we convert the values to character and then use</code>unique()` to get the name for the dataset.</p>
<div class="sourceCode" id="cb686"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">linelist_split</span> <span class="op">%&gt;%</span>
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">.x</span>,<span class="va">hospital</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Pull out Species variable</span>
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Convert factor to character</span>
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We can now see that each of the list elements has a name. These names can be access via <code><a href="https://rdrr.io/r/base/names.html">names(linelist_split)</a></code>.</p>
<div class="inline-figure"><img src="images/purrr_linelist_split_named.png" width="575" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb687"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Central Hospital"                     "Military Hospital"                    "Missing"                             
## [4] "Other"                                "Port Hospital"                        "St. Mark's Maternity Hospital (SMMH)"</code></pre>
<p>Lastly, we take the vector of names (shown above) and will use <code>map()</code> to iterate through them, applying <code>export()</code> function on that element of the list <code>linelist_split</code> and saving the correct name. Here is how it works:</p>
<ul>
<li>We begin with the vector of character names, passed to <code>map()</code> as <code>.x</code> (the sequence)<br>
</li>
<li>The <code>.f</code> function is <code>export()</code> (<strong>rio</strong> package, see <a href="import-and-export.html#import-and-export">Import and export</a> page), which needs a dataframe and a filepath to write to<br>
</li>
<li>The input <code>.x</code> (the hospital name) is used <em>within</em> <code>.f</code> to extract/index that specific element of <code>linelist_split</code> list. This results in only one data frame at a time being provided to <code>export()</code>.
<ul>
<li>For example, at “Military Hospital”, then <code>linelist_split[[.x]]</code> is actually <code>linelist_split[["Military Hospital"]]</code>, thus returning the second element of <code>linelist_split</code> - all the cases from that hospital.<br>
</li>
</ul>
</li>
<li>The filepath provided to <code>export()</code> is dynamic via use of <code>str_glue()</code> (see <a href="characters-and-strings.html#characters-and-strings">Characters and strings</a> page):
<ul>
<li>
<code>here()</code> is used to get the base of the filepath and specify the “data” folder (note single quotes to not interrupt the <code>str_glue()</code> double quotes)<br>
</li>
<li>Then a slash <code><a href="https://rdrr.io/r/base/Arithmetic.html">/</a></code>, and then again the <code>.x</code> which prints the current hospital name to make the file identifiable<br>
</li>
<li>Finally the extension “.csv” which <code>export()</code> uses to create a CSV file</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb689"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">map</span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu">export</span><span class="op">(</span><span class="va">linelist_split</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>, file<span class="op">=</span> <span class="fu">str_glue</span><span class="op">(</span><span class="st">"{here('data')}/{.x}.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now you can see that each file is saved in the “data” folder of the R Project “Epi_R_handbook”!</p>
<div class="inline-figure"><img src="images/purrr_export_csv.png" width="632" style="display: block; margin: auto;"></div>
</div>
<div id="split-dataset-and-export-as-excel-sheets" class="section level4 unnumbered">
<h4>Split dataset and export as Excel sheets<a class="anchor" aria-label="anchor" href="#split-dataset-and-export-as-excel-sheets"><i class="fas fa-link"></i></a>
</h4>
<p>To export the hospital linelists as <em>an Excel workbook with one linelist per sheet</em>, we can just provide the named list <code>linelist_split</code> to the <code>write_xlsx()</code> function from the <strong>writexl</strong> package. This has the ability to save one Excel workbook with multiple sheets. The list element names are automatically applied as the sheet names.</p>
<div class="sourceCode" id="cb690"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist_split</span> <span class="op">%&gt;%</span> 
  <span class="fu">writexl</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/writexl/reference/write_xlsx.html">write_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"hospital_linelists.xlsx"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>You can now open the Excel file and see that each hospital has its own sheet.</p>
<div class="inline-figure"><img src="images/purrr_export_sheets.png" width="652" style="display: block; margin: auto;"></div>
</div>
<div id="more-than-one-group_split-column" class="section level4 unnumbered">
<h4>More than one <code>group_split()</code> column<a class="anchor" aria-label="anchor" href="#more-than-one-group_split-column"><i class="fas fa-link"></i></a>
</h4>
<p>If you wanted to split the linelist by <em>more than one grouping column</em>, such as to produce subset linelist by intersection of hospital AND gender, you will need a different approach to naming the list elements. This involves collecting the unique “group keys” using <code><a href="https://dplyr.tidyverse.org/reference/group_data.html">group_keys()</a></code> from <strong>dplyr</strong> - they are returned as a data frame. Then you can combine the group keys into values with <code>unite()</code> as shown below, and assign these conglomerate names to <code>linelist_split</code>.</p>
<div class="sourceCode" id="cb691"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># split linelist by unique hospital-gender combinations</span>
<span class="va">linelist_split</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="va">gender</span><span class="op">)</span>

<span class="co"># extract group_keys() as a dataframe</span>
<span class="va">groupings</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="va">gender</span><span class="op">)</span> <span class="op">%&gt;%</span>       
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_data.html">group_keys</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">groupings</span>      <span class="co"># show unique groupings </span></code></pre></div>
<pre><code>## # A tibble: 18 x 2
##    hospital                             gender
##  * &lt;chr&gt;                                &lt;chr&gt; 
##  1 Central Hospital                     f     
##  2 Central Hospital                     m     
##  3 Central Hospital                     &lt;NA&gt;  
##  4 Military Hospital                    f     
##  5 Military Hospital                    m     
##  6 Military Hospital                    &lt;NA&gt;  
##  7 Missing                              f     
##  8 Missing                              m     
##  9 Missing                              &lt;NA&gt;  
## 10 Other                                f     
## 11 Other                                m     
## 12 Other                                &lt;NA&gt;  
## 13 Port Hospital                        f     
## 14 Port Hospital                        m     
## 15 Port Hospital                        &lt;NA&gt;  
## 16 St. Mark's Maternity Hospital (SMMH) f     
## 17 St. Mark's Maternity Hospital (SMMH) m     
## 18 St. Mark's Maternity Hospital (SMMH) &lt;NA&gt;</code></pre>
<p>Now we combine the groupings together, separated by dashes, and assign them as the names of list elements in <code>linelist_split</code>. This takes some extra lines as we replace <code>NA</code> with “Missing”, use <code>unite()</code> from <strong>dplyr</strong> to combine the column values together (separated by dashes), and then convert into an un-named vector so it can be used as names of <code>linelist_split</code>.</p>
<div class="sourceCode" id="cb693"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Combine into one name value </span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">groupings</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">replace_na</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># replace NA with "Missing" in all columns</span>
  <span class="fu">unite</span><span class="op">(</span><span class="st">"combined"</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span> <span class="op">%&gt;%</span>                         <span class="co"># Unite all column values into one</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">as_vector</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="reading-in-multiple-excel-sheets" class="section level4 unnumbered">
<h4>Reading in multiple Excel sheets<a class="anchor" aria-label="anchor" href="#reading-in-multiple-excel-sheets"><i class="fas fa-link"></i></a>
</h4>
<p>For reference, if you want to use <strong>purrr</strong> to import multiple Excel workbook sheets and combine them (the reverse of above), you can use the package <strong>readxl</strong> as demonstrated below.</p>
<p>First, extract the sheet names from the Excel workbook. Use <code>excel_sheets()</code> from the <strong>readxl</strong> package. You provide the filepath within the parentheses.</p>
<div class="sourceCode" id="cb694"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sheet_names</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/excel_sheets.html">excel_sheets</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"hospital_linelists.xlsx"</span><span class="op">)</span><span class="op">)</span>

<span class="va">sheet_names</span></code></pre></div>
<pre><code>## [1] "Central Hospital"              "Military Hospital"             "Missing"                       "Other"                        
## [5] "Port Hospital"                 "St. Mark's Maternity Hospital"</code></pre>
<p>Now we can use this vector of sheet names to iteratively <code>import()</code> the sheets. The argument used to import a specific Excel workbook sheet is given <code>.x</code>, which is the sheet name currently being mapped on. Finally, because we have used <code>map()</code>, the sheets have been saved as in a list - each data frame is one element in the list.</p>
<div class="sourceCode" id="cb696"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sheets_as_list</span> <span class="op">&lt;-</span> <span class="va">sheet_names</span> <span class="op">%&gt;%</span> 
  <span class="fu">map</span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"hospital_linelists.xlsx"</span><span class="op">)</span>, which <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Assuming each data frame has the same columns, we can combine the six data frames with a simple <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> command (from <strong>dplyr</strong>). Optionally, add <code>.id = "sheet_name"</code> to have a column specifying which sheet each row came from originally.</p>
<div class="sourceCode" id="cb697"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">combined_sheets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">sheets_as_list</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="resources-9" class="section level2" number="16.4">
<h2>
<span class="header-section-number">16.4</span> Resources<a class="anchor" aria-label="anchor" href="#resources-9"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://datacarpentry.org/semester-biology/materials/for-loops-R/">for loops with Data Carpentry</a></p>
<p>The <a href="https://r4ds.had.co.nz/iteration.html#iteration">R for Data Science page on iteration</a></p>
<p><a href="https://martinctc.github.io/blog/vignette-write-and-read-multiple-excel-files-with-purrr/">Vignette on write/read Excel files</a></p>
<p>A purrr <a href="https://jennybc.github.io/purrr-tutorial/index.html">tutorial</a></p>
<p><a href="https://raw.githubusercontent.com/rstudio/cheatsheets/master/pngs/thumbnails/purrr-cheatsheet-thumbs.png">purrr cheatsheet</a></p>
<p>TO DO
group_split
collapse
pluck</p>
<p>set_names()
vars = linelist %&gt;%
select_if(is.numeric) %&gt;%
select(-cyl, - year) %&gt;%
names() %&gt;%
set_names()</p>

</div>
</div>



<div class="chapter-nav">
<div class="prev"><a href="de-duplication.html"><span class="header-section-number">15</span> De-duplication</a></div>
<div class="next"><a href="missing-data.html"><span class="header-section-number">17</span> Missing data</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#iteration-and-loops"><span class="header-section-number">16</span> Iteration and loops</a></li>
<li><a class="nav-link" href="#preparation-5"><span class="header-section-number">16.1</span> Preparation</a></li>
<li>
<a class="nav-link" href="#for-loops"><span class="header-section-number">16.2</span> for loops</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#container">Container</a></li>
<li><a class="nav-link" href="#sequence">Sequence</a></li>
<li><a class="nav-link" href="#operations">Operations</a></li>
<li><a class="nav-link" href="#printing">Printing</a></li>
<li><a class="nav-link" href="#testing-your-for-loop">Testing your for loop</a></li>
<li><a class="nav-link" href="#looping-plots">Looping plots</a></li>
<li><a class="nav-link" href="#tracking-progress-of-a-loop">Tracking progress of a loop</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#purrr"><span class="header-section-number">16.3</span> purrr</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#load-packages-3">Load packages</a></li>
<li><a class="nav-link" href="#mapping-a-function-across-columns">Mapping a function across columns</a></li>
<li><a class="nav-link" href="#custom-functions">Custom functions</a></li>
<li><a class="nav-link" href="#split-and-combine-datasets">Split and combine datasets</a></li>
</ul>
</li>
<li><a class="nav-link" href="#resources-9"><span class="header-section-number">16.4</span> Resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>
</div>
  

  

</div>
 <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>The Epidemiologist R Handbook</strong>" was written by the handbook team. It was last built on 2021-03-09.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
