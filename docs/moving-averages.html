<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>18 Moving averages | R Handbook for Epidemiologists</title>
<meta name="author" content="the handbook team">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.6/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.15/datatables.js"></script><link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script><link href="libs/tabwid-1.0.0/tabwid.css" rel="stylesheet">
<script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.9.3/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-1.57.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-1.57.1/plotly-latest.min.js"></script><link href="libs/vis-4.20.1/vis.css" rel="stylesheet">
<script src="libs/vis-4.20.1/vis.min.js"></script><script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-1.57.1/plotly-basic-1.57.1.min.js"></script><script src="libs/plotly-cartesian-1.57.1/plotly-cartesian-1.57.1.min.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R Handbook for Epidemiologists</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome - THIS IS A DRAFT</a></li>
<li class="book-part">About this book</li>
<li><a class="" href="style-and-editorial-notes.html"><span class="header-section-number">1</span> Style and editorial notes</a></li>
<li><a class="" href="datasets-used.html"><span class="header-section-number">2</span> Datasets used</a></li>
<li class="book-part">Basics</li>
<li><a class="" href="r-basics.html"><span class="header-section-number">3</span> R Basics</a></li>
<li><a class="" href="importing-and-exporting.html"><span class="header-section-number">4</span> Importing and exporting</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">5</span> R projects</a></li>
<li><a class="" href="suggested-packages.html"><span class="header-section-number">6</span> Suggested packages</a></li>
<li class="book-part">Data Management</li>
<li><a class="" href="cleaning-data.html"><span class="header-section-number">7</span> Cleaning data</a></li>
<li><a class="" href="working-with-dates.html"><span class="header-section-number">8</span> Working with dates</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">9</span> Missing data</a></li>
<li><a class="" href="grouping-data.html"><span class="header-section-number">10</span> Grouping data</a></li>
<li><a class="" href="joining-data.html"><span class="header-section-number">11</span> Joining data</a></li>
<li><a class="" href="characters-and-strings.html"><span class="header-section-number">12</span> Characters and strings</a></li>
<li><a class="" href="de-duplication.html"><span class="header-section-number">13</span> De-duplication</a></li>
<li><a class="" href="iteration-and-loops.html"><span class="header-section-number">14</span> Iteration and loops</a></li>
<li class="book-part">Analysis</li>
<li><a class="" href="descriptive-analysis.html"><span class="header-section-number">15</span> Descriptive analysis</a></li>
<li><a class="" href="simple-statistical-tests.html"><span class="header-section-number">16</span> Simple statistical tests</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">17</span> Standardization</a></li>
<li><a class="active" href="moving-averages.html"><span class="header-section-number">18</span> Moving averages</a></li>
<li><a class="" href="outbreak-detection.html"><span class="header-section-number">19</span> Outbreak detection</a></li>
<li><a class="" href="time-series-analysis.html"><span class="header-section-number">20</span> Time series analysis</a></li>
<li><a class="" href="epidemic-modeling.html"><span class="header-section-number">21</span> Epidemic modeling</a></li>
<li><a class="" href="modeling.html"><span class="header-section-number">22</span> Modeling</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">23</span> Survey analysis</a></li>
<li><a class="" href="survival-analysis-1.html"><span class="header-section-number">24</span> Survival analysis</a></li>
<li><a class="" href="gis-basics.html"><span class="header-section-number">25</span> GIS basics</a></li>
<li class="book-part">Data Vizualization</li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">26</span> ggplot tips</a></li>
<li><a class="" href="epidemic-curves.html"><span class="header-section-number">27</span> Epidemic curves</a></li>
<li><a class="" href="plot-continuous-data.html"><span class="header-section-number">28</span> Plot continuous data</a></li>
<li><a class="" href="plot-categorical-data.html"><span class="header-section-number">29</span> Plot categorical data</a></li>
<li><a class="" href="tables.html"><span class="header-section-number">30</span> Tables</a></li>
<li><a class="" href="age-pyramids.html"><span class="header-section-number">31</span> Age pyramids</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">32</span> Diagrams</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">33</span> Combination analysis</a></li>
<li><a class="" href="heatmaps-density-plots.html"><span class="header-section-number">34</span> Heatmaps &amp; density plots</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">35</span> Transmission chains</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">36</span> Phylogenetic trees</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">37</span> Interactive plots</a></li>
<li class="book-part">Advanced</li>
<li><a class="" href="errors-warnings-1.html"><span class="header-section-number">38</span> Errors &amp; warnings</a></li>
<li><a class="" href="advanced-rstudio.html"><span class="header-section-number">39</span> Advanced RStudio</a></li>
<li><a class="" href="relational-databases.html"><span class="header-section-number">40</span> Relational databases</a></li>
<li><a class="" href="routine-reports.html"><span class="header-section-number">41</span> Routine reports</a></li>
<li><a class="" href="r-markdown-1.html"><span class="header-section-number">42</span> R Markdown</a></li>
<li><a class="" href="shiny-and-dashboards.html"><span class="header-section-number">43</span> Shiny and dashboards</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">44</span> Collaboration</a></li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">45</span> Writing functions</a></li>
<li><a class="" href="r-on-network-drives.html"><span class="header-section-number">46</span> R on network drives</a></li>
<li><a class="" href="directory-interactions.html"><span class="header-section-number">47</span> Directory interactions</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="moving-averages" class="section level1 tabset tabset-fade" number="18">
<h1>
<span class="header-section-number">18</span> Moving averages<a class="anchor" aria-label="anchor" href="#moving-averages"><i class="fas fa-link"></i></a>
</h1>
<div class="inline-figure"><img src="images/moving_avg_epicurve.png" width="50%"></div>
<!-- ======================================================= -->
<div id="overview-12" class="section level2 tabset tabset-fade tabset-pills" number="18.1">
<h2>
<span class="header-section-number">18.1</span> Overview<a class="anchor" aria-label="anchor" href="#overview-12"><i class="fas fa-link"></i></a>
</h2>
<p>This page will cover methods to calculate and visualize moving averages, for:</p>
<p><strong>To see a moving average for an epicurve, see the page on epicurves (LINK)</strong></p>
<!-- ======================================================= -->
</div>
<div id="preparation-9" class="section level2 tabset tabset-fade tabset-pills" number="18.2">
<h2>
<span class="header-section-number">18.2</span> Preparation<a class="anchor" aria-label="anchor" href="#preparation-9"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Load packages</strong></p>
<div class="sourceCode" id="cb735"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span>
  <span class="va">tidyverse</span>,      <span class="co"># for data management and viz</span>
  <span class="va">slider</span>,         <span class="co"># for calculating moving averages</span>
  <span class="va">tidyquant</span>,      <span class="co"># for calculating moving averages on-the-fly in ggplot</span>
<span class="op">)</span></code></pre></div>
<pre><code>## 
## Your package installed</code></pre>
<pre><code>## Warning in pacman::p_load(tidyverse, slider, tidyquant, ): Failed to install/load:</code></pre>
<!-- ======================================================= -->
</div>
<div id="calculate-then-display" class="section level2 tabset tabset-fade tabset-pills" number="18.3">
<h2>
<span class="header-section-number">18.3</span> Calculate-then-display<a class="anchor" aria-label="anchor" href="#calculate-then-display"><i class="fas fa-link"></i></a>
</h2>
<p>Using the package <strong>slider</strong> to calculate a moving average in a dataframe, prior to any plotting.</p>
<p>In this approach, the moving average is calculated in the dataset prior to plotting:</p>
<ul>
<li>Within <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>, a new column is created to hold the average. <code>slide_index()</code> from <strong>slider</strong> package is used as shown below.<br>
</li>
<li>In the <code>ggplot()</code>, a <code>geom_line()</code> is added after the histogram, reflecting the moving average.</li>
</ul>
<p>See the helpful online <a href="https://cran.r-project.org/web/packages/slider/vignettes/slider.html">vignette for the <strong>slider</strong> package</a></p>
<ul>
<li>Can assign <code>.before = Inf</code> to achieve cumulative averages from the first row<br>
</li>
<li>Use <code>slide()</code> in simple cases<br>
</li>
<li>Use <code>slide_index()</code> to designate a date column as an index, so that dates which do not appear in the dataframe are still included in the window
<ul>
<li>
<code>.before</code>, <code>.after</code> TODO<br>
</li>
<li>
<code>.complete</code> TODO<br>
</li>
<li>
</ul>
</li>
</ul>
<p>First we count the number of cases reported each day. Note that <code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code> is appropriate if the data are in a linelist format (one row per case) - if starting with aggregated counts you will need to follow a different approach (e.g. <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code> - see page on Summarizing data).</p>
<div class="sourceCode" id="cb738"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make dataset of daily counts and 7-day moving average</span>
<span class="co">#######################################################</span>
<span class="va">ll_counts_7day</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date_onset</span>, name <span class="op">=</span> <span class="st">"new_cases"</span><span class="op">)</span> <span class="op">%&gt;%</span>    <span class="co"># count cases by date, new column is named "new_cases"</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The new dataset now looks like this:</p>
<div class="sourceCode" id="cb739"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">ll_counts_7day</span>, rownames <span class="op">=</span> <span class="cn">FALSE</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">6</span>, scrollX<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">)</span></code></pre></div>
<div id="htmlwidget-af7338e91dd89aba09df" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-af7338e91dd89aba09df">{"x":{"filter":"none","data":[["2014-04-07","2014-04-15","2014-04-21","2014-04-25","2014-04-26","2014-04-27","2014-05-01","2014-05-03","2014-05-04","2014-05-05","2014-05-06","2014-05-07","2014-05-08","2014-05-09","2014-05-10","2014-05-11","2014-05-12","2014-05-13","2014-05-14","2014-05-16","2014-05-17","2014-05-18","2014-05-19","2014-05-20","2014-05-21","2014-05-22","2014-05-23","2014-05-24","2014-05-25","2014-05-26","2014-05-27","2014-05-28","2014-05-29","2014-05-30","2014-05-31","2014-06-02","2014-06-03","2014-06-05","2014-06-06","2014-06-07","2014-06-08","2014-06-09","2014-06-10","2014-06-11","2014-06-12","2014-06-13","2014-06-14","2014-06-15","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-20","2014-06-21","2014-06-22","2014-06-23","2014-06-24","2014-06-25","2014-06-26","2014-06-27","2014-06-28","2014-06-29","2014-06-30","2014-07-01","2014-07-02","2014-07-03","2014-07-04","2014-07-05","2014-07-06","2014-07-07","2014-07-08","2014-07-09","2014-07-10","2014-07-11","2014-07-12","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-21","2014-07-22","2014-07-23","2014-07-24","2014-07-25","2014-07-26","2014-07-27","2014-07-28","2014-07-29","2014-07-30","2014-07-31","2014-08-01","2014-08-02","2014-08-03","2014-08-04","2014-08-05","2014-08-06","2014-08-07","2014-08-08","2014-08-09","2014-08-10","2014-08-11","2014-08-12","2014-08-13","2014-08-14","2014-08-15","2014-08-16","2014-08-17","2014-08-18","2014-08-19","2014-08-20","2014-08-21","2014-08-22","2014-08-23","2014-08-24","2014-08-25","2014-08-26","2014-08-27","2014-08-28","2014-08-29","2014-08-30","2014-08-31","2014-09-01","2014-09-02","2014-09-03","2014-09-04","2014-09-05","2014-09-06","2014-09-07","2014-09-08","2014-09-09","2014-09-10","2014-09-11","2014-09-12","2014-09-13","2014-09-14","2014-09-15","2014-09-16","2014-09-17","2014-09-18","2014-09-19","2014-09-20","2014-09-21","2014-09-22","2014-09-23","2014-09-24","2014-09-25","2014-09-26","2014-09-27","2014-09-28","2014-09-29","2014-09-30","2014-10-01","2014-10-02","2014-10-03","2014-10-04","2014-10-05","2014-10-06","2014-10-07","2014-10-08","2014-10-09","2014-10-10","2014-10-11","2014-10-12","2014-10-13","2014-10-14","2014-10-15","2014-10-16","2014-10-17","2014-10-18","2014-10-19","2014-10-20","2014-10-21","2014-10-22","2014-10-23","2014-10-24","2014-10-25","2014-10-26","2014-10-27","2014-10-28","2014-10-29","2014-10-30","2014-10-31","2014-11-01","2014-11-02","2014-11-03","2014-11-04","2014-11-05","2014-11-06","2014-11-07","2014-11-08","2014-11-09","2014-11-10","2014-11-11","2014-11-12","2014-11-13","2014-11-14","2014-11-15","2014-11-16","2014-11-17","2014-11-18","2014-11-19","2014-11-20","2014-11-21","2014-11-22","2014-11-23","2014-11-24","2014-11-25","2014-11-26","2014-11-27","2014-11-28","2014-11-29","2014-11-30","2014-12-01","2014-12-02","2014-12-03","2014-12-04","2014-12-05","2014-12-06","2014-12-07","2014-12-08","2014-12-09","2014-12-10","2014-12-11","2014-12-12","2014-12-13","2014-12-14","2014-12-15","2014-12-16","2014-12-17","2014-12-18","2014-12-19","2014-12-20","2014-12-21","2014-12-22","2014-12-23","2014-12-24","2014-12-25","2014-12-26","2014-12-27","2014-12-28","2014-12-29","2014-12-30","2014-12-31","2015-01-01","2015-01-02","2015-01-03","2015-01-04","2015-01-05","2015-01-06","2015-01-07","2015-01-08","2015-01-09","2015-01-10","2015-01-11","2015-01-12","2015-01-13","2015-01-14","2015-01-15","2015-01-16","2015-01-17","2015-01-18","2015-01-19","2015-01-20","2015-01-21","2015-01-22","2015-01-23","2015-01-24","2015-01-25","2015-01-26","2015-01-27","2015-01-28","2015-01-29","2015-01-30","2015-01-31","2015-02-01","2015-02-02","2015-02-03","2015-02-04","2015-02-05","2015-02-06","2015-02-07","2015-02-08","2015-02-09","2015-02-10","2015-02-11","2015-02-12","2015-02-13","2015-02-14","2015-02-15","2015-02-16","2015-02-17","2015-02-18","2015-02-19","2015-02-20","2015-02-21","2015-02-22","2015-02-23","2015-02-24","2015-02-25","2015-02-26","2015-02-27","2015-02-28","2015-03-01","2015-03-02","2015-03-03","2015-03-04","2015-03-05","2015-03-06","2015-03-07","2015-03-08","2015-03-09","2015-03-10","2015-03-11","2015-03-12","2015-03-13","2015-03-14","2015-03-15","2015-03-16","2015-03-17","2015-03-18","2015-03-19","2015-03-20","2015-03-21","2015-03-22","2015-03-23","2015-03-24","2015-03-25","2015-03-26","2015-03-27","2015-03-28","2015-03-29","2015-03-30","2015-03-31","2015-04-01","2015-04-02","2015-04-03","2015-04-04","2015-04-05","2015-04-06","2015-04-07","2015-04-08","2015-04-09","2015-04-10","2015-04-11","2015-04-12","2015-04-13","2015-04-14","2015-04-15","2015-04-16","2015-04-17","2015-04-18","2015-04-19","2015-04-20","2015-04-21","2015-04-22","2015-04-23","2015-04-24","2015-04-25","2015-04-26","2015-04-27","2015-04-28","2015-04-29","2015-04-30"],[1,1,2,1,1,1,2,1,1,1,3,2,2,2,1,1,2,3,3,2,3,4,2,1,3,1,2,2,2,4,11,1,1,1,1,5,3,3,4,5,1,5,5,3,1,1,2,5,6,4,2,2,7,3,4,2,5,5,3,2,2,2,6,4,4,5,7,5,3,3,7,8,5,4,6,6,11,9,6,6,9,7,11,4,6,11,8,10,7,12,6,15,14,8,10,14,13,18,18,9,9,9,10,13,17,6,17,13,19,29,13,14,15,20,19,29,18,27,21,18,24,23,26,25,20,31,26,29,29,22,36,31,36,35,24,30,32,28,43,40,49,36,39,36,50,51,30,50,37,42,34,39,45,40,38,37,44,30,43,46,42,41,40,26,36,34,33,35,33,36,39,31,38,31,40,27,35,42,42,22,40,29,33,24,38,38,37,36,29,35,26,29,34,32,23,27,26,18,31,22,30,23,20,18,11,21,19,21,31,35,28,14,21,25,18,20,21,22,18,32,20,20,23,16,15,18,18,18,17,20,18,17,20,16,17,15,18,18,15,14,20,19,19,11,15,19,11,13,13,12,11,14,18,17,10,15,16,11,17,19,14,12,18,15,15,15,11,13,22,11,14,11,13,11,14,11,10,16,10,16,13,13,10,11,8,11,11,12,8,9,8,8,10,8,9,11,13,13,15,13,11,16,6,8,10,16,11,11,7,11,16,9,10,8,14,7,10,11,11,7,5,11,6,8,9,13,9,7,9,4,9,7,13,2,7,9,5,5,10,12,10,3,6,4,5,11,3,7,6,7,9,3,7,4,9,6,5,5,9,4,4,4,9,7,8,2,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>date_onset<\/th>\n      <th>new_cases<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":6,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[6,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>Next, we create a new column that is the 7-day average. We are using the function <code>slide_index()</code> from <strong>slider</strong> specifically because we recognize that <em>there are missing days</em> in the above dataframe, and they must be accounted for. To do this, we set a our “index” (<code>.i</code> argument) as <code>the column</code>date_onset<code>. Since</code>date_onset<code>is a column of class Date, the function recognizes and when calculating it counts the days that do not appear in the dataframe. If you were to use another **slider** function like</code>slide()`, this indexing would not occur.</p>
<p>Also not that the 7-day window, in this example, is achieved with the argument <code>.before = 6</code>. In this way the window is the day and 6 days preceding. If you want the window to be different (centered or following) use <code>.after</code> in conjunction.</p>
<div class="sourceCode" id="cb740"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## calculate the average number of cases in the preceding 7 days</span>
<span class="va">ll_counts_7day</span> <span class="op">&lt;-</span> <span class="va">ll_counts_7day</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    avg_7day <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/slider/man/slide_index.html">slide_index_dbl</a></span><span class="op">(</span>    <span class="co"># create new column</span>
        <span class="va">new_cases</span>,                       <span class="co"># calculate avg based on value in new_cases column</span>
        .i <span class="op">=</span> <span class="va">date_onset</span>,                 <span class="co"># index column is date_onset, so non-present dates are included in 7day window </span>
        .f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,    <span class="co"># function is mean() with missing values removed</span>
        .before <span class="op">=</span> <span class="fl">6</span>,                     <span class="co"># window is the day and 6-days before</span>
        .complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>               <span class="co"># fills in first days with NA</span></code></pre></div>
<p>Step 2 is plotting the 7-day average, in this case shown on top of the underlying daily data.</p>
<div class="sourceCode" id="cb741"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">ll_counts_7day</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">new_cases</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"#92a8d1"</span>, stat <span class="op">=</span> <span class="st">"identity"</span>, position <span class="op">=</span> <span class="st">"stack"</span>, colour <span class="op">=</span> <span class="st">"#92a8d1"</span><span class="op">)</span><span class="op">+</span> 
    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">avg_7day</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">scale_x_date</span><span class="op">(</span>
      date_breaks <span class="op">=</span> <span class="st">"1 month"</span>,
      date_labels <span class="op">=</span> <span class="st">'%d/%m'</span>,
      expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">""</span>, y <span class="op">=</span><span class="st">"Number of confirmed cases"</span><span class="op">)</span><span class="op">+</span> 
    <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> </code></pre></div>
<pre><code>## Warning: Ignoring unknown parameters: binwidth, bins, pad</code></pre>
<pre><code>## Warning: Removed 1 row(s) containing missing values (geom_path).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-475-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="calculate-on-the-fly" class="section level2 tabset tabset-fade tabset-pills" number="18.4">
<h2>
<span class="header-section-number">18.4</span> Calculate on-the-fly<a class="anchor" aria-label="anchor" href="#calculate-on-the-fly"><i class="fas fa-link"></i></a>
</h2>
<p>TBD - <strong>tidyquant</strong></p>
<div class="sourceCode" id="cb744"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">per_pos_plot_county</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tests_per_county</span><span class="op">)</span>,
       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">DtSpecimenCollect_Final</span>, y <span class="op">=</span> <span class="va">prop_pos</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">+</span>  <span class="co"># plot raw values</span>
  <span class="fu">tidyquant</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/geom_ma.html">geom_ma</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">7</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">+</span> <span class="co"># plot moving average</span>
  <span class="fu">theme_minimal_hgrid</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2020-03-15"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title    <span class="op">=</span> <span class="st">"COUNTY-WIDE TESTING PERCENT POSITIVE"</span>,
       subtitle <span class="op">=</span> <span class="st">"Daily and 7-day moving average"</span>,
       y        <span class="op">=</span> <span class="st">"Percent Positive"</span>,
       x        <span class="op">=</span> <span class="st">"Date Specimen Collected"</span><span class="op">)</span><span class="op">+</span>
  <span class="va">theme_text_size</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,
        panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"khaki"</span><span class="op">)</span>
        <span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="resources-10" class="section level2 tabset tabset-fade tabset-pills" number="18.5">
<h2>
<span class="header-section-number">18.5</span> Resources<a class="anchor" aria-label="anchor" href="#resources-10"><i class="fas fa-link"></i></a>
</h2>
<p>See the helpful online <a href="https://cran.r-project.org/web/packages/slider/vignettes/slider.html">vignette for the <strong>slider</strong> package</a></p>
<p>If your use case requires that you “skip over” weekends and even holidays, you might like <strong>almanac</strong> package.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="standardization.html"><span class="header-section-number">17</span> Standardization</a></div>
<div class="next"><a href="outbreak-detection.html"><span class="header-section-number">19</span> Outbreak detection</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#moving-averages"><span class="header-section-number">18</span> Moving averages</a></li>
<li><a class="nav-link" href="#overview-12"><span class="header-section-number">18.1</span> Overview</a></li>
<li><a class="nav-link" href="#preparation-9"><span class="header-section-number">18.2</span> Preparation</a></li>
<li><a class="nav-link" href="#calculate-then-display"><span class="header-section-number">18.3</span> Calculate-then-display</a></li>
<li><a class="nav-link" href="#calculate-on-the-fly"><span class="header-section-number">18.4</span> Calculate on-the-fly</a></li>
<li><a class="nav-link" href="#resources-10"><span class="header-section-number">18.5</span> Resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R Handbook for Epidemiologists</strong>" was written by the handbook team. It was last built on 2021-02-20.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
