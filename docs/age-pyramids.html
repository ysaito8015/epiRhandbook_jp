<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>31 Age pyramids | R Handbook for Epidemiologists</title>
<meta name="author" content="the handbook team">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.6/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.15/datatables.js"></script><link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script><link href="libs/tabwid-1.0.0/tabwid.css" rel="stylesheet">
<script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.9.3/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-1.57.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-1.57.1/plotly-latest.min.js"></script><link href="libs/vis-4.20.1/vis.css" rel="stylesheet">
<script src="libs/vis-4.20.1/vis.min.js"></script><script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-1.57.1/plotly-basic-1.57.1.min.js"></script><script src="libs/plotly-cartesian-1.57.1/plotly-cartesian-1.57.1.min.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R Handbook for Epidemiologists</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li class="book-part">About this book</li>
<li><a class="" href="style-and-editorial-notes.html"><span class="header-section-number">1</span> Style and editorial notes</a></li>
<li><a class="" href="datasets-used.html"><span class="header-section-number">2</span> Datasets used</a></li>
<li class="book-part">Basics</li>
<li><a class="" href="r-basics.html"><span class="header-section-number">3</span> R Basics</a></li>
<li><a class="" href="importing-and-exporting.html"><span class="header-section-number">4</span> Importing and exporting</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">5</span> R projects</a></li>
<li><a class="" href="suggested-packages.html"><span class="header-section-number">6</span> Suggested packages</a></li>
<li class="book-part">Data Management</li>
<li><a class="" href="cleaning-data.html"><span class="header-section-number">7</span> Cleaning data</a></li>
<li><a class="" href="working-with-dates.html"><span class="header-section-number">8</span> Working with dates</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">9</span> Missing data</a></li>
<li><a class="" href="grouping-data.html"><span class="header-section-number">10</span> Grouping data</a></li>
<li><a class="" href="joining-matching-datasets.html"><span class="header-section-number">11</span> Joining &amp; matching datasets</a></li>
<li><a class="" href="charactersstrings.html"><span class="header-section-number">12</span> Characters/strings</a></li>
<li><a class="" href="de-duplication.html"><span class="header-section-number">13</span> De-duplication</a></li>
<li><a class="" href="iteration-and-loops.html"><span class="header-section-number">14</span> Iteration and loops</a></li>
<li class="book-part">Analysis</li>
<li><a class="" href="descriptive-analysis.html"><span class="header-section-number">15</span> Descriptive analysis</a></li>
<li><a class="" href="simple-statistical-tests.html"><span class="header-section-number">16</span> Simple statistical tests</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">17</span> Standardization</a></li>
<li><a class="" href="moving-averages.html"><span class="header-section-number">18</span> Moving averages</a></li>
<li><a class="" href="outbreak-detection.html"><span class="header-section-number">19</span> Outbreak detection</a></li>
<li><a class="" href="time-series-analysis.html"><span class="header-section-number">20</span> Time series analysis</a></li>
<li><a class="" href="epidemicmodels.html"><span class="header-section-number">21</span> Epidemic modeling</a></li>
<li><a class="" href="modeling.html"><span class="header-section-number">22</span> Modeling</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">23</span> Survey analysis</a></li>
<li><a class="" href="survival-analysis-1.html"><span class="header-section-number">24</span> Survival analysis</a></li>
<li><a class="" href="gis-basics.html"><span class="header-section-number">25</span> GIS basics</a></li>
<li class="book-part">Data Vizualization</li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">26</span> ggplot tips</a></li>
<li><a class="" href="epidemic-curves.html"><span class="header-section-number">27</span> Epidemic curves</a></li>
<li><a class="" href="plotting-continuous-data.html"><span class="header-section-number">28</span> Plotting continuous data</a></li>
<li><a class="" href="plotting-categorical-variables.html"><span class="header-section-number">29</span> Plotting categorical variables</a></li>
<li><a class="" href="tables.html"><span class="header-section-number">30</span> Tables</a></li>
<li><a class="active" href="age-pyramids.html"><span class="header-section-number">31</span> Age pyramids</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">32</span> Diagrams</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">33</span> Combination analysis</a></li>
<li><a class="" href="heatmaps-density-plots.html"><span class="header-section-number">34</span> Heatmaps &amp; density plots</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">35</span> Transmission chains</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">36</span> Phylogenetic trees</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">37</span> Interactive plots</a></li>
<li class="book-part">Advanced</li>
<li><a class="" href="errors-warnings-1.html"><span class="header-section-number">38</span> Errors &amp; Warnings</a></li>
<li><a class="" href="advanced-rstudio.html"><span class="header-section-number">39</span> Advanced RStudio</a></li>
<li><a class="" href="relational-databases.html"><span class="header-section-number">40</span> Relational databases</a></li>
<li><a class="" href="routine-reports.html"><span class="header-section-number">41</span> Routine reports</a></li>
<li><a class="" href="r-markdown.html"><span class="header-section-number">42</span> R Markdown</a></li>
<li><a class="" href="shiny-basics.html"><span class="header-section-number">43</span> Shiny basics</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">44</span> Collaboration</a></li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">45</span> Writing functions</a></li>
<li><a class="" href="r-on-network-drives.html"><span class="header-section-number">46</span> R on network drives</a></li>
<li><a class="" href="directory-interactions.html"><span class="header-section-number">47</span> Directory interactions</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="age-pyramids" class="section level1 tabset tabset-fade" number="31">
<h1>
<span class="header-section-number">31</span> Age pyramids<a class="anchor" aria-label="anchor" href="#age-pyramids"><i class="fas fa-link"></i></a>
</h1>
<p>Age pyramids can be useful to show patterns by age group. They can show gender, or the distribution of other characteristics.<br>
These tabs demonstrate how to produce age pyramids using:</p>
<ul>
<li>Fast &amp; easy: Using the <strong>apyramid</strong> package<br>
</li>
<li>More flexible: Using <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code><br>
</li>
<li>Having baseline demographics displayed in the background of the pyramid<br>
</li>
<li>Using pyramid-style plots to show other types of data (e.g responses to Likert-style questions)</li>
</ul>
<!-- ======================================================= --><div id="overview-27" class="section level2 tabset tabset-fade" number="31.1">
<h2>
<span class="header-section-number">31.1</span> Overview<a class="anchor" aria-label="anchor" href="#overview-27"><i class="fas fa-link"></i></a>
</h2>
<p><img src="images/pop_pyramid_baseline.png" width="50%"><img src="images/likert.png" width="50%"></p>
<p>Age/gender demographic pyramids in R are generally made with <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> by creating two barplots (one for each gender), converting one’s values to negative values, and flipping the x and y axes to display the barplots vertically.</p>
<p>Here we offer a quick approach through the <strong>apyramid</strong> package:</p>
<ul>
<li>More customizable code using the raw <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> commands<br>
</li>
<li>How to combine case demographic data and compare with that of a baseline population (as shown above)<br>
</li>
<li>Application of these methods to show other types of data (e.g. responses to Likert-style survey questions)</li>
</ul>
<!-- ======================================================= -->
</div>
<div id="preparation-22" class="section level2 tabset tabset-fade" number="31.2">
<h2>
<span class="header-section-number">31.2</span> Preparation<a class="anchor" aria-label="anchor" href="#preparation-22"><i class="fas fa-link"></i></a>
</h2>
<p>For this tab we use the <code>linelist</code> dataset that is cleaned in the Cleaning tab.</p>
<p>To make a traditional age/sex demographic pyramid, the data must first be cleaned in the following ways:</p>
<ul>
<li>The gender column must be cleaned.<br>
</li>
<li>Age should be in an age category column, and should be an of class Factor (with correctly ordered levels)</li>
</ul>
<p><strong>Load packages</strong></p>
<p>First, load the packages required for this analysis:</p>
<div class="sourceCode" id="cb877"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">rio</span>,       <span class="co"># to import data</span>
               <span class="va">here</span>,      <span class="co"># to locate files</span>
               <span class="va">tidyverse</span>, <span class="co"># to clean, handle, and plot the data (includes ggplot2 package)</span>
               <span class="va">apyramid</span>,  <span class="co"># a package dedicated to creating age pyramids</span>
               <span class="va">stringr</span><span class="op">)</span>   <span class="co"># working with strings for titles, captions, etc.</span></code></pre></div>
<p>Load the data</p>
<div class="sourceCode" id="cb878"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"linelist_cleaned.csv"</span><span class="op">)</span></code></pre></div>
<p><strong>Check class of variables</strong></p>
<p>Ensure that the age variable is class Numeric, and check the class and order of levels of <code>age_cat</code> and <code>age_cat5</code></p>
<div class="sourceCode" id="cb879"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_years</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "numeric"</code></pre>
<div class="sourceCode" id="cb881"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_cat</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "factor"</code></pre>
<div class="sourceCode" id="cb883"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_cat5</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "factor"</code></pre>
<div class="sourceCode" id="cb885"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_cat</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##   0-4   5-9 10-14 15-19 20-29 30-49 50-69   70+  &lt;NA&gt; 
##  1048  1109   955   760  1014   780   123    11    88</code></pre>
<div class="sourceCode" id="cb887"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_cat5</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##   0-4   5-9 10-14 15-19 20-24 25-29 30-34 35-39 40-44 45-49 50-54 55-59 60-64 65-69 70-74 75-79 80-84   85+  &lt;NA&gt; 
##  1048  1109   955   760   574   440   324   215   155    86    66    33    13    11     5     3     0     3    88</code></pre>
<!-- ======================================================= -->
</div>
<div id="apyramid-package" class="section level2 tabset tabset-fade" number="31.3">
<h2>
<span class="header-section-number">31.3</span> <strong>apyramid</strong> package<a class="anchor" aria-label="anchor" href="#apyramid-package"><i class="fas fa-link"></i></a>
</h2>
<p>The package <strong>apyramid</strong> allows you to quickly make an age pyramid. For more nuanced situations, see the tab on using <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> to make age pyramids. You can read more about the <strong>apyramid</strong> package in its Help page by entering <code>?age_pyramid</code> in your R console.</p>
<div id="linelist-data" class="section level3" number="31.3.1">
<h3>
<span class="header-section-number">31.3.1</span> Linelist data<a class="anchor" aria-label="anchor" href="#linelist-data"><i class="fas fa-link"></i></a>
</h3>
<p>Using the cleaned linelist dataset, we can create an age pyramid with just one simple command. If you need help cleaning your data, see the handbook page on Cleaning data (LINK). In this command:</p>
<ul>
<li>The <em>data</em> argument is set as the <code>linelist</code> dataframe<br>
</li>
<li>The <em>age_group</em> argument is set to the name (in quotes) of the numeric category variable (in this case <code>age_cat5</code>)<br>
</li>
<li>The <em>split_by</em> argument (bar colors) should be a binary column (in this case “gender”)</li>
</ul>
<div class="sourceCode" id="cb889"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">apyramid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/apyramid/man/age_pyramid.html">age_pyramid</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span>,
                      age_group <span class="op">=</span> <span class="st">"age_cat5"</span>,
                      split_by <span class="op">=</span> <span class="st">"gender"</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: 283 missing rows were removed (88 values from `age_cat5` and 283 values from `gender`).</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-579-1.png" width="672">
When using <strong>agepyramid</strong> package, if the <code>split_by</code> column is binary (e.g. male/female, or yes/no), then the result will appear as a pyramid. However if there are more than two values in the <code>split_by</code> column (not including <code>NA</code>), the pyramid will appears as a faceted barplot with empty bars in the background indicating the range of the un-faceted data set for the age group. Values of split_by will appear as labels at top of each facet. For example below if the <code>split_by</code> variable is “hospital”.</p>
<div class="sourceCode" id="cb891"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">apyramid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/apyramid/man/age_pyramid.html">age_pyramid</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span>,
                      age_group <span class="op">=</span> <span class="st">"age_cat5"</span>,
                      split_by <span class="op">=</span> <span class="st">"hospital"</span>,
                      na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>        <span class="co"># show a bar for patients missing age, (note: this changes the pyramid into a faceted barplot)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-580-1.png" width="672"></div>
<p><strong>Missing values</strong><br>
Rows missing values for the <code>split_by</code> or <code>age_group</code> columns, if coded as <code>NA</code>, will not trigger the faceting shown above. By default these rows will not be shown. However you can specify that they appear, in an adjacent barplot and as a separate age group at the top, by specifying <code>na.rm = FALSE</code>.</p>
<div class="sourceCode" id="cb892"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">apyramid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/apyramid/man/age_pyramid.html">age_pyramid</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span>,
                      age_group <span class="op">=</span> <span class="st">"age_cat5"</span>,
                      split_by <span class="op">=</span> <span class="st">"gender"</span>,
                      na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>         <span class="co"># show patients missing age or gender</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-581-1.png" width="672"></div>
<p><strong>Proportions, colors, &amp; aesthetics</strong></p>
<p>By default, the bars display counts (not %), a dashed mid-line for each group is shown, and the colors are green/purple. Each of these parameters can all be adjusted, as shown below:</p>
<p>You can also add additional <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> commands to the plot using the standard <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> “+” syntax, such as aesthetic themes and label adjustments:</p>
<div class="sourceCode" id="cb893"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">apyramid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/apyramid/man/age_pyramid.html">age_pyramid</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span>,
                      age_group <span class="op">=</span> <span class="st">"age_cat5"</span>,
                      split_by <span class="op">=</span> <span class="st">"gender"</span>,
                      proportional <span class="op">=</span> <span class="cn">TRUE</span>,                  <span class="co"># show percents, not counts</span>
                      show_midpoint <span class="op">=</span> <span class="cn">FALSE</span>,                <span class="co"># remove bar mid-point line</span>
                      <span class="co">#pal = c("orange", "purple")          # can specify alt. colors here (but not labels, see below)</span>
                      <span class="op">)</span><span class="op">+</span>                 
  
  <span class="co"># additional ggplot commands</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                          <span class="co"># simplify the background</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"orange"</span>, <span class="st">"purple"</span><span class="op">)</span>,         <span class="co"># to specify colors AND labels</span>
                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Percent of all cases"</span>,                          <span class="co"># note that x and y labels are switched (see ggplot tab)</span>
       x <span class="op">=</span> <span class="st">"Age categories"</span>,                          
       fill <span class="op">=</span> <span class="st">"Gender"</span>, 
       caption <span class="op">=</span> <span class="st">"My data source and caption here"</span>,
       title <span class="op">=</span> <span class="st">"Title of my plot"</span>,
       subtitle <span class="op">=</span> <span class="st">"Subtitle with \n a second line..."</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,                             <span class="co"># move legend to bottom</span>
    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,     <span class="co"># fonts/sizes, see ggplot tips page</span>
    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: 283 missing rows were removed (88 values from `age_cat5` and 283 values from `gender`).</code></pre>
<pre><code>## Scale for 'fill' is already present. Adding another scale for 'fill', which will replace the existing scale.</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-582-1.png" width="672"></div>
</div>
<div id="aggregated-data-1" class="section level3" number="31.3.2">
<h3>
<span class="header-section-number">31.3.2</span> Aggregated data<a class="anchor" aria-label="anchor" href="#aggregated-data-1"><i class="fas fa-link"></i></a>
</h3>
<p>The examples above assume your data are in a linelist-like format, with one row per observation. If your data are already aggregated into counts by age category, you can still use the <strong>apyramid</strong> package, as shown below.</p>
<p>Let’s say that your dataset looks like this, with columns for age category, and male counts, female counts, and missing counts.<br>
(see the handbook page on Transforming data for tips)</p>
<pre><code>## `summarise()` has grouped output by 'age_cat5'. You can override using the `.groups` argument.</code></pre>
<div class="sourceCode" id="cb897"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># View the aggregated data</span>
<span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">demo_agg</span>, rownames <span class="op">=</span> <span class="cn">FALSE</span>, filter<span class="op">=</span><span class="st">"top"</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">5</span>, scrollX<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">)</span></code></pre></div>
<p><code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> perfers data in “long” format, so first pivot the data to be “long” with the <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> function from <strong>dplyr</strong>.</p>
<div class="sourceCode" id="cb898"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># pivot the aggregated data into long format</span>
<span class="va">demo_agg_long</span> <span class="op">&lt;-</span> <span class="va">demo_agg</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">f</span>, <span class="va">m</span>, <span class="va">missing_gender</span><span class="op">)</span>,            <span class="co"># cols to elongate</span>
               names_to <span class="op">=</span> <span class="st">"gender"</span>,                <span class="co"># name for new col of categories</span>
               values_to <span class="op">=</span> <span class="st">"counts"</span><span class="op">)</span> <span class="op">%&gt;%</span>           <span class="co"># name for new col of counts</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gender <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/na_if.html">na_if</a></span><span class="op">(</span><span class="va">gender</span>, <span class="st">"missing_gender"</span><span class="op">)</span><span class="op">)</span> <span class="co"># convert "missing_gender" to NA</span></code></pre></div>
<div class="sourceCode" id="cb899"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># View the aggregated data</span>
<span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">demo_agg_long</span>, rownames <span class="op">=</span> <span class="cn">FALSE</span>, filter<span class="op">=</span><span class="st">"top"</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">5</span>, scrollX<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">)</span></code></pre></div>
<p>Then use the <code>split_by</code> and <code>count</code> arguments of <code>age_pyramid()</code> to specify the respective columns:</p>
<div class="sourceCode" id="cb900"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">apyramid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/apyramid/man/age_pyramid.html">age_pyramid</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">demo_agg_long</span>,
                      age_group <span class="op">=</span> <span class="st">"age_cat5"</span>,
                      split_by <span class="op">=</span> <span class="st">"gender"</span>,
                      count <span class="op">=</span> <span class="st">"counts"</span><span class="op">)</span>      <span class="co"># give the column name for the aggregated counts</span></code></pre></div>
<pre><code>## Warning: Removed 25 rows containing missing values (position_stack).</code></pre>
<pre><code>## Warning: Removed 19 rows containing missing values.</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-587-1.png" width="672"></div>
<p>Note in the above, that the factor order of “m” and “f” is different (pyramid reversed). To adjust the order you must re-define gender in the aggredated data as a Factor and order the levels as desired.</p>
<!-- ======================================================= -->
</div>
</div>
<div id="ggplot-1" class="section level2 tabset tabset-fade" number="31.4">
<h2>
<span class="header-section-number">31.4</span> <code>ggplot()</code><a class="anchor" aria-label="anchor" href="#ggplot-1"><i class="fas fa-link"></i></a>
</h2>
<p>Using <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> to build your age pyramid allows for more flexibility, but requires more effort and understanding of how <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> works. It is also easier to accidentally make mistakes.</p>
<p><strong>apyramid</strong> uses <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> in the background (and accepts <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> commands added), but this page shows how to adjust or recreate a pyramid only using <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>, if you wish.</p>
<!-- ======================================================= -->
<div id="constructing-the-plot" class="section level3 tabset tabset-fade" number="31.4.1">
<h3>
<span class="header-section-number">31.4.1</span> Constructing the plot<a class="anchor" aria-label="anchor" href="#constructing-the-plot"><i class="fas fa-link"></i></a>
</h3>
<p>First, understand that to make such a pyramid using <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> the approach is to:</p>
<ul>
<li><p>Within the <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>, create <strong>two</strong> graphs by age category. Create one for each of the two grouping values (in this case gender). See filters applied to the <code>data</code> arguments in each <code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram()</a></code> commands below.</p></li>
<li><p>If using <code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram()</a></code>, the graphs operate off the numeric column (e.g. <code>age_years</code>), whereas if using <code>geom_barplot()</code> the graphs operate from an ordered Factor (e.g. <code>age_cat5</code>).</p></li>
<li><p>One graph will have positive count values, while the other will have its counts converted to negative values - this allows both graphs to be seen and compared against each other in the same plot.</p></li>
<li><p>The command <code><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip()</a></code> switches the X and Y axes, resulting in the graphs turning vertical and creating the pyramid.</p></li>
<li><p>Lastly, the counts-axis labels must be specified so they appear as “positive” counts on both sides of the pyramid (despite the underlying values on one side being negative).</p></li>
</ul>
<p>A <strong>simple</strong> version of this, using <code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram()</a></code>, is below:</p>
<div class="sourceCode" id="cb903"><pre class="downlit sourceCode r">
<code class="sourceCode R">  <span class="co"># begin ggplot</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, fill <span class="op">=</span> <span class="va">gender</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># female histogram</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">linelist</span>, <span class="va">gender</span> <span class="op">==</span> <span class="st">"f"</span><span class="op">)</span>,
                 breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">85</span>,<span class="fl">5</span><span class="op">)</span>,
                 colour <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># male histogram (values converted to negative)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">linelist</span>, <span class="va">gender</span> <span class="op">==</span> <span class="st">"m"</span><span class="op">)</span>,
                 breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">85</span>,<span class="fl">5</span><span class="op">)</span>,
                 <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">..count..</span><span class="op">*</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
                 colour <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># flip the X and Y axes</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># adjust counts-axis scale</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">600</span>, <span class="fl">900</span><span class="op">)</span>,
                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">600</span>,<span class="fl">900</span>,<span class="fl">100</span><span class="op">)</span>,
                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">600</span>, <span class="fl">900</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-588-1.png" width="672"></div>
<p><span style="color: red;"><strong><em>DANGER:</em></strong> If the <strong>limits</strong> of your counts axis are set too low, and a counts bar exceeds them, the bar will disappear entirely or be artificially shortened! Watch for this if analyzing data which is routinely updated. Prevent it by having your count-axis limits auto-adjust to your data, as below.</span></p>
<p>There are many things you can change/add to this simple version, including:</p>
<ul>
<li>Auto adjust counts-axis count scale to your data (avoid errors discussed in warning below)<br>
</li>
<li>Manually specify colors and legend labels</li>
</ul>
<div class="sourceCode" id="cb904"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create dataset with proportion of total</span>
<span class="va">pyramid_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age_cat5</span>, <span class="va">gender</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="op">(</span><span class="va">counts</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">counts</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span>, 
         percent <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
            <span class="va">gender</span> <span class="op">==</span> <span class="st">"f"</span> <span class="op">~</span> <span class="va">percent</span>,
            <span class="va">gender</span> <span class="op">==</span> <span class="st">"m"</span> <span class="op">~</span> <span class="op">-</span><span class="va">percent</span>,
            <span class="cn">TRUE</span>          <span class="op">~</span> <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by 'age_cat5'. You can override using the `.groups` argument.</code></pre>
<div class="sourceCode" id="cb906"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">max_per</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">pyramid_data</span><span class="op">$</span><span class="va">percent</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="va">min_per</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">pyramid_data</span><span class="op">$</span><span class="va">percent</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>


<span class="co"># begin ggplot</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  <span class="co"># default x-axis is age in years;</span>

  <span class="co"># case data graph</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pyramid_data</span>,
           stat <span class="op">=</span> <span class="st">"identity"</span>,
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age_cat5</span>,
               y <span class="op">=</span> <span class="va">percent</span>,
               fill <span class="op">=</span> <span class="va">gender</span><span class="op">)</span>,        <span class="co"># </span>
           colour <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">+</span>         <span class="co"># white around each bar</span>
  
  <span class="co"># flip the X and Y axes to make pyramid vertical</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  

  <span class="co"># adjust the axes scales (remember they are flipped now!)</span>
  <span class="co">#scale_x_continuous(breaks = seq(0,100,5), labels = seq(0,100,5)) +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">min_per</span>, <span class="va">max_per</span><span class="op">)</span>,
                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">min_per</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">max_per</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,
                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">min_per</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">max_per</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="st">"%"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>

  <span class="co"># designate colors and legend labels manually</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>
    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"f"</span> <span class="op">=</span> <span class="st">"orange"</span>,
               <span class="st">"m"</span> <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span>,
    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Female"</span>, <span class="st">"Male"</span><span class="op">)</span>,
  <span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># label values (remember X and Y flipped now)</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">"Age group"</span>,
    y <span class="op">=</span> <span class="st">"Percent of total"</span>,
    fill <span class="op">=</span> <span class="cn">NULL</span>,
    caption <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"Data are from linelist \nn = {nrow(linelist)} (age or sex missing for {sum(is.na(linelist$gender) | is.na(linelist$age_years))} cases) \nData as of: {format(Sys.Date(), '%d %b %Y')}"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># optional aesthetic themes</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
    axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,
    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, 
    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0</span>, size<span class="op">=</span><span class="fl">11</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Age and gender of cases"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 13 rows containing missing values (position_stack).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-589-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="compare-to-baseline" class="section level3" number="31.4.2">
<h3>
<span class="header-section-number">31.4.2</span> Compare to baseline<a class="anchor" aria-label="anchor" href="#compare-to-baseline"><i class="fas fa-link"></i></a>
</h3>
<p>With the flexibility of <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>, you can have a second layer of bars in the background that represent the true population pyramid. This can provide a nice visualization to compare the observed counts with the baseline.</p>
<p>Import and view the population data</p>
<div class="sourceCode" id="cb908"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># import the population demographics data</span>
<span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"country_demographics.csv"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb909"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># display the linelist data as a table</span>
<span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">pop</span>, rownames <span class="op">=</span> <span class="cn">FALSE</span>, filter<span class="op">=</span><span class="st">"top"</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">10</span>, scrollX<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">)</span></code></pre></div>
<div id="htmlwidget-9817685aeb0a08d5df8b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-9817685aeb0a08d5df8b">{"x":{"filter":"top","filterHTML":"<tr>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"integer\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"40402\" data-max=\"7828087\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"integer\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"64656\" data-max=\"7674675\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80-84","85+"],[7828087,6705882,5601230,4576430,3734111,3111651,2571215,2121247,1735468,1418749,1145345,900239,685141,500248,347093,202240,94325,40402],[7674675,6592449,5522555,4533885,3726537,3118040,2592416,2150490,1771213,1459439,1193903,956070,745682,563894,416543,258538,130479,64656]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>age_cat5<\/th>\n      <th>m<\/th>\n      <th>f<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true}},"evals":[],"jsHooks":[]}</script><p>First some data management steps:</p>
<p>Here we record the order of age categories that we want to appear. Due to some quirks the way the <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> is implemented, it is easiest to store these as a character vector and use them later in the plotting function.</p>
<div class="sourceCode" id="cb910"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># record correct age cat levels</span>
<span class="va">age_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0-4"</span>,<span class="st">"5-9"</span>, <span class="st">"10-14"</span>, <span class="st">"15-19"</span>, <span class="st">"20-24"</span>,
                <span class="st">"25-29"</span>,<span class="st">"30-34"</span>, <span class="st">"35-39"</span>, <span class="st">"40-44"</span>, <span class="st">"45-49"</span>,
                <span class="st">"50-54"</span>, <span class="st">"55-59"</span>, <span class="st">"60-64"</span>, <span class="st">"65-69"</span>, <span class="st">"70-74"</span>,
                <span class="st">"75-79"</span>, <span class="st">"80-84"</span>, <span class="st">"85+"</span><span class="op">)</span></code></pre></div>
<p>Combine the population and case data through the <strong>dplyr</strong> function <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code>:</p>
<ul>
<li>First, ensure they have the <em>exact same</em> column names, age categories values, and gender values<br>
</li>
<li>Make them have the same data structure: columns of age category, gender, counts, and percent of total<br>
</li>
<li>Bind them together, one on-top of the other (<code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code>)</li>
</ul>
<div class="sourceCode" id="cb911"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create/transform populaton data, with percent of total</span>
<span class="co">########################################################</span>
<span class="va">pop_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="va">pop</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">f</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"gender"</span>, values_to <span class="op">=</span> <span class="st">"counts"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># pivot gender columns longer</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="st">"population"</span>,                                                         <span class="co"># add column designating data source</span>
         percent  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="op">(</span><span class="va">counts</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">counts</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span>,                     <span class="co"># calculate % of total</span>
         percent  <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>                                                        <span class="co"># if male, convert % to negative</span>
                            <span class="va">gender</span> <span class="op">==</span> <span class="st">"f"</span> <span class="op">~</span> <span class="va">percent</span>,
                            <span class="va">gender</span> <span class="op">==</span> <span class="st">"m"</span> <span class="op">~</span> <span class="op">-</span><span class="va">percent</span>,
                            <span class="cn">TRUE</span>          <span class="op">~</span> <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Review the changed population dataset</p>
<div class="sourceCode" id="cb912"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># display the linelist data as a table</span>
<span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">pop_data</span>, rownames <span class="op">=</span> <span class="cn">FALSE</span>, filter<span class="op">=</span><span class="st">"top"</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">5</span>, scrollX<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">)</span></code></pre></div>
<p>Now implement the same for the case linelist. Slightly different because it begins with case-rows, not counts.</p>
<div class="sourceCode" id="cb913"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create case data by age/gender, with percent of total</span>
<span class="co">#######################################################</span>
<span class="va">case_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age_cat5</span>, <span class="va">gender</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># aggregate linelist cases into age-gender groups</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>     <span class="co"># calculate counts per age-gender group</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="st">"cases"</span>,                                          <span class="co"># add column designating data source</span>
         percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="op">(</span><span class="va">counts</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">counts</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span>,  <span class="co"># calculate % of total for age-gender groups</span>
         percent <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>                                     <span class="co"># convert % to negative if male</span>
            <span class="va">gender</span> <span class="op">==</span> <span class="st">"f"</span> <span class="op">~</span> <span class="va">percent</span>,
            <span class="va">gender</span> <span class="op">==</span> <span class="st">"m"</span> <span class="op">~</span> <span class="op">-</span><span class="va">percent</span>,
            <span class="cn">TRUE</span>          <span class="op">~</span> <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by 'age_cat5'. You can override using the `.groups` argument.</code></pre>
<p>Review the changed case dataset</p>
<div class="sourceCode" id="cb915"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># display the linelist data as a table</span>
<span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">case_data</span>, rownames <span class="op">=</span> <span class="cn">FALSE</span>, filter<span class="op">=</span><span class="st">"top"</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">5</span>, scrollX<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">)</span></code></pre></div>
<p>Now the two datasets are combined, one on top of the other (same column names)</p>
<div class="sourceCode" id="cb916"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># combine case and population data (same column names, age_cat values, and gender values)</span>
<span class="va">pyramid_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">case_data</span>, <span class="va">pop_data</span><span class="op">)</span></code></pre></div>
<p>Store the maximum and minimum percent values, used in the plotting funtion to define the extent of the plot (and not cut off any bars!)</p>
<div class="sourceCode" id="cb917"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define extent of percent axis, used for plot limits</span>
<span class="va">max_per</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">pyramid_data</span><span class="op">$</span><span class="va">percent</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="va">min_per</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">pyramid_data</span><span class="op">$</span><span class="va">percent</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span></code></pre></div>
<p>Now the plot is made with <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code>:</p>
<ul>
<li>One bar graph of population data (wider, more transparent bars)</li>
<li>One bar graph of case data (small, more solid bars)</li>
</ul>
<div class="sourceCode" id="cb918"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># begin ggplot</span>
<span class="co">##############</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  <span class="co"># default x-axis is age in years;</span>

  <span class="co"># population data graph</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">pyramid_data</span>, <span class="va">data</span> <span class="op">==</span> <span class="st">"population"</span><span class="op">)</span>,
           stat <span class="op">=</span> <span class="st">"identity"</span>,
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age_cat5</span>,
               y <span class="op">=</span> <span class="va">percent</span>,
               fill <span class="op">=</span> <span class="va">gender</span><span class="op">)</span>,        
           colour <span class="op">=</span> <span class="st">"black"</span>,                               <span class="co"># black color around bars</span>
           alpha <span class="op">=</span> <span class="fl">0.2</span>,                                    <span class="co"># more transparent</span>
           width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span>                                     <span class="co"># full width</span>
  
  <span class="co"># case data graph</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">pyramid_data</span>, <span class="va">data</span> <span class="op">==</span> <span class="st">"cases"</span><span class="op">)</span>, 
           stat <span class="op">=</span> <span class="st">"identity"</span>,                              <span class="co"># use % as given in data, not counting rows</span>
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age_cat5</span>,                               <span class="co"># age categories as original X axis</span>
               y <span class="op">=</span> <span class="va">percent</span>,                                <span class="co"># % as original Y-axis</span>
               fill <span class="op">=</span> <span class="va">gender</span><span class="op">)</span>,                             <span class="co"># fill of bars by gender</span>
           colour <span class="op">=</span> <span class="st">"black"</span>,                               <span class="co"># black color around bars</span>
           alpha <span class="op">=</span> <span class="fl">1</span>,                                      <span class="co"># not transparent </span>
           width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">+</span>                                   <span class="co"># half width</span>
  
  <span class="co"># flip the X and Y axes to make pyramid vertical</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  
  <span class="co"># adjust axes order, scale, and labels (remember X and Y axes are flipped now)</span>
  <span class="co"># manually ensure that age-axis is ordered correctly</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="va">age_levels</span><span class="op">)</span><span class="op">+</span> 
  
  <span class="co"># set percent-axis </span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">min_per</span>, <span class="va">max_per</span><span class="op">)</span>,                                          <span class="co"># min and max defined above</span>
                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">min_per</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">max_per</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,                <span class="co"># from min% to max% by 2 </span>
                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>                                                       <span class="co"># for the labels, paste together... </span>
                       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">min_per</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">max_per</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,                  <span class="co"># ...rounded absolute values of breaks... </span>
                       <span class="st">"%"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                                                               <span class="co"># ... with "%"</span>
                                                                                            <span class="co"># floor(), ceiling() round down and up </span>

  <span class="co"># designate colors and legend labels manually</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>
    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"f"</span> <span class="op">=</span> <span class="st">"orange"</span>,         <span class="co"># assign colors to values in the data</span>
               <span class="st">"m"</span> <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span>,
    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"f"</span> <span class="op">=</span> <span class="st">"Female"</span>,
               <span class="st">"m"</span><span class="op">=</span> <span class="st">"Male"</span><span class="op">)</span>,      <span class="co"># change labels that appear in legend, note order</span>
  <span class="op">)</span> <span class="op">+</span>

  <span class="co"># plot labels, titles, caption    </span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"Case age and gender distribution,\nas compared to baseline population"</span>,
    subtitle <span class="op">=</span> <span class="st">""</span>,
    x <span class="op">=</span> <span class="st">"Age category"</span>,
    y <span class="op">=</span> <span class="st">"Percent of total"</span>,
    fill <span class="op">=</span> <span class="cn">NULL</span>,
    caption <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"Cases shown on top of country demographic baseline\nCase data are from linelist, n = {nrow(linelist)}\nAge or gender missing for {sum(is.na(linelist$gender) | is.na(linelist$age_years))} cases\nCase data as of: {format(max(linelist$date_onset, na.rm=T), '%d %b %Y')}"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># optional aesthetic themes</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>
    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,                             <span class="co"># move legend to bottom</span>
    panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
    axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,
    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, 
    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0</span>, size<span class="op">=</span><span class="fl">11</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 13 rows containing missing values (position_stack).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-600-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="likert-scale" class="section level2 tabset tabset-fade" number="31.5">
<h2>
<span class="header-section-number">31.5</span> Likert scale<a class="anchor" aria-label="anchor" href="#likert-scale"><i class="fas fa-link"></i></a>
</h2>
<p>The techniques used to make a population pyramid with <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> can also be used to make plots of Likert-scale survey data.</p>
<p>Import the data</p>
<div class="sourceCode" id="cb920"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># import the likert survey response data</span>
<span class="va">likert_data</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"likert_data.csv"</span><span class="op">)</span></code></pre></div>
<p>Start with data that looks like this, with a categorical classification of each respondent (<code>status</code>) and their answers to 8 questions on a 4-point Likert-type scale (“Very poor”, “Poor”, “Good”, “Very good”).</p>
<div class="sourceCode" id="cb921"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># display the linelist data as a table</span>
<span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html">datatable</a></span><span class="op">(</span><span class="va">likert_data</span>, rownames <span class="op">=</span> <span class="cn">FALSE</span>, filter<span class="op">=</span><span class="st">"top"</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pageLength <span class="op">=</span> <span class="fl">10</span>, scrollX<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">)</span></code></pre></div>
<p>First, some data management steps:</p>
<ul>
<li>Pivot the data longer<br>
</li>
<li>Create new column <code>direction</code> depending on whether response was generally “positive” or “negative”<br>
</li>
<li>Set the Factor level order for the <code>status</code> column and the <code>Response</code> column<br>
</li>
<li>Store the max count value so limits of plot are appropriate</li>
</ul>
<div class="sourceCode" id="cb922"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">melted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="va">likert_data</span>, <span class="va">Q1</span><span class="op">:</span><span class="va">Q8</span>, names_to <span class="op">=</span> <span class="st">"Question"</span>, values_to <span class="op">=</span> <span class="st">"Response"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>direction <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span>
               <span class="va">Response</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Poor"</span>,<span class="st">"Very Poor"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Negative"</span>,
               <span class="va">Response</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Good"</span>, <span class="st">"Very Good"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"Positive"</span>,
               <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Unknown"</span><span class="op">)</span>,
            status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">status</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
                 <span class="st">"Senior"</span>, <span class="st">"Intermediate"</span>, <span class="st">"Junior"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
            Response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Response</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Very Good"</span>, <span class="st">"Good"</span>,
                                             <span class="st">"Very Poor"</span>, <span class="st">"Poor"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># must reverse Very Poor and Poor for ordering to work</span>

<span class="va">melted_max</span> <span class="op">&lt;-</span> <span class="va">melted</span> <span class="op">%&gt;%</span> 
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">status</span>, <span class="va">Question</span><span class="op">)</span> <span class="op">%&gt;%</span> 
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by 'status'. You can override using the `.groups` argument.</code></pre>
<div class="sourceCode" id="cb924"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">melted_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">melted_max</span><span class="op">$</span><span class="va">n</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span></code></pre></div>
<p>Now make the plot:</p>
<div class="sourceCode" id="cb925"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make plot</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
     <span class="co"># bar graph of the "negative" responses </span>
     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">melted</span>,
                            <span class="va">direction</span> <span class="op">==</span> <span class="st">"Negative"</span><span class="op">)</span>, 
              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">status</span>,
                        y<span class="op">=</span><span class="va">..count..</span><span class="op">*</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,    <span class="co"># counts inverted to negative</span>
                        fill <span class="op">=</span> <span class="va">Response</span><span class="op">)</span>,
                    color <span class="op">=</span> <span class="st">"black"</span>,
                    closed <span class="op">=</span> <span class="st">"left"</span>, 
                    position <span class="op">=</span> <span class="st">"stack"</span><span class="op">)</span><span class="op">+</span>
     
     <span class="co"># bar graph of the "positive responses</span>
     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">melted</span>, <span class="va">direction</span> <span class="op">==</span> <span class="st">"Positive"</span><span class="op">)</span>,
              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">status</span>, fill <span class="op">=</span> <span class="va">Response</span><span class="op">)</span>,
              colour <span class="op">=</span> <span class="st">"black"</span>,
              closed <span class="op">=</span> <span class="st">"left"</span>,
              position <span class="op">=</span> <span class="st">"stack"</span><span class="op">)</span><span class="op">+</span>
     
     <span class="co"># flip the X and Y axes</span>
     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  
     <span class="co"># Black vertical line at 0</span>
     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"black"</span>, size<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span>
     
    <span class="co"># convert labels to all positive numbers</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">melted_max</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="fl">11</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">melted_max</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span>,   <span class="co"># seq from neg to pos by 10, edges rounded outward to nearest 5</span>
                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">melted_max</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">melted_max</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>,
                       labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">melted_max</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="fl">10</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,
                                            <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">melted_max</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
     
    <span class="co"># color scales manually assigned </span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Very Good"</span>  <span class="op">=</span> <span class="st">"green4"</span>, <span class="co"># assigns colors</span>
                                  <span class="st">"Good"</span>      <span class="op">=</span> <span class="st">"green3"</span>,
                                  <span class="st">"Poor"</span>      <span class="op">=</span> <span class="st">"yellow"</span>,
                                  <span class="st">"Very Poor"</span> <span class="op">=</span> <span class="st">"red3"</span><span class="op">)</span>,
                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Very Good"</span>, <span class="st">"Good"</span>, <span class="st">"Poor"</span>, <span class="st">"Very Poor"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="co"># orders the legend</span>
     
    
     
    <span class="co"># facet the entire plot so each question is a sub-plot</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Question</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">+</span>
     
    <span class="co"># labels, titles, caption</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Respondent status"</span>,
          y <span class="op">=</span> <span class="st">"Number of responses"</span>,
          fill <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">+</span>
     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="fu">str_glue</span><span class="op">(</span><span class="st">"Likert-style responses\nn = {nrow(likert_data)}"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>

     <span class="co"># aesthetic settings</span>
     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,
           axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,
           strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,  <span class="co"># facet sub-titles</span>
           plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,
           panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span> <span class="co"># black box around each facet</span></code></pre></div>
<pre><code>## Warning: Ignoring unknown parameters: closed

## Warning: Ignoring unknown parameters: closed</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-606-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="resources-21" class="section level2 tabset tabset-fade" number="31.6">
<h2>
<span class="header-section-number">31.6</span> Resources<a class="anchor" aria-label="anchor" href="#resources-21"><i class="fas fa-link"></i></a>
</h2>
<p>This tab should stay with the name “Resources”.
Links to other online tutorials or resources.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="tables.html"><span class="header-section-number">30</span> Tables</a></div>
<div class="next"><a href="diagrams.html"><span class="header-section-number">32</span> Diagrams</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#age-pyramids"><span class="header-section-number">31</span> Age pyramids</a></li>
<li><a class="nav-link" href="#overview-27"><span class="header-section-number">31.1</span> Overview</a></li>
<li><a class="nav-link" href="#preparation-22"><span class="header-section-number">31.2</span> Preparation</a></li>
<li>
<a class="nav-link" href="#apyramid-package"><span class="header-section-number">31.3</span> apyramid package</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#linelist-data"><span class="header-section-number">31.3.1</span> Linelist data</a></li>
<li><a class="nav-link" href="#aggregated-data-1"><span class="header-section-number">31.3.2</span> Aggregated data</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#ggplot-1"><span class="header-section-number">31.4</span> ggplot()</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#constructing-the-plot"><span class="header-section-number">31.4.1</span> Constructing the plot</a></li>
<li><a class="nav-link" href="#compare-to-baseline"><span class="header-section-number">31.4.2</span> Compare to baseline</a></li>
</ul>
</li>
<li><a class="nav-link" href="#likert-scale"><span class="header-section-number">31.5</span> Likert scale</a></li>
<li><a class="nav-link" href="#resources-21"><span class="header-section-number">31.6</span> Resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R Handbook for Epidemiologists</strong>" was written by the handbook team. It was last built on 2021-02-08.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
