<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>1 Factors | The Epidemiologist R Handbook</title>
<meta name="author" content="the handbook team">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.7/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.4/tabs.js"></script><script src="libs/bs3compat-0.2.4/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">The Epidemiologist R Handbook</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">Preview pages</li>
<li><a class="active" href="factors.html"><span class="header-section-number">1</span> Factors</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="factors" class="section level1" number="1">
<h1>
<span class="header-section-number">1</span> Factors<a class="anchor" aria-label="anchor" href="#factors"><i class="fas fa-link"></i></a>
</h1>
<p>In R, <em>factors</em> are a class of data that allow for ordered categories with a fixed set of acceptable values. Typically, you would convert a column from character or numeric class to a factor if you want to set an intrinsic order to the values (“<em>levels</em>”) so they can be displayed non-alphabetically in plots and tables. Another common use of factors is to standardise the legends of plots so they do not fluctuate if certain values are temporarily absent from the data.</p>
<p>This page demonstrates use of functions from the package <strong>forcats</strong> (a short name for “<strong>For</strong> <strong>cat</strong>egorical variables”) and some <strong>base</strong> R functions. We also touch upon the use of <strong>lubridate</strong> and <strong>aweek</strong> for special factor cases related to epidemiological weeks.</p>
<p>A complete list of <strong>forcats</strong> functions can be found online <a href="https://forcats.tidyverse.org/reference/index.html">here</a>. Below we demonstrate some of the most common ones.</p>
<!-- ======================================================= -->
<div id="preparation" class="section level2" number="1.1">
<h2>
<span class="header-section-number">1.1</span> Preparation<a class="anchor" aria-label="anchor" href="#preparation"><i class="fas fa-link"></i></a>
</h2>
<div id="load-packages" class="section level3 unnumbered">
<h3>Load packages<a class="anchor" aria-label="anchor" href="#load-packages"><i class="fas fa-link"></i></a>
</h3>
<p>This code chunk shows the loading of packages required for the analyses. In this handbook we emphasize <code>p_load()</code> from <strong>pacman</strong>, which installs the package if necessary <em>and</em> loads it for use. You can also load installed packages with <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> from <strong>base</strong> R. See the page on [R basics] for more information on R packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span>
  <span class="va">rio</span>,           <span class="co"># import/export</span>
  <span class="va">here</span>,          <span class="co"># filepaths</span>
  <span class="va">lubridate</span>,     <span class="co"># working with dates</span>
  <span class="va">forcats</span>,       <span class="co"># factors</span>
  <span class="va">aweek</span>,         <span class="co"># create epiweeks with automatic factor levels</span>
  <span class="va">janitor</span>,       <span class="co"># tables</span>
  <span class="va">tidyverse</span>      <span class="co"># data mgmt and viz</span>
  <span class="op">)</span></code></pre></div>
</div>
<div id="import-data" class="section level3 unnumbered">
<h3>Import data<a class="anchor" aria-label="anchor" href="#import-data"><i class="fas fa-link"></i></a>
</h3>
<p>We import the dataset of cases from a simulated Ebola epidemic. If you want to follow along, <a href="https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds" class="download-button">click to download the “clean” linelist</a> (as .rds file). Import your data with the <code>import()</code> function from the <strong>rio</strong> package (it accepts many file types like .xlsx, .rds, .csv - see the [Import and export] page for details).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># import your dataset</span>
<span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu">import</span><span class="op">(</span><span class="st">"linelist_cleaned.xlsx"</span><span class="op">)</span></code></pre></div>
</div>
<div id="fct_newcat" class="section level3 unnumbered">
<h3>New categorical variable<a class="anchor" aria-label="anchor" href="#fct_newcat"><i class="fas fa-link"></i></a>
</h3>
<p>For demonstration in this page we will use a common scenario - the creation of a new categorical variable.</p>
<div id="create-column" class="section level4 unnumbered">
<h4>Create column<a class="anchor" aria-label="anchor" href="#create-column"><i class="fas fa-link"></i></a>
</h4>
<p>We use the existing column <code>days_onset_hosp</code> (days from symptom onset to hospital admission) and create a new column <code>delay_cat</code> by classifying each row into one of several categories. We do this with the <strong>dplyr</strong> function <code>case_when()</code>, which sequentially applies logical criteria (right-side) to each row and returns the corresponding left-side value for the new column <code>delay_cat</code>. Read more about <code>case_when()</code> in [Cleaning data and core functions].</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>delay_cat <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span>
    <span class="co"># criteria                                   # new value if TRUE</span>
    <span class="va">days_onset_hosp</span> <span class="op">&lt;</span> <span class="fl">2</span>                        <span class="op">~</span> <span class="st">"&lt;2 days"</span>,
    <span class="va">days_onset_hosp</span> <span class="op">&gt;=</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">days_onset_hosp</span> <span class="op">&lt;</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"2-5 days"</span>,
    <span class="va">days_onset_hosp</span> <span class="op">&gt;=</span> <span class="fl">5</span>                       <span class="op">~</span> <span class="st">"&gt;5 days"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">days_onset_hosp</span><span class="op">)</span>                     <span class="op">~</span> <span class="cn">NA_character_</span>,
    <span class="cn">TRUE</span>                                       <span class="op">~</span> <span class="st">"Check me"</span><span class="op">)</span><span class="op">)</span>  </code></pre></div>
</div>
<div id="default-value-order" class="section level4 unnumbered">
<h4>Default value order<a class="anchor" aria-label="anchor" href="#default-value-order"><i class="fas fa-link"></i></a>
</h4>
<p>As created with <code>case_when()</code>, the new column <code>delay_cat</code> is a categorical column of class Character - <em>not</em> yet a factor. Thus, in a frequency table, we see that the unique values appear in a default alpha-numeric order - an order that does not make much intuitive sense:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">delay_cat</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  &lt;2 days  &gt;5 days 2-5 days     &lt;NA&gt; 
##     2990      602     2040      256</code></pre>
<p>Likewise, if we make a bar plot, the values also appear in this order on the x-axis (see the [ggplot basics] page for more on <strong>ggplot2</strong> - the most common visualization package in R).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_bar</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay_cat</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-92-1.png" width="672"></div>
</div>
</div>
</div>
<div id="convert-to-factor" class="section level2" number="1.2">
<h2>
<span class="header-section-number">1.2</span> Convert to factor<a class="anchor" aria-label="anchor" href="#convert-to-factor"><i class="fas fa-link"></i></a>
</h2>
<p>To initially convert a character or numeric column to the class factor you have two options: the <strong>base</strong> R function <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code>, or the <strong>forcats</strong> function <code>as_factor()</code>. We suggest using the <strong>base</strong> R function <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code> because it allows you to convert to factor <em>and</em> set the order of the levels in one command (90% of the time this is all you really want to do).</p>
<p>Below we use <code>mutate()</code> and <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code> to convert the column <code>delay_cat</code> from class character to class factor. The column <code>delay_cat</code> is created in the <a href="factors.html#fct_newcat">Preparation</a> section above.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>delay_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">delay_cat</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><em>The unique “values” in this column are now considered “levels” of the factor.</em> The levels have an <em>order</em>, which can be printed with the <strong>base</strong> R function <code><a href="https://rdrr.io/r/base/levels.html">levels()</a></code>, or alternatively viewed in a count table via <code><a href="https://rdrr.io/r/base/table.html">table()</a></code> from <strong>base</strong> R or <code>tabyl()</code> from <strong>janitor</strong>. By default, the order of the levels will be alpha-numeric, as before. Note that <code>NA</code> is not a factor level.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">delay_cat</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "&lt;2 days"  "&gt;5 days"  "2-5 days"</code></pre>
<p>However, you can conveniently specify the levels and their order in the <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code> command, as a character vector to the <code>levels =</code> argument. The spelling must exactly match the values. The vector of values you provide sets two things:</p>
<ol style="list-style-type: decimal">
<li>The column’s possible/acceptable values. These can include values that do not yet exist in the column (but might later). Later, if add rows or attempt to otherwise convert/add new values to <code>delay_cat</code>, R will return an error if the value is not in the defined levels.<br>
</li>
<li>The order of the levels</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>delay_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">delay_cat</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;2 days"</span>, <span class="st">"2-5 days"</span>, <span class="st">"&gt;5 days"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We can now see that the levels are ordered, as specified in the previous command, in a sensible order.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">delay_cat</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "&lt;2 days"  "2-5 days" "&gt;5 days"</code></pre>
<p>Now the plot order makes more intuitive sense as well.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_bar</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay_cat</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-97-1.png" width="672"></div>
</div>
<div id="add-or-drop-levels" class="section level2" number="1.3">
<h2>
<span class="header-section-number">1.3</span> Add or drop levels<a class="anchor" aria-label="anchor" href="#add-or-drop-levels"><i class="fas fa-link"></i></a>
</h2>
<div id="add" class="section level3 unnumbered">
<h3>Add<a class="anchor" aria-label="anchor" href="#add"><i class="fas fa-link"></i></a>
</h3>
<p>If you need to add levels to a factor, you can do this with <code>fct_expand()</code>. Just write the factor name followed by the new levels (separated by commas). By tabulating the values, we can see the new levels and the zero counts. You can use <code><a href="https://rdrr.io/r/base/table.html">table()</a></code> from <strong>base</strong> R, or <code>tabyl()</code> from <strong>janitor</strong>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>delay_cat <span class="op">=</span> <span class="fu">fct_expand</span><span class="op">(</span><span class="va">delay_cat</span>, <span class="st">"Not admitted to hospital"</span>, <span class="st">"Transfer to other jurisdiction"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">tabyl</span><span class="op">(</span><span class="va">delay_cat</span><span class="op">)</span>   <span class="co"># print table</span></code></pre></div>
<pre><code>##                       delay_cat    n    percent valid_percent
##                         &lt;2 days 2990 0.50781250     0.5308949
##                        2-5 days 2040 0.34646739     0.3622159
##                         &gt;5 days  602 0.10224185     0.1068892
##        Not admitted to hospital    0 0.00000000     0.0000000
##  Transfer to other jurisdiction    0 0.00000000     0.0000000
##                            &lt;NA&gt;  256 0.04347826            NA</code></pre>
<p>Note: there is a special <strong>forcats</strong> function to easily add missing values (<code>NA</code>) as a level. See the section on <a href="factors.html#fct_missing">Missing values</a> below.</p>
</div>
<div id="drop" class="section level3 unnumbered">
<h3>Drop<a class="anchor" aria-label="anchor" href="#drop"><i class="fas fa-link"></i></a>
</h3>
<p>If you use <code>fct_drop()</code>, the “unused” levels with zero counts will be dropped from the set of levels. The levels we added above (“Not admitted to a hospital”) exists as a level but no rows actually have those values. So they will be dropped by applying <code>fct_drop()</code> to our factor column:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>delay_cat <span class="op">=</span> <span class="fu">fct_drop</span><span class="op">(</span><span class="va">delay_cat</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">tabyl</span><span class="op">(</span><span class="va">delay_cat</span><span class="op">)</span></code></pre></div>
<pre><code>##  delay_cat    n    percent valid_percent
##    &lt;2 days 2990 0.50781250     0.5308949
##   2-5 days 2040 0.34646739     0.3622159
##    &gt;5 days  602 0.10224185     0.1068892
##       &lt;NA&gt;  256 0.04347826            NA</code></pre>
</div>
</div>
<div id="adjust-level-order" class="section level2" number="1.4">
<h2>
<span class="header-section-number">1.4</span> Adjust level order<a class="anchor" aria-label="anchor" href="#adjust-level-order"><i class="fas fa-link"></i></a>
</h2>
<p>The package <strong>forcats</strong> offers useful functions to easily adjust the order of a factor’s levels (after a column been defined as class factor):</p>
<p>These functions can be applied to a factor column in two contexts:</p>
<ol style="list-style-type: decimal">
<li>To the column in the data frame, as usual, so the transformation is available for any subsequent use of the data<br>
</li>
<li>
<em>Inside of a plot</em>, so that the change is applied only within the plot</li>
</ol>
<div id="manually" class="section level3 unnumbered">
<h3>Manually<a class="anchor" aria-label="anchor" href="#manually"><i class="fas fa-link"></i></a>
</h3>
<p>This function is used to manually order the factor levels. Within the parentheses first provide the factor column name, then provide either:</p>
<ul>
<li>All the levels in the desired order (as a character vector <code><a href="https://rdrr.io/r/base/c.html">c()</a></code>), or<br>
</li>
<li>One level and it’s corrected placement using the <code>after =</code> argument</li>
</ul>
<p>Here is an example of redefining the column <code>delay_cat</code> (which is already class Factor) and specifying all the desired order of levels.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># re-define level order</span>
<span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>delay_cat <span class="op">=</span> <span class="fu">fct_relevel</span><span class="op">(</span><span class="va">delay_cat</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;2 days"</span>, <span class="st">"2-5 days"</span>, <span class="st">"&gt;5 days"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>If you only want to move one level, you can specify it to <code>fct_relevel()</code> alone and give a number to the <code>after =</code> argument to indicate where in the order it should be. For example, the command below shifts “&lt;2 days” to the second position:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># re-define level order</span>
<span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>delay_cat <span class="op">=</span> <span class="fu">fct_relevel</span><span class="op">(</span><span class="va">delay_cat</span>, <span class="st">"&lt;2 days"</span>, after <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">tabyl</span><span class="op">(</span><span class="va">delay_cat</span><span class="op">)</span></code></pre></div>
</div>
<div id="within-a-plot" class="section level3 unnumbered">
<h3>Within a plot<a class="anchor" aria-label="anchor" href="#within-a-plot"><i class="fas fa-link"></i></a>
</h3>
<p>The <strong>forcats</strong> commands can be used to set the level order in the data frame, or only within a plot. By using the command to “wrap around” the column name <em>within</em> the <code>ggplot()</code> plotting command, you can reverse/relevel/etc. the transformation will only apply within that plot.</p>
<p>Below, two plots are created with <code>ggplot()</code> (see the [ggplot basics] page). In the first, the <code>delay_cat</code> column is mapped to the x-axis of the plot, with it’s default level order as in the data <code>linelist</code>. In the second example it is wrapped within <code>fct_relevel()</code> and the order is changed in the plot.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Alpha-numeric default order - no adjustment within ggplot</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span><span class="op">)</span><span class="op">+</span>
    <span class="fu">geom_bar</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay_cat</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Factor level order adjusted within ggplot</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_bar</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">fct_relevel</span><span class="op">(</span><span class="va">delay_cat</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;2 days"</span>, <span class="st">"2-5 days"</span>, <span class="st">"&gt;5 days"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-103-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-103-2.png" width="50%"></p>
<p>Note that default x-axis title is now quite complicated - you can overwrite this title with the <strong>ggplot2</strong> <code>labs()</code> argument.</p>
</div>
<div id="reverse" class="section level3 unnumbered">
<h3>Reverse<a class="anchor" aria-label="anchor" href="#reverse"><i class="fas fa-link"></i></a>
</h3>
<p>It is rather common that you want to reverse the level order. Simply wrap the factor with <code>fct_rev()</code>.</p>
<p>Note that if you want to reverse <em>only</em> a plot legend but not the actual factor levels, you can do that with <code>guides()</code> (see [ggplot tips]).</p>
</div>
<div id="by-frequency" class="section level3 unnumbered">
<h3>By frequency<a class="anchor" aria-label="anchor" href="#by-frequency"><i class="fas fa-link"></i></a>
</h3>
<p>To order by frequency that the value appears in the data, use <code>fct_infreq()</code>. Any missing values (<code>NA</code>) will automatically be included at the end, unless they are converted to an explicit level (see <a href="factors.html#fct_missing">this section</a>). You can reverse the order by further wrapping with <code>fct_rev()</code>.</p>
<p>This function can be used within a <code>ggplot()</code>, as shown below.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ordered by frequency</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">fct_infreq</span><span class="op">(</span><span class="va">delay_cat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_bar</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Delay onset to admission (days)"</span>,
       title <span class="op">=</span> <span class="st">"Ordered by frequency"</span><span class="op">)</span>

<span class="co"># reversed frequency</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="fu">fct_infreq</span><span class="op">(</span><span class="va">delay_cat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_bar</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Delay onset to admission (days)"</span>,
       title <span class="op">=</span> <span class="st">"Reverse of order by frequency"</span><span class="op">)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-104-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-104-2.png" width="50%"></p>
</div>
<div id="by-appearance" class="section level3 unnumbered">
<h3>By appearance<a class="anchor" aria-label="anchor" href="#by-appearance"><i class="fas fa-link"></i></a>
</h3>
<p>Use <code>fct_inorder()</code> to set the level order to match the order of appearance in the data, starting from the first row. This can be useful if you first carefully <code>arrange()</code> the data in the data frame, and then use this to set the factor order.</p>
</div>
<div id="by-summary-statistic-of-another-column" class="section level3 unnumbered">
<h3>By summary statistic of another column<a class="anchor" aria-label="anchor" href="#by-summary-statistic-of-another-column"><i class="fas fa-link"></i></a>
</h3>
<p>You can use <code>fct_reorder()</code> to order the levels of one column <em>by a summary statistic of another column</em>. Visually, this can result in pleasing plots where the bars/points ascend or descend steadily across the plot.</p>
<p>In the examples below, the x-axis is <code>delay_cat</code>, and the y-axis is numeric column <code>ct_blood</code> (cycle-threshold value). Box plots show the CT value distribution by <code>delay_cat</code> group. We want to order the box plots in ascending order by the group median CT value.</p>
<p>In the first example below, the default order alpha-numeric level order is used. You can see the box plot heights are jumbled and not in any particular order. In the second example, the <code>delay_cat</code> column (mapped to the x-axis) has been wrapped in <code>fct_reorder()</code>, the column <code>ct_blood</code> is given as the second argument, and “median” is given as the third argument (you could also use “max”, “mean”, “min”, etc). Thus, the order of the levels of <code>delay_cat</code> will now reflect ascending median CT values of each <code>delay_cat</code> group’s median CT value. This is reflected in the second plot - the box plots have been re-arranged to ascend. Note how <code>NA</code> (missing) will appear at the end, unless converted to an explicit level.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># boxplots ordered by original factor levels</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_boxplot</span><span class="op">(</span>
    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay_cat</span>,
        y <span class="op">=</span> <span class="va">ct_blood</span>, 
        fill <span class="op">=</span> <span class="va">delay_cat</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Delay onset to admission (days)"</span>,
       title <span class="op">=</span> <span class="st">"Ordered by original alpha-numeric levels"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>


<span class="co"># boxplots ordered by median CT value</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_boxplot</span><span class="op">(</span>
    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">fct_reorder</span><span class="op">(</span><span class="va">delay_cat</span>, <span class="va">ct_blood</span>, <span class="st">"median"</span><span class="op">)</span>,
        y <span class="op">=</span> <span class="va">ct_blood</span>,
        fill <span class="op">=</span> <span class="va">delay_cat</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Delay onset to admission (days)"</span>,
       title <span class="op">=</span> <span class="st">"Ordered by median CT value in group"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-105-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-105-2.png" width="50%"></p>
<p>Note in this example above there are no steps required prior to the <code>ggplot()</code> call - the grouping and calculations are all done internally to the ggplot command.</p>
</div>
<div id="by-end-value" class="section level3 unnumbered">
<h3>By “end” value<a class="anchor" aria-label="anchor" href="#by-end-value"><i class="fas fa-link"></i></a>
</h3>
<p>Use <code>fct_reorder2()</code> for grouped line plots. It orders the levels (and therefore the <em>legend</em>) to align with the vertical ordering of the lines at the “end” of the plot. Technically speaking, it “orders by the y-values associated with the largest x values.”</p>
<p>For example, if you have lines showing case counts by hospital over time, you can apply <code>fct_reorder2()</code> to the <code>color =</code> argument within <code>aes()</code>, such that the vertical order of hospitals appearing in the legend aligns with the order of lines at the terminal end of the plot. Read more in the <a href="https://forcats.tidyverse.org/reference/fct_reorder.html">online documentation</a>.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">epidemic_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span>         <span class="co"># begin with the linelist   </span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">date_onset</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2014-09-21"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>    <span class="co"># cut-off date, for visual clarity</span>
    <span class="fu">count</span><span class="op">(</span>                                            <span class="co"># get case counts per week and by hospital</span>
      epiweek <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">date_onset</span>, <span class="st">"week"</span><span class="op">)</span>,  
      <span class="va">hospital</span>                                            
    <span class="op">)</span> 
  
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">epidemic_data</span><span class="op">)</span><span class="op">+</span>                       <span class="co"># start plot</span>
  <span class="fu">geom_line</span><span class="op">(</span>                                        <span class="co"># make lines</span>
    <span class="fu">aes</span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">epiweek</span>,                                  <span class="co"># x-axis epiweek</span>
      y <span class="op">=</span> <span class="va">n</span>,                                        <span class="co"># height is number of cases per week</span>
      color <span class="op">=</span> <span class="fu">fct_reorder2</span><span class="op">(</span><span class="va">hospital</span>, <span class="va">epiweek</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="co"># data grouped and colored by hospital, with factor order by height at end of plot</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Factor levels (and legend display) by line height at end of plot"</span>,
       color <span class="op">=</span> <span class="st">"Hospital"</span><span class="op">)</span>                          <span class="co"># change legend title</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-106-1.png" width="672"></div>
</div>
</div>
<div id="fct_missing" class="section level2" number="1.5">
<h2>
<span class="header-section-number">1.5</span> Missing values<a class="anchor" aria-label="anchor" href="#fct_missing"><i class="fas fa-link"></i></a>
</h2>
<p>If you have <code>NA</code> values in your factor column, you can easily convert them to a named level such as “Missing” with <code>fct_explicit_na()</code>. The <code>NA</code> values are converted to “(Missing)” at the end of the level order by default. You can adjust the level name with the argument <code>na_level =</code>.</p>
<p>Below, this opertation is performed on the column <code>delay_cat</code> and a table is printed with <code>tabyl()</code> with <code>NA</code> converted to “Missing delay”.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>delay_cat <span class="op">=</span> <span class="fu">fct_explicit_na</span><span class="op">(</span><span class="va">delay_cat</span>, na_level <span class="op">=</span> <span class="st">"Missing delay"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">tabyl</span><span class="op">(</span><span class="va">delay_cat</span><span class="op">)</span></code></pre></div>
<pre><code>##      delay_cat    n    percent
##       2-5 days 2040 0.34646739
##        &lt;2 days 2990 0.50781250
##        &gt;5 days  602 0.10224185
##  Missing delay  256 0.04347826</code></pre>
</div>
<div id="combine-levels" class="section level2" number="1.6">
<h2>
<span class="header-section-number">1.6</span> Combine levels<a class="anchor" aria-label="anchor" href="#combine-levels"><i class="fas fa-link"></i></a>
</h2>
<div id="manually-1" class="section level3 unnumbered">
<h3>Manually<a class="anchor" aria-label="anchor" href="#manually-1"><i class="fas fa-link"></i></a>
</h3>
<p>You can adjust the level displays manually manually with <code>fct_recode()</code>. This is like the <strong>dplyr</strong> function <code>recode()</code> (see [Cleaning data and core functions]), but it allows the creation of new factor levels. If you use the simple <code>recode()</code> on a factor, new re-coded values will be rejected unless they have already been set as permissible levels.</p>
<p>This tool can also be used to “combine” levels, by assigning multiple levels the same re-coded value. Just be careful to not lose information! Consider doing these combining steps in a new column (not over-writing the existing column).</p>
<p><code>fct_recode()</code> has a different syntax than <code>recode()</code>. <code>recode()</code> uses <code>OLD = NEW</code>, whereas <code>fct_recode()</code> uses <code>NEW = OLD</code>.</p>
<p>The current levels of <code>delay_cat</code> are:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">delay_cat</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "&lt;2 days"  "2-5 days" "&gt;5 days"</code></pre>
<p>The new levels are created using syntax <code>fct_recode(column, "new" = "old", "new" = "old", "new" = "old")</code> and printed:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>delay_cat <span class="op">=</span> <span class="fu">fct_recode</span><span class="op">(</span>
    <span class="va">delay_cat</span>,
    <span class="st">"Less than 2 days"</span> <span class="op">=</span> <span class="st">"&lt;2 days"</span>,
    <span class="st">"2 to 5 days"</span>      <span class="op">=</span> <span class="st">"2-5 days"</span>,
    <span class="st">"More than 5 days"</span> <span class="op">=</span> <span class="st">"&gt;5 days"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">tabyl</span><span class="op">(</span><span class="va">delay_cat</span><span class="op">)</span></code></pre></div>
<pre><code>##         delay_cat    n    percent valid_percent
##  Less than 2 days 2990 0.50781250     0.5308949
##       2 to 5 days 2040 0.34646739     0.3622159
##  More than 5 days  602 0.10224185     0.1068892
##              &lt;NA&gt;  256 0.04347826            NA</code></pre>
<p>Here they are manually combined with <code>fct_recode()</code>. Note there is no error raised at the creation of a new level “Less than 5 days”.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>delay_cat <span class="op">=</span> <span class="fu">fct_recode</span><span class="op">(</span>
    <span class="va">delay_cat</span>,
    <span class="st">"Less than 5 days"</span> <span class="op">=</span> <span class="st">"&lt;2 days"</span>,
    <span class="st">"Less than 5 days"</span> <span class="op">=</span> <span class="st">"2-5 days"</span>,
    <span class="st">"More than 5 days"</span> <span class="op">=</span> <span class="st">"&gt;5 days"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">tabyl</span><span class="op">(</span><span class="va">delay_cat</span><span class="op">)</span></code></pre></div>
<pre><code>##         delay_cat    n    percent valid_percent
##  Less than 5 days 5030 0.85427989     0.8931108
##  More than 5 days  602 0.10224185     0.1068892
##              &lt;NA&gt;  256 0.04347826            NA</code></pre>
</div>
<div id="reduce-into-other" class="section level3 unnumbered">
<h3>Reduce into “Other”<a class="anchor" aria-label="anchor" href="#reduce-into-other"><i class="fas fa-link"></i></a>
</h3>
<p>You can use <code>fct_other()</code> to manually assign factor levels to an “Other” level. Below, all levels in the column <code>hospital</code>, aside from “Port Hospital” and “Central Hospital”, are combined into “Other”. You can provide a vector to either <code>keep =</code>, or <code>drop =</code>. You can change the display of the “Other” level with <code>other_level =</code>.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span>    
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu">fct_other</span><span class="op">(</span>                      <span class="co"># adjust levels</span>
    <span class="va">hospital</span>,
    keep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Port Hospital"</span>, <span class="st">"Central Hospital"</span><span class="op">)</span>,  <span class="co"># keep these separate</span>
    other_level <span class="op">=</span> <span class="st">"Other Hospital"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>            <span class="co"># All others as "Other Hospital"</span>
  <span class="fu">tabyl</span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span>                                   <span class="co"># print table</span></code></pre></div>
<pre><code>##          hospital    n    percent
##  Central Hospital  454 0.07710598
##     Port Hospital 1762 0.29925272
##    Other Hospital 3672 0.62364130</code></pre>
</div>
<div id="reduce-by-frequency" class="section level3 unnumbered">
<h3>Reduce by frequency<a class="anchor" aria-label="anchor" href="#reduce-by-frequency"><i class="fas fa-link"></i></a>
</h3>
<p>You can combine the least-frequent factor levels automatically using <code>fct_lump()</code>.</p>
<p>To “lump” together many low-frequency levels into an “Other” group, do one of the following:</p>
<ul>
<li>Set <code>n =</code> as the number of groups you want to keep. The n most-frequent levels will be kept, and all others will combine into “Other”.<br>
</li>
<li>Set <code>prop =</code> as the threshold frequency proportion for levels above which you want to keep. All other values will combine into “Other”.</li>
</ul>
<p>You can change the display of the “Other” level with <code>other_level =</code>. Below, all but the two most-frequent hospitals are combined into “Other Hospital”.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span>    
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu">fct_lump</span><span class="op">(</span>                      <span class="co"># adjust levels</span>
    <span class="va">hospital</span>,
    n <span class="op">=</span> <span class="fl">2</span>,                                          <span class="co"># keep top 2 levels</span>
    other_level <span class="op">=</span> <span class="st">"Other Hospital"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>            <span class="co"># all others as "Other Hospital"</span>
  <span class="fu">tabyl</span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span>                                   <span class="co"># print table</span></code></pre></div>
<pre><code>##        hospital    n   percent
##         Missing 1469 0.2494905
##   Port Hospital 1762 0.2992527
##  Other Hospital 2657 0.4512568</code></pre>
<p>, warn
## Show all levels</p>
<p>One benefit of using factors is to standardise the appearance of plot legends and tables, regardless of which values are actually present in a dataset.</p>
<p>If you are preparing many figures (e.g. for multiple jurisdictions) you will want the legends and tables to appear identically even with varying levels of data completion or data composition.</p>
</div>
<div id="in-plots" class="section level3 unnumbered">
<h3>In plots<a class="anchor" aria-label="anchor" href="#in-plots"><i class="fas fa-link"></i></a>
</h3>
<p>In a <code>ggplot()</code> figure, simply add the argument <code>drop = FALSE</code> in the relevant <code>scale_xxxx()</code> function. All factor levels will be displayed, regardless of whether they are present in the data. If your factor column levels are displayed using <code>fill =</code>, then in scale_fill_discrete() you include <code>drop = FALSE</code>, as shown below. If your levels are displayed with <code>x =</code> (to the x-axis) <code>color =</code> or <code>size =</code> you would provide this to <code>scale_color_discrete()</code> or <code>scale_size_discrete()</code> accordingly.</p>
<p>This example is a stacked bar plot of age category, by hospital. Adding <code>scale_fill_discrete(drop = FALSE)</code> ensures that all age groups appear in the legend, even if not present in the data.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_bar</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">hospital</span>, fill <span class="op">=</span> <span class="va">age_cat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_discrete</span><span class="op">(</span>drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span>                        <span class="co"># show all age groups in the legend, even those not present</span>
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"All age groups will appear in legend, even if not present in data"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-114-1.png" width="672"></div>
</div>
<div id="in-tables" class="section level3 unnumbered">
<h3>In tables<a class="anchor" aria-label="anchor" href="#in-tables"><i class="fas fa-link"></i></a>
</h3>
<p>Both the <strong>base</strong> R <code><a href="https://rdrr.io/r/base/table.html">table()</a></code> and <code>tabyl()</code> from <strong>janitor</strong> will show all factor levels (even unused levels).</p>
<p>If you use <code>count()</code> or <code>summarise()</code> from <strong>dplyr</strong> to make a table, add the argument <code>.drop = FALSE</code> to include counts for all factor levels even those unused.</p>
<p>Read more in the [Descriptive tables] page, or at the <a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_discrete documentation</a>, or the <a href="https://dplyr.tidyverse.org/reference/count.html">count() documentation</a>. You can see another example in the [Contact tracing] page.</p>
</div>
</div>
<div id="epiweeks" class="section level2" number="1.7">
<h2>
<span class="header-section-number">1.7</span> Epiweeks<a class="anchor" aria-label="anchor" href="#epiweeks"><i class="fas fa-link"></i></a>
</h2>
<p>Please see the extensive discussion of how to create epidemiological weeks in the [Grouping data] page.<br>
Please also see the [Working with dates] page for tips on how to create and format epidemiological weeks.</p>
<div id="epiweeks-in-a-plot" class="section level3 unnumbered">
<h3>Epiweeks in a plot<a class="anchor" aria-label="anchor" href="#epiweeks-in-a-plot"><i class="fas fa-link"></i></a>
</h3>
<p>If your goal is to create epiweeks to display in a plot, you can do this simply with <strong>lubridate</strong>’s <code>floor_date()</code>, as explained in the [Grouping data] page. The values returned will be of class Date with format YYYY-MM-DD. If you use this column in a plot, the dates will naturally order correctly, and you do not need to worry about levels or converting to class Factor. See the <code>ggplot()</code> histogram of onset dates below.</p>
<p>In this approach, you can adjust the <em>display</em> of the dates on an axis with <code>scale_x_date()</code>. See the page on [Epidemic curves] for more information. You can specify a “strptime” display format to the <code>date_labels =</code> argument of <code>scale_x_date()</code>. These formats use “%” placeholders and are covered in the [Working with dates] page. Use “%Y” to represent a 4-digit year, and either “%W” or “%U” to represent the week number (Monday or Sunday weeks respectively).</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>epiweek_date <span class="op">=</span> <span class="fu">floor_date</span><span class="op">(</span><span class="va">date_onset</span>, <span class="st">"week"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># create week column</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                                  <span class="co"># begin ggplot</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek_date</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>           <span class="co"># histogram of date of onset</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>date_labels <span class="op">=</span> <span class="st">"%Y-W%W"</span><span class="op">)</span>                       <span class="co"># adjust disply of dates to be YYYY-WWw</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-115-1.png" width="672"></div>
</div>
<div id="epiweeks-in-the-data" class="section level3 unnumbered">
<h3>Epiweeks in the data<a class="anchor" aria-label="anchor" href="#epiweeks-in-the-data"><i class="fas fa-link"></i></a>
</h3>
<p>However, if your purpose in factoring is <em>not</em> to plot, you can approach this one of two ways:</p>
<ol style="list-style-type: decimal">
<li>
<em>For fine control over the display</em>, convert the <strong>lubridate</strong> epiweek column (YYYY-MM-DD) to the desired display format (YYYY-WWw) <em>within the data frame itself</em>, and then convert it to class Factor.</li>
</ol>
<p>First, use <code><a href="https://rdrr.io/r/base/format.html">format()</a></code> from <strong>base</strong> R to convert the date display from YYYY-MM-DD to YYYY-Www display (see the [Working with dates] page). In this process the class will be converted to character. Then, convert from character to class Factor with <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code>.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>epiweek_date <span class="op">=</span> <span class="fu">floor_date</span><span class="op">(</span><span class="va">date_onset</span>, <span class="st">"week"</span><span class="op">)</span>,       <span class="co"># create epiweeks (YYYY-MM-DD)</span>
         epiweek_formatted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">epiweek_date</span>, <span class="st">"%Y-W%W"</span><span class="op">)</span>,  <span class="co"># Convert to display (YYYY-WWw)</span>
         epiweek_formatted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">epiweek_formatted</span><span class="op">)</span><span class="op">)</span>       <span class="co"># Convert to factor</span>

<span class="co"># Display levels</span>
<span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">epiweek_formatted</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "2014-W13" "2014-W14" "2014-W15" "2014-W16" "2014-W17" "2014-W18" "2014-W19" "2014-W20" "2014-W21" "2014-W22" "2014-W23" "2014-W24" "2014-W25" "2014-W26" "2014-W27" "2014-W28"
## [17] "2014-W29" "2014-W30" "2014-W31" "2014-W32" "2014-W33" "2014-W34" "2014-W35" "2014-W36" "2014-W37" "2014-W38" "2014-W39" "2014-W40" "2014-W41" "2014-W42" "2014-W43" "2014-W44"
## [33] "2014-W45" "2014-W46" "2014-W47" "2014-W48" "2014-W49" "2014-W50" "2014-W51" "2015-W00" "2015-W01" "2015-W02" "2015-W03" "2015-W04" "2015-W05" "2015-W06" "2015-W07" "2015-W08"
## [49] "2015-W09" "2015-W10" "2015-W11" "2015-W12" "2015-W13" "2015-W14" "2015-W15" "2015-W16"</code></pre>
<p><span style="color: red;"><strong><em>DANGER:</em></strong> If you place the weeks ahead of the years (“Www-YYYY”) (“%W-%Y”), the default alpha-numeric level ordering will be incorrect (e.g. 01-2015 will be before 35-2014). You could need to manually adjust the order, which would be a long painful process.</span></p>
<ol start="2" style="list-style-type: decimal">
<li>
<em>For fast default display</em>, use the <strong>aweek</strong> package and it’s function <code>date2week()</code>. You can set the <code>week_start =</code> day, and if you set <code>factor = TRUE</code> then the output column is an ordered factor. As a bonus, the factor includes levels for <em>all</em> possible weeks in the span - even if there are no cases that week.</li>
</ol>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>epiweek <span class="op">=</span> <span class="fu">date2week</span><span class="op">(</span><span class="va">date_onset</span>, week_start <span class="op">=</span> <span class="st">"Monday"</span>, factor <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span></code></pre></div>
<p>See the [Working with dates] page for more information about <strong>aweek</strong>. It also offers the reverse function <code>week2date()</code>.</p>
<!-- ======================================================= -->
</div>
</div>
<div id="resources" class="section level2" number="1.8">
<h2>
<span class="header-section-number">1.8</span> Resources<a class="anchor" aria-label="anchor" href="#resources"><i class="fas fa-link"></i></a>
</h2>
<p>R for Data Science page on <a href="https://r4ds.had.co.nz/factors.html">factors</a><br><a href="https://cran.r-project.org/web/packages/aweek/vignettes/introduction.html">aweek package vignette</a></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="index.html"></a></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#factors"><span class="header-section-number">1</span> Factors</a></li>
<li>
<a class="nav-link" href="#preparation"><span class="header-section-number">1.1</span> Preparation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#load-packages">Load packages</a></li>
<li><a class="nav-link" href="#import-data">Import data</a></li>
<li><a class="nav-link" href="#fct_newcat">New categorical variable</a></li>
</ul>
</li>
<li><a class="nav-link" href="#convert-to-factor"><span class="header-section-number">1.2</span> Convert to factor</a></li>
<li>
<a class="nav-link" href="#add-or-drop-levels"><span class="header-section-number">1.3</span> Add or drop levels</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#add">Add</a></li>
<li><a class="nav-link" href="#drop">Drop</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#adjust-level-order"><span class="header-section-number">1.4</span> Adjust level order</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#manually">Manually</a></li>
<li><a class="nav-link" href="#within-a-plot">Within a plot</a></li>
<li><a class="nav-link" href="#reverse">Reverse</a></li>
<li><a class="nav-link" href="#by-frequency">By frequency</a></li>
<li><a class="nav-link" href="#by-appearance">By appearance</a></li>
<li><a class="nav-link" href="#by-summary-statistic-of-another-column">By summary statistic of another column</a></li>
<li><a class="nav-link" href="#by-end-value">By “end” value</a></li>
</ul>
</li>
<li><a class="nav-link" href="#fct_missing"><span class="header-section-number">1.5</span> Missing values</a></li>
<li>
<a class="nav-link" href="#combine-levels"><span class="header-section-number">1.6</span> Combine levels</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#manually-1">Manually</a></li>
<li><a class="nav-link" href="#reduce-into-other">Reduce into “Other”</a></li>
<li><a class="nav-link" href="#reduce-by-frequency">Reduce by frequency</a></li>
<li><a class="nav-link" href="#in-plots">In plots</a></li>
<li><a class="nav-link" href="#in-tables">In tables</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#epiweeks"><span class="header-section-number">1.7</span> Epiweeks</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#epiweeks-in-a-plot">Epiweeks in a plot</a></li>
<li><a class="nav-link" href="#epiweeks-in-the-data">Epiweeks in the data</a></li>
</ul>
</li>
<li><a class="nav-link" href="#resources"><span class="header-section-number">1.8</span> Resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>The Epidemiologist R Handbook</strong>" was written by the handbook team. It was last built on 2021-05-02.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
