<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>1 Epidemic curves | R Handbook for Epidemiologists</title>
<meta name="author" content="the handbook team">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.6/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.15/datatables.js"></script><link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R Handbook for Epidemiologists</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome - THIS IS A DRAFT</a></li>
<li class="book-part">Preview pages</li>
<li><a class="active" href="epidemic-curves.html"><span class="header-section-number">1</span> Epidemic curves</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="epidemic-curves" class="section level1" number="1">
<h1>
<span class="header-section-number">1</span> Epidemic curves<a class="anchor" aria-label="anchor" href="#epidemic-curves"><i class="fas fa-link"></i></a>
</h1>
<!-- ======================================================= -->
<div id="overview" class="section level2 unnumbered">
<h2>Overview<a class="anchor" aria-label="anchor" href="#overview"><i class="fas fa-link"></i></a>
</h2>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-69-1.png" width="75%"></div>
<!-- ======================================================= -->
</div>
<div id="preparation" class="section level2" number="1.1">
<h2>
<span class="header-section-number">1.1</span> Preparation<a class="anchor" aria-label="anchor" href="#preparation"><i class="fas fa-link"></i></a>
</h2>
<div id="packages" class="section level3 unnumbered">
<h3>Packages<a class="anchor" aria-label="anchor" href="#packages"><i class="fas fa-link"></i></a>
</h3>
<p>This code chunk shows the loading of packages required for the analyses.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">rio</span>,          <span class="co"># file import/export</span>
               <span class="va">here</span>,         <span class="co"># relative filepaths </span>
               <span class="va">lubridate</span>,    <span class="co"># working with dates/epiweeks</span>
               <span class="va">aweek</span>,        <span class="co"># alternative package for working with dates/epiweeks</span>
               <span class="va">incidence</span>,    <span class="co"># epicurves of linelist data</span>
               <span class="va">stringr</span>,      <span class="co"># search and manipulate character strings</span>
               <span class="va">forcats</span>,      <span class="co"># working with factors</span>
               <span class="va">RColorBrewer</span>, <span class="co"># Color palettes from colorbrewer2.org</span>
               <span class="va">tidyverse</span>     <span class="co"># data management + ggplot2 graphics</span>
<span class="op">)</span> </code></pre></div>
</div>
<div id="load-data" class="section level3 unnumbered">
<h3>Load data<a class="anchor" aria-label="anchor" href="#load-data"><i class="fas fa-link"></i></a>
</h3>
<p>Two example datasets are used in this section:</p>
<ul>
<li>Linelist of individual cases from a simulated epidemic<br>
</li>
<li>Aggregated counts by hospital from the same simulated epidemic</li>
</ul>
<p>The dataset is imported using the <code>import()</code> function from the <em>rio</em> package. See the page on [Import and export] for various ways to import data. The linelist and aggregated versions of the data are displayed below.</p>
<p>For most of this document, the <em>linelist dataset</em> will be used. The aggregated counts dataset will be used at the end.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"linelist_cleaned.xlsx"</span><span class="op">)</span></code></pre></div>
<p>Review the two datasets and notice the differences</p>
<p><strong>Case linelist</strong></p>
<p>The first 50 rows are displayed</p>
<div id="htmlwidget-803e19b23169c00e14b8" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-803e19b23169c00e14b8">{"x":{"filter":"none","data":[["d8a13d","8689b7","11f8ea","dae8c7","acf422","1a4ac9","275cc7","1389ca","057e7a","c97dd9","02d8fd","c36eb4","88eff2","542d07","f50e8a","7f5a01","b799eb","415e3a","bc2adf","188c88","959170","dd9d20","6d788e","67be4e","a9feb3","f81362","4c1040","2cb9a5","342b03","92ddf7","69446e","583717","0a9827","3789ee","d9f1b9","14224c","c5d4ec","53f4ae","c8c030","6b70f0","675f57","1a9636","059cc0","9cd6d0","4ade58","571076","7d99f2","6dca26","579c1d","267434"],[4,4,2,3,6,6,5,4,7,9,9,8,5,5,10,7,5,6,6,10,8,7,11,8,6,8,7,11,7,9,12,10,9,10,8,8,7,7,9,7,11,14,10,12,11,13,12,14,11,15],["2014-05-06",null,null,"2014-05-23","2014-05-25",null,"2014-05-24",null,"2014-06-04",null,"2014-06-14","2014-06-15",null,"2014-06-10",null,"2014-06-23","2014-06-27",null,"2014-07-03","2014-07-03","2014-06-29",null,"2014-07-12","2014-07-15","2014-06-29",null,"2014-07-17",null,null,"2014-07-19",null,null,null,"2014-07-26","2014-07-18","2014-07-17","2014-07-21","2014-07-30",null,null,"2014-07-30",null,null,"2014-08-01","2014-08-02","2014-08-06","2014-07-24",null,"2014-08-03","2014-08-01"],["2014-05-08","2014-05-13","2014-05-16",null,"2014-05-27","2014-05-27","2014-05-27","2014-06-05","2014-06-14",null,"2014-06-20","2014-06-20","2014-06-20",null,"2014-06-22","2014-06-25","2014-07-03","2014-07-06","2014-07-09","2014-07-09","2014-07-13",null,"2014-07-16","2014-07-17","2014-07-19","2014-07-20",null,"2014-07-22","2014-07-22","2014-07-23","2014-07-23","2014-07-27","2014-07-28","2014-08-01","2014-08-02","2014-08-02","2014-08-02",null,"2014-08-02","2014-08-03","2014-08-04","2014-08-05","2014-08-05","2014-08-06","2014-08-07","2014-08-07","2014-08-08","2014-08-09","2014-08-09","2014-08-10"],["2014-05-10","2014-05-14","2014-05-18","2014-05-27","2014-05-28","2014-05-29","2014-05-28","2014-06-07","2014-06-15","2014-06-19","2014-06-20","2014-06-21","2014-06-21","2014-06-23","2014-06-23","2014-06-27","2014-07-05","2014-07-08","2014-07-09","2014-07-11","2014-07-13","2014-07-17","2014-07-17","2014-07-19","2014-07-21","2014-07-21","2014-07-20","2014-07-22","2014-07-24","2014-07-25","2014-07-25","2014-07-28","2014-07-30","2014-08-02","2014-08-03","2014-08-02","2014-08-02","2014-08-04","2014-08-02","2014-08-04","2014-08-04","2014-08-06","2014-08-05","2014-08-07","2014-08-09","2014-08-08","2014-08-10","2014-08-10","2014-08-10","2014-08-11"],[null,"2014-05-18","2014-05-30","2014-05-30","2014-06-27","2014-06-07","2014-06-07","2014-06-09",null,"2014-07-11","2014-07-01","2014-06-24","2014-06-24","2014-06-28","2014-07-01","2014-07-06","2014-07-12","2014-07-26",null,"2014-07-16","2014-07-19","2014-07-21",null,"2014-08-14","2014-08-03","2014-08-07",null,"2014-08-28","2014-08-24",null,"2014-07-27","2014-08-06","2014-07-20","2014-09-13","2014-08-24","2014-08-19",null,null,"2014-08-11",null,"2014-08-18","2014-08-13","2014-08-24","2014-08-13","2014-09-08","2014-08-24","2014-08-27","2014-08-14","2014-08-16","2014-08-21"],[null,"Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover","Death","Death","Death","Death",null,"Death","Recover","Recover",null,null,"Death","Recover","Recover","Recover","Death","Death","Recover","Recover",null,"Recover","Death","Death",null,null,null,null,null,"Death",null,"Death","Recover","Death","Recover","Recover","Recover","Recover","Recover","Death","Death","Recover"],["f","f","m","f","m","m","f","f","f","m","m","m","f","m","f","f","m","f","m","f","f","m","m","f","f","m",null,"f","f","m","f","m","m","f","m","m","m","f","f","m","f","m","m","m","m","f","f","f","f","m"],[3,7,21,4,4,30,13,2,4,22,20,16,5,16,0,13,14,13,19,3,2,23,13,7,14,35,null,10,9,32,31,27,12,12,21,24,33,9,8,40,28,3,18,17,14,17,1,20,29,1],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[3,7,21,4,4,30,13,2,4,22,20,16,5,16,0,13,14,13,19,3,2,23,13,7,14,35,null,10,9,32,31,27,12,12,21,24,33,9,8,40,28,3,18,17,14,17,1,20,29,1],["0-4","5-9","20-29","0-4","0-4","30-49","10-14","0-4","0-4","20-29","20-29","15-19","5-9","15-19","0-4","10-14","10-14","10-14","15-19","0-4","0-4","20-29","10-14","5-9","10-14","30-49",null,"10-14","5-9","30-49","30-49","20-29","10-14","10-14","20-29","20-29","30-49","5-9","5-9","30-49","20-29","0-4","15-19","15-19","10-14","15-19","0-4","20-29","20-29","0-4"],["0-4","5-9","20-24","0-4","0-4","30-34","10-14","0-4","0-4","20-24","20-24","15-19","5-9","15-19","0-4","10-14","10-14","10-14","15-19","0-4","0-4","20-24","10-14","5-9","10-14","35-39",null,"10-14","5-9","30-34","30-34","25-29","10-14","10-14","20-24","20-24","30-34","5-9","5-9","40-44","25-29","0-4","15-19","15-19","10-14","15-19","0-4","20-24","25-29","0-4"],["St. Mark's Maternity Hospital (SMMH)","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Central Hospital","Port Hospital","Central Hospital","Missing","Missing","Port Hospital","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Port Hospital","Missing","Missing","Other","Missing","Central Hospital","Central Hospital","Missing","Missing","Other","St. Mark's Maternity Hospital (SMMH)","Other","Other","Port Hospital","Other","Missing","Military Hospital","Other","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Missing","Missing","Port Hospital","Port Hospital","Missing","Port Hospital","Other","Military Hospital","Missing","Port Hospital","Other","Other"],[-13.2354719577436,-13.2152339775486,-13.212910703914,-13.2197320896877,-13.2688968279886,-13.2604684939726,-13.2369393782451,-13.2572163655863,-13.2180326141688,-13.2243437095992,-13.2124311244169,-13.2619688324425,-13.2195578885261,-13.2628934511971,-13.2336087079551,-13.2339681355349,-13.2162953240809,-13.2531041397858,-13.2266742923612,-13.2123762615712,-13.2452992638476,-13.2192936985287,-13.2199077448676,-13.2343062806506,-13.2155668757305,-13.2163318124535,-13.2359603887432,-13.2097478342339,-13.2209544818868,-13.2221173306518,-13.2306657089937,-13.2587625731645,-13.2243932729634,-13.2137356012883,-13.2207093341173,-13.2564700881739,-13.2258087869163,-13.2223378683793,-13.2106014146595,-13.2486407324245,-13.2188046852032,-13.2461808628649,-13.2123634125052,-13.2111276946553,-13.2591405401705,-13.2191390852229,-13.2301859855135,-13.2481679868778,-13.2163350530737,-13.217405738006],[8.4627682729487,8.45171855856465,8.46481700596819,8.44852192548534,8.47845973648553,8.45421479878989,8.46916113869591,8.47292327643506,8.47155535608018,8.47145134147474,8.45344099552146,8.48475855218221,8.46210832824745,8.46479592922727,8.47804840685363,8.46957530395867,8.46395131808455,8.46110718866038,8.48408263734462,8.4594706833607,8.48334624336805,8.4859413033916,8.4693933891765,8.47121232619015,8.4627846208641,8.4630635336683,8.47704542384682,8.47714159984428,8.48436046542975,8.46420961833913,8.47808779372907,8.45574180260702,8.48325844901445,8.4732571907655,8.47571579396786,8.48329801272452,8.47317350834362,8.46136226718465,8.47793008081529,8.48480340615605,8.47782489076703,8.48313501406402,8.48309382244331,8.46975025432843,8.45279482787079,8.44933234263738,8.47770243597866,8.46556229437808,8.48604294056283,8.47529881925793],["20b688",null,null,"be7f8a","1511c5",null,"e02f66",null,"cbbe78",null,"e61cb9","057e7a",null,"4977bd",null,"a75c7f","ea3740",null,"b799eb","9d07e6","beb26e",null,"36e2e7","7baf73","af1c1f",null,"916d0a",null,null,"d15be5",null,null,null,"3b096b","7baf73","d0eead","805a4f","4af3d1",null,null,"7ee655",null,null,"0e3c82","3789ee","9cd6d0","ce4ec6",null,"b56849","db7b54"],["other",null,null,"other","other",null,"other",null,"funeral",null,"other","other",null,"funeral",null,"other","other",null,"other","funeral","funeral",null,"other","other","other",null,"other",null,null,"other",null,null,null,"other","other","other","funeral","other",null,null,"other",null,null,"funeral","other","other","other",null,"other","other"],[33,41,61,42,51,74,55,19,39,69,61,59,37,67,0,49,79,48,70,28,22,67,70,24,53,85,25,51,48,74,71,69,66,49,65,73,67,53,42,74,74,41,64,64,67,58,21,55,63,20],[55,104,171,60,89,173,115,52,67,135,133,149,78,141,22,113,153,142,137,50,31,160,168,84,144,174,42,115,120,201,203,182,140,134,132,166,176,112,100,173,124,62,126,113,164,98,40,130,163,53],[22,22,23,24,24,22,22,23,23,22,22,21,23,23,25,23,21,22,21,20,21,21,21,24,22,21,23,22,23,23,22,21,23,23,22,22,24,22,21,22,22,21,21,23,22,21,22,23,23,22],["no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no","no","no",null,null,"no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,null,"no","no","no","no",null,"no","no","no","no","no","no","no",null,"no","no"],["no","no","no",null,"no","no","yes","yes","no","no","no","yes","yes","no","no","no","no",null,null,"no","no",null,"yes","no","no","yes","no","no","no","no","no","no","no",null,null,"yes","yes","no","no",null,"yes","yes","no","no","no","yes","yes",null,"no","no"],["no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","no","yes",null,null,"yes","yes",null,"yes","no","yes","yes","yes","yes","yes","yes","yes","yes","no",null,null,"yes","yes","yes","yes",null,"yes","no","no","no","yes","yes","yes",null,"yes","yes"],["no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no","no","no",null,null,"no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,null,"no","no","no","no",null,"no","no","no","no","no","no","no",null,"no","no"],["no","no","no",null,"yes","no","yes","no","no","yes","yes","no","no","no","yes","yes","no",null,null,"yes","yes",null,"yes","yes","yes","no","yes","no","no","no","yes","no","yes",null,null,"yes","yes","no","yes",null,"no","no","no","no","no","yes","no",null,"no","yes"],[37.2,37,37,37.4,36.9,37.3,37.5,37.3,36.8,36.5,36.9,37,37.3,35.6,37.3,37,37,37.1,36.8,36.8,37.5,36.6,36.6,37.1,37.2,37.1,37.1,36.9,37.4,37.7,36.8,36.7,36.3,37.2,37.4,38,36,37.3,37.8,36.3,36.7,37.3,37.5,36,37,37.3,37.4,36.4,37.1,36.5],["19:08","14:47","11:19","17:22","10:37",null,"09:40","10:28","18:15","10:20","21:28","12:31","11:17",null,null,"11:48","15:03","14:26","10:49","14:32","08:48","17:27","23:27","19:03","16:40",null,"18:58","12:28","14:19",null,"16:54","10:11","06:53","09:48","05:56","07:21","14:48","16:29",null,"15:42",null,"15:07","15:45",null,null,"21:54","09:13","05:17","14:30","09:32"],[109.090909090909,37.9068047337278,20.8611196607503,116.666666666667,64.3858098724908,24.7251829329413,41.5879017013233,70.2662721893491,86.879037647583,37.8600823045267,34.4847080106281,26.5753794874105,60.8152531229454,33.7005180825914,0,38.374187485316,33.7477038745782,23.8048006347947,37.2955405189408,112,228.928199791883,26.171875,24.8015873015873,34.0136054421769,25.5594135802469,28.075042938301,141.72335600907,38.5633270321361,33.3333333333333,18.3163783074676,17.2292460384867,20.8308175341142,33.6734693877551,27.288928491869,37.3048668503214,26.4915082014806,21.6296487603306,42.2512755102041,42,24.7251829329413,48.1269510926119,106.659729448491,40.3124212648022,50.121387735923,24.9107674003569,60.3915035401916,131.25,32.5443786982248,23.7118446309609,71.1997152011392],[2,1,2,null,1,2,1,2,1,null,0,1,1,null,1,2,2,2,0,2,0,null,1,2,2,1,null,0,2,2,2,1,2,1,1,0,0,null,0,1,0,1,0,1,2,1,2,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p><strong>Case counts aggregated by hospital</strong></p>
<p>The first 50 rows are displayed</p>
<div id="htmlwidget-aab00efb314276a40ee2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-aab00efb314276a40ee2">{"x":{"filter":"none","data":[["Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital"],["2014-05-06","2014-05-10","2014-05-13","2014-05-28","2014-06-06","2014-06-09","2014-06-14","2014-06-19","2014-07-09","2014-07-10","2014-07-11","2014-07-13","2014-07-14","2014-07-15","2014-07-17","2014-07-19","2014-07-27","2014-07-30","2014-08-01","2014-08-02","2014-08-04","2014-08-05","2014-08-07","2014-08-09","2014-08-12","2014-08-14","2014-08-15","2014-08-16","2014-08-17","2014-08-18","2014-08-19","2014-08-20","2014-08-21","2014-08-22","2014-08-23","2014-08-24","2014-08-26","2014-08-28","2014-08-29","2014-08-30","2014-08-31","2014-09-01","2014-09-02","2014-09-03","2014-09-04","2014-09-05","2014-09-06","2014-09-07","2014-09-09","2014-09-10"],[1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2,1,1,2,1,2,1,1,2,1,3,1,1,1,2,3,2,2,2,1,2,2,2,1,2,3,3,2,1,1,2,3,2,2,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>n_cases<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="set-parameters" class="section level3 unnumbered">
<h3>Set parameters<a class="anchor" aria-label="anchor" href="#set-parameters"><i class="fas fa-link"></i></a>
</h3>
<p>You may want to set editable parameters for production of a report, such as the date for which the data is current (the “data date”).
You can then reference <code>data_date</code> in the code when applying filters or in captions that auto-update.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## set the report date for the report</span>
<span class="co">## note: can be set to Sys.Date() for the current date</span>
<span class="va">data_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2015-05-15"</span><span class="op">)</span></code></pre></div>
</div>
<div id="verify-dates" class="section level3 unnumbered">
<h3>Verify dates<a class="anchor" aria-label="anchor" href="#verify-dates"><i class="fas fa-link"></i></a>
</h3>
<p>Verify that each relevant date column is class Date and has an appropriate range of values.</p>
<p>You can do this one-by-one using <code><a href="https://rdrr.io/r/graphics/hist.html">hist()</a></code> for histograms, or <code><a href="https://rdrr.io/r/base/range.html">range()</a></code> with <code>na.rm=TRUE</code>. An alternative is to use a <em>for loop</em> to print a histogram for each pre-defined date column.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create character vector of column names </span>
<span class="va">DateCols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/vars_select.html">vars_select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span>, <span class="fu">matches</span><span class="op">(</span><span class="st">"date|Date|dt"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Produce histogram of each date column</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">Col</span> <span class="kw">in</span> <span class="va">DateCols</span><span class="op">)</span> <span class="op">{</span>     <span class="co"># open loop. iterate for each name in vector DateCols</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">[</span>, <span class="va">Col</span><span class="op">]</span>,     <span class="co"># print histogram of the column in linelist dataframe</span>
       breaks <span class="op">=</span> <span class="fl">50</span>,         <span class="co"># number of breaks for the histogram</span>
       xlab <span class="op">=</span> <span class="va">Col</span><span class="op">)</span>          <span class="co"># x-axis label is the name of the column</span>
  <span class="op">}</span>                         <span class="co"># close the loop</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-75-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-75-2.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-75-3.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-75-4.png" width="50%"></p>
<!-- ======================================================= -->
</div>
</div>
<div id="epicurves-with-incidence-package" class="section level2" number="1.2">
<h2>
<span class="header-section-number">1.2</span> Epicurves with <code>incidence</code> package<a class="anchor" aria-label="anchor" href="#epicurves-with-incidence-package"><i class="fas fa-link"></i></a>
</h2>
<p>Below are tabs on making quick epicurves using the <strong>incidence</strong> package</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> <strong>incidence</strong> expects data to be in a “linelist” format of one row per case (not aggregated). If your data is aggregated counts, read the section on aggregated data using <strong>ggplot2</strong>.</span></p>
<p><span style="color: darkgreen;"><strong><em>TIP:</em></strong> The documentation for plotting an <strong>incidence</strong> object can be accessed by entering <code>?plot.incidence</code> in your R console.</span></p>
<p>For further information see this <a href="https://cran.r-project.org/web/packages/incidence/vignettes/customize_plot.html#example-data-simulated-ebola-outbreak">incidence package vignette</a>.</p>
<!-- ======================================================= -->
<div id="simple-example" class="section level3 unnumbered">
<h3>Simple example<a class="anchor" aria-label="anchor" href="#simple-example"><i class="fas fa-link"></i></a>
</h3>
<p><strong>2 steps are requires to plot an epicurve with the <em>incidence</em> package:</strong></p>
<ol style="list-style-type: decimal">
<li>
<strong>Create</strong> an <em>incidence object</em> (using the function <code>incidence()</code>)
<ul>
<li>Provide the case linelist<br>
</li>
<li>Specify the <em>time interval</em> into which the cases should be aggregated (daily, weekly, monthly..)<br>
</li>
<li>Specify any sub-groups<br>
</li>
</ul>
</li>
<li>
<strong>Plot</strong> the incidence object
<ul>
<li>Specify labels, aesthetic themes, etc.</li>
</ul>
</li>
</ol>
<p><strong>A simple example</strong> - an epicurve of daily cases:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load incidence package</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">incidence</span><span class="op">)</span>

<span class="co"># create the incidence object aggregating case-rows by day</span>
<span class="va">epi_day</span>   <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>,  <span class="co"># the linelist date column of interest</span>
                       interval <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>     <span class="co"># the time interval</span>

<span class="co"># plot the incidence object</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_day</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-76-1.png" width="672"></div>
</div>
<div id="change-time-interval-of-case-aggregation" class="section level3 unnumbered">
<h3>Change time interval of case aggregation<a class="anchor" aria-label="anchor" href="#change-time-interval-of-case-aggregation"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>interval</code> argument defines how the observations are grouped into vertical bars. Some options are listed below (a full list originates from the package <strong>aweek</strong>):</p>
<ul>
<li>“week” (Monday start day is default)<br>
</li>
<li>“2 weeks” (or 3, 4, 5…)<br>
</li>
<li>“Sunday week”<br>
</li>
<li>“2 Sunday weeks” (or 3, 4, 5…)<br>
</li>
<li>“MMWRweek” (starts on Sunday - see US CDC)<br>
</li>
<li>“month” (1st of month)<br>
</li>
<li>“quarter” (1st of month of quarter)</li>
<li>“2 months” (or 3, 4, 5…)<br>
</li>
<li>“year” (1st day of calendar year)</li>
</ul>
<p>Below are examples of how different intervals look when applied to the linelist.<br>
Format and frequency of the date <em>labels</em> on the x-axis are the defaults for the specified interval.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create the incidence objects (with different intervals)</span>
<span class="co">##############################</span>
<span class="co"># Weekly (Monday week by default)</span>
<span class="va">epi_wk</span>      <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"Monday week"</span><span class="op">)</span>

<span class="co"># Sunday week</span>
<span class="va">epi_Sun_wk</span>  <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"Sunday week"</span><span class="op">)</span>

<span class="co"># Three weeks (Monday weeks by default)</span>
<span class="va">epi_3wk</span>     <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"3 weeks"</span><span class="op">)</span>

<span class="co"># Monthly</span>
<span class="va">epi_month</span>   <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span>


<span class="co"># Plot the incidence objects (+ titles for clarity)</span>
<span class="co">############################</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_wk</span><span class="op">)</span><span class="op">+</span>     <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Monday weeks"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_Sun_wk</span><span class="op">)</span><span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Sunday weeks"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_3wk</span><span class="op">)</span><span class="op">+</span>    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Every 3 Monday weeks"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_month</span><span class="op">)</span><span class="op">+</span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Months"</span><span class="op">)</span></code></pre></div>
<p><img src="_main_files/figure-html/incidence-1.png" width="50%"><img src="_main_files/figure-html/incidence-2.png" width="50%"><img src="_main_files/figure-html/incidence-3.png" width="50%"><img src="_main_files/figure-html/incidence-4.png" width="50%"></p>
</div>
<div id="filtered-data" class="section level3 unnumbered">
<h3>Filtered data<a class="anchor" aria-label="anchor" href="#filtered-data"><i class="fas fa-link"></i></a>
</h3>
<p>To plot the epicurve of a subset of data:</p>
<ol style="list-style-type: decimal">
<li>Filter the linelist data<br>
</li>
<li>Feed the filtered data to the <code>incidence()</code> command<br>
</li>
<li>Plot the incidence object</li>
</ol>
<p>The example below uses data filtered to show only cases at Central Hospital.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># filter the linelist</span>
<span class="va">central_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span>

<span class="co"># create incidence object using filtered data</span>
<span class="va">central_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span>

<span class="co"># plot the incidence object</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">central_outbreak</span><span class="op">)</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Weekly case incidence at Central Hospital"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-77-1.png" width="672"></div>
</div>
<div id="modifications-with-plot" class="section level3 unnumbered">
<h3>Modifications with <code>plot()</code><a class="anchor" aria-label="anchor" href="#modifications-with-plot"><i class="fas fa-link"></i></a>
</h3>
<p>An incidence plot can be modified via these arguments <em>within the <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> function</em>.</p>
<ul>
<li>
<code>show_cases =</code> - If TRUE, each case is shows as a box. Best on smaller outbreaks.<br>
</li>
<li>
<code>color =</code> - Color of case bars/boxes<br>
</li>
<li>
<code>border =</code> - Color of line around boxes, if <code>show_cases = TRUE</code><br>
</li>
<li>
<code>alpha =</code> - Transparency of case bars/boxes (1 is fully opaque, 0 is fully transparent)<br>
</li>
<li>
<code>xlab =</code> - Title of x-axis (axis labels can also be applied using <code>labs()</code> from ggplot)<br>
</li>
<li>
<code>ylab =</code> - Title of y-axis; defaults to user-defined incidence time interval<br>
</li>
<li>
<code>labels_week =</code> - Logical, indicate whether x-axis labels are in week or date format, absent other modifications</li>
<li>
<code>n_breaks =</code> - Number of x-axis label breaks, absent other modifications<br>
</li>
<li>
<code>first_date</code> &amp; <code>last_date</code> - Dates used to limit the date axis of the plot</li>
</ul>
<p>Type <code>?plot.incidence</code> in the R console for more details on each. Below is an example using some of the above arguments.<br>
To further adjust aesthetics, see the section on using <code>ggplot()</code> and apply those <code>theme()</code> arguments to the <strong>incidence</strong> plot.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># filter the linelist</span>
<span class="va">central_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span>

<span class="co"># create incidence object using filtered data</span>
<span class="va">central_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span>

<span class="co"># plot incidence object</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">central_outbreak</span>,
     xlab <span class="op">=</span> <span class="st">"Week of onset"</span>,
     ylab <span class="op">=</span> <span class="st">"Week of onset"</span>,
     show_cases <span class="op">=</span> <span class="cn">TRUE</span>,
     alpha <span class="op">=</span> <span class="fl">0.5</span>,
     color <span class="op">=</span> <span class="st">"darkblue"</span>,
     border <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-78-1.png" width="50%"></div>
</div>
<div id="ggplot2-modifictions" class="section level3 unnumbered">
<h3>ggplot2 modifictions<a class="anchor" aria-label="anchor" href="#ggplot2-modifictions"><i class="fas fa-link"></i></a>
</h3>
<p>You can add traditional <strong>ggplot2</strong> modifications to the incidence plot by adding a <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> after the close of the incidence <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> function, as demonstrated below:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># filter the linelist</span>
<span class="va">central_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span>

<span class="co"># create incidence object using filtered data</span>
<span class="va">central_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span>

<span class="co"># plot</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">central_outbreak</span>,         <span class="co"># plot with incidence package and arguments</span>
     xlab <span class="op">=</span> <span class="st">"Week of onset"</span>,
     ylab <span class="op">=</span> <span class="st">"Weekly case incidence"</span>,
     show_cases <span class="op">=</span> <span class="cn">TRUE</span>,
     alpha <span class="op">=</span> <span class="fl">0.5</span>,
     color <span class="op">=</span> <span class="st">"darkblue"</span>,
     border <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">+</span>
  
  <span class="co"># Add some modifications using ggplot() functions</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>      <span class="co"># remove excess space on left and right</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>      <span class="co"># remove excess space below 0 on y-axis</span>
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"Incidence plot with ggplot() modifications"</span>,
    caption <span class="op">=</span> <span class="st">"This is the caption for this plot"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>         <span class="co"># simplify background</span>
  <span class="fu">theme</span><span class="op">(</span>
    axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>,         <span class="co"># axis titles larger and bold</span>
                              face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,
    axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>,          <span class="co"># axis test bold</span>
                             face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,
    plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>       <span class="co"># move caption to left</span>
  <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-79-1.png" width="672"></div>
</div>
<div id="change-colors-and-legend" class="section level3 unnumbered">
<h3>Change colors and legend<a class="anchor" aria-label="anchor" href="#change-colors-and-legend"><i class="fas fa-link"></i></a>
</h3>
<div id="to-change-the-legend" class="section level4 unnumbered">
<h4>To change the legend<a class="anchor" aria-label="anchor" href="#to-change-the-legend"><i class="fas fa-link"></i></a>
</h4>
<p>Add <strong>ggplot2</strong> commands to the incidence plot, such as:</p>
<ul>
<li>
<code>theme(legend.position = "top")</code> (or “bottom”, “left”, “right”)</li>
<li>
<code>theme(legend.direction = "horizontal")</code><br>
</li>
<li>
<code>theme(legend.title = element_blank())</code> to have no title<br>
</li>
<li>
<code>guides(fill = guide_legend(reverse = TRUE))</code> to reverse order of the legend</li>
</ul>
<p>See the page of [ggplot tips] for more details on working with legends.</p>
</div>
<div id="to-change-colors" class="section level4 unnumbered">
<h4>To change colors<a class="anchor" aria-label="anchor" href="#to-change-colors"><i class="fas fa-link"></i></a>
</h4>
<p>To specify colors manually, provide the name of the color or a character vector of colors to the argument <code>color =</code>. The number of colors listed must equal the number of groups (be aware of missing values as a group)</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># weekly outbreak by hospital</span>
<span class="va">hosp_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>, 
                               interval <span class="op">=</span> <span class="st">"week"</span>, 
                               groups <span class="op">=</span> <span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span>,
                               na_as_group <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>   <span class="co"># Missing values not assigned their own group</span>
<span class="co"># default colors</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hosp_outbreak</span><span class="op">)</span>

<span class="co"># manual colors</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hosp_outbreak</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkgreen"</span>, <span class="st">"darkblue"</span>, <span class="st">"purple"</span>, <span class="st">"grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-80-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-80-2.png" width="50%"></p>
<p><strong>To change the color palette</strong><br>
Use the argument <code>col_pal</code> in <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> to change the color palette to one of the default <strong>base</strong> R palettes (do <em>not</em> put the name of the palette in quotes).</p>
<p>Alternatively, adjust the palette with <strong>ggplot2</strong> scales - see the [ggplot tips] page for details.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create incidence object, with data grouped by age category</span>
<span class="va">age_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>,            <span class="co"># date of onset for x-axis</span>
                               interval <span class="op">=</span> <span class="st">"week"</span>,         <span class="co"># weekly aggregation of cases</span>
                               groups <span class="op">=</span> <span class="va">linelist</span><span class="op">$</span><span class="va">age_cat</span>, <span class="co"># color by age_cat value</span>
                               na_as_group <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>        <span class="co"># missing values assigned their own group</span>

<span class="co"># plot the epicurve with default palette</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">age_outbreak</span><span class="op">)</span>

<span class="co"># plot with different color palette</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">age_outbreak</span>, col_pal <span class="op">=</span> <span class="va">rainbow</span><span class="op">)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-81-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-81-2.png" width="50%"></p>
</div>
</div>
<div id="show-individual-cases" class="section level3 unnumbered">
<h3>Show individual cases<a class="anchor" aria-label="anchor" href="#show-individual-cases"><i class="fas fa-link"></i></a>
</h3>
<p><strong>To show boxes around each individual case, use the argument <code>show_cases = TRUE</code> in the <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> function.</strong></p>
<p>Boxes around each case can be more reader-friendly, if the outbreak is of a small size. Boxes can be applied when the interval is days, weeks, or any other time period. The code below creates the <em>weekly</em> epicurve for a smaller outbreak (only cases from Central Hospital), with boxes around each case.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create filtered dataset for Central Hospital</span>
<span class="va">central_data</span>  <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span>

<span class="co"># create incidence object (weekly)</span>
<span class="va">central_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"Monday week"</span><span class="op">)</span>

<span class="co"># plot outbreak</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">central_outbreak</span>,
     show_cases <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>                 <span class="co"># show boxes around individual cases</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-82-1.png" width="672"></div>
<p>The same epicurve showing individual cases, but with other aesthetic modifications using <strong>ggplot2</strong>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># add plot() arguments and ggplot() commands</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">central_outbreak</span>,
     show_cases <span class="op">=</span> <span class="cn">T</span>,                 <span class="co"># show boxes around each individual case</span>
     color <span class="op">=</span> <span class="st">"lightblue"</span>,            <span class="co"># color inside boxes</span>
     border <span class="op">=</span> <span class="st">"darkblue"</span>,            <span class="co"># color of border around boxes</span>
     alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">+</span>                   <span class="co"># transparency</span>
  
  <span class="co">### ggplot() commands added to the plot</span>
  
  <span class="co"># scale modifications</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># remove excess x-axis space below and after case bars</span>
    date_breaks       <span class="op">=</span> <span class="st">"4 weeks"</span>,      <span class="co"># labels appear every 4 Monday weeks</span>
    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,         <span class="co"># vertical lines appear every Monday week</span>
    date_labels       <span class="op">=</span> <span class="st">"%d\n%b'%y"</span><span class="op">)</span><span class="op">+</span>   <span class="co"># date labels format </span>
  
  <span class="fu">scale_y_continuous</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>             <span class="co"># remove excess space under 0 on y-axis</span>

  <span class="co"># aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                <span class="co"># simplify background</span>
  
  <span class="fu">theme</span><span class="op">(</span>
    axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,       <span class="co"># axis title format</span>
    plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>  <span class="co"># caption format and left-align</span>
  
  <span class="co"># plot labels</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Week of symptom onset (Monday weeks)"</span>, 
       y <span class="op">=</span> <span class="st">"Weekly reported cases"</span>, 
       title <span class="op">=</span> <span class="st">"Weekly case incidence at Central Hospital"</span>,
       <span class="co">#subtitle = "",</span>
       caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; Case onsets range from {format(min(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')} to {format(max(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')}\n{nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-83-1.png" width="672"></div>
</div>
<div id="group-and-color-by-values" class="section level3 unnumbered">
<h3>Group and color by values<a class="anchor" aria-label="anchor" href="#group-and-color-by-values"><i class="fas fa-link"></i></a>
</h3>
<p>To color cases by a value, provide the column to the <code>groups =</code> argument in the <code>incidence()</code> command.</p>
<p>In the example below the cases are colored by their age category. Note the use of <code>incidence()</code> argument <code>na_as_group =</code>. If <code>TRUE</code> (by default), missing values (<code>NA</code>) will form their own group.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create incidence object, with data grouped by age category</span>
<span class="va">age_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>,            <span class="co"># date of onset for x-axis</span>
                               interval <span class="op">=</span> <span class="st">"week"</span>,         <span class="co"># Monday weekly aggregation of cases</span>
                               groups <span class="op">=</span> <span class="va">linelist</span><span class="op">$</span><span class="va">age_cat</span>, <span class="co"># color by age_cat value</span>
                               na_as_group <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>        <span class="co"># missing values assigned their own group</span>


<span class="co"># plot the grouped incidence object</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">age_outbreak</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-84-1.png" width="672"></div>
<p>To adjust the legend title, add the <strong>ggplot2</strong> function <code>labs()</code> as shown below, specifying a label for <code>fill =</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the grouped incidence object</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">age_outbreak</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Age category"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-85-1.png" width="672"></div>
</div>
<div id="adjust-level-order" class="section level3 unnumbered">
<h3>Adjust level order<a class="anchor" aria-label="anchor" href="#adjust-level-order"><i class="fas fa-link"></i></a>
</h3>
<p>To adjust the order of group appearance (on plot and in legend), the grouping column must be class Factor. See the page on [Factors] for more information.</p>
<p>Below is an epicurve by gender, and the objective is to show Missing on top, Male in the middle, and Female on the bottom - but to have the Legend in the reverse order so that Missing is on the bottom.</p>
<ul>
<li>First, the dataset is defined and gender is re-defined as a factor<br>
</li>
<li>The order of levels of gender are defined with <code>NA</code> first, so it appears on the top of the bars<br>
</li>
<li>More appropriate labels are defined for each factor level - these appear in the legend<br>
</li>
<li>The argument <code>exclude = NULL</code> in <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code> is necessary to adjust the order of <code>NA</code>, which is excluded by default.<br>
</li>
<li>Title of legend adjusted using <code>fill =</code> in <code>labs()</code>
</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ORIGINAL - </span>

<span class="co"># create weekly incidence object, grouped by hospital</span>
<span class="va">hospital_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span>
  <span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>, 
  interval <span class="op">=</span> <span class="st">"week"</span>, 
  groups <span class="op">=</span> <span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span>

<span class="co"># plot</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hospital_outbreak</span>,
     show_cases <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"ORIGINAL - hospital not a factor"</span><span class="op">)</span>



<span class="co"># MODIFIED - hospital as factor</span>
<span class="co">###############################</span>

<span class="co"># load forcats package for working with factors</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">forcats</span><span class="op">)</span>

<span class="co"># Convert hospital column to factor and adjust levels</span>
<span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>                       <span class="co"># define as factor</span>
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu">fct_explicit_na</span><span class="op">(</span><span class="va">hospital</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>   <span class="co"># convert NA to "Missing" </span>
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu">fct_lump</span><span class="op">(</span><span class="va">hospital</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>              <span class="co"># Keep 3 most frequent hospitals, with remaining combined into "Other" </span>
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu">fct_relevel</span><span class="op">(</span><span class="va">hospital</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Other"</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Set "Other" and "Missing" as top levels</span>


<span class="co"># Create weekly incidence object, grouped by hospital</span>
<span class="va">hospital_outbreak_mod</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span>
  <span class="va">plot_data</span><span class="op">$</span><span class="va">date_onset</span>, 
  interval <span class="op">=</span> <span class="st">"week"</span>, 
  groups <span class="op">=</span> <span class="va">plot_data</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span>

<span class="co"># plot</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hospital_outbreak_mod</span>,
     show_cases <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span>                       <span class="co"># do NOT show box around each case</span>
  
  
  <span class="co"># ggplot modifications     </span>
  <span class="fu">guides</span><span class="op">(</span>
    fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>       <span class="co"># reverse order of legend only   </span>

  <span class="co"># labels added via ggplot</span>
  <span class="fu">labs</span><span class="op">(</span>
      title <span class="op">=</span> <span class="st">"MODIFIED - hospital as factor"</span>,   <span class="co"># plot title</span>
      subtitle <span class="op">=</span> <span class="st">"Other &amp; Missing at top of epicurve and bottom of legend"</span>,
      y <span class="op">=</span> <span class="st">"Weekly case incidence"</span>,               <span class="co"># y axis title  </span>
      x <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,               <span class="co"># x axis title</span>
      fill <span class="op">=</span> <span class="st">"Hospital"</span><span class="op">)</span>                         <span class="co"># title of legend     </span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-86-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-86-2.png" width="50%"></p>
</div>
<div id="date-axis-labelsgridlines" class="section level3 unnumbered">
<h3>Date-axis labels/gridlines<a class="anchor" aria-label="anchor" href="#date-axis-labelsgridlines"><i class="fas fa-link"></i></a>
</h3>
<p><span style="color: darkgreen;"><strong><em>TIP:</em></strong> Remember that date-axis <strong>labels</strong> are independent from the aggregation of the data into bars</span></p>
<div id="modify-the-bars" class="section level4 unnumbered">
<h4>Modify the bars<a class="anchor" aria-label="anchor" href="#modify-the-bars"><i class="fas fa-link"></i></a>
</h4>
<p>The aggregation of data into bars occurs when you set the <code>interval =</code> when creating the incidence object. The options for <code>interval</code> come from the package <strong>aweek</strong> and include options like “day”, “Monday week”, “Sunday week”, “month”, “2 weeks”, etc, as described in an earlier section.</p>
</div>
<div id="modify-date-axis-labels-frequency-format" class="section level4 unnumbered">
<h4>Modify date-axis labels (frequency &amp; format)<a class="anchor" aria-label="anchor" href="#modify-date-axis-labels-frequency-format"><i class="fas fa-link"></i></a>
</h4>
<p>If working with the <strong>incidence</strong> package, you have several options to make modifications to the date-axis labels:</p>
<ol style="list-style-type: decimal">
<li>Use the <strong>incidence</strong> package functions <code>scale_x_date()</code> and <code>make_breaks()</code><br>
</li>
<li>Use the <strong>ggplot2</strong> function <code>scale_x_date()</code> and its argument such as <code>date_breaks</code> and date_labels`<br>
</li>
<li>Use a combination of the above</li>
</ol>
</div>
<div id="option-1-add-scale_x_incidence-only" class="section level4 unnumbered">
<h4>Option 1: Add <code>scale_x_incidence()</code> only<a class="anchor" aria-label="anchor" href="#option-1-add-scale_x_incidence-only"><i class="fas fa-link"></i></a>
</h4>
<p>Add <code>scale_x_incidence()</code> from the <strong>incidence</strong> package:</p>
<ul>
<li>
<strong>Advantages</strong>: Short code. Auto-adjusts weekly labels to interval of incidence object (Monday, Sunday weeks, etc.)<br>
</li>
<li>
<strong>Disadvantages</strong>: Cannot make <em>fine</em> adjustments to label format, nor to minor vertical grid-lines between labels</li>
</ul>
<p>Syntax: provide the name of the incidence object to ensure labels align with specified interval (e.g. Sunday or Monday weeks)</p>
<p>Optional arguments:</p>
<ul>
<li>Use <code>n_breaks =</code> to specify the number of date labels, which start from the <em>interval</em> of the first case
<ul>
<li>Tip: for breaks every nth week, use <code>n_breaks = nrow(i)/n</code> (where “i” is the incidence object name and “n” is a number)<br>
</li>
</ul>
</li>
<li>Use <code>labels_week =</code> to adjust whether labels are formatted as weeks (YYYY-Www) or dates (YYYY-MM-DD)
<ul>
<li>One vertical gridline will appear per date label</li>
</ul>
</li>
</ul>
<p>Other notes:</p>
<ul>
<li>If the interval is “month”, <code>n_breaks</code> and <code>labels_week</code> will behave differently<br>
</li>
<li>Adding <strong>ggplot2</strong>’s <code>scale_x_date()</code> to the plot will remove any labels created by <code>scale_x_incidence</code><br>
</li>
<li>Note that in plot below the first label is 27 April 2014, the Sunday before the first case (May 1) (aligns with Sunday weeks of the incidence object)<br>
</li>
<li>Type <code>?scale_x_incidence</code> into the R console to see more information.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create weekly incidence object (Sunday weeks)</span>
<span class="va">outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"Sunday week"</span><span class="op">)</span>

<span class="co"># plot with scale_x_incidence()</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">outbreak</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_x_incidence</span><span class="op">(</span><span class="va">outbreak</span>,             <span class="co"># name of incidence object</span>
                    labels_week <span class="op">=</span> <span class="cn">FALSE</span>,  <span class="co"># show dates instead of weeks</span>
                    n_breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">outbreak</span><span class="op">)</span><span class="op">/</span><span class="fl">8</span><span class="op">)</span> <span class="co"># breaks every 8 weeks from Sunday before first case</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-87-1.png" width="672"></div>
</div>
<div id="option-2-scale_x_date-and-make_breaks" class="section level4 unnumbered">
<h4>Option 2: <code>scale_x_date()</code> and <code>make_breaks()</code><a class="anchor" aria-label="anchor" href="#option-2-scale_x_date-and-make_breaks"><i class="fas fa-link"></i></a>
</h4>
<p>Add <code>scale_x_date()</code> from <strong>ggplot2</strong>, but also leverage <code>make_breaks()</code> from <strong>incidence</strong>:<br>
* <strong>Advantages</strong>: Best of both worlds: weekly labels auto-aligned to incidence interval, <em>and</em> you can make detailed adjustments to label format
* <strong>Disadvantages</strong>: <em>If</em> minor grid-lines on Sunday-week date labels are desired, they are not auto-aligned</p>
<p>Syntax: After creating the incidence object, use <code>make_breaks()</code> to define date label breaks. <code>make_breaks()</code> is similar to <code>scale_x_incidence()</code> (described above). Provide the incidence object name and optionally <code>n_breaks</code> as described before.</p>
<p>Lastly, add <code>scale_x_date()</code> to the incidence plot and use the following arguments:<br>
+ <code>breaks =</code> provide the breaks vector you created with <code>make_breaks()</code>, by accessing the <code>$breaks</code> vector (see example below)
+ <code>date_labels =</code> you can make fine adjustments to date label format (e.g. “%d %b”) (use “” for new line)<br>
+ <code>date_minor_breaks =</code> You can set this to weeks and it will</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Break modification using scale_x_date() and make_breaks()</span>
<span class="co">###########################################################</span>
<span class="co"># make incidence object</span>
<span class="va">outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"Monday week"</span><span class="op">)</span>

<span class="co"># make breaks</span>
<span class="va">my_labels</span> <span class="op">&lt;-</span>  <span class="fu">make_breaks</span><span class="op">(</span><span class="va">outbreak</span>, n_breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">outbreak</span><span class="op">)</span><span class="op">/</span><span class="fl">6</span><span class="op">)</span> <span class="co"># breaks every 6 weeks</span>

<span class="co"># plot</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">outbreak</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>breaks      <span class="op">=</span> <span class="va">my_labels</span><span class="op">$</span><span class="va">breaks</span>, <span class="co"># use $breaks from the make_breaks() output</span>
               date_labels <span class="op">=</span> <span class="st">"%d %b\n%Y"</span>,      <span class="co"># detailed adjustment to date label format</span>
               date_minor_breaks <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span>    <span class="co"># vertical lines for each week (only works for Monday week incidence objects)  </span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-88-1.png" width="672"></div>
</div>
<div id="option-3-use-scale_x_date-only" class="section level4 unnumbered">
<h4>Option 3: Use <code>scale_x_date()</code> only<a class="anchor" aria-label="anchor" href="#option-3-use-scale_x_date-only"><i class="fas fa-link"></i></a>
</h4>
<p>Add only <code>scale_x_date()</code> from <strong>ggplot2</strong> to the incidence plot:</p>
<ul>
<li>
<strong>Advantages</strong>: Complete control over breaks, labels, gridlines, and plot width<br>
</li>
<li>
<strong>Disadvantages</strong>: More code required, more opportunity to make mistakes</li>
</ul>
<p>Syntax:<br>
If your incidence intervals are days or <strong>Monday weeks</strong>, (easy!):</p>
<ul>
<li>Provide an interval for date labels to <code>date_breaks =</code> (e.g. “day”, “week”, “2 weeks”, “month”, “year”)</li>
<li>Provide an interval to <code>date_minor_breaks =</code> for vertical lines between the primary date labels</li>
</ul>
<p>If your incidence intervals are <strong>Sunday weeks</strong>, it is more complex - see below for a Sunday week example</p>
<ul>
<li>Provide a sequence of Sunday dates to <code>breaks =</code> and to <code>minor_breaks =</code><br>
</li>
<li>Use <code>date_labels =</code> for formatting (see Dates page for tips)<br>
</li>
<li>Add the argument <code>expand = c(0,0)</code> to start labels at the first incidence bar. Otherwise, the first label will shift depending on your specified label interval.</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Date break modification using scale_x_date() only</span>
<span class="co">###################################################</span>

<span class="co"># make incidence object</span>
<span class="va">outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"Monday week"</span><span class="op">)</span>

<span class="co"># plot</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">outbreak</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># remove excess x-axis space below and after case bars</span>
               date_breaks       <span class="op">=</span> <span class="st">"3 weeks"</span>,      <span class="co"># date labels appear every 3 Monday weeks</span>
               date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,         <span class="co"># minor vertical lines appear every Monday week</span>
               date_labels       <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span>  <span class="co"># date labels format </span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-89-1.png" width="672"></div>
</div>
<div id="a-sunday-week-example" class="section level4 unnumbered">
<h4>A Sunday week example<a class="anchor" aria-label="anchor" href="#a-sunday-week-example"><i class="fas fa-link"></i></a>
</h4>
<p>If you want a plot of Sunday weeks and also finely-adjusted label formats, you might find this code example helpful.<br>
Here is an example of producing a weekly epicurve using <strong>incidence</strong> for Sunday weeks, with finely-adjusted date labels through <code>scale_x_date()</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load packages</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">tidyverse</span>,  <span class="co"># for ggplot</span>
               <span class="va">incidence</span>,  <span class="co"># for epicurve</span>
               <span class="va">lubridate</span><span class="op">)</span>  <span class="co"># for floor_date() and ceiling_date()</span>

<span class="co"># create incidence object (specifying SUNDAY weeks)</span>
<span class="va">central_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>,
                              interval <span class="op">=</span> <span class="st">"Sunday week"</span><span class="op">)</span> <span class="co"># equivalent to "MMWRweek" (see US CDC)</span>

<span class="co"># plot() the incidence object</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">central_outbreak</span><span class="op">)</span><span class="op">+</span>                  
  
  <span class="co">### ggplot() commands added to the plot</span>
  
  <span class="co"># Date-axis </span>
  <span class="fu">scale_x_date</span><span class="op">(</span>
    
    <span class="co"># remove excess x-axis space below and after case bars</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,                 
    
    <span class="co"># date labels every 3 weeks, from Sunday before first case to Sunday after last case</span>
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
                      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
                      by   <span class="op">=</span> <span class="st">"3 weeks"</span><span class="op">)</span>,
    
    <span class="co"># grid-lines every week, from Sunday before first case to Sunday after last case</span>
    minor_breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
                            to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
                            by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>,
    <span class="co"># date labels format</span>
    date_labels <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span>       
  
  <span class="co"># Y-axis</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                  <span class="co"># remove excess space under x-axis</span>
  
  <span class="co"># Aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                    <span class="co"># simplify background</span>
  
  <span class="fu">theme</span><span class="op">(</span>
    axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,       <span class="co"># axis titles formatting</span>
    plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>  <span class="co"># caption formatting, left-aligned</span>
  
  <span class="co"># Plot labels</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Week of symptom onset (Sunday weeks)"</span>, 
       y <span class="op">=</span> <span class="st">"Weekly case incidence"</span>, 
       title <span class="op">=</span> <span class="st">"Weekly case incidence at Central Hospital (Sunday weeks)"</span>,
       <span class="co">#subtitle = "",</span>
       caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; Case onsets range from {format(min(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')} to {format(max(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')}\n{nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-90-1.png" width="672"></div>
<p>Miscellaneous notes and cautions:</p>
<p><span style="color: red;"><strong><em>DANGER:</em></strong> Be cautious if a static y-axis scale (e.g. 0 to 30 by 5: <code><a href="https://rdrr.io/r/base/seq.html">seq(0, 30, 5)</a></code>). Static numbers can cut-off your data if the data changes!.</span></p>
<p>Note: if using aggregated counts (for example an epiweek x-axis) your x-axis may not be Date class and may require use <code>scale_x_discrete()</code> instead of <code>scale_x_date()</code> - see section on aggregated data epicurves for more details.</p>
</div>
</div>
<div id="facetssmall-multiples" class="section level3 unnumbered">
<h3>Facets/small multiples<a class="anchor" aria-label="anchor" href="#facetssmall-multiples"><i class="fas fa-link"></i></a>
</h3>
<p>To facet the plot by a variable (make “small multiples”), see the tab on epicurves with <code>ggplot()</code></p>
<!-- ======================================================= -->
</div>
</div>
<div id="epicurves-with-ggplot2" class="section level2" number="1.3">
<h2>
<span class="header-section-number">1.3</span> Epicurves with ggplot2<a class="anchor" aria-label="anchor" href="#epicurves-with-ggplot2"><i class="fas fa-link"></i></a>
</h2>
<p>Using the <strong>ggplot2</strong> package alone to create an epicurve is also possible. It can offer more customizeable plots, but can also involve more code and potential for error:</p>
<p>Unlike using <strong>incidence</strong> package, you must manually control the aggregation of the data (into weeks, months, etc) <em>and</em> the labels on the date axis. If not carefully managed, this can lead to headaches.</p>
<p>These examples use a subset of the <code>linelist</code> dataset - only the cases from Central Hospital.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">central_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
<div id="examples" class="section level3 unnumbered">
<h3>Examples<a class="anchor" aria-label="anchor" href="#examples"><i class="fas fa-link"></i></a>
</h3>
<p>To produce an epicurve with <code>ggplot()</code> there are three main elements:</p>
<ul>
<li>A histogram, to aggregate the linelisted cases into “bins” and display bars of the counts per bin (potentially by grouped values)<br>
</li>
<li>Scales for the axes and their associated labels (see tab on modifications)</li>
<li>Aesthetic themes for the plot, including titles, labels, captions, etc.</li>
</ul>
<p>Below is perhaps the most simple code to produce daily and weekly epicurves. Axis scales and labels use default options.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># daily </span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># x column must be class Date</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span>                     <span class="co"># date values binned by 1 day </span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Daily"</span><span class="op">)</span>

<span class="co"># weekly</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  
  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">+</span>                     <span class="co"># date values binned each 7 days (arbitrary 7 days!) </span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Weekly"</span><span class="op">)</span></code></pre></div>
<p><img src="_main_files/figure-html/ggplot_simple-1.png" width="50%"><img src="_main_files/figure-html/ggplot_simple-2.png" width="50%"></p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Using <code>binwidth = 7</code> starts the first bin at the first case, which could be any day of the week! To create specific Monday or Sunday weeks, see guidance below .</span></p>
<p>To create weekly epicurves where the bins begin on a specific day of the week (e.g. Monday or Sunday), specify the histogram <code>breaks =</code> manually (not with <code>binwidth</code>). This can be done by creating a sequence of dates using <code><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date()</a></code> function from <strong>base</strong> R, which expects <code>to</code>, <code>from</code>, and <code>by</code> arguments. You can start/end the sequence at a specific date (<code><a href="https://rdrr.io/r/base/as.Date.html">as.Date("YYYY-MM-DD")</a></code>, or write flexible code to begin the sequence at a specific day of the week before the first case. An example of creating such weekly breaks is below:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Sequence of dates from the Monday before the first case to the Monday after the last case, by week</span>
<span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
         to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
         by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "2014-04-28" "2014-05-05" "2014-05-12" "2014-05-19" "2014-05-26" "2014-06-02" "2014-06-09" "2014-06-16" "2014-06-23"
## [10] "2014-06-30" "2014-07-07" "2014-07-14" "2014-07-21" "2014-07-28" "2014-08-04" "2014-08-11" "2014-08-18" "2014-08-25"
## [19] "2014-09-01" "2014-09-08" "2014-09-15" "2014-09-22" "2014-09-29" "2014-10-06" "2014-10-13" "2014-10-20" "2014-10-27"
## [28] "2014-11-03" "2014-11-10" "2014-11-17" "2014-11-24" "2014-12-01" "2014-12-08" "2014-12-15" "2014-12-22" "2014-12-29"
## [37] "2015-01-05" "2015-01-12" "2015-01-19" "2015-01-26" "2015-02-02" "2015-02-09" "2015-02-16" "2015-02-23" "2015-03-02"
## [46] "2015-03-09" "2015-03-16" "2015-03-23" "2015-03-30" "2015-04-06" "2015-04-13" "2015-04-20" "2015-04-27" "2015-05-04"</code></pre>
<p>Let’s unpack the rather daunting code above:</p>
<ul>
<li>The “from” value (earliest date of the sequence) is created as follows: the minimum date value (<code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code> with <code>na.rm=TRUE</code>) in the column <code>date_onset</code> is fed to <code>floor_date()</code> from the <strong>lubridate</strong> package. <code>floor_date()</code> uses the specified arguments to return the start date of that “week”, given that the start of each week is a Monday (<code>week_start = 1</code>).<br>
</li>
<li>Likewise, the “to” value (end date of the sequence) is created using the inverse function <code>ceiling_date()</code> to return the Monday <em>after</em> the last case.<br>
</li>
<li>The “by” argument can be set to any length of days, weeks, or months.</li>
</ul>
<p>Similar sequence of dates can be supplied to create the histogram breaks (the edges of the bars), and also the breaks for the date labels. Read more about the date labels in later sections. Defining your breaks like above will be necessary if your weekly bins are not by Monday weeks.</p>
<p>Below is detailed example code to produce weekly epicurves for Monday weeks and for Sunday weeks. See the section on date axis modifications to learn the nuances of date-axis label management.</p>
<div id="monday-weeks-example" class="section level4 unnumbered">
<h4>Monday weeks example<a class="anchor" aria-label="anchor" href="#monday-weeks-example"><i class="fas fa-link"></i></a>
</h4>
<p>Of note:</p>
<ul>
<li>The break points of the <em>histogram bins</em> are specified manually to begin the Monday (<code>week_start = 1</code>) before the earliest case and to end the Monday after the last case (see explanation above).<br>
</li>
<li>The breaks for <em>date labels</em> on the x-axis are easy and use <code>date_breaks =</code> within <code>scale_x_date()</code> because we want Monday weeks. For Sunday weeks, use a different method.<br>
</li>
<li>Minor vertical gridlines between date labels are made using <code>date_minor_breaks =</code> within <code>scale_x_date()</code>, again because this plot is for Monday weeks. Sunday weeks use a different method.<br>
</li>
<li>Adding <code>expand = c(0,0)</code> to the x and y scales removes excess space on each side of the axes, which also ensures the date labels begin at the first bar.<br>
</li>
<li>Color and fill of the bars are defined in <code>geom_histogram()</code>
</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># TOTAL MONDAY WEEK ALIGNMENT</span>
<span class="co">#############################</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="co"># make histogram: specify bin break points: starts the Monday before first case, end Monday after last case</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>
      from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
      by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>, <span class="co"># bins are 7-days</span>
    color <span class="op">=</span> <span class="st">"darkblue"</span>,   <span class="co"># color of lines around bars</span>
    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># color of fill within bars</span>
  
  <span class="co"># x-axis labels</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># remove excess x-axis space before and after case bars</span>
    date_breaks       <span class="op">=</span> <span class="st">"3 weeks"</span>,      <span class="co"># labels appear every 3 Monday weeks</span>
    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,         <span class="co"># vertical lines appear every Monday week</span>
    date_labels       <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span> <span class="co"># date labels format</span>
  
  <span class="co"># y-axis</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>             <span class="co"># remove excess y-axis space below 0</span>
  
  <span class="co"># aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                <span class="co"># simplify plot background</span>
  
  <span class="fu">theme</span><span class="op">(</span>
    plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, <span class="co"># caption on left side in italics</span>
                                hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, 
    axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>   <span class="co"># axis titles in bold</span>
  
  <span class="co"># labels</span>
  <span class="fu">labs</span><span class="op">(</span>
    title    <span class="op">=</span> <span class="st">"Weekly incidence of cases (Monday weeks)"</span>,
    subtitle <span class="op">=</span> <span class="st">"Subtitle: Note alignment of bars, vertical lines, and axis labels on Mondays"</span>,
    x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,
    y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span>,
    caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; Case onsets range from {format(min(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')} to {format(max(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')}\n{nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-95-1.png" width="672"></div>
</div>
<div id="sunday-weeks-example" class="section level4 unnumbered">
<h4>Sunday weeks example<a class="anchor" aria-label="anchor" href="#sunday-weeks-example"><i class="fas fa-link"></i></a>
</h4>
<p>The below code achieves the same epicurve but uses <em>Sunday</em> weeks. Of note:</p>
<ul>
<li>The break points of the <em>histogram bins</em> are specified manually to begin the Sunday (<code>week_start = 7</code>) before the earliest case and to end the Sunday after the last case (see explanation above).</li>
<li>Because the bins are <em>not</em> Monday weeks, the breaks for <em>date labels</em> on the x-axis and the vertical gridlines must be manually specified vectors of dates, as generated by <code><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date()</a></code>. These date break vectors are given to <code>breaks =</code> and <code>minor_breaks =</code> within <code>scale_x_date()</code>. Unlike for Monday weeks, you <em>cannot</em> use the <code>scale_x_date()</code> arguments <code>date_breaks</code> and <code>date_minor_breaks</code>.<br>
</li>
<li>Adding <code>expand = c(0,0)</code> to the x and y scales removes excess space on each side of the axes, which also ensures the labels begin at the first bar.<br>
</li>
<li>Color and fill are defined in <code>geom_histogram()</code>
</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># TOTAL SUNDAY WEEK ALIGNMENT</span>
<span class="co">#############################</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="co"># Histogram -</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>                    
    
    <span class="co"># manually specify bin break points: starts the Sunday before first case, end Sunday after last case</span>
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>
      from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
      by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>, <span class="co"># bins are 7-days</span>
    color <span class="op">=</span> <span class="st">"darkblue"</span>,   <span class="co"># color of lines around bars</span>
    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># color of fill within bars</span>
  
  <span class="co"># The labels on the x-axis</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,
    
    <span class="co"># manually specify label breaks: starts the Sunday before first case, end Sunday after last case</span>
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>
      from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
      by   <span class="op">=</span> <span class="st">"3 weeks"</span><span class="op">)</span>,
    
    <span class="co"># manually specify vertical gridline breaks: starts the Sunday before first case, end Sunday after last case</span>
    minor_breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>
      from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
      by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>,
   
    <span class="co"># date label format</span>
    date_labels <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span>         <span class="co"># day, above month abbrev., above 2-digit year</span>
  
  <span class="co"># y-axis</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                     <span class="co"># removes excess y-axis space below 0</span>
  
  <span class="co"># aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                               <span class="co"># a set of themes to simplify plot</span>
  
  <span class="fu">theme</span><span class="op">(</span>
    plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, <span class="co"># caption on left side in italics</span>
                                hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, 
    axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>   <span class="co"># axis titles in bold</span>
  
  <span class="co"># labels</span>
  <span class="fu">labs</span><span class="op">(</span>
    title    <span class="op">=</span> <span class="st">"Weekly incidence of cases (Sunday weeks)"</span>,
    subtitle <span class="op">=</span> <span class="st">"Subtitle: Note alignment of bars, vertical lines, and axis labels on Sundays"</span>,
    x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,
    y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span>,
    caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; Case onsets range from {format(min(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')} to {format(max(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')}\n{nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-96-1.png" width="672"></div>
</div>
</div>
<div id="groupcolor-by-value" class="section level3 unnumbered">
<h3>Group/color by value<a class="anchor" aria-label="anchor" href="#groupcolor-by-value"><i class="fas fa-link"></i></a>
</h3>
<p>To designate a column containing groups, make the following changes. See the [ggplot tips] page for details.</p>
<ul>
<li>Add the <em>aesthetics</em> argument <code>aes()</code> within the <code>geom_histogram()</code> (don’t forget comma afterward)</li>
<li>
<strong>Within <code>aes()</code></strong>, provide the grouping column name to <code>group =</code> and <code>fill =</code> (no quotes needed). <code>group</code> is necessary, while <code>fill</code> sets the color of the bar by group.<br>
</li>
<li>Remove any <code>fill =</code> argument outside of the <code>aes()</code>, as it will override the one inside<br>
</li>
<li>Arguments <em>inside</em> <code>aes()</code> will apply by group, whereas any <em>outside</em> will apply to all bars (e.g. you may want <code>color =</code> outside, so each bar has the same color border)</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">geom_histogram</span><span class="op">(</span>
    <span class="fu">aes</span><span class="op">(</span>group <span class="op">=</span> <span class="va">gender</span>, fill <span class="op">=</span> <span class="va">gender</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="adjust-colors" class="section level3 unnumbered">
<h3>Adjust colors<a class="anchor" aria-label="anchor" href="#adjust-colors"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>To adjust the colors via a pre-defined color scale, see the page on [ggplot tips].<br>
</li>
<li>To <em>manually</em> set fill color for each group, use <code>scale_fill_manual()</code> (note <code>scale_color_manual()</code> is different!).
<ul>
<li>Use the <code>values =</code> argument to apply a vector of colors.<br>
</li>
<li>Use <code>na.value =</code> to specify a color for missing values.<br>
</li>
<li>! While you <em>can</em> use the <code>labels =</code> argument in <code>scale_fill_manual()</code> to change the legend labels - it is easy to accidentally give labels in the incorrect order and have an incorrect legend! So, it is recommended to instead convert the group column to class Factor and adjust labels as described in the [Factors] page.</li>
</ul>
</li>
</ul>
</div>
<div id="adjust-level-order-1" class="section level3 unnumbered">
<h3>Adjust level order<a class="anchor" aria-label="anchor" href="#adjust-level-order-1"><i class="fas fa-link"></i></a>
</h3>
<p>Stacking order, and the labels for each group in the legend, is best adjusted by classifying the group column as class Factor. You can then designate the levels and their labels, and the order (which is reflected in stack order). See the page on [Factors] or [ggplot tips] for details. One example given below:</p>
<p>Step 1: Before making the ggplot, convert the grouping column to class Factor using <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code> from <strong>base</strong> R.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load forcats package for working with factors</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">forcats</span><span class="op">)</span>

<span class="co"># Convert hospital column to factor and adjust levels</span>
<span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>                       <span class="co"># define as factor</span>
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu">fct_explicit_na</span><span class="op">(</span><span class="va">hospital</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>   <span class="co"># convert NA to "Missing" </span>
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu">fct_lump</span><span class="op">(</span><span class="va">hospital</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>              <span class="co"># Keep 3 most frequent hospitals, with remaining combined into "Other" </span>
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu">fct_relevel</span><span class="op">(</span><span class="va">hospital</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Other"</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Set "Other" and "Missing" as top levels</span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_data</span>,
       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span>,
           group <span class="op">=</span> <span class="va">hospital</span>,
           fill <span class="op">=</span> <span class="va">hospital</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="co"># make histogram: specify bin break points: starts the Monday before first case, end Monday after last case</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>
      from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
      by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">+</span>  
    
  <span class="co"># x-axis labels</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># remove excess x-axis space before and after case bars</span>
    date_breaks       <span class="op">=</span> <span class="st">"3 weeks"</span>,      <span class="co"># labels appear every 3 Monday weeks</span>
    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,         <span class="co"># vertical lines appear every Monday week</span>
    date_labels       <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span> <span class="co"># date labels format</span>
  
  <span class="co"># y-axis</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>             <span class="co"># remove excess y-axis space below 0</span>
  
  <span class="co"># manual specification of colors</span>
  <span class="fu">scale_fill_manual</span><span class="op">(</span>
    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey"</span>, <span class="st">"black"</span>, <span class="st">"orange"</span>, <span class="st">"purple"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="co"># specify fill colors ("values") - attention to order!</span>
  
  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>  <span class="co"># reverse order of legend only</span>
  
  <span class="co"># aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                <span class="co"># simplify plot background</span>
  
  <span class="fu">theme</span><span class="op">(</span>
    plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, <span class="co"># caption on left side in italics</span>
                                hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, 
    axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>   <span class="co"># axis titles in bold</span>
  
  <span class="co"># labels</span>
  <span class="fu">labs</span><span class="op">(</span>
    title    <span class="op">=</span> <span class="st">"Weekly incidence of cases by hospital"</span>,
    subtitle <span class="op">=</span> <span class="st">"3 most frequent values shown individually, plus 'Other'"</span>,
    x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,
    y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span>,
    fill     <span class="op">=</span> <span class="st">"Hospital"</span><span class="op">)</span>   <span class="co"># title of legend</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-100-1.png" width="672"></div>
</div>
<div id="adjust-legend" class="section level3 unnumbered">
<h3>Adjust legend<a class="anchor" aria-label="anchor" href="#adjust-legend"><i class="fas fa-link"></i></a>
</h3>
<p>Read more about legends in the [ggplot tips] page. Here are a few highlights:</p>
<ul>
<li>
<code>theme(legend.position = "top")</code> (or “bottom”, “left”, “right”)</li>
<li>
<code>theme(legend.direction = "horizontal")</code><br>
</li>
<li>
<code>theme(legend.title = element_blank())</code> to have no title<br>
</li>
<li>
<code>guides(fill = guide_legend(reverse = TRUE))</code> to reverse order of the legend</li>
</ul>
</div>
<div id="bars-side-by-side" class="section level3 unnumbered">
<h3>Bars side-by-side<a class="anchor" aria-label="anchor" href="#bars-side-by-side"><i class="fas fa-link"></i></a>
</h3>
<p>Side-by-side display of group bars (as opposed to stacked) is specified within <code>geom_histogram()</code> with <code>position = "dodge"</code> (outside of <code>aes()</code>).</p>
<p>If there are more than two value groups, these can become difficult to read. Consider instead using a faceted plot (small multiples). To improve readability in this example, missing gender values are removed and only Central Hospital cases are shown.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">########################</span>
<span class="co"># bin break points for histogram defined here for clarity</span>
<span class="co"># starts the Monday before first case, end Monday after last case</span>
<span class="va">bin_breaks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
                      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
                      by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span> <span class="co"># bins are 7-days</span>

<span class="co"># New dataset without rows missing gender</span>
<span class="va">central_data_dodge</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span> <span class="op">%&gt;%</span>      <span class="co"># Only rows from Central Hospital, for clarity</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>                      <span class="co"># remove rows missing gender</span>
  <span class="fu">mutate</span><span class="op">(</span>gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span>,                 <span class="co"># Set Gender as factor and adjust value labels</span>
         gender <span class="op">=</span> <span class="fu">fct_recode</span><span class="op">(</span><span class="va">gender</span>,
                            <span class="st">"Female"</span> <span class="op">=</span> <span class="st">"f"</span>,
                            <span class="st">"Male"</span> <span class="op">=</span> <span class="st">"m"</span><span class="op">)</span><span class="op">)</span> 

<span class="co"># make plot</span>
<span class="co">###########</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data_dodge</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">geom_histogram</span><span class="op">(</span>
        <span class="fu">aes</span><span class="op">(</span>group <span class="op">=</span> <span class="va">gender</span>, fill <span class="op">=</span> <span class="va">gender</span><span class="op">)</span>,    <span class="co"># arguments inside aes() apply by group</span>
        color <span class="op">=</span> <span class="st">"black"</span>,                       <span class="co"># arguments outside aes() apply to all data</span>
        breaks <span class="op">=</span> <span class="va">bin_breaks</span>,                   <span class="co"># see breaks defined above</span>
        position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span><span class="op">+</span>                   <span class="co"># side-by-side bars</span>
                      
  
  <span class="co"># The labels on the x-axis</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># remove excess x-axis space below and after case bars</span>
               date_breaks       <span class="op">=</span> <span class="st">"3 weeks"</span>,      <span class="co"># labels appear every 3 Monday weeks</span>
               date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,         <span class="co"># vertical lines appear every Monday week</span>
               date_labels       <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span> <span class="co"># date labels format</span>
  
  <span class="co"># y-axis</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                   <span class="co"># removes excess y-axis space between bottom of bars and the labels</span>
  
  <span class="co">#scale of colors and legend labels</span>
  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"brown"</span>, <span class="st">"orange"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>     <span class="co"># specify fill colors ("values") - attention to order!</span>

  <span class="co"># aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                               <span class="co"># a set of themes to simplify plot</span>
  <span class="fu">theme</span><span class="op">(</span>plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="co"># caption on left side in italics</span>
        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>               <span class="co"># axis titles in bold</span>
  
  <span class="co"># labels</span>
  <span class="fu">labs</span><span class="op">(</span>title    <span class="op">=</span> <span class="st">"Weekly incidence of cases, by gender"</span>,
       subtitle <span class="op">=</span> <span class="st">"Subtitle"</span>,
       fill     <span class="op">=</span> <span class="st">"Gender"</span>,                                      <span class="co"># provide new title for legend</span>
       x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,
       y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-101-1.png" width="672"></div>
</div>
<div id="date-axis-labelsgridlines-1" class="section level3 unnumbered">
<h3>Date-axis labels/gridlines<a class="anchor" aria-label="anchor" href="#date-axis-labelsgridlines-1"><i class="fas fa-link"></i></a>
</h3>
<p><span style="color: darkgreen;"><strong><em>TIP:</em></strong> Remember that date-axis <strong>labels</strong> are independent from the aggregation of the data into bars</span></p>
<p>To <strong>modify the aggregation of data into bins/bars</strong>, do <strong>one</strong> of the following:</p>
<ul>
<li>Specify a <code>binwidth =</code> within <code>geom_histogram()</code> - for a column of class Date, the given number is interpreted in days<br>
</li>
<li>Specify <code>breaks =</code> as a sequence of bin break-point dates<br>
</li>
<li>Group the rows into aggregated counts (by week, month, etc.) prior to plotting and feed the aggregated counts to <code>ggplot()</code> (see later section on aggregated data).</li>
</ul>
<p>To <strong>modify the date labels</strong>, use <code>scale_x_date()</code> in one of these ways:</p>
<ul>
<li>If your histogram bins are days, Monday weeks, months, or years:
<ul>
<li>Use <code>date_breaks =</code> to specify label frequency (e.g. “day”, “week”, “3 weeks”, “month”, or “year”)</li>
<li>Use <code>date_minor_breaks =</code> to specify frequency of minor vertical gridlines between date labels<br>
</li>
<li>Add <code>expand = c(0,0)</code> to begin the labels at the first bar (otherwise, first label will shift forward depending on specified frequency)<br>
</li>
<li>Use <code>date_labels =</code> to specify format of date labels - see the Dates page for tips (use <code>\n</code> for a new line)<br>
</li>
</ul>
</li>
<li>If your histogram bins are Sunday weeks:
<ul>
<li>Use <code>breaks =</code> and <code>minor_breaks =</code> by providing a sequence of date breaks for each</li>
<li>You can still use <code>date_labels =</code> and <code>expand</code> for formatting as described above</li>
</ul>
</li>
</ul>
<p>To <strong>create a sequence of dates</strong><br>
You can use <code><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date()</a></code> from <strong>base</strong> R. You can start/end the sequence at a specific date (<code><a href="https://rdrr.io/r/base/as.Date.html">as.Date("YYYY-MM-DD")</a></code>, or write flexible code to begin the sequence at a specific day of the week before the first case. An example of creating such flexible breaks is below.</p>
<p>See the opening <strong>ggplot2</strong> section above for a detailed explanation.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
         to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
         by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span></code></pre></div>
<p>If using aggregated counts (for example an epiweek x-axis) your x-axis may not be Date class and may require use <code>scale_x_discrete()</code> instead of <code>scale_x_date()</code> - see ggplot tips page for more details.</p>
<p>Set maximum and minimum date values using <code>limits = c()</code> within <code>scale_x_date()</code>. E.g. <code>scale_x_date(limits = c(as.Date("2014-04-01), NA))</code> sets a minimum but leaves the maximum open.</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Caution using limits! They remove all data outside the limits, which can impact y-axis max/min, modeling, and other statistics. Strongly consider instead using limits by adding <code>coord_cartesian()</code> to your plot, which acts as a “zoom” without removing data. </span></p>
<p><span style="color: red;"><strong><em>DANGER:</em></strong> Be cautious setting the y-axis scale breaks (e.g. 0 to 30 by 5: <code><a href="https://rdrr.io/r/base/seq.html">seq(0, 30, 5)</a></code>). Static numbers can cut-off your data if the data changes!.</span></p>
<p>See <a href="https://rdrr.io/r/base/strptime.html">this page</a> or the [Working with dates] page for tips on creating date labels.</p>
<p><strong>Below is a demonstration of some plots where the bins and the plot labels/gridlines are aligned and not aligned:</strong><br>
Click “Code” to see the code</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 7-day binwidth defaults</span>
<span class="co">#################</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># x column must be class Date</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
    binwidth <span class="op">=</span> <span class="fl">7</span>,                       <span class="co"># 7 days per bin (! starts at first case!)</span>
    color <span class="op">=</span> <span class="st">"darkblue"</span>,                 <span class="co"># color of lines around bars</span>
    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span>               <span class="co"># color of bar fill</span>
  
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"MISALIGNED"</span>,
    subtitle <span class="op">=</span> <span class="st">"!CAUTION: 7-day bars start Thursdays with first case\ndefault axis labels/ticks not aligned"</span><span class="op">)</span>


<span class="co"># 7-day bins + Monday labels</span>
<span class="co">#############################</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
    binwidth <span class="op">=</span> <span class="fl">7</span>,                 <span class="co"># 7-day bins with start at first case</span>
    color <span class="op">=</span> <span class="st">"darkblue"</span>,
    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,               <span class="co"># remove excess x-axis space below and after case bars</span>
    date_breaks <span class="op">=</span> <span class="st">"3 weeks"</span>,       <span class="co"># Monday every 3 weeks</span>
    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,    <span class="co"># Monday weeks</span>
    date_labels <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span>  <span class="co"># label format</span>
  
  <span class="fu">scale_y_continuous</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>              <span class="co"># remove excess space under x-axis, make flush with labels</span>
  
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"MISALIGNED"</span>,
    subtitle <span class="op">=</span> <span class="st">"!CAUTION: 7-day bars start Thursdays with first case\nDate labels and gridlines on Mondays"</span><span class="op">)</span>



<span class="co"># 7-day bins + Months</span>
<span class="co">#####################</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
    binwidth <span class="op">=</span> <span class="fl">7</span>,
    color <span class="op">=</span> <span class="st">"darkblue"</span>,
    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,                 <span class="co"># remove excess x-axis space below and after case bars</span>
    date_breaks <span class="op">=</span> <span class="st">"months"</span>,          <span class="co"># 1st of month</span>
    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,      <span class="co"># Monday weeks</span>
    date_labels <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span>    <span class="co"># label format</span>
  
  <span class="fu">scale_y_continuous</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                <span class="co"># remove excess space under x-axis, make flush with labels</span>
  
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"MISALIGNED"</span>,
    subtitle <span class="op">=</span> <span class="st">"!CAUTION: 7-day bars start Thursdays with first case\nGridlines at 1st of each month (with labels) and weekly on Mondays\nLabels on 1st of each month"</span><span class="op">)</span>


<span class="co"># TOTAL MONDAY ALIGNMENT: specify manual bin breaks to be mondays</span>
<span class="co">#################################################################</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_histogram</span><span class="op">(</span>
    <span class="co"># histogram breaks set to 7 days beginning Monday before first case</span>
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>
      from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
      by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"darkblue"</span>,
    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,                   <span class="co"># remove excess x-axis space below and after case bars</span>
    date_breaks <span class="op">=</span> <span class="st">"3 weeks"</span>,           <span class="co"># Monday every 3 weeks</span>
    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,        <span class="co"># Monday weeks </span>
    date_labels <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span>      <span class="co"># label format</span>
  
  <span class="fu">labs</span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"ALIGNED Mondays"</span>,
    subtitle <span class="op">=</span> <span class="st">"7-day bins manually set to begin Monday before first case (28 Apr)\nDate labels and gridlines on Mondays as well"</span><span class="op">)</span>


<span class="co"># TOTAL SUNDAY ALIGNMENT: specify manual bin breaks AND labels to be Sundays</span>
<span class="co">############################################################################</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_histogram</span><span class="op">(</span>
    <span class="co"># histogram breaks set to 7 days beginning Sunday before first case</span>
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
                      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
                      by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"darkblue"</span>,
    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,
    <span class="co"># date label breaks set to every 3 weeks beginning Sunday before first case</span>
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
                      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
                      by   <span class="op">=</span> <span class="st">"3 weeks"</span><span class="op">)</span>,
    <span class="co"># gridlines set to weekly beginning Sunday before first case</span>
    minor_breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
                            to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,
                            by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>,
    date_labels <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span>  <span class="co"># label format</span>
  
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"ALIGNED Sundays"</span>,
       subtitle <span class="op">=</span> <span class="st">"7-day bins manually set to begin Sunday before first case (27 Apr)\nDate labels and gridlines manually set to Sundays as well"</span><span class="op">)</span>



<span class="co"># Check values of bars by creating dataframe of grouped values</span>
<span class="co"># central_tab &lt;- central_data %&gt;% </span>
<span class="co">#   mutate(week = aweek::date2week(date_onset, floor_day = TRUE, factor = TRUE)) %&gt;% </span>
<span class="co">#   group_by(week, .drop=F) %&gt;%</span>
<span class="co">#   summarize(n = n()) %&gt;% </span>
<span class="co">#   mutate(groups_3wk = 1:(nrow(central_tab)+1) %/% 3) %&gt;% </span>
<span class="co">#   group_by(groups_3wk) %&gt;% </span>
<span class="co">#   summarize(n = n())</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-103-1.png" width="672"><img src="_main_files/figure-html/unnamed-chunk-103-2.png" width="672"><img src="_main_files/figure-html/unnamed-chunk-103-3.png" width="672"><img src="_main_files/figure-html/unnamed-chunk-103-4.png" width="672"><img src="_main_files/figure-html/unnamed-chunk-103-5.png" width="672"></p>
</div>
</div>
<div id="facetingsmall-multiples" class="section level2" number="1.4">
<h2>
<span class="header-section-number">1.4</span> Faceting/small-multiples<a class="anchor" aria-label="anchor" href="#facetingsmall-multiples"><i class="fas fa-link"></i></a>
</h2>
<p>As with other ggplots, you can create facetted plots (“small multiples”). As explained in the [ggplot tips] page of this handbook, you can use either:</p>
<ul>
<li><code>facet_wrap()</code></li>
<li><code>facet_grid()</code></li>
</ul>
<p>For epicurves, <code>facet_wrap()</code> is typically easiest as it is likely that you only need to facet on one column. The general syntax is <code>facet_wrap(rows ~ cols)</code>, where to the left of the tilde (~) is the name of a column to be spread across the “rows” of the facetted plot, and to the right of the tilde is the name of a column to be spread across the “columns” of the facetted plot.</p>
<p>Most simply, just use one column name, to the right of the tilde: <code>facet_wrap(~age_cat)</code>.</p>
<p><strong>Free axes</strong><br>
You will need to decide whether the scales (<code>scales =</code>) of the axes for each facet are “fixed” to the same dimensions (default), or “free” (meaning they will change based on the data within the facet). You can also specify “free_x” or “free_y” to release in only one dimension.</p>
<p><strong>Number of cols and rows of facets</strong><br>
This can be specified with <code>ncol =</code> and <code>nrow =</code> within <code>facet_wrap()</code>.</p>
<p><strong>Order of panels</strong><br>
To change the order of appearance, change the underlying order of the levels of the factor column used to create the facets.</p>
<p><strong>Aesthetics</strong><br>
Font size and face, strip color, etc. can be modified through <code>theme()</code> with arguments like:</p>
<ul>
<li>
<code>strip.text = element_text()</code> (size, colour, face, angle…)</li>
<li>
<code>strip.background = element_rect()</code> (e.g. element_rect(fill=“red”))<br>
</li>
<li>
<code>strip.position =</code> (position of the strip “bottom”, “top”, “left”, or “right”)</li>
</ul>
<p><strong>Strip labels</strong><br>
Labels of the facet plots can be modified through the “labels” of the column as a factor, or by the use of a “labeller”.</p>
<p>Make a labeller like this, using the function <code>as_labeller()</code> from <strong>ggplot2</strong>:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_labels</span> <span class="op">&lt;-</span> <span class="fu">as_labeller</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
     <span class="st">"0-4"</span>   <span class="op">=</span> <span class="st">"Ages 0-4"</span>,
     <span class="st">"5-9"</span>   <span class="op">=</span> <span class="st">"Ages 5-9"</span>,
     <span class="st">"10-14"</span> <span class="op">=</span> <span class="st">"Ages 10-14"</span>,
     <span class="st">"15-19"</span> <span class="op">=</span> <span class="st">"Ages 15-19"</span>,
     <span class="st">"20-29"</span> <span class="op">=</span> <span class="st">"Ages 20-29"</span>,
     <span class="st">"30-49"</span> <span class="op">=</span> <span class="st">"Ages 30-49"</span>,
     <span class="st">"50-69"</span> <span class="op">=</span> <span class="st">"Ages 50-69"</span>,
     <span class="st">"70+"</span>   <span class="op">=</span> <span class="st">"Over age 70"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><strong>An example facetted plot</strong> - facetted by column <code>age_cat</code>.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make plot</span>
<span class="co">###########</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="fu">geom_histogram</span><span class="op">(</span>
        <span class="fu">aes</span><span class="op">(</span>group <span class="op">=</span> <span class="va">age_cat</span>, fill <span class="op">=</span> <span class="va">age_cat</span><span class="op">)</span>,    <span class="co"># arguments inside aes() apply by group</span>
        color <span class="op">=</span> <span class="st">"black"</span>,                       <span class="co"># arguments outside aes() apply to all data</span>
        breaks <span class="op">=</span> <span class="va">bin_breaks</span><span class="op">)</span><span class="op">+</span>                  <span class="co"># see breaks defined above</span>
                      
    
  
  <span class="co"># The labels on the x-axis</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># remove excess x-axis space below and after case bars</span>
               date_breaks       <span class="op">=</span> <span class="st">"2 months"</span>,     <span class="co"># labels appear every 2 months</span>
               date_minor_breaks <span class="op">=</span> <span class="st">"1 month"</span>,      <span class="co"># vertical lines appear every 1 month </span>
               date_labels       <span class="op">=</span> <span class="st">"%b\n'%y"</span><span class="op">)</span><span class="op">+</span>     <span class="co"># date labels format</span>
  
  <span class="co"># y-axis</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                   <span class="co"># removes excess y-axis space between bottom of bars and the labels</span>
  
  <span class="co"># aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                               <span class="co"># a set of themes to simplify plot</span>
  <span class="fu">theme</span><span class="op">(</span>plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="co"># caption on left side in italics</span>
        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,
        legend.position <span class="op">=</span> <span class="st">"bottom"</span>,
        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
        strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>               <span class="co"># axis titles in bold</span>
  
  <span class="co"># create facets</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">age_cat</span>,
             ncol <span class="op">=</span> <span class="fl">4</span>,
             strip.position <span class="op">=</span> <span class="st">"top"</span>,
             labeller <span class="op">=</span> <span class="va">my_labels</span><span class="op">)</span><span class="op">+</span>             
  
  <span class="co"># labels</span>
  <span class="fu">labs</span><span class="op">(</span>title    <span class="op">=</span> <span class="st">"Weekly incidence of cases, by age category"</span>,
       subtitle <span class="op">=</span> <span class="st">"Subtitle"</span>,
       fill     <span class="op">=</span> <span class="st">"Age category"</span>,                                      <span class="co"># provide new title for legend</span>
       x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,
       y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span>,
       caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; Case onsets range from {format(min(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')} to {format(max(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')}\n{nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-105-1.png" width="672"></div>
<p>See this <a href="https://ggplot2.tidyverse.org/reference/labellers.html">link</a> for more information on labellers.</p>
<div id="total-epidemic-in-facet-background" class="section level3 unnumbered">
<h3>Total epidemic in facet background<a class="anchor" aria-label="anchor" href="#total-epidemic-in-facet-background"><i class="fas fa-link"></i></a>
</h3>
<p>Add a separate <code>geom_histogram()</code> command <em>before</em> the current one. Specify that the data used is the data <em>without</em> the column used for faceting (use <code>select()</code>). Then, specify a color like “grey” and a degree of transparency to make it appear in the background.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="epidemic-curves.html#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_histogram</span>(<span class="at">data =</span> <span class="fu">select</span>(central_data, <span class="sc">-</span>age_cat), <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>)<span class="sc">+</span></span></code></pre></div>
<p>Note that the y-axis maximum is now based on the height of the entire epidemic.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="co"># for background shadow of whole outbreak</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
    data <span class="op">=</span> <span class="fu">select</span><span class="op">(</span><span class="va">central_data</span>, <span class="op">-</span><span class="va">age_cat</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"grey"</span>,
    alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">+</span>

  <span class="co"># actual epicurves by group</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
    <span class="fu">aes</span><span class="op">(</span>group <span class="op">=</span> <span class="va">age_cat</span>, fill <span class="op">=</span> <span class="va">age_cat</span><span class="op">)</span>,  <span class="co"># arguments inside aes() apply by group</span>
    color <span class="op">=</span> <span class="st">"black"</span>,                       <span class="co"># arguments outside aes() apply to all data</span>
    breaks <span class="op">=</span> <span class="va">bin_breaks</span><span class="op">)</span><span class="op">+</span>                  <span class="co"># see breaks defined above</span>
                      
  <span class="co"># Labels on x-axis</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># remove excess x-axis space below and after case bars</span>
    date_breaks       <span class="op">=</span> <span class="st">"2 months"</span>,     <span class="co"># labels appear every 2 months</span>
    date_minor_breaks <span class="op">=</span> <span class="st">"1 month"</span>,      <span class="co"># vertical lines appear every 1 month </span>
    date_labels       <span class="op">=</span> <span class="st">"%b\n'%y"</span><span class="op">)</span><span class="op">+</span>     <span class="co"># date labels format</span>
  
  <span class="co"># y-axis</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>  <span class="co"># removes excess y-axis space below 0</span>
  
  <span class="co"># aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                           <span class="co"># a set of themes to simplify plot</span>
  <span class="fu">theme</span><span class="op">(</span>
    plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="co"># caption on left side in italics</span>
    axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,
    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,
    strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
    strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>        <span class="co"># axis titles in bold</span>
  
  <span class="co"># create facets</span>
  <span class="fu">facet_wrap</span><span class="op">(</span>
    <span class="op">~</span><span class="va">age_cat</span>,                          <span class="co"># each plot is one value of age_cat</span>
    ncol <span class="op">=</span> <span class="fl">4</span>,                          <span class="co"># number of columns</span>
    strip.position <span class="op">=</span> <span class="st">"top"</span>,            <span class="co"># position of the facet title/strip</span>
    labeller <span class="op">=</span> <span class="va">my_labels</span><span class="op">)</span><span class="op">+</span>             <span class="co"># labeller defines above</span>
  
  <span class="co"># labels</span>
  <span class="fu">labs</span><span class="op">(</span>
    title    <span class="op">=</span> <span class="st">"Weekly incidence of cases, by age category"</span>,
    subtitle <span class="op">=</span> <span class="st">"Subtitle"</span>,
    fill     <span class="op">=</span> <span class="st">"Age category"</span>,                                      <span class="co"># provide new title for legend</span>
    x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,
    y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span>,
    caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; Case onsets range from {format(min(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')} to {format(max(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')}\n{nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-107-1.png" width="672"></div>
</div>
<div id="one-facet-box-with-all-data" class="section level3 unnumbered">
<h3>One facet box with ALL data<a class="anchor" aria-label="anchor" href="#one-facet-box-with-all-data"><i class="fas fa-link"></i></a>
</h3>
<p>To do this, you duplicate all the data (double the number of rows in the dataset) and in the faceted column have a new value (e.g. “all”) which indicates all the duplicated rows. A helper function is below that enables this:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define helper function</span>
<span class="va">CreateAllFacet</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">col</span><span class="op">)</span><span class="op">{</span>
     <span class="va">df</span><span class="op">$</span><span class="va">facet</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span>
     <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">df</span>
     <span class="va">temp</span><span class="op">$</span><span class="va">facet</span> <span class="op">&lt;-</span> <span class="st">"all"</span>
     <span class="va">merged</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">df</span><span class="op">)</span>
     
     <span class="co"># ensure the facet value is a factor</span>
     <span class="va">merged</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">merged</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
     
     <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">merged</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Create dataset that is duplicated, to show "all zones" as another facet level</span>
<span class="va">central_data2</span> <span class="op">&lt;-</span> <span class="fu">CreateAllFacet</span><span class="op">(</span><span class="va">central_data</span>, col <span class="op">=</span> <span class="st">"age_cat"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>facet <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">facet</span>,
                        levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"all"</span>, <span class="st">"0-4"</span>, <span class="st">"5-9"</span>, <span class="st">"10-14"</span>, <span class="st">"15-19"</span>, <span class="st">"20-29"</span>, <span class="st">"30-49"</span>, <span class="st">"50-69"</span>, <span class="st">"70+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># check</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">central_data2</span><span class="op">$</span><span class="va">facet</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##   all   0-4   5-9 10-14 15-19 20-29 30-49 50-69   70+  &lt;NA&gt; 
##   454    92    55    82    62    79    64    12     0     8</code></pre>
<p>Notable changes to the <code>ggplot()</code> command are:</p>
<ul>
<li>The data used is now central_data2 (double the rows, with new column “facet”)</li>
<li>Labeller will need to be updated, if used<br>
</li>
<li>To achieve vertically stacked facets: the facet column is moved to rows side of equation and on right is replaced by “.” (<code>facet_wrap(facet~.)</code>), and <code>ncol = 1</code>. You may also need to adjust the width and height of the saved png plot image (see <code>ggsave()</code> in [ggplot tips]).</li>
</ul>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data2</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="co"># actual epicurves by group</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
        <span class="fu">aes</span><span class="op">(</span>group <span class="op">=</span> <span class="va">age_cat</span>, fill <span class="op">=</span> <span class="va">age_cat</span><span class="op">)</span>,  <span class="co"># arguments inside aes() apply by group</span>
        color <span class="op">=</span> <span class="st">"black"</span>,                       <span class="co"># arguments outside aes() apply to all data</span>
        breaks <span class="op">=</span> <span class="va">bin_breaks</span><span class="op">)</span><span class="op">+</span>                  <span class="co"># see breaks defined above</span>
                      
  <span class="co"># Labels on x-axis</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># remove excess x-axis space below and after case bars</span>
               date_breaks       <span class="op">=</span> <span class="st">"2 months"</span>,     <span class="co"># labels appear every 2 months</span>
               date_minor_breaks <span class="op">=</span> <span class="st">"1 month"</span>,      <span class="co"># vertical lines appear every 1 month </span>
               date_labels       <span class="op">=</span> <span class="st">"%b\n'%y"</span><span class="op">)</span><span class="op">+</span>     <span class="co"># date labels format</span>
  
  <span class="co"># y-axis</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                   <span class="co"># removes excess y-axis space between bottom of bars and the labels</span>
  
  <span class="co"># aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                               <span class="co"># a set of themes to simplify plot</span>
  <span class="fu">theme</span><span class="op">(</span>plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="co"># caption on left side in italics</span>
        axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,
        legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">+</span>               
  
  <span class="co"># create facets</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="va">facet</span><span class="op">~</span><span class="va">.</span> ,                            <span class="co"># each plot is one value of facet</span>
             ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span>            

  <span class="co"># labels</span>
  <span class="fu">labs</span><span class="op">(</span>title    <span class="op">=</span> <span class="st">"Weekly incidence of cases, by age category"</span>,
       subtitle <span class="op">=</span> <span class="st">"Subtitle"</span>,
       fill     <span class="op">=</span> <span class="st">"Age category"</span>,                                      <span class="co"># provide new title for legend</span>
       x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,
       y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span>,
       caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; Case onsets range from {format(min(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')} to {format(max(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')}\n{nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-109-1.png" width="480"></div>
</div>
</div>
<div id="moving-averages" class="section level2" number="1.5">
<h2>
<span class="header-section-number">1.5</span> Moving averages<a class="anchor" aria-label="anchor" href="#moving-averages"><i class="fas fa-link"></i></a>
</h2>
<p>Add a moving averages to a <code>ggplot()</code> epicurve in one of two ways:</p>
<ol style="list-style-type: decimal">
<li>Plot the pre-calculated moving average:
<ul>
<li>Aggregate the data as necessary (daily, weekly, etc.)<br>
</li>
<li>Calculate the moving average<br>
</li>
<li>Add the moving average to the ggplot (e.g. with <code>geom_line()</code>)<br>
</li>
</ul>
</li>
<li>Calculate on-the-fly within the <code>ggplot()</code> command</li>
</ol>
<p>See the page on <a href="epidemic-curves.html#moving-averages">Moving averages</a> for more details. Brief examples are provided below.</p>
<div id="using-slider" class="section level3" number="1.5.1">
<h3>
<span class="header-section-number">1.5.1</span> <strong>Using slider</strong><a class="anchor" aria-label="anchor" href="#using-slider"><i class="fas fa-link"></i></a>
</h3>
<p>In this approach, the moving average is calculated in the dataset prior to plotting:</p>
<ul>
<li>Within <code>mutate()</code>, a new column is created to hold the average. <code>slide_index()</code> from <strong>slider</strong> package is used as shown below.<br>
</li>
<li>In the <code>ggplot()</code>, a <code>geom_line()</code> is added after the histogram, reflecting the moving average.</li>
</ul>
<p>See the helpful online <a href="https://cran.r-project.org/web/packages/slider/vignettes/slider.html">vignette for the <strong>slider</strong> package</a></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load package</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">slider</span><span class="op">)</span>  <span class="co"># slider used to calculate rolling averages</span>

<span class="co"># make dataset of daily counts and 7-day moving average</span>
<span class="co">#######################################################</span>
<span class="va">ll_counts_7day</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="co">## count cases by date</span>
  <span class="fu">count</span><span class="op">(</span><span class="va">date_onset</span>,
        name <span class="op">=</span> <span class="st">"new_cases"</span><span class="op">)</span> <span class="op">%&gt;%</span>   <span class="co"># name of new column</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># remove cases with missing date_onset</span>
  
  <span class="co">## calculate the average number of cases in the preceding 7 days</span>
  <span class="fu">mutate</span><span class="op">(</span>
    avg_7day <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/slider/man/slide_index.html">slide_index</a></span><span class="op">(</span>    <span class="co"># create new column</span>
      <span class="va">new_cases</span>,                       <span class="co"># calculate based on value in new_cases column</span>
      .i <span class="op">=</span> <span class="va">date_onset</span>,                 <span class="co"># index is date_onset col, so non-present dates are included in window </span>
      .f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,    <span class="co"># function is mean() with missing values removed</span>
      .before <span class="op">=</span> <span class="fl">6</span>,                     <span class="co"># window is the day and 6-days before</span>
      .complete <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,              <span class="co"># must be FALSE for unlist() to work in next step</span>
    avg_7day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">avg_7day</span><span class="op">)</span><span class="op">)</span>


<span class="co"># plot</span>
<span class="co">######</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">ll_counts_7day</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">new_cases</span><span class="op">)</span>,
                   fill<span class="op">=</span><span class="st">"#92a8d1"</span>,
                   stat <span class="op">=</span> <span class="st">"identity"</span>,
                   position <span class="op">=</span> <span class="st">"stack"</span>,
                   colour <span class="op">=</span> <span class="st">"#92a8d1"</span><span class="op">)</span><span class="op">+</span> 
    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">avg_7day</span>, lty <span class="op">=</span> <span class="st">"7-day \nrolling avg"</span><span class="op">)</span>,
              color<span class="op">=</span><span class="st">"red"</span>,
              size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">scale_x_date</span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">"1 month"</span>,
                 date_labels <span class="op">=</span> <span class="st">'%d/%m'</span>,
                 expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,
                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">""</span>,
         y <span class="op">=</span><span class="st">"Number of confirmed cases"</span>,
         fill <span class="op">=</span> <span class="st">"Legend"</span><span class="op">)</span><span class="op">+</span> 
    <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="co"># removes title of legend</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-110-1.png" width="672"></div>
<div id="using-tidyquant" class="section level5" number="1.5.1.0.1">
<h5>
<span class="header-section-number">1.5.1.0.1</span> <strong>Using tidyquant</strong><a class="anchor" aria-label="anchor" href="#using-tidyquant"><i class="fas fa-link"></i></a>
</h5>
<p>Using the <strong>tidyquant</strong> package to calculate the moving average on-the-fly (within <code>ggplot()</code>).</p>
<p>This option is more difficult to modify than pre-calculating the moving average. By default,<code><a href="https://rdrr.io/pkg/tidyquant/man/geom_ma.html">geom_ma()</a></code> uses the Simple Moving Average (SMA) (<code>TRR::SMA()</code>). See documentation by entering <code>?SMA</code> in your R console. Calculates the arithmetic mean over the past <code>n</code> observations. Also note how the moving average does not begin as early as the previous example.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load package</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">tidyquant</span><span class="op">)</span>

<span class="co"># make daily count data</span>
<span class="co">#######################</span>
<span class="va">ll_counts_7day</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">count</span><span class="op">(</span><span class="va">date_onset</span>, name <span class="op">=</span> <span class="st">"daily_cases"</span><span class="op">)</span>


<span class="co"># plot</span>
<span class="co">######</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">ll_counts_7day</span>,   <span class="co"># use daily count data</span>
       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span>,      <span class="co"># date x-axis</span>
           y <span class="op">=</span> <span class="va">daily_cases</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>   <span class="co"># counts</span>
  
  <span class="co"># histogram in the background</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>,    <span class="co"># height = value in the cell, not number of rows</span>
                 color <span class="op">=</span> <span class="st">"#92a8d1"</span>,    <span class="co"># color of lines within histogram</span>
                 fill <span class="op">=</span> <span class="st">"#92a8d1"</span><span class="op">)</span><span class="op">+</span>    <span class="co"># color of histogram</span>
  
  <span class="co"># moving average line</span>
  <span class="fu">tidyquant</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/geom_ma.html">geom_ma</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">7</span>,            <span class="co"># window width</span>
                     size <span class="op">=</span> <span class="fl">2</span>,         <span class="co"># line size</span>
                     color <span class="op">=</span> <span class="st">"black"</span>,  <span class="co"># line color</span>
                     lty <span class="op">=</span> <span class="st">"solid"</span>     <span class="co"># line type ()</span>
                     <span class="op">)</span><span class="op">+</span>
     
  <span class="co"># labels for x-axis</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">"2 months"</span>,      <span class="co"># labels every 2 months </span>
               date_minor_breaks <span class="op">=</span> <span class="st">"1 month"</span>, <span class="co"># gridlines every month</span>
               date_labels <span class="op">=</span> <span class="st">'%b\n%Y'</span><span class="op">)</span><span class="op">+</span>       <span class="co">#labeled by month with year below</span>
     
  <span class="co"># Choose color palette (uses RColorBrewer package)</span>
  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Pastel2"</span><span class="op">)</span><span class="op">+</span> 
  
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date of onset"</span>, 
       y <span class="op">=</span> <span class="st">"Daily case incidence"</span>,
       title <span class="op">=</span> <span class="st">"Daily case incidence, with 7-day moving average"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-111-1.png" width="672"></div>
</div>
</div>
</div>
<div id="tentative-data" class="section level2" number="1.6">
<h2>
<span class="header-section-number">1.6</span> Tentative data<a class="anchor" aria-label="anchor" href="#tentative-data"><i class="fas fa-link"></i></a>
</h2>
<p>The most recent data shown in epicurves should often be marked as tentative, or subject to reporting delays. This can be done in by adding a vertical line and/or rectangle over a specified number of days. Here are two options:</p>
<ol style="list-style-type: decimal">
<li>Use <code>annotate()</code>:
<ul>
<li>
<strong>Pros:</strong> Transparency of rectangle is easy. <strong>Cons:</strong> Items will not appear in legend.<br>
</li>
<li>For a line use <code>annotate(geom = "segment")</code>. Provide <code>x</code>, <code>xend</code>, <code>y</code>, and <code>yend</code>. Adjust size, linetype (<code>lty</code>), and color.<br>
</li>
<li>For a rectangle use <code>annotate(geom = "rect")</code>. Provide xmin/xmax/ymin/ymax. Adjust color and alpha.<br>
</li>
</ul>
</li>
<li>Use <code>geom_segment()</code> and <code>geom_rect()</code>:
<ul>
<li>
<strong>Pros:</strong> Items can easily appear in legend. <strong>Cons:</strong> Difficult to achieve semi-transparency of rectangle.<br>
</li>
<li>Provide the same x/y arguments as noted above for <code>annotate()</code>
</li>
</ul>
</li>
</ol>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> While you can use <code>geom_rect()</code> to draw a rectangle, adjusting the transparency (alpha) does not work in a linelist context. This function overlays a rectangle for each observation/row!. Try a very low alpha (e.g. 0.01), or use <code>annotate(geom = "rect")</code> as shown. </span></p>
<div id="using-annotate" class="section level3 unnumbered">
<h3>Using <code>annotate()</code><a class="anchor" aria-label="anchor" href="#using-annotate"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Within <code>annotate(geom = "rect")</code>, the <code>xmin</code> and <code>xmax</code> arguments must be given inputs of class Date.<br>
</li>
<li>Note that because these data are aggregated into weekly bars, and the last bar extends to the Monday after the last data point, the shaded region may appear to cover 4 weeks<br>
</li>
<li>Here is an <code>annotate()</code> <a href="https://ggplot2.tidyverse.org/reference/annotate.html">online example</a>
</li>
</ul>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="co"># histogram</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>
      from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
      by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"darkblue"</span>,
    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># scales</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,                   <span class="co"># remove excess x-axis space below and after case bars</span>
    date_breaks <span class="op">=</span> <span class="st">"1 month"</span>,           <span class="co"># 1st of month</span>
    date_minor_breaks <span class="op">=</span> <span class="st">"1 month"</span>,     <span class="co"># 1st of month</span>
    date_labels <span class="op">=</span> <span class="st">"%b\n'%y"</span><span class="op">)</span><span class="op">+</span>          <span class="co"># label format</span>
  
  <span class="co"># labels and theme</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Using annotate()\nRectangle and line showing that data from last 21-days are tentative"</span>,
    x <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,
    y <span class="op">=</span> <span class="st">"Weekly case indicence"</span><span class="op">)</span><span class="op">+</span> 
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  
  <span class="co"># add semi-transparent red rectangle to tentative data</span>
  <span class="fu">annotate</span><span class="op">(</span><span class="st">"rect"</span>,
           xmin  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">21</span><span class="op">)</span>, <span class="co"># note must be wrapped in as.Date()</span>
           xmax  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="cn">Inf</span><span class="op">)</span>,                                          <span class="co"># note must be wrapped in as.Date()</span>
           ymin  <span class="op">=</span> <span class="fl">0</span>,
           ymax  <span class="op">=</span> <span class="cn">Inf</span>,
           alpha <span class="op">=</span> <span class="fl">0.2</span>,          <span class="co"># alpha easy and intuitive to adjust using annotate()</span>
           fill  <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">+</span>
  
  <span class="co"># add black vertical line on top of other layers</span>
  <span class="fu">annotate</span><span class="op">(</span><span class="st">"segment"</span>,
           x     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">21</span>, <span class="co"># 21 days before last data</span>
           xend  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">21</span>, 
           y     <span class="op">=</span> <span class="fl">0</span>,         <span class="co"># line begins at y = 0</span>
           yend  <span class="op">=</span> <span class="cn">Inf</span>,       <span class="co"># line to top of plot</span>
           size  <span class="op">=</span> <span class="fl">2</span>,         <span class="co"># line size</span>
           color <span class="op">=</span> <span class="st">"black"</span>,
           lty   <span class="op">=</span> <span class="st">"solid"</span><span class="op">)</span><span class="op">+</span>   <span class="co"># linetype e.g. "solid", "dashed"</span>

  <span class="co"># add text in rectangle</span>
  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>,
           x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">15</span>,
           y <span class="op">=</span> <span class="fl">15</span>,
           label <span class="op">=</span> <span class="st">"Subject to reporting delays"</span>,
           angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-112-1.png" width="672"></div>
<p>The same black vertical line can be achieved with the code below, but using <code>geom_vline()</code> you lose the ability to control the height:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">21</span>,
           size <span class="op">=</span> <span class="fl">2</span>,
           color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></code></pre></div>
</div>
<div id="using-geom_segment-and-geom_rect" class="section level3 unnumbered">
<h3>Using <code>geom_segment()</code> and <code>geom_rect()</code><a class="anchor" aria-label="anchor" href="#using-geom_segment-and-geom_rect"><i class="fas fa-link"></i></a>
</h3>
<p>In this alternative method, the red color is explained in the legend.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">central_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="co"># histogram</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>
      from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
      by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"darkblue"</span>,
    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span>

  <span class="co"># scales</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>
    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,                   <span class="co"># remove excess x-axis space below and after case bars</span>
    date_breaks <span class="op">=</span> <span class="st">"3 weeks"</span>,           <span class="co"># Monday every 3 weeks</span>
    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,        <span class="co"># Monday weeks </span>
    date_labels <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span>      <span class="co"># label format</span>
  
  <span class="co"># labels and theme</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Using geom_segment() and geom_rect()\nRectangle and line showing that data from last 21-days are tentative"</span>,
    subtitle <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">+</span> 
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  
  <span class="co"># make rectangle covering last 21 days</span>
  <span class="fu">geom_rect</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>
              xmin  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">21</span><span class="op">)</span>, <span class="co"># note must be wrapped in as.Date()</span>
              xmax  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="cn">Inf</span><span class="op">)</span>,                                          <span class="co"># note must be wrapped in as.Date()</span>
              ymin  <span class="op">=</span> <span class="fl">0</span>,
              ymax  <span class="op">=</span> <span class="cn">Inf</span>,
              color <span class="op">=</span> <span class="st">"Reporting delays\npossible"</span><span class="op">)</span>,    <span class="co"># sets label for legend (note: is within aes())</span>
              alpha <span class="op">=</span> <span class="fl">.002</span>,                             <span class="co"># !!! Difficult to adjust transparency with this option</span>
              fill  <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">+</span>
  
  <span class="co"># make vertical line</span>
  <span class="fu">geom_segment</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">21</span>,
                   xend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">21</span>,
                   y <span class="op">=</span> <span class="fl">0</span>,
                   yend <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>,
               color <span class="op">=</span> <span class="st">"black"</span>,
               lty <span class="op">=</span> <span class="st">"solid"</span>,
               size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>                 <span class="co"># remove title of legend</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-114-1.png" width="672"></div>
</div>
</div>
<div id="multi-level-date-labels" class="section level2" number="1.7">
<h2>
<span class="header-section-number">1.7</span> Multi-level date labels<a class="anchor" aria-label="anchor" href="#multi-level-date-labels"><i class="fas fa-link"></i></a>
</h2>
<p>If you want multi-level date labels (e.g. month and year) <em>without duplicating the lower label levels</em>, consider one of the approaches below:</p>
<p>Remember - you can can use tools like <code>\n</code> <em>within</em> the <code>date_labels</code> or <code>labels</code> arguments to put parts of each label on a new line below. However, the code below helps you take years or months (for example) on a lower line <em>and only once</em>.</p>
<p>A few notes on the code below:</p>
<ul>
<li>Case counts are aggregated into weeks for aesthetic reasons. See Epicurves page (aggregated data tab) for details.<br>
</li>
<li>A line is used instead of a histogram, as the faceting approach below does not work well with histograms.</li>
</ul>
<p><strong>Aggregate to weekly counts</strong></p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create dataset of case counts by week</span>
<span class="co">#######################################</span>
<span class="va">central_weekly</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span> <span class="op">%&gt;%</span>           <span class="co"># filter linelist</span>
  <span class="fu">mutate</span><span class="op">(</span>week <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">date_onset</span>, unit <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  
  <span class="fu">count</span><span class="op">(</span><span class="va">week</span>, .drop<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op">%&gt;%</span>                             <span class="co"># summarize weekly case counts</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>                             <span class="co"># remove cases with missing onset_date</span>
  <span class="fu">complete</span><span class="op">(</span>week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>,           <span class="co"># fill-in all weeks with no cases reported</span>
                           to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>,
                           by   <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><strong>Make plots</strong></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot with box border on year</span>
<span class="co">##############################</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">central_weekly</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">n</span><span class="op">)</span>,    <span class="co"># make line, specify x and y</span>
            stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span>             <span class="co"># because line height is count number</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>date_labels<span class="op">=</span><span class="st">"%b"</span>,             <span class="co"># date label format show month </span>
               date_breaks<span class="op">=</span><span class="st">"month"</span>,          <span class="co"># date labels on 1st of each month</span>
               expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>              <span class="co"># remove excess space</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="op">~</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>, <span class="co"># facet on year (of Date class column)</span>
             space<span class="op">=</span><span class="st">"free_x"</span>,                
             scales<span class="op">=</span><span class="st">"free_x"</span>,                <span class="co"># x-axes adapt to data range (not "fixed")</span>
             switch<span class="op">=</span><span class="st">"x"</span><span class="op">)</span> <span class="op">+</span>                   <span class="co"># facet labels (year) on bottom</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>strip.placement <span class="op">=</span> <span class="st">"outside"</span>,         <span class="co"># facet labels placement</span>
        strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, <span class="co"># facet labels no fill grey border</span>
                                        colour <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span>,
        panel.spacing <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>      <span class="co"># no space between facet panels</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Nested year labels, grey label border"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-116-1.png" width="672"></div>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot with no box border on year</span>
<span class="co">#################################</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">central_weekly</span>,
       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>              <span class="co"># establish x and y for entire plot</span>
  <span class="fu">geom_line</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>,              <span class="co"># make line, line height is count number</span>
            color <span class="op">=</span> <span class="st">"#69b3a2"</span><span class="op">)</span> <span class="op">+</span>            <span class="co"># line color</span>
  <span class="fu">geom_point</span><span class="op">(</span>size<span class="op">=</span><span class="fl">1</span>, color<span class="op">=</span><span class="st">"#69b3a2"</span><span class="op">)</span> <span class="op">+</span>     <span class="co"># make points at the weekly data points</span>
  <span class="fu">geom_area</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#69b3a2"</span>,               <span class="co"># fill area below line</span>
            alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span><span class="op">+</span>                   <span class="co"># fill transparency</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>date_labels<span class="op">=</span><span class="st">"%b"</span>,            <span class="co"># date label format show month </span>
               date_breaks<span class="op">=</span><span class="st">"month"</span>,         <span class="co"># date labels on 1st of each month</span>
               expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>             <span class="co"># remove excess space</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="op">~</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>,   <span class="co"># facet on year (of Date class column)</span>
             space<span class="op">=</span><span class="st">"free_x"</span>,                
             scales<span class="op">=</span><span class="st">"free_x"</span>,               <span class="co"># x-axes adapt to data range (not "fixed")</span>
             switch<span class="op">=</span><span class="st">"x"</span><span class="op">)</span> <span class="op">+</span>                  <span class="co"># facet labels (year) on bottom</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>strip.placement <span class="op">=</span> <span class="st">"outside"</span>,                     <span class="co"># facet label placement</span>
          strip.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,            <span class="co"># no facet lable background</span>
          panel.grid.minor.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,          
          panel.border <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>colour<span class="op">=</span><span class="st">"grey40"</span><span class="op">)</span>,  <span class="co"># grey border to facet PANEL</span>
          panel.spacing<span class="op">=</span><span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>,<span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                   <span class="co"># No space between facet panels</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Nested year labels - points, shaded, no label border"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-116-2.png" width="672"></div>
<p>The above techniques were adapted from <a href="https://stackoverflow.com/questions/44616530/axis-labels-on-two-lines-with-nested-x-variables-year-below-months">this</a> and <a href="https://stackoverflow.com/questions/20571306/multi-row-x-axis-labels-in-ggplot-line-chart">this</a> post on stackoverflow.com.</p>
</div>
<div id="aggregated-data" class="section level2" number="1.8">
<h2>
<span class="header-section-number">1.8</span> Aggregated data<a class="anchor" aria-label="anchor" href="#aggregated-data"><i class="fas fa-link"></i></a>
</h2>
<div id="aggregating-linelist-data" class="section level3 unnumbered">
<h3>Aggregating linelist data<a class="anchor" aria-label="anchor" href="#aggregating-linelist-data"><i class="fas fa-link"></i></a>
</h3>
<p>To learn generally how to group and aggregate data, see the page on [Grouping data].</p>
<p>In this circumstance, we demonstrate aggregating into weeks, months, and days.</p>
<div id="aggregating-into-weeks" class="section level4 unnumbered">
<h4>Aggregating into weeks<a class="anchor" aria-label="anchor" href="#aggregating-into-weeks"><i class="fas fa-link"></i></a>
</h4>
<p>Create a new column that is weeks, then use <code>group_by()</code> with <code>summarize()</code> to get weekly case counts.</p>
<p>To aggregate into weeks and show ALL weeks (even ones with no cases), do this:</p>
<ol style="list-style-type: decimal">
<li>Create a new ‘week’ column within <code>mutate()</code>, using <code>floor_date()</code> from the <strong>lubridate</strong> package:
<ul>
<li>use <code>unit =</code> to set the desired time unit, e.g. "week`<br>
</li>
<li>use <code>week_start =</code> to set the weekday start of the week (7 = Sunday, 1 = Monday)</li>
</ul>
</li>
<li>Follow with <code>complete()</code> to ensure that all weeks appear - even those with no cases.</li>
</ol>
<p>For example:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make dataset of weekly case counts</span>
<span class="va">weekly_counts</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>
    week <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">date_onset</span>,
                                 unit <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># new column of week of onset</span>
  <span class="fu">count</span><span class="op">(</span><span class="va">week</span><span class="op">)</span> <span class="op">%&gt;%</span>                                     <span class="co"># group data by week and count rows per group</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>                            <span class="co"># remove entries for cases missing date_onset</span>
  <span class="fu">complete</span><span class="op">(</span>week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>,          <span class="co"># fill-in all weeks with no cases reported</span>
                           to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>,
                           by<span class="op">=</span><span class="st">"week"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span>                                           <span class="co"># deactivate grouping</span></code></pre></div>
<p>Here are the first 50 rows of the resulting dataframe:</p>
<div id="htmlwidget-ff88355e23a22283ede7" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ff88355e23a22283ede7">{"x":{"filter":"top","filterHTML":"<tr>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1396742400000\" data-max=\"1426377600000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"integer\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1\" data-max=\"293\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["2014-04-06","2014-04-13","2014-04-20","2014-04-27","2014-05-04","2014-05-11","2014-05-18","2014-05-25","2014-06-01","2014-06-08","2014-06-15","2014-06-22","2014-06-29","2014-07-06","2014-07-13","2014-07-20","2014-07-27","2014-08-03","2014-08-10","2014-08-17","2014-08-24","2014-08-31","2014-09-07","2014-09-14","2014-09-21","2014-09-28","2014-10-05","2014-10-12","2014-10-19","2014-10-26","2014-11-02","2014-11-09","2014-11-16","2014-11-23","2014-11-30","2014-12-07","2014-12-14","2014-12-21","2014-12-28","2015-01-04","2015-01-11","2015-01-18","2015-01-25","2015-02-01","2015-02-08","2015-02-15","2015-02-22","2015-03-01","2015-03-08","2015-03-15"],[1,1,4,4,12,14,15,21,20,18,29,23,33,36,54,57,79,86,114,128,164,193,216,293,283,277,265,245,239,239,221,177,133,172,153,125,123,123,94,101,106,101,86,81,67,79,80,75,68,61]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>week<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p><strong>Alternatively, you can use the <a href="https://cran.r-project.org/web/packages/aweek/vignettes/introduction.html"><strong>aweek</strong></a> package’s <code>date2week()</code> function</strong>. As shown below, set <code>week_start =</code> to “Sunday”, or “Monday”, etc. Set <code>floor_date = TRUE</code> so the output is YYYY-Www. Set <code>factor = TRUE</code> so that all possible weeks are included, even if there are no cases (this replaces the <code>complete()</code> step in the <strong>lubridate</strong> approach above). You can also use <code>numeric = TRUE</code> if you want only the week number (note this will not distinguish between years).</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make dataset of weekly case counts</span>
<span class="va">weekly_counts</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>week <span class="op">=</span> <span class="fu">aweek</span><span class="fu">::</span><span class="fu"><a href="https://www.repidemicsconsortium.org/aweek/reference/date2week.html">date2week</a></span><span class="op">(</span><span class="va">date_onset</span>,          <span class="co"># new column of week of onset</span>
                                 floor_day <span class="op">=</span> <span class="cn">T</span>,       <span class="co"># show as weeks without weekday</span>
                                 factor <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># include all possible weeks</span>
  <span class="fu">count</span><span class="op">(</span><span class="va">week</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span>                                           <span class="co"># deactivate grouping</span>

<span class="co"># Optional: add column of start DATE for each week - e.g. for ggplot() when date x-axis is expected</span>
<span class="co"># note: add this step AFTER the above code, to ensure all weeks are present</span>
<span class="va">weekly_counts</span> <span class="op">&lt;-</span> <span class="va">weekly_counts</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>week_as_date <span class="op">=</span> <span class="fu">aweek</span><span class="fu">::</span><span class="fu"><a href="https://www.repidemicsconsortium.org/aweek/reference/date2week.html">week2date</a></span><span class="op">(</span><span class="va">week</span>, week_start <span class="op">=</span> <span class="st">"Monday"</span><span class="op">)</span><span class="op">)</span> <span class="co"># output is Monday date of each week</span></code></pre></div>
</div>
<div id="aggregating-into-months" class="section level4 unnumbered">
<h4>Aggregating into months<a class="anchor" aria-label="anchor" href="#aggregating-into-months"><i class="fas fa-link"></i></a>
</h4>
<p>To aggregate cases into months, again use <code>floor_date()</code> from the <strong>lubridate</strong> package, but with the argument <code>unit = "months"</code>. This rounds each date down to the 1st of its month. The output will be class Date.</p>
<p>Note that in the <code>complete()</code> step we also use “months”</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make dataset of weekly case counts</span>
<span class="va">monthly_counts</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>month <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">date_onset</span>, unit <span class="op">=</span> <span class="st">"months"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>   <span class="co"># new column, 1st of month of onset</span>
  <span class="fu">count</span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">complete</span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span>,     <span class="co"># fill-in all months with no cases reported</span>
                            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span>,
                            by<span class="op">=</span><span class="st">"month"</span><span class="op">)</span><span class="op">)</span>    </code></pre></div>
<div id="htmlwidget-ffe2f2da4761fd477a19" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ffe2f2da4761fd477a19">{"x":{"filter":"top","filterHTML":"<tr>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1396310400000\" data-max=\"1427846400000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"integer\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"7\" data-max=\"1105\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["2014-04-01","2014-05-01","2014-06-01","2014-07-01","2014-08-01","2014-09-01","2014-10-01","2014-11-01","2014-12-01","2015-01-01","2015-02-01","2015-03-01","2015-04-01"],[7,65,98,227,536,1088,1105,760,560,432,307,276,186]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>month<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="aggregating-into-days" class="section level4 unnumbered">
<h4>Aggregating into days<a class="anchor" aria-label="anchor" href="#aggregating-into-days"><i class="fas fa-link"></i></a>
</h4>
<p>To aggregate a linelist into days, use the same approach but there is no need to create a new column. Use <code>group_by()</code> on the date column (e.g. <code>date_onset</code>).</p>
<p>If plotting a histogram, missing days in the data are not a problem as long as the column is class Date. However, it may be important for other types of plots or tables to have all possible days apear in the data. This is done with: <code><a href="https://tidyr.tidyverse.org/reference/complete.html">tidyr::complete()</a></code></p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Make dataset of weekly case counts</span>
<span class="va">daily_counts</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">count</span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span> <span class="op">%&gt;%</span>                           <span class="co"># count number of rows per unique date</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>                  <span class="co"># remove aggregation of rows that were missing date_onset</span>
  <span class="fu">complete</span><span class="op">(</span>date_onset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span>, <span class="co"># ensure all days appear</span>
                                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span>,
                                 by<span class="op">=</span><span class="st">"day"</span><span class="op">)</span><span class="op">)</span>  </code></pre></div>
</div>
</div>
<div id="plotting-aggregated-data" class="section level3 unnumbered">
<h3>Plotting aggregated data<a class="anchor" aria-label="anchor" href="#plotting-aggregated-data"><i class="fas fa-link"></i></a>
</h3>
<p>Often instead of a linelist, you begin with aggregated counts from facilities, districts, etc. You can make an epicurve from <code>ggplot()</code> but the code will be slightly different. The <strong>incidence</strong> package does not currently support plotting of aggregated data.</p>
<p>This section will utilize the <code>count_data</code> dataset that was imported earlier, in the data preparation section. It is the <code>linelist</code> aggregated to day-hospital counts. The first 50 rows are displayed below.</p>
<div id="htmlwidget-ee24cb7e23f8a2c52c79" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ee24cb7e23f8a2c52c79">{"x":{"filter":"top","filterHTML":"<tr>\n  <td data-type=\"disabled\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1399334400000\" data-max=\"1410307200000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"integer\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"1\" data-max=\"3\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital"],["2014-05-06","2014-05-10","2014-05-13","2014-05-28","2014-06-06","2014-06-09","2014-06-14","2014-06-19","2014-07-09","2014-07-10","2014-07-11","2014-07-13","2014-07-14","2014-07-15","2014-07-17","2014-07-19","2014-07-27","2014-07-30","2014-08-01","2014-08-02","2014-08-04","2014-08-05","2014-08-07","2014-08-09","2014-08-12","2014-08-14","2014-08-15","2014-08-16","2014-08-17","2014-08-18","2014-08-19","2014-08-20","2014-08-21","2014-08-22","2014-08-23","2014-08-24","2014-08-26","2014-08-28","2014-08-29","2014-08-30","2014-08-31","2014-09-01","2014-09-02","2014-09-03","2014-09-04","2014-09-05","2014-09-06","2014-09-07","2014-09-09","2014-09-10"],[1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2,1,1,2,1,2,1,1,2,1,3,1,1,1,2,3,2,2,2,1,2,2,2,1,2,3,3,2,1,1,2,3,2,2,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>n_cases<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>As before, we must ensure date variables are correctly classified.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Convert Date variable to Date class</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">count_data</span><span class="op">$</span><span class="va">date_hospitalisation</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Date"</code></pre>
<div id="plotting-daily-counts" class="section level4 unnumbered">
<h4>Plotting daily counts<a class="anchor" aria-label="anchor" href="#plotting-daily-counts"><i class="fas fa-link"></i></a>
</h4>
<p>We can plot a daily epicurve from these <em>daily counts</em>. Here are the differences:</p>
<ul>
<li>Specify <code>y =</code> to the counts column within the primary aesthetics <code>aes()</code>
</li>
<li>Use of <code>stat = "identity"</code> within <code>geom_histogram()</code> indicates that the y-values could be counts from the <code>y =</code> column in <code>aes()</code>
</li>
</ul>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">count_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">date_hospitalisation</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">n_cases</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
     <span class="fu">geom_histogram</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span><span class="op">+</span>
     <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date of report"</span>, 
          y <span class="op">=</span> <span class="st">"Number of cases"</span>,
          Title <span class="op">=</span> <span class="st">"Daily case incidence, from daily count data"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-125-1.png" width="672"></div>
</div>
<div id="plotting-weekly-counts" class="section level4 unnumbered">
<h4>Plotting weekly counts<a class="anchor" aria-label="anchor" href="#plotting-weekly-counts"><i class="fas fa-link"></i></a>
</h4>
<p>To aggregated the daily counts into weekly counts, we use the package <strong>lubridate</strong> and function <code>floor_date()</code>, as described above. Note that we use <code>group_by()</code> and <code>summarize()</code> in place of <code>count()</code> because we need to <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> case counts instead of just counting the number of rows per group.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create weekly dataset with epiweek column</span>
<span class="va">count_data_weekly</span> <span class="op">&lt;-</span> <span class="va">count_data</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>epiweek <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">date_hospitalisation</span>, <span class="st">"week"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">hospital</span>, <span class="va">epiweek</span>, .drop<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span>n_cases_weekly <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n_cases</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>   </code></pre></div>
<p>The first 50 rows of <code>count_data_weekly</code> are displayed below. You can see that the counts have been aggregated into weeks. Each week is displayed by the first day of the week (Monday by default).</p>
<div id="htmlwidget-f213b79998e7602296be" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f213b79998e7602296be">{"x":{"filter":"none","data":[["Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Military Hospital","Military Hospital"],["2014-05-04","2014-05-11","2014-05-25","2014-06-01","2014-06-08","2014-06-15","2014-07-06","2014-07-13","2014-07-27","2014-08-03","2014-08-10","2014-08-17","2014-08-24","2014-08-31","2014-09-07","2014-09-14","2014-09-21","2014-09-28","2014-10-05","2014-10-12","2014-10-19","2014-10-26","2014-11-02","2014-11-09","2014-11-16","2014-11-23","2014-11-30","2014-12-07","2014-12-14","2014-12-21","2014-12-28","2015-01-04","2015-01-11","2015-01-18","2015-01-25","2015-02-01","2015-02-08","2015-02-15","2015-02-22","2015-03-01","2015-03-08","2015-03-15","2015-03-22","2015-03-29","2015-04-05","2015-04-12","2015-04-19","2015-04-26","2014-04-13","2014-05-11"],[2,1,2,1,2,1,3,7,5,6,6,13,9,15,12,23,24,23,25,26,23,19,25,19,14,9,10,9,8,12,5,10,5,6,6,4,8,9,8,2,5,3,4,5,6,3,6,5,1,6]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>epiweek<\/th>\n      <th>n_cases_weekly<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>We also specify the factor level order of <code>hospital</code></p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">count_data_weekly</span> <span class="op">&lt;-</span> <span class="va">count_data_weekly</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span>,
         hospital <span class="op">=</span> <span class="fu">fct_relevel</span><span class="op">(</span><span class="va">hospital</span>,
                                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Missing"</span>, <span class="st">"Port Hospital"</span>,
                                  <span class="st">"Military Hospital"</span>, <span class="st">"Central Hospital"</span>,
                                  <span class="st">"St. Mark's Maternity Hospital (SMMH)"</span>,
                                  <span class="st">"Other"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now plot by epiweek.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">count_data_weekly</span>,
       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>,
           y <span class="op">=</span> <span class="va">n_cases_weekly</span>,
           group <span class="op">=</span> <span class="va">hospital</span>,
           fill <span class="op">=</span> <span class="va">hospital</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  
  <span class="fu">geom_histogram</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span><span class="op">+</span>
     
  <span class="co"># labels for x-axis</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">"2 months"</span>,      <span class="co"># labels every 2 months </span>
               date_minor_breaks <span class="op">=</span> <span class="st">"1 month"</span>, <span class="co"># gridlines every month</span>
               date_labels <span class="op">=</span> <span class="st">'%b\n%Y'</span><span class="op">)</span><span class="op">+</span>       <span class="co">#labeled by month with year below</span>
     
  <span class="co"># Choose color palette (uses RColorBrewer package)</span>
  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Pastel2"</span><span class="op">)</span><span class="op">+</span> 
  
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Week of onset"</span>, 
       y <span class="op">=</span> <span class="st">"Weekly case incidence"</span>,
       fill <span class="op">=</span> <span class="st">"Hospital"</span>,
       title <span class="op">=</span> <span class="st">"Weekly case incidence, from aggregated count data by hospital"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-129-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="dual-axis" class="section level2" number="1.9">
<h2>
<span class="header-section-number">1.9</span> Dual-axis<a class="anchor" aria-label="anchor" href="#dual-axis"><i class="fas fa-link"></i></a>
</h2>
<p>Although there are fierce discussions about the validity of dual axes within the data visualization community, many epi supervisors want to see an epicurve or similar chart with a percent overlaid with a second axis.</p>
<p>See the handbook page on [ggplot tips] for details on how to make a second axis.</p>
</div>
<div id="cumulative-incidence" class="section level2" number="1.10">
<h2>
<span class="header-section-number">1.10</span> Cumulative Incidence<a class="anchor" aria-label="anchor" href="#cumulative-incidence"><i class="fas fa-link"></i></a>
</h2>
<p>If beginning with a case linelist, create a new column containing the cumulative number of cases per day in an outbreak using <code><a href="https://rdrr.io/r/base/cumsum.html">cumsum()</a></code> from <strong>base</strong> R:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cumulative_case_counts</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">count</span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span> <span class="op">%&gt;%</span>                <span class="co"># count of rows per day (returned in column "n")   </span>
  <span class="fu">mutate</span><span class="op">(</span>                         
    cumulative_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>       <span class="co"># new column of the cumulative number of rows at each date</span>
    <span class="op">)</span></code></pre></div>
<p>The first 10 rows are shown below:</p>
<div id="htmlwidget-949d157732e0514f4b6a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-949d157732e0514f4b6a">{"x":{"filter":"none","data":[["2014-04-07","2014-04-15","2014-04-21","2014-04-25","2014-04-26","2014-04-27","2014-05-01","2014-05-03","2014-05-04","2014-05-05"],[1,1,2,1,1,1,2,1,1,1],[1,2,4,5,6,7,9,10,11,12]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>date_onset<\/th>\n      <th>n<\/th>\n      <th>cumulative_cases<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>This cumulative column can then be plotted against <code>date_onset</code>, using <code>geom_line()</code>:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot_cumulative</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">cumulative_case_counts</span>,
    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span>, y <span class="op">=</span> <span class="va">cumulative_cases</span><span class="op">)</span>,
    size <span class="op">=</span> <span class="fl">2</span>,
    color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>

<span class="va">plot_cumulative</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-132-1.png" width="672"></div>
<p>It can also be overlaid onto the epicurve, with dual-axis using the <strong>cowplot</strong> method described in the [ggplot tips] page:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#load package</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">cowplot</span><span class="op">)</span>

<span class="co"># Make first plot of epicurve histogram</span>
<span class="va">plot_cases</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>          
    data <span class="op">=</span> <span class="va">linelist</span>,
    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,
    binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>
    y <span class="op">=</span> <span class="st">"Daily cases"</span>,
    x <span class="op">=</span> <span class="st">"Date of symptom onset"</span>
  <span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_cowplot</span><span class="op">(</span><span class="op">)</span>

<span class="co"># make second plot of cumulative cases line</span>
<span class="va">plot_cumulative</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">cumulative_case_counts</span>,
    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span>, y <span class="op">=</span> <span class="va">cumulative_cases</span><span class="op">)</span>,
    size <span class="op">=</span> <span class="fl">2</span>,
    color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>
    position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>,
       y <span class="op">=</span> <span class="st">"Cumulative cases"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_cowplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>
    axis.line.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
    axis.text.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
    axis.title.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
    axis.ticks <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now use <strong>cowplot</strong> to overlay the two plots. Attention has been paid to the x-axis alignment, side of the y-axis, and use of <code>theme_cowplot()</code>.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aligned_plots</span> <span class="op">&lt;-</span> <span class="fu">align_plots</span><span class="op">(</span><span class="va">plot_cases</span>, <span class="va">plot_cumulative</span>, align<span class="op">=</span><span class="st">"hv"</span>, axis<span class="op">=</span><span class="st">"tblr"</span><span class="op">)</span>
<span class="fu">ggdraw</span><span class="op">(</span><span class="va">aligned_plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu">draw_plot</span><span class="op">(</span><span class="va">aligned_plots</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-134-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="resources" class="section level2" number="1.11">
<h2>
<span class="header-section-number">1.11</span> Resources<a class="anchor" aria-label="anchor" href="#resources"><i class="fas fa-link"></i></a>
</h2>
<p>Links to other online tutorials or resources.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="index.html">Welcome - THIS IS A DRAFT</a></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#epidemic-curves"><span class="header-section-number">1</span> Epidemic curves</a></li>
<li><a class="nav-link" href="#overview">Overview</a></li>
<li>
<a class="nav-link" href="#preparation"><span class="header-section-number">1.1</span> Preparation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#packages">Packages</a></li>
<li><a class="nav-link" href="#load-data">Load data</a></li>
<li><a class="nav-link" href="#set-parameters">Set parameters</a></li>
<li><a class="nav-link" href="#verify-dates">Verify dates</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#epicurves-with-incidence-package"><span class="header-section-number">1.2</span> Epicurves with incidence package</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#simple-example">Simple example</a></li>
<li><a class="nav-link" href="#change-time-interval-of-case-aggregation">Change time interval of case aggregation</a></li>
<li><a class="nav-link" href="#filtered-data">Filtered data</a></li>
<li><a class="nav-link" href="#modifications-with-plot">Modifications with plot()</a></li>
<li><a class="nav-link" href="#ggplot2-modifictions">ggplot2 modifictions</a></li>
<li><a class="nav-link" href="#change-colors-and-legend">Change colors and legend</a></li>
<li><a class="nav-link" href="#show-individual-cases">Show individual cases</a></li>
<li><a class="nav-link" href="#group-and-color-by-values">Group and color by values</a></li>
<li><a class="nav-link" href="#adjust-level-order">Adjust level order</a></li>
<li><a class="nav-link" href="#date-axis-labelsgridlines">Date-axis labels/gridlines</a></li>
<li><a class="nav-link" href="#facetssmall-multiples">Facets/small multiples</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#epicurves-with-ggplot2"><span class="header-section-number">1.3</span> Epicurves with ggplot2</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#examples">Examples</a></li>
<li><a class="nav-link" href="#groupcolor-by-value">Group/color by value</a></li>
<li><a class="nav-link" href="#adjust-colors">Adjust colors</a></li>
<li><a class="nav-link" href="#adjust-level-order-1">Adjust level order</a></li>
<li><a class="nav-link" href="#adjust-legend">Adjust legend</a></li>
<li><a class="nav-link" href="#bars-side-by-side">Bars side-by-side</a></li>
<li><a class="nav-link" href="#date-axis-labelsgridlines-1">Date-axis labels/gridlines</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#facetingsmall-multiples"><span class="header-section-number">1.4</span> Faceting/small-multiples</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#total-epidemic-in-facet-background">Total epidemic in facet background</a></li>
<li><a class="nav-link" href="#one-facet-box-with-all-data">One facet box with ALL data</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#moving-averages"><span class="header-section-number">1.5</span> Moving averages</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#using-slider"><span class="header-section-number">1.5.1</span> Using slider</a></li></ul>
</li>
<li>
<a class="nav-link" href="#tentative-data"><span class="header-section-number">1.6</span> Tentative data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#using-annotate">Using annotate()</a></li>
<li><a class="nav-link" href="#using-geom_segment-and-geom_rect">Using geom_segment() and geom_rect()</a></li>
</ul>
</li>
<li><a class="nav-link" href="#multi-level-date-labels"><span class="header-section-number">1.7</span> Multi-level date labels</a></li>
<li>
<a class="nav-link" href="#aggregated-data"><span class="header-section-number">1.8</span> Aggregated data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#aggregating-linelist-data">Aggregating linelist data</a></li>
<li><a class="nav-link" href="#plotting-aggregated-data">Plotting aggregated data</a></li>
</ul>
</li>
<li><a class="nav-link" href="#dual-axis"><span class="header-section-number">1.9</span> Dual-axis</a></li>
<li><a class="nav-link" href="#cumulative-incidence"><span class="header-section-number">1.10</span> Cumulative Incidence</a></li>
<li><a class="nav-link" href="#resources"><span class="header-section-number">1.11</span> Resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R Handbook for Epidemiologists</strong>" was written by the handbook team. It was last built on 2021-02-26.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
