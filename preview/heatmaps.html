<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>1 Heatmaps | R Handbook for Epidemiologists</title>
<meta name="author" content="the handbook team">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.6/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.15/datatables.js"></script><link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R Handbook for Epidemiologists</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome - THIS IS A DRAFT</a></li>
<li class="book-part">Preview pages</li>
<li><a class="active" href="heatmaps.html"><span class="header-section-number">1</span> Heatmaps</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="heatmaps" class="section level1" number="1">
<h1>
<span class="header-section-number">1</span> Heatmaps<a class="anchor" aria-label="anchor" href="#heatmaps"><i class="fas fa-link"></i></a>
</h1>
<p>Heatmaps can be useful visualizations. Below we demonstrate two examples:</p>
<ul>
<li>Tracking reporting metrics across many facilities/jurisdictions over time<br>
</li>
<li>Creating a visual matrix of transmission events by age (“who infected whom”)</li>
</ul>
<p><img src="images/transmission_matrix.png" width="50%"><img src="images/heat_tile.png" width="50%"></p>
<!-- ======================================================= -->
<div id="preparation" class="section level2" number="1.1">
<h2>
<span class="header-section-number">1.1</span> Preparation<a class="anchor" aria-label="anchor" href="#preparation"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Load packages</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span>
  <span class="va">tidyverse</span>,       <span class="co"># data manipulation and visualization</span>
  <span class="va">rio</span>,             <span class="co"># importing data </span>
  <span class="va">lubridate</span>        <span class="co"># working with dates</span>
  <span class="op">)</span></code></pre></div>
<p><strong>Datasets</strong></p>
<p>This page utilizes the case linelist for the transmission matrix section, and a separate dataset of daily malaria case counts by facility for the metrics tracking section. They are loaded and cleaned in their individual sections.</p>
</div>
<div id="contact-matrix" class="section level2" number="1.2">
<h2>
<span class="header-section-number">1.2</span> Contact matrix<a class="anchor" aria-label="anchor" href="#contact-matrix"><i class="fas fa-link"></i></a>
</h2>
<p>Heat tiles can be useful to visualize matrices. One example is to display “who-infected-whom” in an outbreak. This assumes that you have information on transmission events in your linelist.</p>
<p>We begin from the case linelist:</p>
<ul>
<li>There is one row per case<br>
</li>
<li>There is a column that contains the case_id of the infector, who is also a case in the linelist</li>
</ul>
<p>The first 50 rows of the linelist are shown below for demonstration:</p>
<p>We load the case <code>linelist</code></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu">import</span><span class="op">(</span><span class="st">"linelist_cleaned.xlsx"</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-5c7dedcdcbf20a799293" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5c7dedcdcbf20a799293">{"x":{"filter":"none","data":[["b8f2fd","8689b7","f96aa5","9e0998","56d39e","275cc7","db4b96","5387a2","8a4580","ab034a","1389ca","9f6884","bab455","c15f36","c36eb4","88eff2","bd14fc","542d07","341efa","920c1b","fdeb61","bc648d","9371a9","bc2adf","170473","abd4af","7fd086","f0461f","006e2f","64c8ef","8ebf6e","6d788e","3c09c4","188619","da8ecb","d6584f","4c1040","386dfb","69446e","3ad520","c76676","ae50c8","1f1620","917506","baacc1","3789ee","6a3ea1","1e061f","422831","72bb4b"],[5,4,3,4,5,5,3,4,4,4,4,4,5,5,8,5,6,5,9,5,5,9,8,6,7,5,7,9,11,6,7,11,7,7,5,6,7,9,12,7,9,9,7,9,12,10,12,9,12,9],["2014-05-07",null,"2014-05-17",null,null,"2014-05-24","2014-05-16","2014-05-26",null,null,null,"2014-06-02",null,null,"2014-06-15",null,"2014-06-04","2014-06-10",null,"2014-05-28",null,null,null,"2014-07-03","2014-07-05","2014-06-08",null,"2014-07-09",null,null,"2014-07-02","2014-07-12","2014-07-09","2014-07-05","2014-06-20","2014-07-14","2014-07-17","2014-07-19",null,"2014-07-12","2014-07-18","2014-07-20","2014-07-15","2014-07-18","2014-07-18","2014-07-26",null,"2014-07-21","2014-07-23",null],["2014-05-12","2014-05-13","2014-05-19","2014-05-26","2014-05-27","2014-05-27","2014-05-31","2014-05-31","2014-06-02","2014-06-03","2014-06-05","2014-06-07","2014-06-15","2014-06-17","2014-06-20","2014-06-20","2014-06-20","2014-06-22","2014-06-24","2014-06-26","2014-06-29","2014-06-30","2014-07-08","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-12","2014-07-12","2014-07-14","2014-07-14","2014-07-16","2014-07-16","2014-07-17","2014-07-18","2014-07-20","2014-07-20","2014-07-23","2014-07-23","2014-07-24","2014-07-25","2014-07-25","2014-07-26","2014-07-27","2014-07-27","2014-08-01","2014-08-02","2014-08-03","2014-08-03","2014-08-03"],["2014-05-13","2014-05-14","2014-05-20","2014-05-27","2014-05-28","2014-05-28","2014-06-01","2014-05-31","2014-06-02","2014-06-05","2014-06-07","2014-06-07","2014-06-16","2014-06-19","2014-06-21","2014-06-21","2014-06-22","2014-06-23","2014-06-26","2014-06-27","2014-07-01","2014-07-02","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-13","2014-07-12","2014-07-14","2014-07-15","2014-07-14","2014-07-17","2014-07-17","2014-07-19","2014-07-20","2014-07-21","2014-07-20","2014-07-23","2014-07-25","2014-07-24","2014-07-25","2014-07-27","2014-07-26","2014-07-27","2014-07-27","2014-08-02","2014-08-03","2014-08-03","2014-08-05","2014-08-05"],["2014-05-18","2014-05-18","2014-05-23","2014-06-02",null,"2014-06-07",null,"2014-06-17",null,"2014-06-11","2014-06-09","2014-07-01","2014-06-18","2014-06-28","2014-06-24","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-04","2014-07-05","2014-07-14","2014-07-20",null,"2014-08-09","2014-07-14","2014-07-27","2014-07-17","2014-07-16","2014-07-25","2014-07-27",null,"2014-07-18","2014-07-24","2014-08-01","2014-08-01",null,null,"2014-07-27",null,null,"2014-08-08","2014-08-02",null,null,"2014-09-13","2014-08-09",null,"2014-08-16","2014-08-08"],[null,"Recover","Recover","Death","Death","Death","Death","Death","Death","Death","Death",null,"Death","Recover","Death","Death","Death","Death","Death","Death",null,"Recover",null,null,"Recover",null,"Recover",null,null,"Recover","Recover","Recover",null,"Death",null,"Recover","Recover","Recover","Death",null,"Death","Death","Death","Death","Death",null,"Death","Death","Death",null],["f","f","m","m","f","f","m","m","m","f","f","m","f","f","m","f","f","m","m","f","f","m","f",null,"f","m","m","m","f","m","f","m","f","m","m","f","f","f","f","f","f","f","f","m","m","f","m","f","f","f"],[10,9,16,10,3,14,8,15,23,5,2,18,19,16,20,26,24,35,21,3,4,3,15,9,2,41,17,31,6,34,13,0,3,10,31,3,13,3,9,35,17,15,19,26,16,6,1,2,21,17],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[10,9,16,10,3,14,8,15,23,5,2,18,19,16,20,26,24,35,21,3,4,3,15,9,2,41,17,31,6,34,13,0,3,10,31,3,13,3,9,35,17,15,19,26,16,6,1,2,21,17],["10-14","5-9","15-19","10-14","0-4","10-14","5-9","15-19","20-29","5-9","0-4","15-19","15-19","15-19","20-29","20-29","20-29","30-49","20-29","0-4","0-4","0-4","15-19","5-9","0-4","30-49","15-19","30-49","5-9","30-49","10-14","0-4","0-4","10-14","30-49","0-4","10-14","0-4","5-9","30-49","15-19","15-19","15-19","20-29","15-19","5-9","0-4","0-4","20-29","15-19"],["10-14","5-9","15-19","10-14","0-4","10-14","5-9","15-19","20-24","5-9","0-4","15-19","15-19","15-19","20-24","25-29","20-24","35-39","20-24","0-4","0-4","0-4","15-19","5-9","0-4","40-44","15-19","30-34","5-9","30-34","10-14","0-4","0-4","10-14","30-34","0-4","10-14","0-4","5-9","35-39","15-19","15-19","15-19","25-29","15-19","5-9","0-4","0-4","20-24","15-19"],["Central Hospital","Missing","St. Mark's Maternity Hospital (SMMH)","Other","St. Mark's Maternity Hospital (SMMH)","Central Hospital","Missing","Port Hospital","Military Hospital","Port Hospital","Missing","Port Hospital","Port Hospital","Missing","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Port Hospital","Missing","Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Missing","Military Hospital","Missing","Port Hospital","Missing","Port Hospital","Central Hospital","Military Hospital","Missing","Other","Military Hospital","Missing","Other","Other","Military Hospital","Military Hospital","Missing","Military Hospital","Port Hospital","Other","Port Hospital","Other","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Missing","Port Hospital","Missing"],[-13.2403686796131,-13.2152339775486,-13.2523649449559,-13.2095352448865,-13.2115157489446,-13.2369393782451,-13.248633850792,-13.2628435102304,-13.2222002700958,-13.2257125599458,-13.2572163655863,-13.2242058657802,-13.2372027220014,-13.2189533374241,-13.2619688324425,-13.2195578885261,-13.2322364148998,-13.2628934511971,-13.2605169121171,-13.2143944706215,-13.2578297469246,-13.2130045468176,-13.2680671272333,-13.2266742923612,-13.247814368147,-13.2220665646121,-13.2353020203708,-13.2362371704204,-13.2193435760875,-13.2614705796373,-13.2630592726116,-13.2199077448676,-13.2485377675465,-13.2581175859281,-13.218781651651,-13.2340994071744,-13.2359603887432,-13.2510797882678,-13.2306657089937,-13.262635786914,-13.2209026809759,-13.2472895700622,-13.213726099278,-13.250631166599,-13.2330734719715,-13.2137356012883,-13.2252870624815,-13.2197236388613,-13.2236219424476,-13.2648130060118],[8.45437728056147,8.45171855856465,8.4601071493071,8.48100593467107,8.45094401624318,8.46916113869591,8.4778746413144,8.45524160975253,8.46388925014565,8.47096910436632,8.47292327643506,8.48663467687094,8.46956119136946,8.45136291368722,8.48475855218221,8.46210832824745,8.47727846519132,8.46479592922727,8.4562327469279,8.45379171630313,8.48606718941662,8.47135450705077,8.473437335922,8.48408263734462,8.47038713612408,8.46228335711268,8.46849944119707,8.48544694884164,8.45057184856276,8.45750552360835,8.47493999153642,8.4693933891765,8.48581188603544,8.45535258467199,8.48438437371817,8.46860151549407,8.47704542384682,8.47178418137766,8.47808779372907,8.4632880274758,8.46353857052336,8.48450777619227,8.46891362864287,8.47947718621549,8.46178968158864,8.4732571907655,8.47032275702511,8.45186511043286,8.48307336439485,8.47622152017857],["40ae5f",null,"11f8ea",null,null,"e02f66","11f8ea","e11027",null,null,null,"431135",null,null,"057e7a",null,"db11a9","4977bd",null,"07e3e8",null,null,null,"b799eb","71577a","4977bd",null,"b80480",null,null,"567136","36e2e7","bc2adf","71577a","eb2277","9e55ae","916d0a","f36522",null,"312ecf","cfd79c","26c588","916d0a","cfd79c","d145b7","3b096b",null,"bde233","700448",null],["other",null,"other",null,null,"other","other","other",null,null,null,"other",null,null,"other",null,"other","funeral",null,"other",null,null,null,"other","other","other",null,"other",null,null,"other","other","other","other","funeral","funeral","other","other",null,"other","other","other","other","other","other","other",null,"other","other",null],[51,40,55,50,27,58,50,64,60,32,21,66,67,46,68,68,68,73,59,29,34,40,44,48,11,78,52,71,32,67,47,18,36,67,72,25,52,32,45,70,57,47,56,55,56,32,14,17,58,56],[110,97,163,120,58,133,110,147,162,76,40,129,128,153,152,172,154,203,162,56,68,61,118,132,47,165,138,182,90,214,120,33,62,126,160,57,141,46,106,190,137,104,121,170,148,101,51,36,123,131],[22,24,23,24,24,23,21,22,22,22,21,24,22,20,22,22,23,24,23,20,22,22,22,21,23,21,23,23,23,22,22,21,22,22,21,22,21,21,22,20,22,21,20,23,22,21,21,23,23,25],["no",null,null,"no","no","no","no","no","no","no",null,null,"no","no","no",null,"no","no",null,"no",null,"no",null,"no","no","no","no","no",null,null,null,"no","no","no","no","no","no","no",null,null,null,null,"no","no","no","no","no","no","no",null],["yes",null,null,"no","yes","no","no","no","no","no",null,null,"yes","no","no",null,"no","no",null,"no",null,"no",null,"no","no","no","no","yes",null,null,null,"no","yes","yes","no","yes","no","yes",null,null,null,null,"no","no","no","no","no","no","yes",null],["yes",null,null,"yes","yes","yes","no","yes","no","yes",null,null,"yes","yes","yes",null,"yes","yes",null,"yes",null,"yes",null,"yes","yes","yes","yes","yes",null,null,null,"yes","no","yes","no","yes","yes","yes",null,null,null,null,"no","no","no","yes","yes","yes","yes",null],["no",null,null,"no","no","no","no","no","no","no",null,null,"yes","no","no",null,"no","no",null,"no",null,"no",null,"yes","no","no","no","no",null,null,null,"yes","no","no","yes","no","no","no",null,null,null,null,"no","no","no","no","no","no","no",null],["no",null,null,"yes","yes","no","no","yes","no","no",null,null,"no","yes","no",null,"yes","no",null,"no",null,"yes",null,"yes","no","yes","no","yes",null,null,null,"yes","yes","yes","yes","yes","no","no",null,null,null,null,"no","yes","yes","no","yes","no","no",null],[36.8,36.8,37.2,37.1,36.3,37.1,37.3,36.8,36.2,37.6,36.7,37.6,36.2,37.3,36.7,37.3,37.1,37.2,36.3,37.5,37.6,36.6,36.8,37.4,36.9,36.7,37,37,37.2,36.8,36.9,36.9,36.9,37.4,37,37.3,36.2,36.6,37.3,37.6,36.6,37.1,37.3,37.3,37.1,37.6,36.6,36.3,37.2,37.5],["14:05",null,"18:12",null,"12:32","08:11","09:05","10:49","10:09","12:46","14:30","13:43","17:33","17:01","14:26","14:33","10:43","13:23","11:25","13:12","13:42","10:25","05:40",null,"08:09","18:35","09:57","08:37","16:01","11:18",null,"17:46","14:44","19:32","11:42","17:03","14:39","11:45","06:09","15:30","12:59","19:18","13:29","06:48","17:26","15:20","09:28","13:42",null,"09:15"],[42.1487603305785,42.5124880433627,20.7008167413151,34.7222222222222,80.2615933412604,32.7887387642037,41.3223140495868,29.6172890925078,22.8623685413809,55.4016620498615,131.25,39.6610780602127,40.8935546875,19.6505617497544,29.4321329639889,22.9853975121687,28.6726260752235,17.7145769128103,22.4813290656912,92.4744897959184,73.5294117647059,107.497984412792,31.6001149095088,27.5482093663912,49.7962879130828,28.6501377410468,27.3051879857173,21.4346093466973,39.5061728395062,14.6300986985763,32.6388888888889,165.289256198347,93.6524453694069,42.2020660115898,28.125,76.9467528470299,26.1556259745486,151.228733459357,40.0498398006408,19.3905817174515,30.3692258511375,43.4541420118343,38.248753500444,19.0311418685121,25.5661066471877,31.3694735810215,53.8254517493272,131.172839506173,38.336968735541,32.6321309946973],[1,1,1,1,1,1,1,0,0,2,2,0,1,2,1,1,2,1,2,1,2,2,1,0,1,1,2,0,2,1,0,1,1,2,2,1,0,0,2,0,0,2,0,0,0,1,1,0,2,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p><strong>Objective</strong>: We need to achieve a “long”-style dataframe that contains the frequency of transmission events between each age category. This will take several data manuipulation steps to achieve.</p>
<p>To begin, we create a dataframe of the cases and their ages, called <code>case_ages</code>. The first rows are displayed below.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">case_ages</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">case_id</span>, <span class="va">infector</span>, <span class="va">age_cat</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">rename</span><span class="op">(</span><span class="st">"case_age_cat"</span> <span class="op">=</span> <span class="st">"age_cat"</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-e9f3fba7047c5946002e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e9f3fba7047c5946002e">{"x":{"filter":"none","data":[["b8f2fd","8689b7","f96aa5","9e0998","56d39e","275cc7","db4b96","5387a2","8a4580","ab034a","1389ca","9f6884","bab455","c15f36","c36eb4","88eff2","bd14fc","542d07","341efa","920c1b","fdeb61","bc648d","9371a9","bc2adf","170473","abd4af","7fd086","f0461f","006e2f","64c8ef","8ebf6e","6d788e","3c09c4","188619","da8ecb","d6584f","4c1040","386dfb","69446e","3ad520","c76676","ae50c8","1f1620","917506","baacc1","3789ee","6a3ea1","1e061f","422831","72bb4b"],["40ae5f",null,"11f8ea",null,null,"e02f66","11f8ea","e11027",null,null,null,"431135",null,null,"057e7a",null,"db11a9","4977bd",null,"07e3e8",null,null,null,"b799eb","71577a","4977bd",null,"b80480",null,null,"567136","36e2e7","bc2adf","71577a","eb2277","9e55ae","916d0a","f36522",null,"312ecf","cfd79c","26c588","916d0a","cfd79c","d145b7","3b096b",null,"bde233","700448",null],["10-14","5-9","15-19","10-14","0-4","10-14","5-9","15-19","20-29","5-9","0-4","15-19","15-19","15-19","20-29","20-29","20-29","30-49","20-29","0-4","0-4","0-4","15-19","5-9","0-4","30-49","15-19","30-49","5-9","30-49","10-14","0-4","0-4","10-14","30-49","0-4","10-14","0-4","5-9","30-49","15-19","15-19","15-19","20-29","15-19","5-9","0-4","0-4","20-29","15-19"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>infector<\/th>\n      <th>case_age_cat<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>Next, we create a dataframe of the infectors - at the moment it consists of a single column. These are the infector IDs from the linelist. Not every case has a known infector, so we remove missing values. The first rows are displayed below.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">infectors</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">infector</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">infector</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-2ae941904925d6384c46" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2ae941904925d6384c46">{"x":{"filter":"none","data":[["40ae5f","11f8ea","e02f66","11f8ea","e11027","431135","057e7a","db11a9","4977bd","07e3e8","b799eb","71577a","4977bd","b80480","567136","36e2e7","bc2adf","71577a","eb2277","9e55ae","916d0a","f36522","312ecf","cfd79c","26c588","916d0a","cfd79c","d145b7","3b096b","bde233","700448","4e08f2","0e3c82","c2595d","9cd6d0","059cc0","648639","ad3141","535760","f97626","b44247","d8c398","92e129","415e3a","b6c0ed","24f9d8","dcd6ff","68623f","c4c05a","e703d8"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>infector<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>Next, we use joins to procure the ages of the infectors. This is not simple, because in the <code>linelist</code>, infector’s ages are not listed as such. We achieve this result by joining the case linelist to the infectors - joining such that the infector in the left-side “baseline” dataframe links to the <code>case_id</code> in the right-side linelist. Thus, the data from the infector’s case record in the linelist (including age) is added to the infector row. The first rows are displayed below.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">infector_ages</span> <span class="op">&lt;-</span> <span class="va">infectors</span> <span class="op">%&gt;%</span>             <span class="co"># begin with infectors</span>
  <span class="fu">left_join</span><span class="op">(</span>                               <span class="co"># add the linelist data to each infector  </span>
    <span class="va">linelist</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"infector"</span> <span class="op">=</span> <span class="st">"case_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>    <span class="co"># match infector to their information as a case</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">infector</span>, <span class="va">age_cat</span><span class="op">)</span> <span class="op">%&gt;%</span>            <span class="co"># keep only columns of interest</span>
  <span class="fu">rename</span><span class="op">(</span><span class="st">"infector_age_cat"</span> <span class="op">=</span> <span class="st">"age_cat"</span><span class="op">)</span>   <span class="co"># rename for clarify</span></code></pre></div>
<div id="htmlwidget-7910a455bda6fd5e6e23" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7910a455bda6fd5e6e23">{"x":{"filter":"none","data":[["40ae5f","11f8ea","e02f66","11f8ea","e11027","431135","057e7a","db11a9","4977bd","07e3e8","b799eb","71577a","4977bd","b80480","567136","36e2e7","bc2adf","71577a","eb2277","9e55ae","916d0a","f36522","312ecf","cfd79c","26c588","916d0a","cfd79c","d145b7","3b096b","bde233","700448","4e08f2","0e3c82","c2595d","9cd6d0","059cc0","648639","ad3141","535760","f97626","b44247","d8c398","92e129","415e3a","b6c0ed","24f9d8","dcd6ff","68623f","c4c05a","e703d8"],["0-4","30-49","5-9","30-49",null,null,"10-14",null,null,"15-19","10-14","30-49",null,null,"30-49",null,"5-9","30-49",null,null,"0-4",null,null,"20-29","20-29","0-4","20-29","5-9",null,null,"15-19",null,null,"20-29","5-9","0-4",null,"5-9",null,"5-9","0-4","30-49","5-9","5-9","0-4","20-29",null,"30-49","0-4",null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>infector<\/th>\n      <th>infector_age_cat<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>Then, we combine the cases and their ages with the infectors and their ages. Each of these dataframe has the column <code>infector</code>, so it is used for the join. The first rows are displayed below:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ages_complete</span> <span class="op">&lt;-</span> <span class="va">case_ages</span> <span class="op">%&gt;%</span>  
  <span class="fu">left_join</span><span class="op">(</span>
    <span class="va">infector_ages</span>,
    by <span class="op">=</span> <span class="st">"infector"</span><span class="op">)</span> <span class="op">%&gt;%</span>        <span class="co"># each has the column infector</span>
  <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span>                     <span class="co"># drop rows with any missing data</span></code></pre></div>
<div id="htmlwidget-782fe3a7fc435daa28a5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-782fe3a7fc435daa28a5">{"x":{"filter":"none","data":[["b8f2fd","f96aa5","f96aa5","f96aa5","f96aa5","f96aa5","275cc7","db4b96","db4b96","db4b96","db4b96","db4b96","c36eb4","c36eb4","920c1b","920c1b","bc2adf","bc2adf","170473","170473","170473","170473","8ebf6e","3c09c4","188619","188619","188619","188619","4c1040","4c1040","4c1040","4c1040","4c1040","4c1040","c76676","c76676","c76676","ae50c8","1f1620","1f1620","1f1620","1f1620","1f1620","1f1620","917506","917506","917506","baacc1","422831","9f0c37"],["40ae5f","11f8ea","11f8ea","11f8ea","11f8ea","11f8ea","e02f66","11f8ea","11f8ea","11f8ea","11f8ea","11f8ea","057e7a","057e7a","07e3e8","07e3e8","b799eb","b799eb","71577a","71577a","71577a","71577a","567136","bc2adf","71577a","71577a","71577a","71577a","916d0a","916d0a","916d0a","916d0a","916d0a","916d0a","cfd79c","cfd79c","cfd79c","26c588","916d0a","916d0a","916d0a","916d0a","916d0a","916d0a","cfd79c","cfd79c","cfd79c","d145b7","700448","c2595d"],["10-14","15-19","15-19","15-19","15-19","15-19","10-14","5-9","5-9","5-9","5-9","5-9","20-29","20-29","0-4","0-4","5-9","5-9","0-4","0-4","0-4","0-4","10-14","0-4","10-14","10-14","10-14","10-14","10-14","10-14","10-14","10-14","10-14","10-14","15-19","15-19","15-19","15-19","15-19","15-19","15-19","15-19","15-19","15-19","20-29","20-29","20-29","15-19","20-29","0-4"],["0-4","30-49","30-49","30-49","30-49","30-49","5-9","30-49","30-49","30-49","30-49","30-49","10-14","10-14","15-19","15-19","10-14","10-14","30-49","30-49","30-49","30-49","30-49","5-9","30-49","30-49","30-49","30-49","0-4","0-4","0-4","0-4","0-4","0-4","20-29","20-29","20-29","20-29","0-4","0-4","0-4","0-4","0-4","0-4","20-29","20-29","20-29","5-9","15-19","20-29"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>infector<\/th>\n      <th>case_age_cat<\/th>\n      <th>infector_age_cat<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>Below, a simple cross-tabulation of counts between the case and infector age groups. Labels added for clarity.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>cases <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">case_age_cat</span>,
      infectors <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">infector_age_cat</span><span class="op">)</span></code></pre></div>
<pre><code>##        infectors
## cases   0-4 5-9 10-14 15-19 20-29 30-49 50-69 70+
##   0-4   127 134   111    84   120    78     5   0
##   5-9   148 106   135    81   125    79     6   0
##   10-14 101 123   106   110   103    64    11   1
##   15-19 125  87    77    62   102    59     3   0
##   20-29 165 139    97    65   150   106     9   0
##   30-49  77  98    76    64    77    48     8   0
##   50-69  11  11    13     5     9     5     0   0
##   70+     0   4     0     1     0     0     1   0</code></pre>
<p>We can convert this table to a dataframe with <code><a href="https://rdrr.io/r/base/data.frame.html">data.frame()</a></code> from <strong>base</strong> R, which also automatically converts it to “long” format, which is desired for the <code>ggplot()</code>. The first rows are shown below.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">long_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>
    cases     <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">case_age_cat</span>,
    infectors <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">infector_age_cat</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-a121271fcaa24054f514" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a121271fcaa24054f514">{"x":{"filter":"none","data":[["0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9"],["0-4","0-4","0-4","0-4","0-4","0-4","0-4","0-4","5-9","5-9","5-9","5-9","5-9","5-9","5-9","5-9","10-14","10-14","10-14","10-14","10-14","10-14","10-14","10-14","15-19","15-19","15-19","15-19","15-19","15-19","15-19","15-19","20-29","20-29","20-29","20-29","20-29","20-29","20-29","20-29","30-49","30-49","30-49","30-49","30-49","30-49","30-49","30-49","50-69","50-69"],[127,148,101,125,165,77,11,0,134,106,123,87,139,98,11,4,111,135,106,77,97,76,13,0,84,81,110,62,65,64,5,1,120,125,103,102,150,77,9,0,78,79,64,59,106,48,5,0,5,6]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>cases<\/th>\n      <th>infectors<\/th>\n      <th>Freq<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>The same but we apply <code><a href="https://rdrr.io/r/base/proportions.html">prop.table()</a></code> from <strong>base</strong> R to the table so instead of counts we get proportion of all values. The first rows are shown below.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">long_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>
    cases <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">case_age_cat</span>,
    infectors <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">infector_age_cat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-31f7235fa254ffcfa430" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-31f7235fa254ffcfa430">{"x":{"filter":"none","data":[["0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9"],["0-4","0-4","0-4","0-4","0-4","0-4","0-4","0-4","5-9","5-9","5-9","5-9","5-9","5-9","5-9","5-9","10-14","10-14","10-14","10-14","10-14","10-14","10-14","10-14","15-19","15-19","15-19","15-19","15-19","15-19","15-19","15-19","20-29","20-29","20-29","20-29","20-29","20-29","20-29","20-29","30-49","30-49","30-49","30-49","30-49","30-49","30-49","30-49","50-69","50-69"],[0.0342133620689655,0.0398706896551724,0.0272090517241379,0.0336745689655172,0.0444504310344828,0.0207435344827586,0.00296336206896552,0,0.0360991379310345,0.0285560344827586,0.033135775862069,0.0234375,0.0374461206896552,0.0264008620689655,0.00296336206896552,0.00107758620689655,0.0299030172413793,0.0363685344827586,0.0285560344827586,0.0207435344827586,0.0261314655172414,0.0204741379310345,0.00350215517241379,0,0.0226293103448276,0.0218211206896552,0.0296336206896552,0.0167025862068966,0.017510775862069,0.0172413793103448,0.00134698275862069,0.000269396551724138,0.0323275862068966,0.0336745689655172,0.0277478448275862,0.0274784482758621,0.0404094827586207,0.0207435344827586,0.00242456896551724,0,0.0210129310344828,0.0212823275862069,0.0172413793103448,0.0158943965517241,0.0285560344827586,0.0129310344827586,0.00134698275862069,0,0.00134698275862069,0.00161637931034483]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>cases<\/th>\n      <th>infectors<\/th>\n      <th>Freq<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>Now finally we can create the heatmap with <strong>ggplot2</strong> package, using the <code>geom_tile()</code> function.</p>
<ul>
<li>In the aesthetics <code>aes()</code> of <code>geom_tile()</code> sex the x and y as the case age and infector age<br>
</li>
<li>Also in <code>aes()</code> set the argument <code>fill =</code> to the Freq column - this is the value that will be converted to a tile color<br>
</li>
<li>Set a scale color with <code>scale_fill_gradient()</code> - you can specify the high/low colors
<ul>
<li>Note that <code>scale_color_gradient()</code> is different! In this case you want the fill<br>
</li>
</ul>
</li>
<li>Because the color is made via “fill”, you can use the <code>fill =</code> argument in <code>labs()</code> to change the legend title</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">long_prop</span><span class="op">)</span><span class="op">+</span>       <span class="co"># use long data, with proportions as Freq</span>
  <span class="fu">geom_tile</span><span class="op">(</span>                    <span class="co"># visualize it in tiles</span>
    <span class="fu">aes</span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">cases</span>,         <span class="co"># x-axis is case age</span>
      y <span class="op">=</span> <span class="va">infectors</span>,     <span class="co"># y-axis is infector age</span>
      fill <span class="op">=</span> <span class="va">Freq</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>            <span class="co"># color of the tile is the Freq column in the data</span>
  <span class="fu">scale_fill_gradient</span><span class="op">(</span>          <span class="co"># adjust the fill color of the tiles</span>
    low <span class="op">=</span> <span class="st">"blue"</span>,
    high <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>                         <span class="co"># labels</span>
    x <span class="op">=</span> <span class="st">"Case age"</span>,
    y <span class="op">=</span> <span class="st">"Infector age"</span>,
    title <span class="op">=</span> <span class="st">"Who infected whom"</span>,
    subtitle <span class="op">=</span> <span class="st">"Contact matrix of transmission events"</span>,
    fill <span class="op">=</span> <span class="st">"Proportion of all\ntranmsission events"</span>     <span class="co"># legend title</span>
  <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-22-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="reporting-metrics-over-time" class="section level2" number="1.3">
<h2>
<span class="header-section-number">1.3</span> Reporting metrics over time<a class="anchor" aria-label="anchor" href="#reporting-metrics-over-time"><i class="fas fa-link"></i></a>
</h2>
<p>Often in public health, an objective is to assess trends over time for many entities (facilities, jurisdictions, etc.). One way to visualize trends over time from many entities is a heatmap where the x-axis is time and the y-axis are the many entities.</p>
<div id="preparation-1" class="section level3 unnumbered">
<h3>Preparation<a class="anchor" aria-label="anchor" href="#preparation-1"><i class="fas fa-link"></i></a>
</h3>
<p>Below are the first 30 rows of these data:</p>
<p>And we also load this separate dataset of daily malaria case counts by facility:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">facility_count_data</span> <span class="op">&lt;-</span> <span class="fu">import</span><span class="op">(</span><span class="st">"facility_count_data.rds"</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-e77fc6264af739e58cb9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-e77fc6264af739e58cb9">{"x":{"filter":"none","data":[["Facility 1","Facility 2","Facility 3","Facility 4","Facility 5","Facility 6","Facility 6","Facility 5","Facility 5","Facility 5","Facility 7","Facility 8","Facility 9","Facility 10","Facility 11","Facility 12","Facility 13","Facility 14","Facility 15","Facility 16","Facility 17","Facility 18","Facility 19","Facility 19","Facility 20","Facility 21","Facility 19","Facility 22","Facility 23","Facility 23"],["2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-12","2019-06-12","2019-06-11","2019-06-10","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-13","2019-06-12","2019-06-13","2019-06-13","2019-06-11","2019-06-13","2019-06-13","2019-06-14"],["2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14","2019-06-14"],["North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North"],["Spring","Bolo","Dingo","Bolo","Bolo","Dingo","Dingo","Bolo","Bolo","Bolo","Spring","Bolo","Spring","Bolo","Spring","Dingo","Bolo","Dingo","Barnard","Barnard","Barnard","Bolo","Bolo","Bolo","Barnard","Bolo","Bolo","Bolo","Dingo","Dingo"],[11,11,8,16,9,3,4,15,11,19,12,7,27,0,17,36,0,5,6,9,4,7,12,4,14,28,5,11,8,8],[12,10,5,16,2,1,0,14,11,15,7,1,8,10,15,36,0,1,3,9,4,0,2,7,9,18,3,4,7,7],[23,5,5,17,6,4,3,13,13,15,13,20,18,24,28,62,0,10,2,16,1,6,18,41,14,5,24,13,16,16],[46,26,18,49,17,8,7,42,35,49,32,28,53,34,60,134,0,16,11,34,9,13,32,52,37,51,32,28,31,31],[1,2,3,4,5,6,6,5,5,5,7,8,9,10,11,12,13,14,15,16,17,18,19,19,20,21,19,22,23,23]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>data_date<\/th>\n      <th>submitted_date<\/th>\n      <th>Province<\/th>\n      <th>District<\/th>\n      <th>malaria_rdt_0-4<\/th>\n      <th>malaria_rdt_5-14<\/th>\n      <th>malaria_rdt_15<\/th>\n      <th>malaria_tot<\/th>\n      <th>newid<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[5,6,7,8,9]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><div id="aggregate-and-summarize" class="section level4 unnumbered">
<h4>Aggregate and summarize<a class="anchor" aria-label="anchor" href="#aggregate-and-summarize"><i class="fas fa-link"></i></a>
</h4>
<p><strong>The objective in this example</strong> is to transform the daily facility total malaria case counts (seen in previous tab) into <em>weekly</em> summary statistics of facility reporting performance - in this case <em>the proportion of days per week that the facility reported any data</em>. For this example we will show data only for <strong>Spring District</strong> from April-May 2019.</p>
<p>To achieve this we will do the following data management steps:</p>
<ol style="list-style-type: decimal">
<li>Filter the data as appropriate (by place, date)<br>
</li>
<li>Create a week column using <code>floor_date()</code> from package <strong>lubridate</strong>
<ul>
<li>This function returns the start-date of a given date’s week, using a specified start date of each week (e.g. “Mondays”)<br>
</li>
<li>The <code>floor_day =</code> argument means that dates are rounded into the week only (day of the week is not shown)<br>
</li>
<li>The <code>factor =</code> argument converts the new column to a factor - important because all possible weeks within the date range are designated as levels, even if there is no data for them currently.<br>
</li>
</ul>
</li>
<li>The data are grouped by columns “location” and “week” to create analysis units of “facility-week”<br>
</li>
<li>The verb <code>summarize()</code> creates new columns to calculate reporting performance for each “facility-week”:
<ul>
<li>Number of days per week (7 - a static value)<br>
</li>
<li>Number of reports received from the facility-week (could be more than 7!)<br>
</li>
<li>Sum of malaria cases reported by the facility-week (just for interest)<br>
</li>
<li>Number of <em>unique</em> days in the facility-week for which there is data reported<br>
</li>
<li>
<strong>Percent of the 7 days per facility-week for which data was reported</strong><br>
</li>
</ul>
</li>
<li>The dataframe is joined (<code>right_join()</code>) to a comprehensive list of all possible facility-week combinations, to make the dataset complete. The matrix of all possible combinations is created by applying <code>expand()</code> to those two columns of the dataframe as it is at that moment in the pipe chain (represented by “.”). Because a <code>right_join()</code> is used, all rows in the <code>expand()</code> dataframe are kept, and added to agg_weeks if necessary. These new rows appear with <code>NA</code> (missing) summarized values.</li>
</ol>
<p>Below we demonstrate step-by-step:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create weekly summary dataset</span>
<span class="va">agg_weeks</span> <span class="op">&lt;-</span> <span class="va">facility_count_data</span> <span class="op">%&gt;%</span> 
  
  <span class="co"># filter the data as appropriate</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span>
    <span class="va">District</span> <span class="op">==</span> <span class="st">"Spring"</span>,
    <span class="va">data_date</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2019-06-01"</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<p>Now the dataset has 584 rows, when it previously had 3038</p>
<p>Next we create a <code>week</code> column reflecting the start date of the week for each record. This is achieved with the <strong>lubridate</strong> package and the function <code>floor_date()</code>, which is set to “week” and for the weeks to begin on Mondays (day 1 of the week - Sundays would be 7). The top rows are shown below.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">agg_weeks</span> <span class="op">&lt;-</span> <span class="va">agg_weeks</span> <span class="op">%&gt;%</span> 
  <span class="co"># Create week column from data_date</span>
  <span class="fu">mutate</span><span class="op">(</span>
    week <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span>                     <span class="co"># create new column of weeks</span>
      <span class="va">data_date</span>,                                      <span class="co"># date column</span>
      unit <span class="op">=</span> <span class="st">"week"</span>,                                  <span class="co"># give start of the week</span>
      week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>                                <span class="co"># weeks to start on Mondays </span></code></pre></div>
<p>The new week column can be seen on the far right of the dataframe</p>
<div id="htmlwidget-7af10df3e4bd4b5f7f59" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7af10df3e4bd4b5f7f59">{"x":{"filter":"none","data":[["Facility 9","Facility 9","Facility 9","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 51","Facility 51","Facility 56","Facility 7","Facility 35","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 35","Facility 35"],["2019-05-31","2019-05-30","2019-05-29","2019-05-31","2019-05-30","2019-05-29","2019-05-28","2019-05-27","2019-05-26","2019-05-25","2019-05-24","2019-05-23","2019-05-31","2019-05-30","2019-04-27","2019-05-31","2019-05-31","2019-05-31","2019-05-30","2019-05-29","2019-05-28","2019-05-27","2019-05-26","2019-05-25","2019-05-24","2019-05-23","2019-05-22","2019-05-21","2019-05-30","2019-05-29"],["2019-06-12","2019-06-12","2019-06-12","2019-06-12","2019-06-12","2019-06-12","2019-06-12","2019-06-12","2019-06-12","2019-06-12","2019-06-12","2019-06-12","2019-06-06","2019-06-06","2019-06-05","2019-06-05","2019-06-04","2019-06-02","2019-06-02","2019-06-02","2019-06-02","2019-06-02","2019-06-02","2019-06-02","2019-06-02","2019-06-02","2019-06-02","2019-06-02","2019-05-31","2019-05-31"],["North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North","North"],["Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring"],[30,36,31,12,18,15,8,17,21,7,9,10,16,16,75,11,115,8,14,17,15,24,6,4,13,26,12,26,64,79],[21,16,23,7,11,11,8,13,12,15,10,25,6,7,35,5,17,10,4,9,20,10,2,2,14,4,12,16,14,41],[23,23,37,25,15,17,12,11,28,18,14,31,10,9,90,5,47,17,13,19,17,21,0,10,16,14,19,30,132,122],[74,75,91,44,44,43,28,41,61,40,33,66,32,32,200,21,179,35,31,45,52,55,8,16,43,44,43,72,210,242],[9,9,9,39,39,39,39,39,39,39,39,39,51,51,56,7,35,28,28,28,28,28,28,28,28,28,28,28,35,35],["2019-05-27","2019-05-27","2019-05-27","2019-05-27","2019-05-27","2019-05-27","2019-05-27","2019-05-27","2019-05-20","2019-05-20","2019-05-20","2019-05-20","2019-05-27","2019-05-27","2019-04-22","2019-05-27","2019-05-27","2019-05-27","2019-05-27","2019-05-27","2019-05-27","2019-05-27","2019-05-20","2019-05-20","2019-05-20","2019-05-20","2019-05-20","2019-05-20","2019-05-27","2019-05-27"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>data_date<\/th>\n      <th>submitted_date<\/th>\n      <th>Province<\/th>\n      <th>District<\/th>\n      <th>malaria_rdt_0-4<\/th>\n      <th>malaria_rdt_5-14<\/th>\n      <th>malaria_rdt_15<\/th>\n      <th>malaria_tot<\/th>\n      <th>newid<\/th>\n      <th>week<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[5,6,7,8,9]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>Now we group the data into facility-weeks and summarise them to produce statistics per facility-week. See the page on [Grouping data] for tips. The grouping itself doesn’t change the dataframe, but it impacts how the subsequent summary statistics are calculated.</p>
<p>The top rows are shown below. Note how the columns have completely changed to reflect the desired summary statistics. Each row reflects one facility-week.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">agg_weeks</span> <span class="op">&lt;-</span> <span class="va">agg_weeks</span> <span class="op">%&gt;%</span>   

  <span class="co"># Group into facility-weeks</span>
  <span class="fu">group_by</span><span class="op">(</span>
    <span class="va">location_name</span>, <span class="va">week</span>,
    .drop <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">%&gt;%</span>
  
  <span class="co"># Create summary statistics columns on the grouped data</span>
  <span class="fu">summarize</span><span class="op">(</span>
    n_days          <span class="op">=</span> <span class="fl">7</span>,                                          <span class="co"># 7 days per week           </span>
    n_reports       <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,                                 <span class="co"># number of reports received per week (could be &gt;7)</span>
    malaria_tot     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">malaria_tot</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,                <span class="co"># total malaria cases reported</span>
    n_days_reported <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_date</span><span class="op">)</span><span class="op">)</span>,                  <span class="co"># number of unique days reporting per week</span>
    p_days_reported <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="op">(</span><span class="va">n_days_reported</span> <span class="op">/</span> <span class="va">n_days</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>      <span class="co"># percent of days reporting</span></code></pre></div>
<div id="htmlwidget-6813380a10b94fa05787" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6813380a10b94fa05787">{"x":{"filter":"none","data":[["Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 11","Facility 11","Facility 11","Facility 11","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28"],["2019-04-15","2019-04-22","2019-04-29","2019-05-06","2019-05-13","2019-05-20","2019-05-27","2019-05-06","2019-05-13","2019-05-20","2019-05-27","2019-04-08","2019-04-15","2019-04-22","2019-04-29","2019-05-06","2019-05-13","2019-05-20","2019-05-27","2019-03-18","2019-03-25","2019-04-01","2019-04-08","2019-04-15","2019-04-22","2019-04-29","2019-05-06","2019-05-13","2019-05-20","2019-05-27"],[7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],[7,7,7,7,7,7,4,8,7,1,4,4,3,5,7,5,7,6,5,7,7,7,7,7,9,7,7,7,7,5],[0,0,85,211,573,420,293,882,667,160,541,0,0,17,31,156,168,82,138,145,219,150,182,223,427,447,191,371,312,218],[7,7,7,7,7,7,4,7,7,1,4,4,3,5,5,5,7,6,5,7,7,7,7,7,7,7,7,7,7,5],[100,100,100,100,100,100,57,100,100,14,57,57,43,71,71,71,100,86,71,100,100,100,100,100,100,100,100,100,100,71]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>week<\/th>\n      <th>n_days<\/th>\n      <th>n_reports<\/th>\n      <th>malaria_tot<\/th>\n      <th>n_days_reported<\/th>\n      <th>p_days_reported<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>Finally, we run the command below to ensure that ALL possible facility-weeks are present in the data, even if they were missing before.</p>
<p>We are using a <code>right_join()</code> on itself (the dataset is represented by “.”) but having been expanded to include all possible combinations of the columns <code>week</code> and <code>location_name</code>. See documentation on the <code>expand()</code> function in the page on [Pivoting]. Before running this code the dataset contains 97 rows.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">agg_weeks</span> <span class="op">&lt;-</span> <span class="va">agg_weeks</span> <span class="op">%&gt;%</span>                             <span class="co"># Ensure every possible facility-week combination appears in the data</span>
  <span class="fu">right_join</span><span class="op">(</span><span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html">expand</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">week</span>, <span class="va">location_name</span><span class="op">)</span><span class="op">)</span>    <span class="co"># "." represents the dataset at that moment in the pipe chain</span></code></pre></div>
<!-- ======================================================= -->
</div>
</div>
<div id="create-heatmap" class="section level3 unnumbered">
<h3>Create heatmap<a class="anchor" aria-label="anchor" href="#create-heatmap"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>ggplot()</code> is make using <code>geom_tile()</code>:</p>
<ul>
<li>Weeks on the x-axis is transformed to dates, allowing use of <code>scale_x_date()</code><br>
</li>
<li>location_name on the y-axis will show all facility names<br>
</li>
<li>The <code>fill</code> is the performance for that facility-week (numeric)<br>
</li>
<li>
<code>scale_fill_gradient()</code> is used on the numeric fill, specifying colors for high, low, and <code>NA</code><br>
</li>
<li>
<code>scale_x_date()</code> is used on the x-axis specifying labels every 2 weeks and their format<br>
</li>
<li>Aesthetic themes and labels can be adjusted as necessary</li>
</ul>
<!-- ======================================================= --><div id="basic" class="section level4 unnumbered">
<h4>Basic<a class="anchor" aria-label="anchor" href="#basic"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">agg_weeks</span>,
       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">aweek</span><span class="fu">::</span><span class="fu"><a href="https://www.repidemicsconsortium.org/aweek/reference/date2week.html">week2date</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>,            <span class="co"># transformed to date class</span>
           y <span class="op">=</span> <span class="va">location_name</span>,
           fill <span class="op">=</span> <span class="va">p_days_reported</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="co"># tiles</span>
  <span class="fu">geom_tile</span><span class="op">(</span>colour<span class="op">=</span><span class="st">"white"</span><span class="op">)</span><span class="op">+</span>                      <span class="co"># white gridlines</span>
  
  <span class="fu">scale_fill_gradient</span><span class="op">(</span>low <span class="op">=</span> <span class="st">"orange"</span>, high <span class="op">=</span> <span class="st">"darkgreen"</span>, na.value <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,
               date_breaks <span class="op">=</span> <span class="st">"2 weeks"</span>,
               date_labels <span class="op">=</span> <span class="st">"%d\n%b"</span><span class="op">)</span><span class="op">+</span>
  
  <span class="co"># aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                  <span class="co"># simplify background</span>
  <span class="fu">theme</span><span class="op">(</span>
    legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    legend.text  <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    legend.key.height <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>,<span class="st">"cm"</span><span class="op">)</span>,         <span class="co"># height of legend key</span>
    legend.key.width  <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.6</span>,<span class="st">"cm"</span><span class="op">)</span>,       <span class="co"># width of legend key</span>
    
    axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>,
    axis.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>vjust<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span>,
    axis.ticks <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span>,
    axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    
    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0</span>,size<span class="op">=</span><span class="fl">14</span>,face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>
    <span class="op">)</span><span class="op">+</span>
  
  <span class="co"># plot labels</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Week"</span>,
       y <span class="op">=</span> <span class="st">"Facility name"</span>,
       fill <span class="op">=</span> <span class="st">"Reporting\nperformance (%)"</span>, <span class="co"># legend title</span>
       title <span class="op">=</span> <span class="st">"Percent of days per week that facility reported data"</span>,
       subtitle <span class="op">=</span> <span class="st">"District health facilities, April-May 2019"</span>,
       caption <span class="op">=</span> <span class="st">"7-day weeks beginning on Mondays."</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-32-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="ordered-y-axis" class="section level4 unnumbered">
<h4>Ordered y-axis<a class="anchor" aria-label="anchor" href="#ordered-y-axis"><i class="fas fa-link"></i></a>
</h4>
<p>If you want to order the y-axis facilities by something, convert them to class Factor and provide the order. Below, the order is set based on the total number of reporting days filed by the facility across the whole timespan:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">facility_order</span> <span class="op">&lt;-</span> <span class="va">agg_weeks</span> <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">location_name</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span>tot_reports <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n_days_reported</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span><span class="va">tot_reports</span><span class="op">)</span> <span class="co"># ascending order</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">as.tibble</span><span class="op">(</span><span class="va">facility_order</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 15 x 2
##    location_name tot_reports
##    &lt;chr&gt;               &lt;int&gt;
##  1 Facility 56             1
##  2 Facility 65             6
##  3 Facility 11            19
##  4 Facility 39            31
##  5 Facility 59            33
##  6 Facility 27            40
##  7 Facility 32            41
##  8 Facility 51            41
##  9 Facility 7             42
## 10 Facility 1             46
## 11 Facility 9             48
## 12 Facility 35            50
## 13 Facility 50            51
## 14 Facility 58            53
## 15 Facility 28            75</code></pre>
<p>Now use the above vector (<code>facility_order$location_name</code>) to be the order of the factor levels of location_name in the dataset <code>agg_weeks</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">agg_weeks</span> <span class="op">&lt;-</span> <span class="va">agg_weeks</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>location_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">location_name</span>, levels <span class="op">=</span> <span class="va">facility_order</span><span class="op">$</span><span class="va">location_name</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>And now the data are re-plotted, with location_name being an ordered factor:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">agg_weeks</span>,
       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">aweek</span><span class="fu">::</span><span class="fu"><a href="https://www.repidemicsconsortium.org/aweek/reference/date2week.html">week2date</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>,            <span class="co"># transformed to date class</span>
           y <span class="op">=</span> <span class="va">location_name</span>,
           fill <span class="op">=</span> <span class="va">p_days_reported</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="co"># tiles</span>
  <span class="fu">geom_tile</span><span class="op">(</span>colour<span class="op">=</span><span class="st">"white"</span><span class="op">)</span><span class="op">+</span>                      <span class="co"># white gridlines</span>

  <span class="fu">scale_fill_gradient</span><span class="op">(</span>low <span class="op">=</span> <span class="st">"orange"</span>, high <span class="op">=</span> <span class="st">"darkgreen"</span>, na.value <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,
               date_breaks <span class="op">=</span> <span class="st">"2 weeks"</span>,
               date_labels <span class="op">=</span> <span class="st">"%d\n%b"</span><span class="op">)</span><span class="op">+</span>
  
  <span class="co"># aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                  <span class="co"># simplify background</span>
  <span class="fu">theme</span><span class="op">(</span>
    legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    legend.text  <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    legend.key.height <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>,<span class="st">"cm"</span><span class="op">)</span>,         <span class="co"># height of legend key</span>
    legend.key.width  <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.6</span>,<span class="st">"cm"</span><span class="op">)</span>,       <span class="co"># width of legend key</span>
    
    axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>,
    axis.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>vjust<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span>,
    axis.ticks <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span>,
    axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    
    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0</span>,size<span class="op">=</span><span class="fl">14</span>,face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>
    <span class="op">)</span><span class="op">+</span>
  
  <span class="co"># plot labels</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Week"</span>,
       y <span class="op">=</span> <span class="st">"Facility name"</span>,
       fill <span class="op">=</span> <span class="st">"Reporting\nperformance (%)"</span>, <span class="co"># legend title</span>
       title <span class="op">=</span> <span class="st">"Percent of days per week that facility reported data"</span>,
       subtitle <span class="op">=</span> <span class="st">"District health facilities, April-May 2019"</span>,
       caption <span class="op">=</span> <span class="st">"7-day weeks beginning on Mondays."</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-36-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="display-values" class="section level4 unnumbered">
<h4>Display values<a class="anchor" aria-label="anchor" href="#display-values"><i class="fas fa-link"></i></a>
</h4>
<p>You can add a <code>geom_text()</code> layer on top of the tiles, to display the actual numbers of each tile. Be aware this may not look pretty if you have many small tiles!</p>
<ul>
<li>Note the fillowing code added <code>geom_text(aes(label=p_days_reported))+</code>. In the aesthetic <code>aes()</code> of the <code>geom_tile()</code> the argument <code>label</code> (what to show) is set to the same numeric column used to create the color gradient.</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">agg_weeks</span>,
       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu">aweek</span><span class="fu">::</span><span class="fu"><a href="https://www.repidemicsconsortium.org/aweek/reference/date2week.html">week2date</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>,            <span class="co"># transformed to date class</span>
           y <span class="op">=</span> <span class="va">location_name</span>,
           fill <span class="op">=</span> <span class="va">p_days_reported</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="co"># tiles</span>
  <span class="fu">geom_tile</span><span class="op">(</span>colour<span class="op">=</span><span class="st">"white"</span><span class="op">)</span><span class="op">+</span>                      <span class="co"># white gridlines</span>
  
  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">p_days_reported</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>          <span class="co"># add text on top of tile</span>
  
  <span class="fu">scale_fill_gradient</span><span class="op">(</span>low <span class="op">=</span> <span class="st">"orange"</span>, high <span class="op">=</span> <span class="st">"darkgreen"</span>, na.value <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_x_date</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,
               date_breaks <span class="op">=</span> <span class="st">"2 weeks"</span>,
               date_labels <span class="op">=</span> <span class="st">"%d\n%b"</span><span class="op">)</span><span class="op">+</span>
  
  <span class="co"># aesthetic themes</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                  <span class="co"># simplify background</span>
  <span class="fu">theme</span><span class="op">(</span>
    legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    legend.text  <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    legend.key.height <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>,<span class="st">"cm"</span><span class="op">)</span>,         <span class="co"># height of legend key</span>
    legend.key.width  <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.6</span>,<span class="st">"cm"</span><span class="op">)</span>,       <span class="co"># width of legend key</span>
    
    axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>,
    axis.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>vjust<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span>,
    axis.ticks <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span>,
    axis.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    
    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0</span>,size<span class="op">=</span><span class="fl">14</span>,face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,
    plot.caption <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>
    <span class="op">)</span><span class="op">+</span>
  
  <span class="co"># plot labels</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Week"</span>,
       y <span class="op">=</span> <span class="st">"Facility name"</span>,
       fill <span class="op">=</span> <span class="st">"Reporting\nperformance (%)"</span>, <span class="co"># legend title</span>
       title <span class="op">=</span> <span class="st">"Percent of days per week that facility reported data"</span>,
       subtitle <span class="op">=</span> <span class="st">"District health facilities, April-May 2019"</span>,
       caption <span class="op">=</span> <span class="st">"7-day weeks beginning on Mondays."</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-37-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="resources" class="section level2" number="1.4">
<h2>
<span class="header-section-number">1.4</span> Resources<a class="anchor" aria-label="anchor" href="#resources"><i class="fas fa-link"></i></a>
</h2>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="index.html">Welcome - THIS IS A DRAFT</a></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#heatmaps"><span class="header-section-number">1</span> Heatmaps</a></li>
<li><a class="nav-link" href="#preparation"><span class="header-section-number">1.1</span> Preparation</a></li>
<li><a class="nav-link" href="#contact-matrix"><span class="header-section-number">1.2</span> Contact matrix</a></li>
<li>
<a class="nav-link" href="#reporting-metrics-over-time"><span class="header-section-number">1.3</span> Reporting metrics over time</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#preparation-1">Preparation</a></li>
<li><a class="nav-link" href="#create-heatmap">Create heatmap</a></li>
</ul>
</li>
<li><a class="nav-link" href="#resources"><span class="header-section-number">1.4</span> Resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R Handbook for Epidemiologists</strong>" was written by the handbook team. It was last built on 2021-02-27.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
