---
knit: "bookdown::render_book"
title: "The Epidemiologist R Handbook"
author: "the handbook team"
description: "This is a R reference manual for applied epidemiologists and public health practitioners."  
date: "`r Sys.Date()`"
#url: 'https://github.com/nsbatra/Epi_R_handbook'
github-repo: nsbatra/Epi_R_handbook
#twitter-handle: 
#cover-image: images/R_Handbook_Logo.png
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
---


#  {-}

```{r, out.width = "100%", fig.align = "center", echo=F}
knitr::include_graphics(here::here("images", "R Handbook Logo.png"))
```

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<span style="color: red;">**THIS IS A DRAFT**.</span>

<span style="color: orange;">**IF YOU ARE REVIEWING THIS BOOK, PLEASE PROVIDE FEEDBACK FOR EACH PAGE AT THIS [LINK](https://forms.gle/4RNdRRLGx67xW9yq9)**</span>


<!-- ======================================================= -->
## About this handbook {-}

<span style="color: brown;">**This is an open-access R reference manual for applied epidemiologists and public health practitioners.**</span>

**This book strives to:**  

* Serve as a quick R code reference manual  
* Provide task-centered examples for addressing common epidemiological problems  
* Assist epidemiologists transitioning to R from SAS, STATA, SPSS, and Excel  
* Be accessible in settings with low internet-connectivity via an **offline version** ([instructions here][Download book and data])  

**How is this different than other R books?**  

* It is written by epidemiologists, for epidemiologists - leveraging experience in local, national, academic, and emergency settings  
* It provides examples of epidemic curves, transmission chains, epidemic modeling and projections, age and sex pyramids and standardization, record matching, outbreak detection, survey analysis, causal diagrams, survival analysis, GIS basics, phylogenetic trees, automated reports, etc...  



<!-- ======================================================= -->
## How to read this handbook {-} 

**Online version**  

* Search via the search box above the Table of Contents 
* Click the "copy" icons to copy code  
* See the "Resources" section of each page for further resources  
* To download data and "follow-along", see the [Download book and data] page  

**Offline version**  

To download the offline version, follow step-by-step instructions in the [Download book and data] page.  

**Languages**  

We are actively seeking to translate this book into languages other than English. If you can help, please contact us at **epiRhandbook@gmail.com**.  


<!-- ======================================================= -->
## Edit or contribute {-}

Want to share how you use this book? Want to offer a fix or addition?  
Email us at **epiRhandbook@gmail.com**. We welcome your comments and suggestions. 

You can also submit an issue or pull request at our [Github repository](https://github.com/nsbatra/R_epi_handbook), or provide structured feedback via this [Google survey](https://forms.gle/4RNdRRLGx67xW9yq9).  



<!-- ======================================================= -->
## Acknowledgements {-}  


### Contributors {-}  

This book is produced by a collaboration of epidemiologists from around the world, drawing upon experiences with organizations including local, state, provincial, and national health departments and ministries, the World Health Organization (WHO), MSF (Médecins Sans Frontières / Doctors without Borders), hospital systems, and academic institutions.

**Editor-in-Chief:** Neale Batra 

**Core team:** Neale Batra, Alex Spina, Amrish Baidjoe, Pat Keating, Henry Laurenson-Schafer, Finlay Campbell  

**Authors**: Neale Batra, Alex Spina, Paula Blomquist, Finlay Campbell, Henry Laurenson-Schafer, Isaac Florence, Natalie Fischer, Aminata Ndiaye, Liza Coyer, Jonny Polonski, Yurie Izawa, Daniel Molling, Sara Hollis, Isha Berry, Wen Lin  

**Reviewers**: 

### Funding and programmatic support {-}  

This handbook is **not** an approved product of any specific organization. Although we strive for accuracy, we provide no guarantee of the content in this book.  

The handbook project received funding via a COVID-19 emergency capacity-building grant from Training Programs in Epidemiology and Public Health Interventions Network ([TEPHINET](https://www.tephinet.org/)). *This handbook was supported by Cooperative Agreement number NU2GGH001873, funded by the Centers for Disease Control and Prevention through TEPHINET, a program of The Task Force for Global Health. Its contents are solely the responsibility of the authors and do not necessarily represent the official views of the Centers for Disease Control and Prevention, the Department of Health and Human Services, The Task Force for Global Health, Inc. or TEPHINET.*

Programmatic support was provided by the EPIET Alumni Network ([EAN](https://epietalumni.net/)) and also MSF's Manson Unit.  



### Inspiration {-}  

The multitude of tutorials and vignettes that provided knowledge for development of handbook content are credited within their respective pages.  

More generally, the following sources provided inspiration and laid the groundwork for this handbook:  
[The "R4Epis" project](https://r4epis.netlify.app/) (a collaboration between MSF and RECON)  
[R Epidemics Consortium (RECON)](https://www.repidemicsconsortium.org/)  
[R for Data Science book (R4DS)](https://r4ds.had.co.nz/)  
[bookdown: Authoring Books and Technical Documents with R Markdown](https://bookdown.org/yihui/bookdown/)  
[Netlify](https://www.netlify.com) hosts this website  


### Image credits {-}  

Images in logo (from US CDC Public Health Image Library):  
[2013 Yemen looking for mosquito breeding sites](https://phil.cdc.gov/Details.aspx?pid=19623)  
[Ebola virus](https://phil.cdc.gov/Details.aspx?pid=23186)  
[Survey in Rajasthan](https://phil.cdc.gov/Details.aspx?pid=19838)  



### Terms of Use and License {-}  

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.


```{r include=FALSE, cache=FALSE}

# clear workspace
rm(list = ls(all = TRUE))

# clear all packages except base
#lapply(names(sessionInfo()$loadedOnly), require, character.only = TRUE)
#invisible(lapply(paste0('package:', names(sessionInfo()$otherPkgs)), detach, character.only=TRUE, unload=TRUE, force=TRUE))

# to ensure that tidyverse packages prevail
filter <- dplyr::filter
select <- dplyr::select
summarise <- dplyr::summarise
summary <- base::summary
incidence <- incidence2::incidence

#load core packages
pacman::p_load(
     rio,
     here,
     DT,
     stringr,
     lubridate,
     tidyverse
)

# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "linelist_cleaned.rds"))

# import the count data - facility level
#count_data <- rio::import(here::here("data", "facility_count_data.rds"))

# Settings

options(scipen=1, digits=3)
```

<!--chapter:end:index.Rmd-->

# (PART) Preview pages {-}
```{r include=FALSE, cache=FALSE}

# clear workspace
rm(list = ls(all = TRUE))

# clear all packages except base
#lapply(names(sessionInfo()$loadedOnly), require, character.only = TRUE)
#invisible(lapply(paste0('package:', names(sessionInfo()$otherPkgs)), detach, character.only=TRUE, unload=TRUE, force=TRUE))

# to ensure that tidyverse packages prevail
filter <- dplyr::filter
select <- dplyr::select
summarise <- dplyr::summarise
summary <- base::summary
incidence <- incidence2::incidence

#load core packages
pacman::p_load(
     rio,
     here,
     DT,
     stringr,
     lubridate,
     tidyverse
)

# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "linelist_cleaned.rds"))

# import the count data - facility level
#count_data <- rio::import(here::here("data", "facility_count_data.rds"))

# Settings

options(scipen=1, digits=3)
```

<!--chapter:end:new_pages/cat_preview.Rmd-->


# Routine reports {  }  

This page will cover the **reportfactory** package. **reportfactory** is a package developed by RECON (R Epidemics Consortium).  

**reportfactory** is an *accompaniment to using R Markdowns for reports*. It is built for scenarios where you are running routine reports (daily, weekly, etc.). It makes easier the organization and compilation of multiple R Markdown files and their outputs. In essence, it provides a "factory" from which you can run the Rmd reports and automatically get organized date- and time-stamped folders with the outputs.  


## Preparation

### Packages {-}  

To begin, we install and/or load the **reportfactory** package from CRAN.  

```{r, eval=FALSE}
pacman::p_load(reportfactory)
```

### R project {-} 

Open a new R project, or have an existing one. See the page on [R projects] for instructions on how to create an R project. The report factory will live within the R project.  

Below, we have created an R project called "demo_factory". Currently there are no other files within the project.  


```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_new1.png"))
```

## New factory  

Adding a new report factory will add a self-contained folder to the R project. Below we will create a factory within the empty "demo_factory" R project. The report factory itself will be called "new_factory" (the default name - this can be changed).  

1) Within the R project, load the **reportfactory** package by entering `library(reportfactory)` or `pacman::p_load(reportfactory)` into the console.  
2) Run the function `new_factory()`. The factory will be added as a folder to the R project root folder by default.  

```{r, eval=F}
# This will create the factory folder in the current directory
new_factory()
```

```{r, eval=F}
# Alternatively, you can specify that the factory be made at a specific file path
new_factory(path = "C:/R handbook/demo_factory")
```

Below see that the folder "new_factory" has been created

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_new2.png"))
```

There are several defaults that you can change in the `new_factory()` command:  

* `factory = ` - you can provide a name for the factory folder. The default is as shown above: "new_factory".  
* `path = ` - as shown above, you can designate a file path for the new factory. The default is the current directory.  
* `report_sources = ` You can provide an alternate name for the folder which holds the R Markdown scripts that create the reports. The default is "report_sources".  
* `outputs = ` You can provide an alternate name for the folder which holds the output reports. The default is "outputs".  

See `?new_factory` for a complete list of the function arguments.  


## Review the factory  

Looking inside the "new_factory" folder we can see that sub-folders were created automatically. You can adjust in the `new_factory()` command if you do not want these sub-folders to be created.    

* The *report_sources* folder should hold your R Markdown scripts, which generate your reports  
* The *outputs* folder will the report outputs (e.g. HTML, Word, PDF, etc.) - it will contain automatically-generated sub-folder organized by report and date-time stamp  
* The *scripts* folder can be used to store other R scripts that can be sourced/run by the R Markdown scripts (optional)  
* The *data* folder can be used to hold your data (optional)  
* A *.here* file was created, so now can reference any files in the sub-folders by their relation to this factory root folder (see [R projects] for more details about the **here** package)  
* A *gitignore* file was created in case you decide to link this to a Github repository (see [Collaboration with Github])  
* An empty README markdown file was created, to assist if using a Github repository  

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_new3.png"))
```
 
Within R, you can run a command to see the structure (folders and files) in the report factory.  

```{r, eval=F}
reportfactory::factory_overview()
```

The following "tree" of the factory's folders and files is printed to the R console. You can see that there sub-folders for "raw" and "clean" data, some example CSV data. There is also an "example_report.Rmd" in the "report_sources" folder.    

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_overview.png"))
```


## Create a report  

For purposes of example, we create a new R markdown script entitled "daily_sitrep.Rmd" and save it within the "report_sources" folder of the report factory. In it, the case linelist is imported from the "data" folder, summary tables and epicurves are printed in the report HTML output and exported as .csv and .png files respectively.

We also have added the data for the report ("linelist_cleaned.rds") to the "clean" sub-folder within the "data" folder. The new R Markdown script can source this data with the following command. To read more about importing data with the **rio** package and the **here** package see the page on [Import and export].  

```{r, eval=F}
linelist <- import(here("data", "clean", "linelist_cleaned.rds"))
```

Below is a screenshot of the beginning of the new R Markdown "daily_sitrep.Rmd". You can see that the output format is set to be HTML, via the YAML header `output: html_document`. Later in the report, there are commands to:  

* Print a summary table of cases, also exporting the table as a .csv file  
* Print an epicurve, also saving it as a .png image file  

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_new_rmd.png"))
```

We can now see in the factory overview that a Rmd has been added to "report_sources" and the data file has been added as well (highlighted):

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_overview2.png"))
```

## Review

You can review the R Markdown reports in the report_sources folder with this command:  

```{r, eval=F}
list_reports()
```



## Compile  

In a report factory, to "compile" a R Markdown report means that the .Rmd will be rendered (as HTML, Word, PDF, etc - however it is indicated in the YAML of the Rmd script). The report factory will auto-create a date- and time-stamped folder for the output in the "outputs" folder. The output and any exported files (e.g. csv, png, xlsx, etc. will be saved in this folder. The Rmd itself will also be saved in this folder, so you have a record of that version of the Rmd, as it was at that moment.  

This contrasts with the normal behavior of a rendered R Markdown, which will save to the location of the .Rmd. This default behavior can result in crowded, messy folders. The report factory aims to improve organization when one needs to run reports frequently.  

### Compile by name {-}  

You can compile a specific report by running `compile_reports()` and providing the name (without .rmd extension) to `reports = `. Below, this command would compile only the "daily_sitrep.rmd" report, rendering the HTML and saving all the products into a date- and time-stamped sub-folder specific to the report, within the "outputs" folder.  

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_compile1.png"))
```


Note that when you compile, you will see several files temporarily appear in the "report_sources" folder - but they will soon disappear. 

### Compile by number {-}

You can also specify the Rmd to compile by feeding a number or vector of numbers to `reports = `. The numbers must align with the order the reports appear when you run `list_reports()`.  

```{r, eval=F}
# Run the second and fourth Rmds in the "report_sources" folder
compile_reports(reports = c(2, 4))
```

### Compile from sub-folder {-}  

You can add sub-folders to the "report_sources" folder. To run an R Markdown report from a subfolder, simply provide the name of the folder to `subfolder = `. Below is an example of code to compile a Rmd report that lives in a sub_folder of "report_sources".  

```{r, eval=F}
compile_reports(
     reports = "summary_for_partners.Rmd",
     subfolder = "for_partners")
```


### Compile all {-}

You can compile *all* the R Markdown reports in the "report_sources" folder by setting the `reports = ` argument to TRUE.  

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_compile_all.png"))
```


### Parameterization {-}

As noted in the page on [R Markdown], you can run reports with specified parameters. You can pass these parameters as a list to `compile_reports()` via the `params = ` argument. For example, in this fictional report there are three parameters provided to the R Markdown reports.  

```{r, eval=F}
compile_reports(
  reports = "daily_sitrep.Rmd",
  params = list(most_recent_data = TRUE,
                region = "NORTHERN",
                rates_denominator = 10000),
  subfolder = "regional"
)
```

## Outputs  

After we have compiled the reports are few times, the "outputs" folder might look like this (highlights added for clarity):  

* Folders have been created for the outputs of each Rmd report  
* Sub-folders have been created for each unique compiling - these folders are date- and time-stamped ("2021-04-07_T20-11-25" means 7th April 2021 at 20:11:25)  
* Within each date/time compiled folder, the rendered output is stored (HTML, PDF, Word, etc.) along with the Rmd and any other exported files from the rendering (e.g. csv, png)  


```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_overview_all.png"))
```



## Review  

You can use `list_outputs()` to review a list of the outputs.  


## Extras  

* With **reportfactory**, you can use the function `list_deps()` to list all packages required across all the reports in the entire factory.  

* There is an accompanying package in development called **rfextras** that offers more helper functions to assist you in building reports, such as:  
  * `load_scripts()` - sources/loads all .R scripts in a given folder (the "scripts" folder by default)  
  * `find_latest()` - finds the latest version of a file (e.g. the latest dataset)




<!-- ======================================================= -->
## Resources {  }

See the **reportfactory** package's [Github page](https://github.com/reconverse/reportfactory)

See the **rfextras** package's [Github page](https://github.com/reconhub/rfextras)  

```{r include=FALSE, cache=FALSE}

# clear workspace
rm(list = ls(all = TRUE))

# clear all packages except base
#lapply(names(sessionInfo()$loadedOnly), require, character.only = TRUE)
#invisible(lapply(paste0('package:', names(sessionInfo()$otherPkgs)), detach, character.only=TRUE, unload=TRUE, force=TRUE))

# to ensure that tidyverse packages prevail
filter <- dplyr::filter
select <- dplyr::select
summarise <- dplyr::summarise
summary <- base::summary
incidence <- incidence2::incidence

#load core packages
pacman::p_load(
     rio,
     here,
     DT,
     stringr,
     lubridate,
     tidyverse
)

# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "linelist_cleaned.rds"))

# import the count data - facility level
#count_data <- rio::import(here::here("data", "facility_count_data.rds"))

# Settings

options(scipen=1, digits=3)
```

<!--chapter:end:new_pages/reportfactory.Rmd-->

