---
title:  |  
  ![](../images/R Handbook Logo.png)
author: ""
date: "Produced `r format(Sys.time(), '%A %d %B %Y')`"
output:
  html_document:
    code_folding: show
    highlight: zenburn
    number_sections: no
    theme: sandstone
    toc: yes
    toc_collapse: no
    toc_depth: 3
    toc_float: yes
params:
    run_page_ind: TRUE
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "_outputs_knitted") })
---

```{r, child= '_page_setup.Rmd', eval = params$run_page_ind, include = F}
```

<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
# Moving averages {#movingavg .tabset .tabset-fade}  

The Page title should be succinct. Consider adding a tag with no spaces into the curly brackets, such as below. This can be used for internal links within the handbook. 
`{#title_tag .tabset .tabset-fade}`

<!-- ======================================================= -->
## Overview {.tabset .tabset-fade .tabset-pills}

Calculating
Visualizing

Keep the title of this section as "Overview".  
This tab should include:  

* Textual overview of the purpose of this page  
* Small image showing outputs   



Add a moving averages to a `ggplot()` epicurve in one of two ways:  

1)  Plot the pre-calculated moving average:  
      + Aggregate the data as necessary (daily, weekly, etc.)  
      + Calculate the moving average  
      + Add the moving average to the ggplot (e.g. with `geom_line()`)  
2) Calculate on-the-fly within the `ggplot()` command  




<!-- ======================================================= -->
## Preparation {.tabset .tabset-fade .tabset-pills}

Keep the title of this section as "Preparation".  
Data preparation steps such as:  

* Loading dataset  
* Adding or changing variables  
* melting, pivoting, grouping, etc.   

<!-- ======================================================= -->
### sub-tab 1 {.tabset .tabset-fade .tabset-pills}

Can be used to separate major steps of data preparation. Re-name as needed


<!-- ======================================================= -->
### sub-tab 2 {.tabset .tabset-fade .tabset-pills}

Can be used to separate major steps of data preparation. Re-name as needed.



<!-- ======================================================= -->
## Calculate before {.tabset .tabset-fade .tabset-pills}

Using the package **slider** to calculate a moving average in a dataframe, prior to any plotting.  

* Can assign `.before = Inf` to achieve cumulative averages from the first row  
* Use `slide()` in simple cases  
* Use `slide_index()` to designate a date column as an index, so that dates which do not appear in the dataframe are still included in the window  
  * `.before`, `.after` TODO  
  * `.complete` TODO  
  * 

```{r, eval=F}
pacman::p_load(slider)  # slider used to calculate rolling averages

# make dataset of daily counts and 7-day moving average
#######################################################
ll_counts_7day <- linelist %>% 
  ## count cases by date
  count(date_onset,
        name = "new_cases") %>%   # name of new column
  
  ## calculate the average number of cases in the preceding 7 days
  mutate(
    avg_7day = slider::slide_index(    # create new column
      new_cases,                       # calculate based on value in new_cases column
      .i = date_onset,                 # index is date_onset col, so non-present dates are included in window 
      .f = ~mean(.x, na.rm = TRUE),    # function is mean() with missing values removed
      .before = 6,                     # window is the day and 6-days before
      .complete = TRUE),             # Must be FALSE for unlist() to work in next step
    avg_7day = unlist(avg_7day))


# plot
######
ggplot(data = ll_counts_7day, aes(x = date_onset)) +
    geom_histogram(aes(y = new_cases), fill="#92a8d1", stat = "identity", position = "stack", colour = "#92a8d1")+ 
    geom_line(aes(y = avg_7day), color="red", size = 1) + 
    scale_x_date(
      date_breaks = "1 month",
      date_labels = '%d/%m',
      expand = c(0,0)) +
    scale_y_continuous(expand = c(0,0), limits = c(0, NA)) + 
    labs(x="", y ="Number of confirmed cases")+ 
    theme_minimal() 
```

<!-- ======================================================= -->
### Option 1 sub-tab {.tabset .tabset-fade .tabset-pills}

Sub-tabs if necessary. Re-name as needed.



<!-- ======================================================= -->
## Calculate on-the-fly {.tabset .tabset-fade .tabset-pills}

```{r, eval=F}
per_pos_plot_county <- ggplot(data = filter(tests_per_county),
       aes(x = DtSpecimenCollect_Final, y = prop_pos))+
  geom_line(size = 1, alpha = 0.2)+  # plot raw values
  tidyquant::geom_ma(n=7, size = 2)+ # plot moving average
  theme_minimal_hgrid()+
  coord_cartesian(xlim = c(as.Date("2020-03-15"), Sys.Date()), ylim = c(0, 15))+
  labs(title    = "COUNTY-WIDE TESTING PERCENT POSITIVE",
       subtitle = "Daily and 7-day moving average",
       y        = "Percent Positive",
       x        = "Date Specimen Collected")+
  theme_text_size+
  theme(axis.text = element_text(face = "bold", size = 14),
        panel.background = element_rect(fill = "khaki")
        )
```


<!-- ======================================================= -->
## Resources {.tabset .tabset-fade .tabset-pills}

This tab should stay with the name "Resources".
Links to other online tutorials or resources.

See the helpful online [vignette for the **slider** package](https://cran.r-project.org/web/packages/slider/vignettes/slider.html)  

If your use case requires that you “skip over” weekends and even holidays, you might like **almanac** package.




```{r, child= '_page_closeout.Rmd', eval = params$run_page_ind == F, include = F}
```

