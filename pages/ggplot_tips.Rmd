---
title:  |  
  ![](../images/R Handbook Logo.png)
author: ""
date: "Produced `r format(Sys.time(), '%A %d %B %Y')`"
output:
  html_document:
    code_folding: show
    highlight: zenburn
    number_sections: no
    theme: sandstone
    toc: yes
    toc_collapse: no
    toc_depth: 3
    toc_float: yes
params:
    run_page_ind: TRUE
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "_outputs_knitted") })
---

```{r, child= '_page_setup.Rmd', eval = params$run_page_ind, include = F}
```


<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
# ggplot tips {#ggplot_tips .tabset .tabset-fade}  


<!-- ======================================================= -->
## Overview {.tabset .tabset-fade .tabset-pills}

Embed ggplot cheatsheet

`ggplot2` is the most popular data visualisation package in R, and is generally used instead of base `R` for creating figures. `ggplot2` benefits from a wide variety of supplementary packages that further enhance its functionality. Despite this, ggplot syntax is significantly different from base `R` plotting, and has a learning curve associated with it. Using `ggplot2` generally requires the user to format their data in a way that is highly `tidyverse` compatible, which ultimately makes using these packages together very effective.

Plotting with `ggplot2` is based on defining base attributes to a plot, and adding layers on top. In addition, the user can change various plot attributes like axis settings, colour schemes, and labels with additional objects that are "added" to the plot. While ggplot objects can be highly complex, the basic order of creating a ggplot looks something like this:

1. Define base/default plot attributes and aesthetic swith `ggplot()` function
2. Add geometric objects to the plot - i.e. is the plot a bar graph, a line plot, a scatter plot, or a histogram? Or is it a combination of these? These functions all start with `geom_` as a prefix.
3. Change plot aesthetics e.g. changing the axes, labels, colour scheme, background etc.

In code, this might look like this:

```{r, eval = TRUE}
# read in dataset

# define base plot attributes and dataset
ggplot(data = linelist_cleaned, mapping = aes(x = age)) +
  # add a geometric object with some parameters
  geom_histogram(binwidth = 10, fill = "red", col = "black") +
  # add labels to the axes
  labs(x = "Age in years", y = "Number of cases")
  

```

With this code, the most important things to note are:

  1. When making a ggplot, all objects are combined with a `+` sign.
  2. Understanding the principles behind aesthetic mapping with the `mappping = aes()` argument is essential to using ggplot. This can be done in the `ggplot()` function as well as every geometric object. Mapping with `aes()` is used to define which variables are assigned to each axis (these can be continuous or categorical variables). It is also used to define whether a variable can be used to create different plot aesthetics. This can apply to the:
  
    a. line colour (`col = `)
    b. filled colour (`fill = `)
    c. linetype (e.g. dotted, dashed) (`linetype =`)
    d. size of an object (`size = `)
  
  This list is not exhaustive, but is enough to give a rough overview.
  
  3. Aesthetics of geometric objects can be defined *explicitly* as in the code above - this is different from assigning them to a variable. In cases where this is done, it must be *outside* the `mapping` argument. 
  
```{r, eval = FALSE}
# correct
ggplot(data = linelist_cleaned, mapping = aes(x = age)) +
  geom_histogram(col = "black")

# incorrect
# correct
ggplot(data = linelist_cleaned, mapping = aes(x = age)) +
  geom_histogram(mapping = aes(col = "black"))

```

An example of defining aesthetics with a variable can be seen here:

```{r, eval = TRUE}
# read in dataset

# define base plot attributes and dataset
ggplot(data = linelist_cleaned, mapping = aes(x = age, fill = outcome)) +
  # add a geometric object with some parameters (NO FILL GIVEN)
  geom_histogram(binwidth = 10, col = "black") +
  # add labels to the axes
  labs(x = "Age in years", y = "Number of cases")
```


There are a huge number of different geoms that can be used, and they are all used with similar attribute names. While not exhaustive, some of the shapes that can be used are:

  1. Histograms - `geom_histogram()`
  2. Barcharts - `geom_bar()`
  3. Boxplots - `geom_boxplot()`
  4. Dot plots (for scatterplots or with discrete variables) - `geom_point()`
  5. Line graphs - `geom_line()` or `geom_path()`
  6. Trend lines - `geom_smooth()`

You can also add straight lines to your plot with `geom_hline()` (horizontal), `geom_vline()` (vertical) or `geom_abline()` (with a specified y intercept and slope)

There is much more detail we could show here, but we'll finish with an example that ties these concepts together by plotting the time between onset and hospitalisation by age with a scatterplot
  
```{r, eval = TRUE, cache.vars = TRUE}

# calculate our delay variable

linelist_cleaned <- linelist_cleaned %>%
  mutate(days_onset_to_hosp = date_hospitalisation - date_onset)

# set up the plot and define key variables
# colour is the outcome
delay_plot <- ggplot(data = linelist_cleaned,
                     aes(x = age_years, y = days_onset_to_hosp, col = outcome)) +
  # define aspects of the geom that are NOT included specific to variables
  # other attributes are inherited
  geom_point(size = 1, alpha = 0.5) +
  # add a trend line
  # use a linear method
  geom_smooth(method = "lm") +
  # add nicer labels
  labs(x = "age", y = "onset to hospitalsiation (days)",
       title = "Onset to hospitalisation by age")

delay_plot

```

This looks ok, but we could make the theme a little nicer. `ggplot2` comes with some preset themes that can be used to change the theme of the plot. We can also edit themes of the plot with extreme detail with the `theme()` function. For example, we can update this plot like this:

```{r, eval = TRUE}

delay_plot + 
  # set the theme to classic
  theme_classic() +
  # further edit the theme to move the legend position
  theme(legend.position = "bottom")

```

<!-- ======================================================= -->
## Preparation {.tabset .tabset-fade .tabset-pills}

When preparing data to plot, it is best to make the data adhere to tidyverse standards as much as possible. This is expanded on much more in previous sections. 

Some simple ways we can prepare our data to make it better for plotting can often include making the contents of the data better for display - this does not necessarily mean its better for data manipulation! For example, we can replace `NA` values in a character column with the string "Unknown", or clean some variables so that their "data friendly" with underscores etc are changed to normal text. Here are some examples of this in action:

```{r, eval = FALSE}
linelist_cleaned <- linelist_cleaned %>%
  # make display version of columns with more friendly names
  mutate(
    # f to Male, f to Female, NA to Unknown
    gender_disp = case_when(gender == "m" ~ "Male",
                            gender == "f" ~ "Female",
                            is.na(gender) ~ "Unknown"),
    # replace NA with unknown for outcome
    outcome_disp = replace_na(outcome, "Unknown")
  )


```



As a matter of data structure, we often also want to pivot our data into *longer* formats, which will allow us to use a set of variables as a single variable. For example, if we wanted to show the number of cases with specific symptoms, we are limited by the fact that each symptom is a specific column. We can pivot this to a longer format like this:

```{r, eval = F}

linelist_sym <- linelist_cleaned %>%
  pivot_longer(cols = c("fever", "chills", "cough", "aches", "vomit"),
               names_to = "symptom_name",
               values_to = "symptom_is_present")

```

We could then use new dataframe in an upcoming plot. Note that this format is not very useful for other operations, and should just be used for the plot it was made for. However, users should endeavour to use these practices as much as possible for the base dataset, as they are more tidyverse compliant, and will make working with the data easier.

<!-- ======================================================= -->
### sub-tab 1 {.tabset .tabset-fade .tabset-pills}

Can be used to separate major steps of data preparation. Re-name as needed


<!-- ======================================================= -->
### sub-tab 2 {.tabset .tabset-fade .tabset-pills}

Can be used to separate major steps of data preparation. Re-name as needed.



<!-- ======================================================= -->
## Highlighting {.tabset .tabset-fade .tabset-pills}

highlighting one line among many etc
gghighlight


<!-- ======================================================= -->
## Dual axes {.tabset .tabset-fade .tabset-pills}
Cowplot
Complicated method (% 100 * ...)

<!-- ======================================================= -->
## Smart Labeling {.tabset .tabset-fade .tabset-pills}
ggrepel

<!-- ======================================================= -->
## Time axes {.tabset .tabset-fade .tabset-pills}


<!-- ======================================================= -->
## Dual axes {.tabset .tabset-fade .tabset-pills}


<!-- ======================================================= -->
## Adding shapes {.tabset .tabset-fade .tabset-pills}

<!-- ======================================================= -->
## Animations {.tabset .tabset-fade .tabset-pills}





```{r, child= '_page_closeout.Rmd', eval = params$run_page_ind == F, include = F}
```

